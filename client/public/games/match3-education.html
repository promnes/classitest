<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ´ŸÑÿßÿ´Ÿäÿ© ÿ™ÿπŸÑŸäŸÖŸäÿ© - Educational Match 3</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0}
.screen.active{display:flex}

/* ===== LEVEL SELECT ===== */
#level-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(6px,1.5vmin,12px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#a78bfa,#6366f1))}
.ls-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.ls-subtitle{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;flex-shrink:0;font-weight:600}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.lv-card{position:relative;background:linear-gradient(145deg,rgba(255,255,255,.35),rgba(255,255,255,.15));border:3px solid rgba(255,255,255,.45);border-radius:clamp(14px,3vmin,22px);padding:clamp(8px,2vmin,16px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .25s;backdrop-filter:blur(6px);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08);transform-style:preserve-3d;animation:cardFloat 3s ease-in-out infinite}
.lv-card:nth-child(even){animation-delay:.5s}.lv-card:nth-child(3n){animation-delay:1s}.lv-card:nth-child(4n+1){animation-delay:1.5s}
.lv-card:hover{transform:translateY(-4px) scale(1.06);background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.25));box-shadow:0 10px 0 rgba(0,0,0,.1),0 16px 32px rgba(0,0,0,.1)}
.lv-card:active{transform:translateY(3px) scale(.97);box-shadow:0 2px 0 rgba(0,0,0,.15),0 3px 8px rgba(0,0,0,.08)}
.lv-card.locked{opacity:.5;cursor:not-allowed;animation:none}
.lv-card.locked:hover{transform:none;background:rgba(255,255,255,.15);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08)}
.lv-card.current{border-color:#fbbf24;box-shadow:0 6px 0 rgba(251,191,36,.3),0 0 18px rgba(251,191,36,.5)}
.lv-num{font-size:clamp(22px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.lv-emoji{font-size:clamp(32px,7vmin,48px);margin:3px 0;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));animation:emojiWiggle 2.5s ease-in-out infinite}
.lv-card:nth-child(2n) .lv-emoji{animation-delay:.3s}.lv-card:nth-child(3n) .lv-emoji{animation-delay:.7s}.lv-card:nth-child(4n) .lv-emoji{animation-delay:1.1s}.lv-card.locked .lv-emoji{animation:none}
.lv-name{font-size:clamp(10px,1.8vmin,14px);color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lv-stars{font-size:clamp(14px,2.8vmin,18px);margin-top:3px}
.lv-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(32px,7vmin,46px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}
.ls-free-btn{flex-shrink:0;background:linear-gradient(135deg,#f59e0b,#f97316);border:none;border-radius:clamp(14px,3vmin,20px);padding:clamp(12px,3vmin,20px) clamp(34px,8vmin,56px);color:#fff;font-size:clamp(18px,4vmin,24px);font-weight:900;cursor:pointer;box-shadow:0 4px 20px rgba(249,115,22,.4);transition:all .2s;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.ls-free-btn:hover{transform:scale(1.05)}
.ls-free-btn:active{transform:scale(.95)}

/* ===== GAME SCREEN ===== */
#game-screen{flex-direction:column;align-items:center;padding:clamp(4px,1vmin,10px);gap:clamp(3px,.8vmin,6px);background:var(--bg,linear-gradient(135deg,#ddd6fe,#a78bfa));transition:background .5s}
.g-header{width:100%;max-width:540px;display:flex;align-items:center;justify-content:space-between;gap:6px;flex-shrink:0}
.g-title-area{display:flex;align-items:center;gap:5px}
.g-title-text{font-size:clamp(16px,3.2vmin,22px);font-weight:900;color:var(--text,#4c1d95)}
.g-level-badge{font-size:clamp(12px,2.2vmin,16px);background:var(--accent,#7c3aed);color:#fff;border-radius:20px;padding:3px 10px;font-weight:800}
.g-stats{display:flex;gap:clamp(4px,1vmin,8px);align-items:center}
.g-stat{text-align:center;background:rgba(255,255,255,.6);border-radius:8px;padding:2px 8px;backdrop-filter:blur(4px)}
.g-stat-val{font-size:clamp(18px,3.5vmin,24px);font-weight:900;color:var(--accent,#7c3aed)}
.g-stat-lbl{font-size:clamp(10px,1.8vmin,12px);color:#4b5563;text-transform:uppercase;letter-spacing:.04em;font-weight:700}

/* Board */
.board-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;width:100%;min-height:0}
.board{display:grid;touch-action:none;position:relative}

/* Tiles */
.tile{border:none;border-radius:clamp(10px,2.5vmin,16px);cursor:grab;display:flex;align-items:center;justify-content:center;font-weight:800;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;padding:0;outline:none;transition:box-shadow .15s,transform .15s;background:linear-gradient(145deg,rgba(255,255,255,.95),rgba(240,235,255,.85));touch-action:none;box-shadow:0 4px 0 rgba(0,0,0,.1),0 6px 12px rgba(0,0,0,.06);transform-style:preserve-3d}
.tile:active{cursor:grabbing}
.tile.selected{box-shadow:0 4px 0 rgba(251,191,36,.4),0 0 0 3px #fbbf24,0 0 14px rgba(251,191,36,.5);z-index:2}
.tile.dragging{z-index:100;box-shadow:0 8px 0 rgba(0,0,0,.15),0 12px 28px rgba(0,0,0,.2);transform:scale(1.12);transition:box-shadow .1s,transform .1s}
.tile.matching{animation:matchPop .45s ease forwards}
.tile.falling{animation:tileFall .38s ease-out}
.tile .te{font-size:clamp(22px,5.5vmin,38px);line-height:1;pointer-events:none;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));animation:emojiBreath 2.5s ease-in-out infinite}
.tile:nth-child(odd) .te{animation-delay:.3s}.tile:nth-child(3n) .te{animation-delay:.8s}.tile:nth-child(5n) .te{animation-delay:1.3s}
.tile.hint-glow{animation:hintPulse .5s ease 4}

/* Moves bar */
.mv-bar{width:100%;max-width:540px;flex-shrink:0}
.mv-track{width:100%;height:clamp(5px,1vmin,8px);background:rgba(255,255,255,.4);border-radius:99px;overflow:hidden}
.mv-fill{height:100%;background:linear-gradient(90deg,#10b981,#34d399);border-radius:99px;transition:width .4s}
.mv-text{text-align:center;font-size:clamp(11px,2vmin,14px);color:var(--text,#4c1d95);font-weight:700;margin-top:2px}

/* Footer */
.g-footer{display:flex;gap:clamp(4px,1vmin,8px);flex-shrink:0;flex-wrap:wrap;justify-content:center}
.f-btn{background:rgba(255,255,255,.7);border:none;border-radius:12px;padding:clamp(7px,1.8vmin,12px) clamp(14px,3.5vmin,24px);font-size:clamp(14px,2.5vmin,18px);font-weight:800;color:var(--text,#4c1d95);cursor:pointer;transition:all .2s}
.f-btn:hover{background:rgba(255,255,255,.9);transform:scale(1.04)}
.f-btn:active{transform:scale(.95)}
.f-btn.hint{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff}

/* Combo popup */
.combo-pop{position:absolute;font-size:clamp(22px,6vmin,36px);font-weight:900;color:#fff;text-shadow:0 3px 10px rgba(0,0,0,.5);pointer-events:none;animation:comboRise .9s ease-out forwards;z-index:200}

/* No-moves overlay */
.no-mv{position:absolute;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50;border-radius:12px}
.no-mv-card{background:#fff;border-radius:16px;padding:clamp(14px,3vmin,24px);text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.no-mv-card h3{font-size:clamp(18px,4vmin,26px);color:#4c1d95;margin-bottom:8px;font-weight:900}
.no-mv-card p{font-size:clamp(13px,2.5vmin,16px);color:#4b5563;margin-bottom:12px;font-weight:600}
.no-mv-card button{background:linear-gradient(135deg,#8b5cf6,#7c3aed);border:none;border-radius:12px;padding:9px 24px;color:#fff;font-size:clamp(14px,2.5vmin,17px);font-weight:800;cursor:pointer}

/* ===== COMPLETE SCREEN ===== */
#complete-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vmin,16px);padding:clamp(12px,3vmin,24px);background:var(--bg,linear-gradient(135deg,#a78bfa,#6366f1))}
.c-emoji{font-size:clamp(56px,14vmin,84px);animation:celebBounce 1s ease infinite;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
.c-title{font-size:clamp(24px,7vmin,38px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4)}
.c-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;font-weight:600}
.c-stars-row{display:flex;gap:clamp(5px,1.2vmin,8px);font-size:clamp(36px,9vmin,54px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.c-stats{display:flex;gap:clamp(8px,2vmin,16px);flex-wrap:wrap;justify-content:center}
.c-stat{text-align:center;background:rgba(255,255,255,.2);border-radius:12px;padding:clamp(6px,1.5vmin,12px) clamp(10px,2.5vmin,18px);backdrop-filter:blur(4px)}
.c-stat-emoji{font-size:clamp(24px,6vmin,36px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.c-stat-val{font-size:clamp(20px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.c-stat-lbl{font-size:clamp(10px,1.8vmin,13px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.c-btns{display:flex;gap:clamp(6px,1.5vmin,10px);flex-wrap:wrap;justify-content:center}
.c-btn{border:none;border-radius:14px;padding:clamp(10px,2.5vmin,16px) clamp(24px,6vmin,40px);font-size:clamp(15px,3vmin,20px);font-weight:900;cursor:pointer;transition:all .2s}
.c-btn:hover{transform:scale(1.04)}
.c-btn:active{transform:scale(.95)}
.c-btn.primary{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 18px rgba(249,115,22,.4)}
.c-btn.secondary{background:rgba(255,255,255,.25);color:#fff;backdrop-filter:blur(4px)}
.c-btn.share{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 18px rgba(37,99,235,.4)}

/* ===== FREE PLAY SCREEN ===== */
#free-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(10px,2.5vmin,18px);padding:clamp(12px,3vmin,24px);overflow-y:auto;background:linear-gradient(135deg,#a78bfa,#818cf8,#6366f1)}
.fp-title{font-size:clamp(20px,5vmin,30px);font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3)}
.fp-group{width:100%;max-width:420px}
.fp-label{font-size:clamp(11px,1.8vmin,13px);color:rgba(255,255,255,.8);margin-bottom:4px;font-weight:600;text-align:center}
.fp-row{display:flex;gap:clamp(4px,1vmin,8px);justify-content:center;flex-wrap:wrap}
.fp-btn{background:rgba(255,255,255,.18);border:2px solid transparent;border-radius:clamp(8px,1.8vmin,14px);padding:clamp(6px,1.5vmin,10px) clamp(10px,2.5vmin,18px);color:#fff;font-size:clamp(11px,2vmin,13px);font-weight:700;cursor:pointer;transition:all .2s;backdrop-filter:blur(4px)}
.fp-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.04)}
.fp-btn.sel{background:rgba(255,255,255,.4);border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,.3)}
.fp-go{margin-top:clamp(4px,1vmin,8px);background:linear-gradient(135deg,#f59e0b,#f97316);border:none;border-radius:16px;padding:clamp(10px,2.5vmin,14px) clamp(32px,7vmin,48px);color:#fff;font-size:clamp(14px,3vmin,18px);font-weight:900;cursor:pointer;box-shadow:0 4px 20px rgba(249,115,22,.4);transition:all .2s}
.fp-go:hover{transform:scale(1.05)}
.fp-back{background:rgba(255,255,255,.2);border:none;border-radius:12px;padding:8px 20px;color:#fff;font-size:clamp(11px,2vmin,13px);font-weight:700;cursor:pointer;transition:all .2s}
.fp-back:hover{background:rgba(255,255,255,.35)}

/* ===== ANIMATIONS ===== */
@keyframes matchPop{0%{transform:scale(1);opacity:1}30%{transform:scale(1.3);opacity:1}60%{transform:scale(.2);opacity:.4}100%{transform:scale(0);opacity:0}}
@keyframes tileFall{0%{transform:translateY(-130%);opacity:.2}55%{transform:translateY(8%);opacity:1}78%{transform:translateY(-4%)}100%{transform:translateY(0);opacity:1}}
@keyframes comboRise{0%{opacity:1;transform:translateY(0) scale(1)}55%{opacity:1;transform:translateY(-35px) scale(1.3)}100%{opacity:0;transform:translateY(-65px) scale(.7)}}
@keyframes celebBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes hintPulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.6)}50%{box-shadow:0 0 0 6px rgba(251,191,36,.25);transform:scale(1.07)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
@keyframes particle{0%{opacity:1;transform:translateY(0) scale(1) rotate(0)}100%{opacity:0;transform:translateY(-70px) scale(.3) rotate(180deg)}}
@keyframes flashPulse{0%{opacity:1}100%{opacity:0}}
@keyframes cardFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes emojiWiggle{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(-6deg)}50%{transform:scale(1) rotate(0deg)}75%{transform:scale(1.15) rotate(6deg)}}
@keyframes emojiBreath{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

.particle{position:fixed;pointer-events:none;z-index:999;animation:particle 1.1s ease-out forwards}
.streak-flash{position:fixed;inset:0;background:radial-gradient(circle,rgba(251,191,36,.22) 0%,transparent 70%);pointer-events:none;z-index:50;animation:flashPulse .45s ease-out forwards}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="level-screen" class="screen active">
  <div class="ls-title" id="ls-title">üß© ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ´ŸÑÿßÿ´Ÿäÿ© ÿ™ÿπŸÑŸäŸÖŸäÿ©</div>
  <div class="ls-subtitle" id="ls-sub">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£ ÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ©!</div>
  <div class="ls-grid" id="ls-grid"></div>
  <button class="ls-free-btn" id="ls-free" onclick="showScreen('free-screen')">üé® ŸÑÿπÿ® ÿ≠ÿ±</button>
</div>

<!-- FREE PLAY -->
<div id="free-screen" class="screen">
  <div class="fp-title" id="fp-title">üé® ŸÑÿπÿ® ÿ≠ÿ±</div>
  <div class="fp-group"><div class="fp-label" id="fp-cat-lbl">ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ</div><div class="fp-row" id="fp-cats"></div></div>
  <div class="fp-group"><div class="fp-label" id="fp-size-lbl">ÿ≠ÿ¨ŸÖ ÿßŸÑÿ¥ÿ®ŸÉÿ©</div><div class="fp-row" id="fp-sizes"></div></div>
  <button class="fp-go" id="fp-go" onclick="startFreePlay()">üéÆ ÿßÿ®ÿØÿ£!</button>
  <button class="fp-back" onclick="showScreen('level-screen')">‚¨Ö ÿ±ÿ¨Ÿàÿπ</button>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="g-header">
    <div class="g-title-area">
      <span class="g-title-text" id="g-title">Match 3</span>
      <span class="g-level-badge" id="g-badge">1</span>
    </div>
    <div class="g-stats">
      <div class="g-stat"><div class="g-stat-val" id="g-score">0</div><div class="g-stat-lbl" id="g-score-l">ÿßŸÑŸÜŸÇÿßÿ∑</div></div>
      <div class="g-stat"><div class="g-stat-val" id="g-moves">0</div><div class="g-stat-lbl" id="g-moves-l">ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™</div></div>
      <div class="g-stat"><div class="g-stat-val" id="g-time">0:00</div><div class="g-stat-lbl" id="g-time-l">ÿßŸÑŸàŸÇÿ™</div></div>
    </div>
  </div>
  <div class="board-wrap"><div class="board" id="board"></div></div>
  <div class="mv-bar"><div class="mv-track"><div class="mv-fill" id="mv-fill"></div></div><div class="mv-text" id="mv-text"></div></div>
  <div class="g-footer">
    <button class="f-btn hint" id="hint-btn" onclick="useHint()">üí° ÿ™ŸÑŸÖŸäÿ≠</button>
    <button class="f-btn" onclick="shuffleBoard()">üîÄ ÿÆŸÑÿ∑</button>
    <button class="f-btn" onclick="showScreen('level-screen')">üè† ÿ±ÿ¨Ÿàÿπ</button>
  </div>
</div>

<!-- COMPLETE -->
<div id="complete-screen" class="screen">
  <div class="c-emoji" id="c-emoji">üéâ</div>
  <div class="c-title" id="c-title">ÿ£ÿ≠ÿ≥ŸÜÿ™!</div>
  <div class="c-stars-row" id="c-stars"></div>
  <div class="c-sub" id="c-sub"></div>
  <div class="c-stats" id="c-stats-area">
    <div class="c-stat"><div class="c-stat-emoji">üèÜ</div><div class="c-stat-val" id="c-score">0</div><div class="c-stat-lbl" id="c-sc-l">ÿßŸÑŸÜŸÇÿßÿ∑</div></div>
    <div class="c-stat"><div class="c-stat-emoji">üéØ</div><div class="c-stat-val" id="c-matches">0</div><div class="c-stat-lbl" id="c-mt-l">ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿßÿ™</div></div>
    <div class="c-stat"><div class="c-stat-emoji">‚è±Ô∏è</div><div class="c-stat-val" id="c-time">0:00</div><div class="c-stat-lbl" id="c-tm-l">ÿßŸÑŸàŸÇÿ™</div></div>
    <div class="c-stat"><div class="c-stat-emoji">üî•</div><div class="c-stat-val" id="c-combo">0</div><div class="c-stat-lbl" id="c-cb-l">ŸÉŸàŸÖÿ®Ÿà</div></div>
  </div>
  <div class="c-btns">
    <button class="c-btn primary" id="c-next" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="c-btn share" id="c-share" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="c-btn secondary" id="c-again" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="c-btn secondary" onclick="showScreen('level-screen')">üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™</button>
  </div>
</div>

<script>
// =========================================================================
//  i18n
// =========================================================================
const LANG = new URLSearchParams(location.search).get('lang') || 'ar';
document.documentElement.lang = LANG;
document.documentElement.dir = LANG === 'ar' ? 'rtl' : 'ltr';
const DIR = document.documentElement.dir;

const I = {
ar:{
  title:'üß© ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ´ŸÑÿßÿ´Ÿäÿ© ÿ™ÿπŸÑŸäŸÖŸäÿ©',sub:'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£ ÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ©!',free:'üé® ŸÑÿπÿ® ÿ≠ÿ±',
  freeTtl:'üé® ŸÑÿπÿ® ÿ≠ÿ±',catLbl:'ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ',sizeLbl:'ÿ≠ÿ¨ŸÖ ÿßŸÑÿ¥ÿ®ŸÉÿ©',go:'üéÆ ÿßÿ®ÿØÿ£!',back:'‚¨Ö ÿ±ÿ¨Ÿàÿπ',
  score:'ÿßŸÑŸÜŸÇÿßÿ∑',moves:'ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™',time:'ÿßŸÑŸàŸÇÿ™',movesLeft:'ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©',
  hint:'üí° ÿ™ŸÑŸÖŸäÿ≠',shuffle:'üîÄ ÿÆŸÑÿ∑',home:'üè† ÿ±ÿ¨Ÿàÿπ',
  next:'‚û°Ô∏è ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä',share:'üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©',again:'üîÑ ÿ•ÿπÿßÿØÿ©',levels:'üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™',
  combo:'ŸÉŸàŸÖÿ®Ÿà',matches:'ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿßÿ™',
  excellent:'üåü ŸÖŸÖÿ™ÿßÿ≤!',great:'üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™!',good:'üëç ÿ¨ŸäÿØ!',tryMore:'üí™ ÿ≠ÿßŸàŸÑ ÿ£ŸÉÿ´ÿ±!',
  completeSub:'ŸÑŸÇÿØ ÿ£ÿ™ŸÖŸÖÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠!',noReach:'ÿ≠ÿßŸàŸÑ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸáÿØŸÅ ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©!',
  noMoves:'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿ±ŸÉÿßÿ™!',noMovesSub:'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ÿ∑ÿßÿ®ŸÇÿßÿ™. ÿßÿÆŸÑÿ∑ ÿßŸÑŸÑŸàÿ≠!',shuffleBtn:'ÿßÿÆŸÑÿ∑',
  shareText:'ÿ≠ŸÇŸÇÿ™ {score} ŸÜŸÇÿ∑ÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ {level} ŸÖŸÜ ŸÑÿπÿ®ÿ© ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ´ŸÑÿßÿ´Ÿäÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖŸäÿ©! ‚≠ê{stars}',
  shareTitle:'ŸÜÿ™Ÿäÿ¨ÿ™Ÿä ŸÅŸä ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ´ŸÑÿßÿ´Ÿäÿ©',
  combo2:'ŸÖÿ≤ÿØŸàÿ¨! √ó2',combo3:'ÿ´ŸÑÿßÿ´Ÿä! √ó3',combo4:'ÿ±ÿ®ÿßÿπŸä! √ó4',combo5:'ÿÆÿßÿ±ŸÇ! √ó5',
  lvNames:['ŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™','ÿ≥ŸÑÿ© ÿßŸÑŸÅŸàÿßŸÉŸá','ÿπÿßŸÑŸÖ ÿßŸÑÿ®ÿ≠ÿßÿ±','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑÿ≠ÿ¥ÿ±ÿßÿ™','ÿ≥ŸÖÿßÿ° Ÿàÿ∑ŸÇÿ≥','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑŸàÿ±ÿØ','ŸàÿßÿØŸä ÿßŸÑÿÆÿ∂ÿßÿ±','ŸÖÿ∑ÿ®ÿÆ ŸÑÿ∞Ÿäÿ∞','ÿπÿßŸÑŸÖ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™','ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑŸÅÿ∂ÿßÿ°','ŸÖŸÑÿπÿ® ÿßŸÑÿ±Ÿäÿßÿ∂ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ','ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ŸÅÿßÿ±Ÿä','ÿπÿßŸÑŸÖ ÿßŸÑÿ∑ŸäŸàÿ±','Ÿàÿ±ÿ¥ÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™','ÿπÿßŸÑŸÖ ÿßŸÑÿ£ÿ≤Ÿäÿßÿ°','ŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖÿ®ÿßŸÜŸä','ŸäŸàŸÖ ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑÿ™ŸÇŸÜŸäÿ©','üåç ÿ®ÿ∑ŸÑ ÿßŸÑÿπÿßŸÑŸÖ'],
  catNames:{farm:'üêÑ ÿ≠ŸäŸàÿßŸÜÿßÿ™',fruit:'üçé ŸÅŸàÿßŸÉŸá',sea:'üê† ÿ®ÿ≠ÿ±',bug:'ü¶ã ÿ≠ÿ¥ÿ±ÿßÿ™',weather:'üå§ ÿ∑ŸÇÿ≥',flower:'üå∏ ÿ≤ŸáŸàÿ±',veggie:'ü•ï ÿÆÿ∂ÿßÿ±',food:'üçï ÿ∑ÿπÿßŸÖ',vehicle:'üöó ŸÖÿ±ŸÉÿ®ÿßÿ™',space:'üöÄ ŸÅÿ∂ÿßÿ°',sport:'‚öΩ ÿ±Ÿäÿßÿ∂ÿ©',music:'üéµ ŸÖŸàÿ≥ŸäŸÇŸâ',wild:'ü¶Å ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ®ÿ±Ÿäÿ©',bird:'ü¶Ö ÿ∑ŸäŸàÿ±',tool:'üî® ÿ£ÿØŸàÿßÿ™',fashion:'üëó ÿ£ÿ≤Ÿäÿßÿ°',building:'üè† ŸÖÿ®ÿßŸÜŸä',school:'üìö ŸÖÿØÿ±ÿ≥ÿ©',tech:'üíª ÿ™ŸÇŸÜŸäÿ©',mix:'üåç ŸÉŸÑ ÿ¥Ÿäÿ°'},
  locked:'üîí'
},
en:{
  title:'üß© Educational Match 3',sub:'Choose a level to start the adventure!',free:'üé® Free Play',
  freeTtl:'üé® Free Play',catLbl:'Content Type',sizeLbl:'Grid Size',go:'üéÆ Start!',back:'‚¨Ö Back',
  score:'Score',moves:'Moves',time:'Time',movesLeft:'Moves Left',
  hint:'üí° Hint',shuffle:'üîÄ Shuffle',home:'üè† Back',
  next:'‚û°Ô∏è Next Level',share:'üì§ Share',again:'üîÑ Replay',levels:'üè† Levels',
  combo:'Combo',matches:'Matches',
  excellent:'üåü Excellent!',great:'üéâ Great Job!',good:'üëç Good!',tryMore:'üí™ Try More!',
  completeSub:'You completed the level!',noReach:'Try to reach the target next time!',
  noMoves:'No Moves!',noMovesSub:'No matches possible. Shuffle!',shuffleBtn:'Shuffle',
  shareText:'I scored {score} points on Level {level} in Educational Match 3! ‚≠ê{stars}',
  shareTitle:'My Match 3 Result',
  combo2:'Double! √ó2',combo3:'Triple! √ó3',combo4:'Quad! √ó4',combo5:'Super! √ó5',
  lvNames:['Farm Friends','Fruit Basket','Ocean World','Bug Garden','Sky Watch','Flower Garden','Veggie Valley','Yummy Kitchen','On the Move','Space Quest','Sports Arena','Music Studio','Wild Safari','Bird Paradise','Tool Workshop','Fashion Show','City Builder','School Days','Tech World','üåç World Champion'],
  catNames:{farm:'üêÑ Animals',fruit:'üçé Fruits',sea:'üê† Sea',bug:'ü¶ã Bugs',weather:'üå§ Weather',flower:'üå∏ Flowers',veggie:'ü•ï Veggies',food:'üçï Food',vehicle:'üöó Vehicles',space:'üöÄ Space',sport:'‚öΩ Sports',music:'üéµ Music',wild:'ü¶Å Wildlife',bird:'ü¶Ö Birds',tool:'üî® Tools',fashion:'üëó Fashion',building:'üè† Buildings',school:'üìö School',tech:'üíª Tech',mix:'üåç All'},
  locked:'üîí'
},
pt:{
  title:'üß© Match 3 Educativo',sub:'Escolha um n√≠vel para come√ßar!',free:'üé® Jogo Livre',
  freeTtl:'üé® Jogo Livre',catLbl:'Tipo de Conte√∫do',sizeLbl:'Tamanho da Grade',go:'üéÆ Come√ßar!',back:'‚¨Ö Voltar',
  score:'Pontos',moves:'Jogadas',time:'Tempo',movesLeft:'Jogadas Restantes',
  hint:'üí° Dica',shuffle:'üîÄ Embaralhar',home:'üè† Voltar',
  next:'‚û°Ô∏è Pr√≥ximo N√≠vel',share:'üì§ Compartilhar',again:'üîÑ Repetir',levels:'üè† N√≠veis',
  combo:'Combo',matches:'Combina√ß√µes',
  excellent:'üåü Excelente!',great:'üéâ Muito Bem!',good:'üëç Bom!',tryMore:'üí™ Tente Mais!',
  completeSub:'Voc√™ completou o n√≠vel!',noReach:'Tente alcan√ßar a meta na pr√≥xima vez!',
  noMoves:'Sem Jogadas!',noMovesSub:'Sem combina√ß√µes. Embaralhe!',shuffleBtn:'Embaralhar',
  shareText:'Fiz {score} pontos no N√≠vel {level} do Match 3 Educativo! ‚≠ê{stars}',
  shareTitle:'Meu Resultado no Match 3',
  combo2:'Duplo! √ó2',combo3:'Triplo! √ó3',combo4:'Qu√°druplo! √ó4',combo5:'Super! √ó5',
  lvNames:['Amigos da Fazenda','Cesta de Frutas','Mundo do Mar','Jardim de Insetos','C√©u e Clima','Jardim de Flores','Vale dos Vegetais','Cozinha Gostosa','Em Movimento','Miss√£o Espacial','Arena Esportiva','Est√∫dio Musical','Safari Selvagem','Para√≠so dos P√°ssaros','Oficina de Ferramentas','Desfile de Moda','Construtor de Cidades','Dia Escolar','Mundo Tech','üåç Campe√£o Mundial'],
  catNames:{farm:'üêÑ Animais',fruit:'üçé Frutas',sea:'üê† Mar',bug:'ü¶ã Insetos',weather:'üå§ Clima',flower:'üå∏ Flores',veggie:'ü•ï Vegetais',food:'üçï Comida',vehicle:'üöó Ve√≠culos',space:'üöÄ Espa√ßo',sport:'‚öΩ Esportes',music:'üéµ M√∫sica',wild:'ü¶Å Selvagens',bird:'ü¶Ö P√°ssaros',tool:'üî® Ferramentas',fashion:'üëó Moda',building:'üè† Edif√≠cios',school:'üìö Escola',tech:'üíª Tech',mix:'üåç Tudo'},
  locked:'üîí'
}};
const t = I[LANG] || I.en;

// =========================================================================
//  1000+ EDUCATIONAL SYMBOLS ‚Äî Real-world objects children can learn from
// =========================================================================
const POOL = {
farm: ['üêÑ','üê∑','üêë','üêê','üê¥','üêî','üêì','ü¶É','üê§','üê£','ü¶Ü','üêï','üêà','üê∞','üêá','üêπ','üê≠','üêø','ü¶î','üê∂','üê±','üêÆ','üêñ','üêó','üêΩ','üêè','üê™','üê´','ü¶ô','üêé','üê•','üïä','üê©','üêæ','ü¶ù','ü¶°','ü¶®','ü¶•','ü¶¶','üêª','üê®','üêº','ü¶ä','üê∫','ü¶´','üêÇ','üêÉ','ü¶Ñ','üêÅ','üêÄ'],
fruit: ['üçé','üçè','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçë','üçí','ü•ù','ü••','üçç','ü•≠','üçÖ','ü•ë','ü´ê','ü´í','ü•ï','üçÜ','üå∂','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•ú','üå∞','üçÑ','üç†','ü•¶','ü•ó','ü•£','ü´ô','ü•´','ü•î','ü´ë','üßÜ','ü•ô','ü´ì','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üßà','üçã‚Äçüü©'],
sea: ['üêü','üê†','üê°','ü¶à','üê¨','üê≥','üêã','ü¶≠','üêô','ü¶ë','ü¶ê','ü¶Ä','ü¶û','üêö','ü™∏','ü™º','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','ü¶à','üê¨','üêô','ü¶ë','üê†','üêü','üê°','ü¶ê','ü¶Ä','ü¶û','üêö','üê¢','üêä','üêç','üê∏','ü¶é','ü™∏','ü™º','ü¶≠','üêâ','üê≤','ü¶ï','ü¶ñ'],
bug: ['ü¶ã','üêõ','üêù','üêû','ü¶ó','üï∑','ü¶Ç','üêú','ü™≤','ü™≥','ü¶ü','ü™∞','üêå','ü™±','ü¶ã','üêõ','üêù','üêû','ü¶ó','üï∑','üêú','ü™≤','üêå','ü™±','ü¶Ç','ü™≥','ü¶ü','ü™∞','üåø','üçÄ','üçÅ','üçÇ','üçÉ','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','ü™¥','üéã','üéç','üçÑ','üåª','üå∏','üåπ','üå∫','üåº','üå∑','üíê'],
weather: ['‚òÄÔ∏è','üå§','‚õÖ','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨','üí®','üåä','üåà','üå™','üå´','üíß','üí¶','üå°','üî•','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','üåô','üåõ','üåú','üåö','üåù','üåû','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üåå','üå†'],
flower: ['üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥','üéã','üéç','ü™π','ü™∫','üçÑ','üåø','üéÑ','üéã','üíÆ','üèµ','üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ'],
veggie: ['ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','ü•ô','üå±','ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','üåø','üçÄ','üåæ','üåª','üåº','ü™¥','üßÇ','ü´ô','ü•´','üßà'],
food: ['üçï','üçî','üåÆ','üåØ','ü•ö','üç≥','ü•ò','üç≤','üçø','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üç©','üç™','üçØ','ü•ê','ü•ñ','üßá','ü•û','üßà','ü´ï','ü´î','ü•£','ü´ó','üçø','üç±','üßÜ','ü•ô','ü´ì'],
vehicle: ['üöó','üöï','üöô','üöå','üöé','üèé','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèç','üõµ','üö≤','üõ¥','üõπ','üõº','üöÅ','üõ∏','üöÄ','üõ©','‚úàÔ∏è','üõ´','üõ¨','üö¢','‚õµ','üõ∂','üö§','üõ•','üõ≥','‚õ¥','üöÇ','üöÉ','üöÑ','üöÖ','üöÜ','üöá','üöà','üöâ','üöä','üöù','üöû','üöã','üö†','üö°','üõ∞','üöè'],
space: ['üåç','üåé','üåè','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','üåù','üåû','‚òÄÔ∏è','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','ü™ê','üî≠','üî¨','üß≤','üß™','üß´','üß¨','üí°','üî¶','üïØ','ü™î','üîã','‚ö°','üõ∏','üöÄ','üõ∞','üì°','üåå','üå†','üéÜ','üéá','üí•','üî•','üíß','üåä','üåÄ','üåà'],
sport: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','üèí','ü•ç','üèè','ü•Ö','‚õ≥','ü™Å','üèπ','üéØ','ü•ä','ü•ã','üéø','‚õ∑','üèÇ','üèãÔ∏è','ü§∏','ü§∫','ü§æ','üèåÔ∏è','üèá','üßò','üßó','ü§ø','üèÑ','üèä','üö£','üéΩ','üèÖ','ü•á','ü•à','ü•â','üèÜ','üéñ','üé™','üé†','üé°','üé¢','üõù','‚õ∫'],
music: ['üéµ','üé∂','üéº','üéπ','üé∏','üé∫','üéª','ü•Å','ü™ò','ü™ó','üé∑','üé§','üéß','üìØ','ü™à','üé¨','üé≠','üé®','üñå','üñç','‚úèÔ∏è','üñä','üñã','üìù','üé™','üé†','üé≤','üéØ','üé≥','üé∞','üéÆ','üïπ','üì∫','üìª','üì∏','üé•','üìπ','üìΩ','üéû','üéü','üíø','üìÄ','üíΩ','üì±','üñ•','‚å®Ô∏è','üñ±','üñ®','üì¢','üì£'],
wild: ['ü¶Å','üêØ','üêÖ','üêÜ','ü¶í','ü¶ì','üêò','ü¶õ','ü¶è','üêª','ü¶ä','üê∫','ü¶å','ü¶¨','ü¶£','ü¶ß','ü¶ç','üêí','üêµ','üôà','üôâ','üôä','ü¶ò','ü¶•','ü¶®','ü¶°','ü¶ù','ü¶¶','üêª‚Äç‚ùÑÔ∏è','üêº','üê®','üêæ','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','ü¶ã','üêù','üêû','ü¶Ö','ü¶â','üêß','ü¶ú','ü¶ö','ü¶©'],
bird: ['ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü¶§','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶§','ü™π','ü™∫','ü•ö','üêæ','üåø','üçÄ','üå≤','üå≥','‚òÅÔ∏è','üå§','‚õÖ','üåà','üåÖ','üèî'],
tool: ['üî®','ü™ì','‚õè','üîß','ü™õ','üî©','‚öôÔ∏è','üóú','ü™ö','üìè','üìê','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üîë','üóù','üîí','üîì','ü™§','üß≤','ü™ù','üß∞','ü™ú','ü™£','üßπ','üß∫','üßª','ü™†','üßº','üßΩ','ü™•','ü™í','üîã','üîå','üí°','üî¶','üïØ','ü™î','üßØ','ü™§','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üìé','üñá','üóë'],
fashion: ['üëï','üëñ','üß£','üß§','üß•','üß¶','üëó','üëò','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üéí','ü©¥','üëû','üëü','ü•æ','ü•ø','üë†','üë°','ü©∞','üë¢','üëë','üëí','üé©','ü™ñ','‚õëÔ∏è','üíÑ','üíç','üíé','üëì','üï∂','ü•Ω','üìø','üß¢','üëï','üëñ','üß£','üß•','üëó','üëò','üéí','üëü','ü•æ','üë†'],
building: ['üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üïå','üïç','‚õ™','üïã','üõï','‚õ©','üèó','üèö','üóº','üóΩ','üóæ','üéë','‚õ≤','‚õ∫','üèõ','üèü','üó∫','üèñ','üèú','üèù','üèû','üèî','‚õ∞','üåã','üåÅ','üåâ','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üóª','üé™','üé°'],
school: ['üìö','üìñ','üìù','üìí','üìì','üìî','üìï','üìó','üìò','üìô','üìÑ','üìÉ','üìã','üìé','üìè','üìê','‚úÇÔ∏è','‚úèÔ∏è','üñä','üñã','üñç','üîó','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üóÑ','üóë','üì∞','üóû','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üîñ','üìÆ','üì¨','üì≠','üì™','üì´','‚úâÔ∏è','üì©','üì®','üìß','üíå'],
tech: ['üíª','üñ•','üñ®','‚å®Ô∏è','üñ±','üíΩ','üíæ','üíø','üì±','üì≤','üì∑','üì∏','üìπ','üì∫','üìª','üì°','üîå','üîã','üí°','üìü','üì†','üïπ','üéÆ','üéß','üî¨','üî≠','üì°','üõ∞','üíª','üñ•','‚å®Ô∏è','üñ±','üì±','üì≤','üì∑','üìπ','üì∫','üìª','üîå','üîã','üí°','üïπ','üéÆ','üéß','üî¨','üî≠','üõ∞','üì°','‚åö','ü§ñ'],
mix: ['üêÑ','üçé','üêü','ü¶ã','‚òÄÔ∏è','üå∏','ü•ï','üçï','üöó','üåç','‚öΩ','üéµ','ü¶Å','ü¶Ö','üî®','üëï','üè†','üìö','üíª','üéâ','üê∑','üçä','üê¨','üêù','üåà','üåπ','üåΩ','üçî','üöå','ü™ê','üèÄ','üé∏','üêØ','ü¶â','üîß','üëó','üè´','üìñ','üì±','üéä','üê¥','üçá','üêô','üêû','‚≠ê','üåª','üçÜ','üç∞','‚úàÔ∏è','üöÄ']
};

// =========================================================================
//  LEVEL CONFIGURATION ‚Äî 20 unique levels
// =========================================================================
const THEMES = [
  {bg:'linear-gradient(135deg,#86efac,#22c55e)',accent:'#16a34a',text:'#14532d',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#fca5a5,#ef4444)',accent:'#b91c1c',text:'#7f1d1d',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#67e8f9,#0891b2)',accent:'#0e7490',text:'#164e63',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#a3e635,#65a30d)',accent:'#4d7c0f',text:'#365314',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#93c5fd,#3b82f6)',accent:'#1d4ed8',text:'#1e3a5f',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#f9a8d4,#ec4899)',accent:'#be185d',text:'#831843',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#86efac,#16a34a)',accent:'#15803d',text:'#14532d',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#fdba74,#ea580c)',accent:'#c2410c',text:'#7c2d12',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#cbd5e1,#475569)',accent:'#334155',text:'#1e293b',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#c4b5fd,#7c3aed)',accent:'#6d28d9',text:'#4c1d95',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#6ee7b7,#059669)',accent:'#047857',text:'#064e3b',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#d8b4fe,#9333ea)',accent:'#7e22ce',text:'#581c87',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#fde68a,#d97706)',accent:'#b45309',text:'#78350f',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#7dd3fc,#0284c7)',accent:'#0369a1',text:'#0c4a6e',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#fb923c,#c2410c)',accent:'#9a3412',text:'#7c2d12',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#f0abfc,#a855f7)',accent:'#9333ea',text:'#581c87',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#a8a29e,#57534e)',accent:'#44403c',text:'#292524',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#60a5fa,#2563eb)',accent:'#1d4ed8',text:'#1e3a5f',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#22d3ee,#0e7490)',accent:'#0891b2',text:'#164e63',tile:'rgba(255,255,255,.88)'},
  {bg:'linear-gradient(135deg,#fb7185,#be123c,#7c3aed)',accent:'#9f1239',text:'#4c1d95',tile:'rgba(255,255,255,.88)'},
];

const LEVELS = [
  {cat:'farm',    rows:5,cols:5,types:4,moves:30,target:100, emoji:'üêÑ'},
  {cat:'fruit',   rows:5,cols:5,types:4,moves:28,target:120, emoji:'üçé'},
  {cat:'sea',     rows:5,cols:6,types:5,moves:30,target:160, emoji:'üê†'},
  {cat:'bug',     rows:5,cols:6,types:5,moves:28,target:180, emoji:'ü¶ã'},
  {cat:'weather', rows:6,cols:6,types:5,moves:32,target:220, emoji:'üå§'},
  {cat:'flower',  rows:6,cols:6,types:5,moves:30,target:260, emoji:'üå∏'},
  {cat:'veggie',  rows:6,cols:6,types:6,moves:30,target:300, emoji:'ü•ï'},
  {cat:'food',    rows:6,cols:7,types:6,moves:32,target:350, emoji:'üçï'},
  {cat:'vehicle', rows:6,cols:7,types:6,moves:30,target:400, emoji:'üöó'},
  {cat:'space',   rows:7,cols:7,types:6,moves:35,target:450, emoji:'üöÄ'},
  {cat:'sport',   rows:7,cols:7,types:6,moves:33,target:500, emoji:'‚öΩ'},
  {cat:'music',   rows:7,cols:7,types:7,moves:33,target:550, emoji:'üéµ'},
  {cat:'wild',    rows:7,cols:7,types:7,moves:35,target:600, emoji:'ü¶Å'},
  {cat:'bird',    rows:7,cols:8,types:7,moves:35,target:650, emoji:'ü¶Ö'},
  {cat:'tool',    rows:7,cols:8,types:7,moves:35,target:700, emoji:'üî®'},
  {cat:'fashion', rows:8,cols:7,types:7,moves:38,target:750, emoji:'üëó'},
  {cat:'building',rows:8,cols:8,types:7,moves:38,target:800, emoji:'üè†'},
  {cat:'school',  rows:8,cols:8,types:8,moves:38,target:850, emoji:'üìö'},
  {cat:'tech',    rows:8,cols:8,types:8,moves:40,target:900, emoji:'üíª'},
  {cat:'mix',     rows:8,cols:8,types:8,moves:45,target:1000,emoji:'üåç'},
];

// =========================================================================
//  AUDIO ‚Äî Web Audio API
// =========================================================================
let audioCtx = null;
function ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function tone(f,d,tp,v){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v||.12,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+(d||.15));o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+(d||.15))}catch(e){}}
function sfxSelect(){tone(523,.07,'sine',.1)}
function sfxSwap(){tone(440,.08,'triangle',.1);setTimeout(()=>tone(554,.08,'triangle',.1),40)}
function sfxMatch(){tone(659,.1,'sine',.13);setTimeout(()=>tone(784,.1,'sine',.13),70);setTimeout(()=>tone(988,.12,'sine',.14),140)}
function sfxCombo(n){for(let i=0;i<Math.min(n,6);i++)setTimeout(()=>tone(523+i*110,.08,'sine',.1+i*.02),i*50)}
function sfxNoMatch(){tone(220,.18,'sawtooth',.07)}
function sfxComplete(){[523,659,784,988,1175,1319].forEach((f,i)=>setTimeout(()=>tone(f,.18,'sine',.11),i*90))}
function sfxClick(){tone(880,.04,'sine',.07)}
function sfxHint(){tone(660,.12,'triangle',.09);setTimeout(()=>tone(880,.15,'triangle',.1),100)}
function sfxDrop(){tone(330,.06,'sine',.06)}
function sfxStar(){[880,1100,1320].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*120))}

// =========================================================================
//  GAME STATE
// =========================================================================
let grid=[], rows=5, cols=5, numTypes=4;
let score=0, movesLeft=30, totalMoves=30, matchCount=0, maxCombo=0, combo=0;
let selectedTile=null, isAnimating=false;
let timerInterval=null, elapsedSeconds=0, startTime=null;
let hintsLeft=3;
let currentLevel=-1; // -1 = free play
let isFreePlay=false;
let freeCat='farm', freeSize='6x6';
let levelEmoji=[]; // current active emoji set for this play

// Progress persistence
let progress = JSON.parse(localStorage.getItem('classify_match3_progress')||'{"unlocked":1,"scores":{},"stars":{}}');
function saveProgress(){localStorage.setItem('classify_match3_progress',JSON.stringify(progress))}

// =========================================================================
//  GRID LOGIC
// =========================================================================
function randomType(){return Math.floor(Math.random()*numTypes)}
function pickLevelEmoji(cat,n){
  const pool=POOL[cat]||POOL.mix;
  const shuffled=[...pool].sort(()=>Math.random()-.5);
  // Deduplicate
  const unique=[...new Set(shuffled)];
  return unique.slice(0,Math.max(n,4));
}

function createGrid(){
  grid=[];
  for(let r=0;r<rows;r++){
    grid[r]=[];
    for(let c=0;c<cols;c++){
      let type;
      do{type=randomType()}while(wouldMatch(r,c,type));
      grid[r][c]=type;
    }
  }
  if(!hasValidMoves()){createGrid()}
}

function wouldMatch(r,c,type){
  if(c>=2 && grid[r][c-1]===type && grid[r][c-2]===type) return true;
  if(r>=2 && grid[r-1] && grid[r-1][c]===type && grid[r-2] && grid[r-2][c]===type) return true;
  return false;
}

function findMatches(){
  const m=new Set();
  for(let r=0;r<rows;r++){
    for(let c=0;c<=cols-3;c++){
      if(grid[r][c]!==-1&&grid[r][c]===grid[r][c+1]&&grid[r][c]===grid[r][c+2]){
        let e=c+2;while(e+1<cols&&grid[r][e+1]===grid[r][c])e++;
        for(let i=c;i<=e;i++)m.add(r+','+i);
      }
    }
  }
  for(let c=0;c<cols;c++){
    for(let r=0;r<=rows-3;r++){
      if(grid[r][c]!==-1&&grid[r][c]===grid[r+1][c]&&grid[r][c]===grid[r+2][c]){
        let e=r+2;while(e+1<rows&&grid[e+1][c]===grid[r][c])e++;
        for(let i=r;i<=e;i++)m.add(i+','+c);
      }
    }
  }
  return[...m].map(s=>{const[r,c]=s.split(',').map(Number);return{r,c}});
}

function hasValidMoves(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(c+1<cols){swap(r,c,r,c+1);if(findMatches().length>0){swap(r,c,r,c+1);return true}swap(r,c,r,c+1)}
      if(r+1<rows){swap(r,c,r+1,c);if(findMatches().length>0){swap(r,c,r+1,c);return true}swap(r,c,r+1,c)}
    }
  }
  return false;
}

function findHintMove(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(c+1<cols){swap(r,c,r,c+1);if(findMatches().length>0){swap(r,c,r,c+1);return[{r,c},{r,c:c+1}]}swap(r,c,r,c+1)}
      if(r+1<rows){swap(r,c,r+1,c);if(findMatches().length>0){swap(r,c,r+1,c);return[{r,c},{r:r+1,c}]}swap(r,c,r+1,c)}
    }
  }
  return null;
}

function swap(r1,c1,r2,c2){const tmp=grid[r1][c1];grid[r1][c1]=grid[r2][c2];grid[r2][c2]=tmp}

function removeMatches(matches){matches.forEach(m=>{grid[m.r][m.c]=-1})}

function dropTiles(){
  for(let c=0;c<cols;c++){
    let wp=rows-1;
    for(let r=rows-1;r>=0;r--){if(grid[r][c]!==-1){if(r!==wp){grid[wp][c]=grid[r][c];grid[r][c]=-1}wp--}}
    for(let r=wp;r>=0;r--){grid[r][c]=randomType()}
  }
}

// =========================================================================
//  RENDERING
// =========================================================================
function getTileSize(){
  const bw=document.querySelector('.board-wrap');
  if(!bw) return 44;
  const maxW=bw.clientWidth-8, maxH=bw.clientHeight-8;
  const gap=Math.max(2,Math.min(4,maxW*.006));
  const sW=(maxW-gap*(cols-1))/cols, sH=(maxH-gap*(rows-1))/rows;
  return Math.floor(Math.min(sW,sH,64));
}

function renderBoard(anim){
  const boardEl=document.getElementById('board');
  const sz=getTileSize();
  const gap=Math.max(2,Math.min(4,sz*.06));
  boardEl.style.gridTemplateColumns=`repeat(${cols},${sz}px)`;
  boardEl.style.gridTemplateRows=`repeat(${rows},${sz}px)`;
  boardEl.style.gap=gap+'px';
  boardEl.innerHTML='';
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const el=document.createElement('div');
      el.className='tile'+(anim?' falling':'');
      el.dataset.r=r;el.dataset.c=c;
      el.style.width=sz+'px';el.style.height=sz+'px';
      el.style.background='var(--tile-bg)';
      const type=grid[r][c];
      el.innerHTML='<span class="te">'+levelEmoji[type]+'</span>';
      el.addEventListener('pointerdown',onPointerDown);
      boardEl.appendChild(el);
    }
  }
}

function getTile(r,c){return document.querySelector(`.tile[data-r="${r}"][data-c="${c}"]`)}
function updateTileContent(r,c){
  const el=getTile(r,c);
  if(!el)return;
  el.innerHTML='<span class="te">'+levelEmoji[grid[r][c]]+'</span>';
  el.className='tile';
}

// =========================================================================
//  DRAG & SWAP SYSTEM
// =========================================================================
let dragTile=null, dragStartX=0, dragStartY=0, dragMoved=false;
let dragTargetTile=null, dragAxis=null;

function onPointerDown(e){
  if(isAnimating)return;
  e.preventDefault();
  const el=e.currentTarget;
  const r=+el.dataset.r, c=+el.dataset.c;
  dragTile={r,c,el};
  dragStartX=e.clientX;
  dragStartY=e.clientY;
  dragMoved=false;
  dragAxis=null;
  dragTargetTile=null;
  el.classList.add('selected');
  el.setPointerCapture(e.pointerId);
  el.addEventListener('pointermove',onPointerMove);
  el.addEventListener('pointerup',onPointerUp);
  el.addEventListener('pointercancel',onPointerUp);
}

function onPointerMove(e){
  if(!dragTile)return;
  const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<8)return;
  dragMoved=true;
  const sz=getTileSize()+Math.max(2,Math.min(4,getTileSize()*.06));
  
  // Determine dominant axis
  if(!dragAxis){dragAxis=Math.abs(dx)>Math.abs(dy)?'x':'y'}
  
  // Clamp movement to one tile
  let mx=0,my=0;
  if(dragAxis==='x'){
    mx=Math.max(-sz,Math.min(sz,dx));
    // Account for RTL direction
    const effDx=DIR==='rtl'?-mx:mx;
    const tc=dragTile.c+(effDx>0?1:-1);
    if(tc>=0&&tc<cols){
      const target=getTile(dragTile.r,tc);
      // Move dragged tile
      dragTile.el.style.transform=`translateX(${mx}px) scale(1.08)`;
      dragTile.el.style.zIndex='10';
      // Move target tile inversely
      if(target){target.style.transform=`translateX(${-mx}px)`;target.style.transition='none'}
      // Clear previous target if changed
      if(dragTargetTile&&dragTargetTile!==target){dragTargetTile.style.transform='';dragTargetTile.style.transition=''}
      dragTargetTile=target;
    }
  } else {
    my=Math.max(-sz,Math.min(sz,dy));
    const tr=dragTile.r+(my>0?1:-1);
    if(tr>=0&&tr<rows){
      const target=getTile(tr,dragTile.c);
      dragTile.el.style.transform=`translateY(${my}px) scale(1.08)`;
      dragTile.el.style.zIndex='10';
      if(target){target.style.transform=`translateY(${-my}px)`;target.style.transition='none'}
      if(dragTargetTile&&dragTargetTile!==target){dragTargetTile.style.transform='';dragTargetTile.style.transition=''}
      dragTargetTile=target;
    }
  }
}

function onPointerUp(e){
  if(!dragTile)return;
  const el=dragTile.el;
  el.removeEventListener('pointermove',onPointerMove);
  el.removeEventListener('pointerup',onPointerUp);
  el.removeEventListener('pointercancel',onPointerUp);
  
  // Reset visual transforms
  el.classList.remove('selected');
  el.style.transform='';el.style.zIndex='';el.style.transition='';
  if(dragTargetTile){dragTargetTile.style.transform='';dragTargetTile.style.transition=''}
  
  const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
  const sz=getTileSize();
  
  if(dragMoved && Math.sqrt(dx*dx+dy*dy)>sz*0.35){
    // Swipe detected ‚Äî determine target
    let tr=dragTile.r, tc=dragTile.c;
    if(dragAxis==='x'){
      const effDx=DIR==='rtl'?-dx:dx;
      tc+=effDx>0?1:-1;
    } else {
      tr+=dy>0?1:-1;
    }
    if(tr>=0&&tr<rows&&tc>=0&&tc<cols){
      sfxSwap();
      trySwap(dragTile.r,dragTile.c,tr,tc);
    }
  } else if(!dragMoved){
    // Tap selection
    if(selectedTile){
      const sr=selectedTile.r,sc=selectedTile.c;
      const dr=Math.abs(sr-dragTile.r),dc=Math.abs(sc-dragTile.c);
      deselectAll();
      if(sr===dragTile.r&&sc===dragTile.c){
        selectedTile=null;
      } else if((dr===1&&dc===0)||(dr===0&&dc===1)){
        sfxSwap();
        trySwap(sr,sc,dragTile.r,dragTile.c);
        selectedTile=null;
      } else {
        el.classList.add('selected');
        selectedTile={r:dragTile.r,c:dragTile.c};
        sfxSelect();
      }
    } else {
      el.classList.add('selected');
      selectedTile={r:dragTile.r,c:dragTile.c};
      sfxSelect();
    }
  } else {
    // Drag was too short, snap back
    deselectAll();
  }
  
  dragTile=null;dragTargetTile=null;dragAxis=null;
}

function deselectAll(){document.querySelectorAll('.tile.selected').forEach(t=>t.classList.remove('selected'))}

// =========================================================================
//  SWAP & CASCADE
// =========================================================================
async function trySwap(r1,c1,r2,c2){
  if(isAnimating)return;
  isAnimating=true;
  deselectAll();
  
  // Animate the swap visually
  const t1=getTile(r1,c1), t2=getTile(r2,c2);
  if(t1&&t2){
    const rect1=t1.getBoundingClientRect(), rect2=t2.getBoundingClientRect();
    const dx2=rect2.left-rect1.left, dy2=rect2.top-rect1.top;
    t1.style.transition='transform .22s ease';t2.style.transition='transform .22s ease';
    t1.style.transform=`translate(${dx2}px,${dy2}px)`;t1.style.zIndex='5';
    t2.style.transform=`translate(${-dx2}px,${-dy2}px)`;
    await delay(240);
    t1.style.transition='none';t2.style.transition='none';
    t1.style.transform='';t2.style.transform='';t1.style.zIndex='';
  }
  
  swap(r1,c1,r2,c2);
  // Update tile content immediately after data swap
  updateTileContent(r1,c1);updateTileContent(r2,c2);
  
  const matches=findMatches();
  if(matches.length===0){
    // Invalid swap ‚Äî reverse
    swap(r1,c1,r2,c2);
    updateTileContent(r1,c1);updateTileContent(r2,c2);
    sfxNoMatch();
    if(t1)t1.style.animation='shake .3s ease';
    if(t2)t2.style.animation='shake .3s ease';
    await delay(350);
    if(t1)t1.style.animation='';if(t2)t2.style.animation='';
    isAnimating=false;return;
  }
  
  // Valid swap
  movesLeft--;
  updateUI();
  if(!startTime){startTime=Date.now();timerInterval=setInterval(updateTimer,1000)}
  combo=0;
  await processCascade();
  checkGameState();
  isAnimating=false;
}

async function processCascade(){
  let matches=findMatches();
  while(matches.length>0){
    combo++;
    if(combo>maxCombo)maxCombo=combo;
    const lvl=currentLevel>=0?currentLevel:0;
    const mul=Math.max(5,(lvl+1)*5);
    const pts=matches.length*mul*combo;
    score+=pts;
    matchCount++;
    updateUI();
    
    // Animate matching tiles
    matches.forEach(m=>{const el=getTile(m.r,m.c);if(el)el.classList.add('matching')});
    sfxMatch();
    if(combo>=2){sfxCombo(combo);showCombo(combo,pts)}
    spawnParticles(matches);
    await delay(420);
    
    removeMatches(matches);
    dropTiles();
    renderBoard(true);
    sfxDrop();
    await delay(360);
    matches=findMatches();
  }
}

function checkGameState(){
  const cfg=currentLevel>=0?LEVELS[currentLevel]:null;
  const target=cfg?cfg.target:999999;
  if(movesLeft<=0||score>=target){
    endGame();
  } else if(!hasValidMoves()){
    showNoMoves();
  }
}

// =========================================================================
//  UI UPDATES
// =========================================================================
function updateUI(){
  document.getElementById('g-score').textContent=score;
  document.getElementById('g-moves').textContent=totalMoves-movesLeft+'/'+totalMoves;
  const cfg=currentLevel>=0?LEVELS[currentLevel]:null;
  const maxMoves=cfg?cfg.moves:totalMoves;
  const pct=Math.max(0,(movesLeft/maxMoves)*100);
  const fill=document.getElementById('mv-fill');
  fill.style.width=pct+'%';
  fill.style.background=pct<20?'linear-gradient(90deg,#ef4444,#f87171)':pct<40?'linear-gradient(90deg,#f59e0b,#fbbf24)':'linear-gradient(90deg,#10b981,#34d399)';
  document.getElementById('mv-text').textContent=t.movesLeft+': '+movesLeft;
}

function updateTimer(){
  elapsedSeconds=Math.floor((Date.now()-startTime)/1000);
  const m=Math.floor(elapsedSeconds/60),s=elapsedSeconds%60;
  document.getElementById('g-time').textContent=m+':'+s.toString().padStart(2,'0');
}

function showCombo(n,pts){
  const labels=[null,null,t.combo2,t.combo3,t.combo4,t.combo5];
  const label=labels[Math.min(n,5)]||('√ó'+n+'!');
  const pop=document.createElement('div');
  pop.className='combo-pop';pop.textContent=label+' +'+pts;
  pop.style.left='50%';pop.style.top='40%';pop.style.transform='translateX(-50%)';
  document.querySelector('.board-wrap').appendChild(pop);
  setTimeout(()=>pop.remove(),1000);
  const flash=document.createElement('div');flash.className='streak-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),500);
}

function spawnParticles(matches){
  const emojis=['‚≠ê','‚ú®','üåü','üí´','üéÜ','üíé'];
  matches.forEach((m,i)=>{
    if(i%2!==0)return;
    const el=getTile(m.r,m.c);if(!el)return;
    const rect=el.getBoundingClientRect();
    for(let p=0;p<2;p++){
      const par=document.createElement('div');par.className='particle';
      par.textContent=emojis[Math.floor(Math.random()*emojis.length)];
      par.style.left=(rect.left+rect.width*Math.random())+'px';
      par.style.top=(rect.top+rect.height*.5)+'px';
      par.style.fontSize=clamp(14,4,24)+'px';
      document.body.appendChild(par);setTimeout(()=>par.remove(),1200);
    }
  });
}

function showNoMoves(){
  const bw=document.querySelector('.board-wrap');
  const ov=document.createElement('div');ov.className='no-mv';
  ov.innerHTML=`<div class="no-mv-card"><h3>${t.noMoves}</h3><p>${t.noMovesSub}</p><button onclick="this.closest('.no-mv').remove();shuffleBoard()">${t.shuffleBtn}</button></div>`;
  bw.appendChild(ov);
}

function clamp(min,vmin,max){return Math.max(min,Math.min(max,window.innerHeight*vmin/100))}

// =========================================================================
//  GAME FLOW
// =========================================================================
function startLevel(idx){
  currentLevel=idx;isFreePlay=false;
  const cfg=LEVELS[idx];
  const theme=THEMES[idx];
  rows=cfg.rows;cols=cfg.cols;numTypes=cfg.types;
  movesLeft=cfg.moves;totalMoves=cfg.moves;
  levelEmoji=pickLevelEmoji(cfg.cat,cfg.types);
  
  applyTheme(theme);
  document.getElementById('g-title').textContent=t.lvNames[idx];
  document.getElementById('g-badge').textContent=(idx+1)+'';
  resetGameState();
  createGrid();
  showScreen('game-screen');
  renderBoard(true);
}

function startFreePlay(){
  sfxClick();
  isFreePlay=true;currentLevel=-1;
  const[r,c]=freeSize.split('x').map(Number);
  rows=r;cols=c;numTypes=Math.min(8,Math.max(4,Math.floor(r*c/6)));
  movesLeft=Math.floor(r*c*1.2);totalMoves=movesLeft;
  levelEmoji=pickLevelEmoji(freeCat,numTypes);
  
  const catKeys=Object.keys(POOL);
  const catIdx=catKeys.indexOf(freeCat);
  applyTheme(THEMES[catIdx%THEMES.length]);
  document.getElementById('g-title').textContent=t.catNames[freeCat]||freeCat;
  document.getElementById('g-badge').textContent='‚≠ê';
  resetGameState();
  createGrid();
  showScreen('game-screen');
  renderBoard(true);
}

function resetGameState(){
  score=0;matchCount=0;maxCombo=0;combo=0;
  selectedTile=null;isAnimating=false;
  elapsedSeconds=0;startTime=null;hintsLeft=3;
  clearInterval(timerInterval);
  document.getElementById('g-score').textContent='0';
  document.getElementById('g-moves').textContent='0/'+totalMoves;
  document.getElementById('g-time').textContent='0:00';
  document.getElementById('hint-btn').textContent=t.hint+' (3)';
  updateUI();
}

function applyTheme(theme){
  const gs=document.getElementById('game-screen');
  gs.style.background=theme.bg;
  gs.style.setProperty('--accent',theme.accent);
  gs.style.setProperty('--text',theme.text);
  gs.style.setProperty('--tile-bg',theme.tile);
  document.getElementById('complete-screen').style.background=theme.bg;
}

function shuffleBoard(){
  sfxClick();
  let attempts=0;
  do{
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      const r2=Math.floor(Math.random()*rows),c2=Math.floor(Math.random()*cols);
      swap(r,c,r2,c2);
    }
    let m=findMatches();
    while(m.length>0){m.forEach(match=>{grid[match.r][match.c]=randomType()});m=findMatches()}
    attempts++;
  }while(!hasValidMoves()&&attempts<20);
  renderBoard(true);
}

function useHint(){
  if(isAnimating||hintsLeft<=0)return;
  sfxHint();hintsLeft--;
  const hint=findHintMove();
  if(!hint)return;
  hint.forEach(h=>{const el=getTile(h.r,h.c);if(el){el.classList.add('hint-glow');setTimeout(()=>el.classList.remove('hint-glow'),2200)}});
  document.getElementById('hint-btn').textContent=t.hint+' ('+hintsLeft+')';
}

function endGame(){
  clearInterval(timerInterval);
  const finalTime=elapsedSeconds||Math.floor((Date.now()-(startTime||Date.now()))/1000);
  const cfg=currentLevel>=0?LEVELS[currentLevel]:null;
  const target=cfg?cfg.target:score;
  
  // Star calculation
  let stars=0;
  if(score>=target)stars=1;
  if(score>=target*1.5)stars=2;
  if(score>=target*2)stars=3;
  
  // Save progress (levels mode)
  if(currentLevel>=0){
    const prev=progress.stars[currentLevel]||0;
    if(stars>prev)progress.stars[currentLevel]=stars;
    const prevScore=progress.scores[currentLevel]||0;
    if(score>prevScore)progress.scores[currentLevel]=score;
    if(stars>=1&&currentLevel+1>=progress.unlocked)progress.unlocked=currentLevel+2;
    saveProgress();
  }
  
  // Score out of 100 for postMessage
  const pctScore=Math.min(100,Math.round((score/Math.max(1,target*2))*100));
  
  // Title & emoji
  let titleText,emoji;
  if(stars>=3){titleText=t.excellent;emoji='üèÜ'}
  else if(stars>=2){titleText=t.great;emoji='üéâ'}
  else if(stars>=1){titleText=t.good;emoji='üëç'}
  else{titleText=t.tryMore;emoji='üí™'}
  
  document.getElementById('c-emoji').textContent=emoji;
  document.getElementById('c-title').textContent=titleText;
  document.getElementById('c-sub').textContent=stars>=1?t.completeSub:t.noReach;
  document.getElementById('c-score').textContent=score;
  document.getElementById('c-matches').textContent=matchCount;
  document.getElementById('c-combo').textContent=maxCombo;
  const m=Math.floor(finalTime/60),s=finalTime%60;
  document.getElementById('c-time').textContent=m+':'+s.toString().padStart(2,'0');
  
  // Render stars
  const starsRow=document.getElementById('c-stars');
  starsRow.innerHTML='';
  for(let i=0;i<3;i++){
    const sp=document.createElement('span');
    sp.textContent=i<stars?'‚≠ê':'‚òÜ';
    sp.style.opacity=i<stars?'1':'.3';
    starsRow.appendChild(sp);
  }
  if(stars>0)sfxStar();
  
  // Show/hide next button
  const nextBtn=document.getElementById('c-next');
  nextBtn.style.display=(currentLevel>=0&&currentLevel<LEVELS.length-1)?'':'none';
  
  sfxComplete();
  showScreen('complete-screen');
  
  // Celebration particles
  if(stars>=1){
    for(let i=0;i<Math.min(stars*8,24);i++){
      setTimeout(()=>{
        const emojis=['‚≠ê','‚ú®','üåü','üéâ','üèÜ','üéä','üíé','üéÜ'];
        const par=document.createElement('div');par.className='particle';
        par.textContent=emojis[Math.floor(Math.random()*emojis.length)];
        par.style.left=(Math.random()*window.innerWidth)+'px';
        par.style.top=(window.innerHeight*.65+Math.random()*80)+'px';
        par.style.fontSize='24px';
        document.body.appendChild(par);setTimeout(()=>par.remove(),1300);
      },i*70);
    }
  }
  
  // Send to parent iframe
  try{
    window.parent.postMessage({
      type:'GAME_COMPLETE',
      score:pctScore,
      total:100,
      timeElapsed:finalTime,
      moves:totalMoves-movesLeft,
      level:currentLevel>=0?currentLevel+1:0,
      stars:stars,
      category:currentLevel>=0?LEVELS[currentLevel].cat:'free',
    },'*');
  }catch(e){}
}

function nextLevel(){
  sfxClick();
  if(currentLevel>=0&&currentLevel<LEVELS.length-1){
    startLevel(currentLevel+1);
  }
}

function replayLevel(){
  sfxClick();
  if(currentLevel>=0)startLevel(currentLevel);
  else startFreePlay();
}

async function shareResult(){
  sfxClick();
  const lvl=currentLevel>=0?(currentLevel+1):0;
  const stars=currentLevel>=0?(progress.stars[currentLevel]||0):0;
  const text=t.shareText.replace('{score}',score).replace('{level}',lvl).replace('{stars}','‚≠ê'.repeat(stars));
  
  // Try native share
  try{
    if(navigator.share){
      await navigator.share({title:t.shareTitle,text:text});
    }
  }catch(e){}
  
  // Send to parent for profile sharing
  try{
    window.parent.postMessage({
      type:'SHARE_ACHIEVEMENT',
      game:'match3',
      level:lvl,
      score:score,
      stars:stars,
      category:currentLevel>=0?LEVELS[currentLevel].cat:'free',
      text:text,
    },'*');
  }catch(e){}
  
  // Visual feedback
  const btn=document.getElementById('c-share');
  const orig=btn.textContent;
  btn.textContent='‚úÖ ' + (LANG==='ar'?'ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©!':'Shared!');
  setTimeout(()=>{btn.textContent=orig},2000);
}

// =========================================================================
//  SCREEN MANAGEMENT
// =========================================================================
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='level-screen')renderLevelSelect();
  if(id==='free-screen')renderFreePlay();
}

function renderLevelSelect(){
  const grid=document.getElementById('ls-grid');
  grid.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cfg=LEVELS[i];
    const unlocked=i<progress.unlocked;
    const stars=progress.stars[i]||0;
    const isCurrent=i===progress.unlocked-1;
    
    const card=document.createElement('div');
    card.className='lv-card'+(unlocked?'':' locked')+(isCurrent?' current':'');
    
    if(unlocked){
      card.innerHTML=`
        <div class="lv-num">${i+1}</div>
        <div class="lv-emoji">${cfg.emoji}</div>
        <div class="lv-name">${t.lvNames[i]}</div>
        <div class="lv-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>`;
      card.onclick=()=>{sfxClick();startLevel(i)};
    } else {
      card.innerHTML=`
        <div class="lv-num" style="opacity:.4">${i+1}</div>
        <div class="lv-lock">${t.locked}</div>
        <div class="lv-name" style="opacity:.4">${t.lvNames[i]}</div>`;
    }
    grid.appendChild(card);
  }
}

function renderFreePlay(){
  // Category buttons
  const catRow=document.getElementById('fp-cats');
  catRow.innerHTML='';
  const cats=Object.keys(POOL);
  cats.forEach(key=>{
    const btn=document.createElement('button');
    btn.className='fp-btn'+(key===freeCat?' sel':'');
    btn.textContent=t.catNames[key]||key;
    btn.onclick=()=>{sfxClick();freeCat=key;catRow.querySelectorAll('.fp-btn').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel')};
    catRow.appendChild(btn);
  });
  
  // Size buttons
  const sizeRow=document.getElementById('fp-sizes');
  sizeRow.innerHTML='';
  ['5x5','6x6','7x7','8x8'].forEach(sz=>{
    const btn=document.createElement('button');
    btn.className='fp-btn'+(sz===freeSize?' sel':'');
    btn.textContent=sz;
    btn.onclick=()=>{sfxClick();freeSize=sz;sizeRow.querySelectorAll('.fp-btn').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel')};
    sizeRow.appendChild(btn);
  });
}

// =========================================================================
//  i18n APPLY
// =========================================================================
function applyI18n(){
  document.getElementById('ls-title').textContent=t.title;
  document.getElementById('ls-sub').textContent=t.sub;
  document.getElementById('ls-free').textContent=t.free;
  document.getElementById('fp-title').textContent=t.freeTtl;
  document.getElementById('fp-cat-lbl').textContent=t.catLbl;
  document.getElementById('fp-size-lbl').textContent=t.sizeLbl;
  document.getElementById('fp-go').textContent=t.go;
  document.getElementById('g-score-l').textContent=t.score;
  document.getElementById('g-moves-l').textContent=t.moves;
  document.getElementById('g-time-l').textContent=t.time;
  document.getElementById('c-sc-l').textContent=t.score;
  document.getElementById('c-mt-l').textContent=t.matches;
  document.getElementById('c-tm-l').textContent=t.time;
  document.getElementById('c-cb-l').textContent=t.combo;
  document.getElementById('c-next').textContent=t.next;
  document.getElementById('c-share').textContent=t.share;
  document.getElementById('c-again').textContent=t.again;
}

// =========================================================================
//  INIT
// =========================================================================
function delay(ms){return new Promise(r=>setTimeout(r,ms))}

let resizeTimer;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(()=>{
    if(document.getElementById('game-screen').classList.contains('active'))renderBoard(false);
  },150);
});

applyI18n();
renderLevelSelect();
</script>
</body>
</html>

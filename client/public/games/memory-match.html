<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© - Memory Match</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;z-index:1}
.screen.active{display:flex}

/* === DYNAMIC BACKGROUND CANVAS === */
#bg-canvas{position:absolute;inset:0;pointer-events:none;z-index:0;width:100%;height:100%}
.g-hdr,.grid-wrap,.hint,.g-foot{position:relative;z-index:1}

/* === LEVEL SELECT === */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(6px,1.5vmin,12px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.ls-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.ls-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;flex-shrink:0;font-weight:600}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.lc{position:relative;background:linear-gradient(145deg,rgba(255,255,255,.35),rgba(255,255,255,.15));border:3px solid rgba(255,255,255,.45);border-radius:clamp(14px,3vmin,22px);padding:clamp(8px,2vmin,16px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .25s;backdrop-filter:blur(6px);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08);transform-style:preserve-3d;animation:cardFloat 3s ease-in-out infinite}
.lc:nth-child(even){animation-delay:.5s}.lc:nth-child(3n){animation-delay:1s}.lc:nth-child(4n+1){animation-delay:1.5s}
.lc:hover{transform:translateY(-4px) scale(1.06);background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.25));box-shadow:0 10px 0 rgba(0,0,0,.1),0 16px 32px rgba(0,0,0,.1)}
.lc:active{transform:translateY(3px) scale(.97);box-shadow:0 2px 0 rgba(0,0,0,.15),0 3px 8px rgba(0,0,0,.08)}
.lc.locked{opacity:.5;cursor:not-allowed;animation:none}
.lc.locked:hover{transform:none;background:rgba(255,255,255,.15);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08)}
.lc.current{border-color:#fbbf24;box-shadow:0 6px 0 rgba(251,191,36,.3),0 0 18px rgba(251,191,36,.5)}
.lc-num{font-size:clamp(22px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.lc-emoji{font-size:clamp(32px,7vmin,48px);margin:3px 0;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));animation:emojiWiggle 2.5s ease-in-out infinite}
.lc:nth-child(2n) .lc-emoji{animation-delay:.3s}.lc:nth-child(3n) .lc-emoji{animation-delay:.7s}.lc:nth-child(4n) .lc-emoji{animation-delay:1.1s}.lc.locked .lc-emoji{animation:none}
.lc-name{font-size:clamp(10px,1.8vmin,14px);color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lc-stars{font-size:clamp(14px,2.8vmin,18px);margin-top:3px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(32px,7vmin,46px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}

/* Level card group color hints */
.lc[data-grp="0"]{border-left:3px solid rgba(34,197,94,.6)}
.lc[data-grp="1"]{border-left:3px solid rgba(14,165,233,.6)}
.lc[data-grp="2"]{border-left:3px solid rgba(249,115,22,.6)}
.lc[data-grp="3"]{border-left:3px solid rgba(245,158,11,.6)}
.lc[data-grp="4"]{border-left:3px solid rgba(168,85,247,.6)}

/* === GAME === */
#game-screen{flex-direction:column;align-items:center;padding:clamp(4px,1vmin,10px);gap:clamp(3px,.8vmin,6px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2));transition:background .5s;position:relative}
.g-hdr{width:100%;max-width:540px;display:flex;align-items:center;justify-content:space-between;gap:6px;flex-shrink:0}
.g-title{font-size:clamp(16px,3.2vmin,22px);font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.g-badge{font-size:clamp(12px,2.2vmin,16px);background:rgba(255,255,255,.3);color:#fff;border-radius:20px;padding:3px 10px;font-weight:800}
.g-stats{display:flex;gap:clamp(4px,1vmin,8px);align-items:center}
.g-stat{text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:2px 8px;backdrop-filter:blur(4px)}
.g-sv{font-size:clamp(18px,3.5vmin,24px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.g-sl{font-size:clamp(10px,1.8vmin,12px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.grid-wrap{flex:1;display:flex;align-items:center;justify-content:center;width:100%;min-height:0}
.grid{display:grid;gap:clamp(3px,1vmin,6px);perspective:1000px}

/* === BASE CARD STYLES === */
.card{aspect-ratio:1;border:none;background:transparent;cursor:pointer;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
.card:disabled{cursor:default}
.card-inner{position:relative;width:100%;height:100%;transition:transform .45s ease;transform-style:preserve-3d;border-radius:clamp(8px,2vmin,14px)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:clamp(8px,2vmin,14px);display:flex;align-items:center;justify-content:center}
.card-front{background:linear-gradient(145deg,var(--cf1,#6366f1),var(--cf2,#4f46e5));box-shadow:0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12);border:3px solid rgba(255,255,255,.3);transform-style:preserve-3d}
.card-front .icon{font-size:clamp(1.6rem,5.5vmin,2.6rem);filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));animation:emojiWiggle 3s ease-in-out infinite}
.card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 8px 0 rgba(0,0,0,.18),0 12px 24px rgba(0,0,0,.15);transform:scale(1.06);transition:transform .15s}
.card:not(.flipped):not(.matched):active .card-front{transform:scale(.96);box-shadow:0 2px 0 rgba(0,0,0,.2),0 3px 8px rgba(0,0,0,.1)}
.card-back{background:linear-gradient(145deg,#fff,#f1f5f9);box-shadow:0 5px 0 rgba(99,102,241,.15),0 8px 16px rgba(0,0,0,.08);transform:rotateY(180deg);border:3px solid rgba(99,102,241,.25)}
.card-back .sym{font-size:clamp(2rem,7vmin,3.2rem);filter:drop-shadow(0 1px 3px rgba(0,0,0,.15));animation:emojiBreath 2s ease-in-out infinite}
.card.matched .card-inner{transform:rotateY(180deg)}
.card.matched .card-back{background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-color:rgba(16,185,129,.3);box-shadow:0 0 16px rgba(16,185,129,.25);animation:mpop .4s ease}
@keyframes mpop{0%{transform:rotateY(180deg) scale(1)}50%{transform:rotateY(180deg) scale(1.12)}100%{transform:rotateY(180deg) scale(1)}}

/* ===== GROUP 0: NATURE (Levels 1-4) ‚Äî Soft Rounded, Gentle ===== */
[data-group="0"] .card-inner,
[data-group="0"] .card-front,
[data-group="0"] .card-back{border-radius:clamp(16px,4vmin,24px) !important}
[data-group="0"] .card-inner{transition:transform .5s ease !important}
[data-group="0"] .card.matched .card-back{
  background:linear-gradient(145deg,#dcfce7,#bbf7d0) !important;
  border-color:rgba(34,197,94,.4) !important;
  animation:matchNature 1.5s ease-in-out infinite !important}
@keyframes matchNature{
  0%,100%{box-shadow:0 0 8px rgba(34,197,94,.25),0 4px 0 rgba(16,185,129,.15)}
  50%{box-shadow:0 0 22px rgba(34,197,94,.55),0 0 44px rgba(34,197,94,.15),0 4px 0 rgba(16,185,129,.15)}}

/* ===== GROUP 1: OCEAN (Levels 5-8) ‚Äî Organic Blob, Wavy ===== */
[data-group="1"] .card-inner,
[data-group="1"] .card-front,
[data-group="1"] .card-back{border-radius:30% 70% 60% 40% / 55% 35% 65% 45% !important}
[data-group="1"] .card-inner{transition:transform .55s cubic-bezier(.25,.8,.25,1) !important}
[data-group="1"] .card-front{border:3px solid rgba(14,165,233,.4) !important}
[data-group="1"] .card.matched .card-back{
  background:linear-gradient(145deg,#e0f2fe,#bae6fd) !important;
  border-color:rgba(14,165,233,.4) !important;
  animation:matchOcean 1.3s ease-in-out infinite !important}
@keyframes matchOcean{
  0%,100%{transform:rotateY(180deg) scale(1);box-shadow:0 0 8px rgba(14,165,233,.2),0 4px 0 rgba(14,165,233,.15)}
  50%{transform:rotateY(180deg) scale(1.05);box-shadow:0 0 24px rgba(14,165,233,.5),0 0 48px rgba(14,165,233,.12),0 4px 0 rgba(14,165,233,.15)}}

/* ===== GROUP 2: CITY/FOOD (Levels 9-12) ‚Äî Circle, Bouncy ===== */
[data-group="2"] .card-inner,
[data-group="2"] .card-front,
[data-group="2"] .card-back{border-radius:50% !important}
[data-group="2"] .card-inner{transition:transform .45s cubic-bezier(.34,1.8,.64,1) !important}
[data-group="2"] .card.flipped .card-inner{transform:rotateY(180deg) scale(1.03) !important}
[data-group="2"] .card.matched .card-inner{transform:rotateY(180deg) scale(1) !important}
[data-group="2"] .card.matched .card-back{
  background:linear-gradient(145deg,#fff7ed,#fed7aa) !important;
  animation:matchCity 2.2s linear infinite !important}
@keyframes matchCity{
  0%{border-color:rgba(239,68,68,.5);box-shadow:0 0 12px rgba(239,68,68,.3)}
  25%{border-color:rgba(245,158,11,.5);box-shadow:0 0 12px rgba(245,158,11,.3)}
  50%{border-color:rgba(34,197,94,.5);box-shadow:0 0 12px rgba(34,197,94,.3)}
  75%{border-color:rgba(59,130,246,.5);box-shadow:0 0 12px rgba(59,130,246,.3)}
  100%{border-color:rgba(239,68,68,.5);box-shadow:0 0 12px rgba(239,68,68,.3)}}

/* ===== GROUP 3: ADVENTURE (Levels 13-16) ‚Äî Sharp + Gold Border ===== */
[data-group="3"] .card-inner,
[data-group="3"] .card-front,
[data-group="3"] .card-back{border-radius:clamp(5px,1.2vmin,8px) !important}
[data-group="3"] .card-inner{transition:transform .4s cubic-bezier(.4,0,.2,1) !important}
[data-group="3"] .card.flipped .card-inner{transform:rotateY(180deg) rotateZ(2deg) !important}
[data-group="3"] .card.matched .card-inner{transform:rotateY(180deg) rotateZ(0deg) !important}
[data-group="3"] .card-front{border:3px solid rgba(245,158,11,.5) !important}
[data-group="3"] .card.matched .card-back{
  background:linear-gradient(145deg,#fef9c3,#fde68a) !important;
  border-color:rgba(245,158,11,.5) !important;
  animation:matchAdventure 1.5s ease-in-out infinite !important}
@keyframes matchAdventure{
  0%,100%{box-shadow:0 0 6px rgba(245,158,11,.3)}
  30%{box-shadow:0 0 18px rgba(245,158,11,.6),0 0 36px rgba(245,158,11,.15)}
  60%{box-shadow:0 0 10px rgba(234,88,12,.4)}}

/* ===== GROUP 4: TECH/BOSS (Levels 17-20) ‚Äî Sharp Neon ===== */
[data-group="4"] .card-inner,
[data-group="4"] .card-front,
[data-group="4"] .card-back{border-radius:3px !important}
[data-group="4"] .card-inner{transition:transform .22s cubic-bezier(.7,0,.3,1) !important}
[data-group="4"] .card-front{border:2px solid rgba(168,85,247,.5) !important;box-shadow:0 0 8px rgba(168,85,247,.2),0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12) !important}
[data-group="4"] .card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 0 14px rgba(168,85,247,.4),0 8px 0 rgba(0,0,0,.15),0 12px 24px rgba(0,0,0,.15) !important}
[data-group="4"] .card.matched .card-back{
  background:linear-gradient(145deg,#f3e8ff,#e9d5ff) !important;
  border-color:rgba(168,85,247,.5) !important;
  animation:matchTech 1s ease-in-out infinite !important}
@keyframes matchTech{
  0%,100%{box-shadow:0 0 4px rgba(168,85,247,.4),0 0 8px rgba(168,85,247,.15)}
  50%{box-shadow:0 0 14px rgba(168,85,247,.7),0 0 28px rgba(168,85,247,.25),0 0 56px rgba(168,85,247,.08)}}

/* === FOOTER & MISC === */
.g-foot{display:flex;gap:clamp(4px,1vmin,8px);flex-shrink:0;flex-wrap:wrap;justify-content:center}
.f-btn{background:rgba(255,255,255,.25);border:none;border-radius:12px;padding:clamp(7px,1.8vmin,12px) clamp(14px,3.5vmin,24px);font-size:clamp(14px,2.5vmin,18px);font-weight:800;color:#fff;cursor:pointer;transition:all .2s;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.f-btn:hover{background:rgba(255,255,255,.35);transform:scale(1.04)}
.f-btn:active{transform:scale(.95)}
.hint{color:rgba(255,255,255,.9);font-size:clamp(14px,2.5vmin,18px);font-weight:600;flex-shrink:0;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}

/* === COMPLETE === */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vmin,16px);padding:clamp(12px,3vmin,24px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.d-emoji{font-size:clamp(56px,14vmin,84px);animation:bounce 1s ease infinite;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.d-title{font-size:clamp(24px,7vmin,38px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4)}
.d-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;font-weight:600}
.d-stars{display:flex;gap:clamp(5px,1.2vmin,8px);font-size:clamp(36px,9vmin,54px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.d-stats{display:flex;gap:clamp(8px,2vmin,16px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:12px;padding:clamp(6px,1.5vmin,12px) clamp(10px,2.5vmin,18px);backdrop-filter:blur(4px)}
.d-st-e{font-size:clamp(24px,6vmin,36px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.d-st-v{font-size:clamp(20px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.d-st-l{font-size:clamp(10px,1.8vmin,13px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.d-btns{display:flex;gap:clamp(6px,1.5vmin,10px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:14px;padding:clamp(10px,2.5vmin,16px) clamp(24px,6vmin,40px);font-size:clamp(15px,3vmin,20px);font-weight:900;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 18px rgba(249,115,22,.4)}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff;backdrop-filter:blur(4px)}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 18px rgba(37,99,235,.4)}
.particle{position:fixed;pointer-events:none;z-index:999;animation:part 1.1s ease-out forwards}
@keyframes part{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.3)}}
@keyframes cardFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes emojiWiggle{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(-6deg)}50%{transform:scale(1) rotate(0deg)}75%{transform:scale(1.15) rotate(6deg)}}
@keyframes emojiBreath{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

/* ===== ROYAL MATCH 3D VISUAL SYSTEM ===== */
#lvl-screen{background-size:300% 300%;animation:royalBG 15s ease infinite}
#done-screen{background-size:300% 300%;animation:royalBG 15s ease infinite}
@keyframes royalBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.screen.active{animation:screenIn .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes screenIn{0%{opacity:0;transform:scale(.93) translateY(12px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.lc{transform-style:preserve-3d;box-shadow:0 6px 0 rgba(0,0,0,.18),0 10px 0 rgba(0,0,0,.08),0 20px 40px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.4) !important;background:linear-gradient(160deg,rgba(255,255,255,.5) 0%,rgba(255,255,255,.2) 40%,rgba(255,255,255,.05) 100%) !important;border:2px solid rgba(255,255,255,.55) !important;transition:all .35s cubic-bezier(.34,1.56,.64,1) !important}
.lc:hover{transform:translateY(-8px) scale(1.1) rotateX(5deg) !important;box-shadow:0 12px 0 rgba(0,0,0,.12),0 20px 0 rgba(0,0,0,.05),0 32px 60px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.6) !important}
.lc:active{transform:translateY(2px) scale(.96) !important}
.lc.current{animation:currentGlow 2.5s ease-in-out infinite,cardFloat 3s ease-in-out infinite !important;border-color:#fbbf24 !important}
@keyframes currentGlow{0%,100%{box-shadow:0 0 15px rgba(251,191,36,.4),0 6px 0 rgba(0,0,0,.15)}50%{box-shadow:0 0 30px rgba(251,191,36,.7),0 0 60px rgba(251,191,36,.2),0 6px 0 rgba(0,0,0,.12)}}
.card-front{box-shadow:0 6px 0 rgba(0,0,0,.2),0 8px 0 rgba(0,0,0,.1),0 14px 28px rgba(0,0,0,.15),inset 0 2px 0 rgba(255,255,255,.35) !important;background:linear-gradient(165deg,var(--cf1,#6366f1),var(--cf2,#4f46e5),rgba(0,0,0,.15)) !important}
.card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 10px 0 rgba(0,0,0,.15),0 14px 0 rgba(0,0,0,.08),0 20px 36px rgba(0,0,0,.18),inset 0 2px 0 rgba(255,255,255,.4) !important;transform:scale(1.08) !important}
.card:not(.flipped):not(.matched):active .card-front{transform:scale(.94) !important;box-shadow:0 2px 0 rgba(0,0,0,.2),0 3px 6px rgba(0,0,0,.1) !important}
.card-back{box-shadow:0 6px 0 rgba(99,102,241,.2),0 8px 0 rgba(99,102,241,.1),0 14px 24px rgba(0,0,0,.1),inset 0 -2px 0 rgba(0,0,0,.04),inset 0 2px 0 rgba(255,255,255,.6) !important;background:linear-gradient(180deg,#fff,#f5f3ff,#ede9fe) !important}
.g-stat{box-shadow:0 3px 0 rgba(0,0,0,.1),0 4px 8px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .2s}
.f-btn{box-shadow:0 4px 0 rgba(0,0,0,.12),0 6px 10px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .2s cubic-bezier(.34,1.56,.64,1) !important}
.f-btn:hover{transform:translateY(-3px) scale(1.05) !important;box-shadow:0 7px 0 rgba(0,0,0,.1),0 10px 16px rgba(0,0,0,.08) !important}
.f-btn:active{transform:translateY(2px) scale(.96) !important;box-shadow:0 1px 0 rgba(0,0,0,.12) !important}
.d-stars span{display:inline-block;animation:starPop3D .6s cubic-bezier(.34,1.56,.64,1) both}
.d-stars span:nth-child(1){animation-delay:.1s}
.d-stars span:nth-child(2){animation-delay:.3s}
.d-stars span:nth-child(3){animation-delay:.5s}
@keyframes starPop3D{0%{transform:scale(0) rotateY(180deg);opacity:0}60%{transform:scale(1.3) rotateY(45deg);opacity:1}100%{transform:scale(1) rotateY(0deg);opacity:1}}
.d-st{box-shadow:0 4px 0 rgba(0,0,0,.1),0 8px 16px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.d-st:hover{transform:translateY(-3px) scale(1.05)}
.d-btn.pri{box-shadow:0 6px 0 #c2410c,0 8px 0 #9a3412,0 14px 24px rgba(249,115,22,.3) !important}
.d-btn.pri:hover{transform:translateY(-3px) scale(1.06) !important;box-shadow:0 9px 0 #c2410c,0 12px 0 #9a3412,0 20px 32px rgba(249,115,22,.35) !important}
.d-btn.pri:active{transform:translateY(3px) scale(.96) !important;box-shadow:0 2px 0 #c2410c !important}
.d-btn.shr{box-shadow:0 6px 0 #1d4ed8,0 8px 0 #1e40af,0 14px 24px rgba(37,99,235,.3) !important}
.d-btn.sec{box-shadow:0 4px 0 rgba(0,0,0,.15),0 6px 12px rgba(0,0,0,.08) !important}
.d-emoji{animation:doneBounce3D 1.5s cubic-bezier(.34,1.56,.64,1) infinite !important;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3)) !important}
@keyframes doneBounce3D{0%,100%{transform:translateY(0) scale(1) rotateZ(0)}25%{transform:translateY(-12px) scale(1.05) rotateZ(-3deg)}50%{transform:translateY(-6px) scale(1.02) rotateZ(0)}75%{transform:translateY(-12px) scale(1.05) rotateZ(3deg)}}
.card.flipped .card-inner{transition:transform .5s cubic-bezier(.34,1.56,.64,1) !important}
.grid{filter:drop-shadow(0 4px 16px rgba(0,0,0,.1))}
/* ===== END ROYAL MATCH 3D ===== */
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="lvl-screen" class="screen active">
  <div class="ls-title" id="ls-t">üß† ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©</div>
  <div class="ls-sub" id="ls-s">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!</div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <canvas id="bg-canvas"></canvas>
  <div class="g-hdr">
    <div style="display:flex;align-items:center;gap:5px">
      <span class="g-title" id="g-t">Memory</span>
      <span class="g-badge" id="g-b">1</span>
    </div>
    <div class="g-stats">
      <div class="g-stat"><div class="g-sv" id="g-mv">0</div><div class="g-sl" id="g-mvl">ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™</div></div>
      <div class="g-stat"><div class="g-sv" id="g-pr">0/8</div><div class="g-sl" id="g-prl">ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨</div></div>
      <div class="g-stat"><div class="g-sv" id="g-tm">0:00</div><div class="g-sl" id="g-tml">ÿßŸÑŸàŸÇÿ™</div></div>
    </div>
  </div>
  <div class="grid-wrap"><div class="grid" id="grid"></div></div>
  <p class="hint" id="hint">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿ®ÿ∑ÿßŸÇÿ© ŸÑŸÑÿ®ÿØÿ°!</p>
  <div class="g-foot">
    <button class="f-btn" onclick="showScreen('lvl-screen')">üè† ÿ±ÿ¨Ÿàÿπ</button>
  </div>
</div>

<!-- COMPLETE -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">üéâ</div>
  <div class="d-title" id="d-t">ŸÖÿ®ÿ±ŸàŸÉ!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">üèÜ</div><div class="d-st-v" id="d-sc">0</div><div class="d-st-l" id="d-scl">ÿßŸÑŸÜŸÇÿßÿ∑</div></div>
    <div class="d-st"><div class="d-st-e">üéØ</div><div class="d-st-v" id="d-mv2">0</div><div class="d-st-l" id="d-mvl2">ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™</div></div>
    <div class="d-st"><div class="d-st-e">‚è±Ô∏è</div><div class="d-st-v" id="d-tm">0:00</div><div class="d-st-l" id="d-tml">ÿßŸÑŸàŸÇÿ™</div></div>
  </div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="d-btn sec" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="d-btn sec" onclick="showScreen('lvl-screen')">üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™</button>
  </div>
</div>

<!-- ===== ROYAL MATCH 3D PARTICLE SYSTEM ===== -->
<script>
(function(){
const c=document.createElement('canvas');
c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9999';
document.body.appendChild(c);
const ctx=c.getContext('2d');
let P=[],raf=null;
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener('resize',resize);resize();

window.spawnConfetti=function(x,y,n){
  n=n||40;
  const cols=['#FF6B6B','#4ECDC4','#45B7D1','#FFEAA7','#DDA0DD','#FF69B4','#98D8C8','#F7DC6F','#BB8FCE','#85C1E9','#F8C471','#82E0AA'];
  for(let i=0;i<n;i++){
    P.push({x:x||Math.random()*c.width,y:y||c.height*.3,
      vx:(Math.random()-.5)*14,vy:-Math.random()*16-3,
      w:Math.random()*10+4,h:Math.random()*6+3,
      color:cols[Math.floor(Math.random()*cols.length)],
      rot:Math.random()*360,rs:(Math.random()-.5)*15,
      g:.25+Math.random()*.2,life:1,d:.006+Math.random()*.007})}
  if(!raf)loop()};

window.spawnFirework=function(x,y){
  const cols=['#FFD700','#FF4500','#00FF7F','#1E90FF','#FF69B4','#FFA500','#E74C3C','#2ECC71','#9B59B6','#F39C12'];
  const col=cols[Math.floor(Math.random()*cols.length)];
  for(let i=0;i<50;i++){
    const a=(i/50)*Math.PI*2,sp=2+Math.random()*6;
    P.push({t:'fw',x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      r:1.5+Math.random()*3,color:col,life:1,d:.012+Math.random()*.012,g:.06})}
  if(!raf)loop()};

window.spawn3DStars=function(x,y,n){
  const em=['\u2b50','\ud83c\udf1f','\u2728','\ud83d\udcab','\ud83c\udf86','\ud83d\udc8e','\ud83c\udfc6','\ud83c\udf89','\ud83c\udf8a','\ud83d\udc51'];
  for(let i=0;i<(n||8);i++){
    P.push({t:'em',x:x+(Math.random()-.5)*100,y:y,
      vx:(Math.random()-.5)*6,vy:-Math.random()*10-3,
      em:em[Math.floor(Math.random()*em.length)],
      sz:18+Math.random()*24,life:1,d:.009,g:.12,rot:0,rs:(Math.random()-.5)*10})}
  if(!raf)loop()};

window.royalCelebration=function(stars){
  stars=stars||1;
  for(let w=0;w<Math.min(stars+1,4);w++)
    setTimeout(()=>{
      spawnConfetti(c.width*(.2+Math.random()*.6),c.height*(.2+Math.random()*.2),25+stars*10);
    },w*350);
  for(let f=0;f<Math.min(stars,3);f++)
    setTimeout(()=>{
      spawnFirework(c.width*(.15+Math.random()*.7),c.height*(.1+Math.random()*.25));
    },200+f*600);
  setTimeout(()=>spawn3DStars(c.width/2,c.height*.45,stars*4),100);
};

function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=P.length-1;i>=0;i--){
    const p=P[i];
    p.life-=p.d;
    if(p.life<=0){P.splice(i,1);continue}
    p.vy+=(p.g||.2);p.x+=p.vx;p.y+=p.vy;p.rot=(p.rot||0)+(p.rs||0);
    ctx.save();ctx.globalAlpha=Math.min(1,p.life*1.5);
    ctx.translate(p.x,p.y);ctx.rotate((p.rot||0)*Math.PI/180);
    if(p.t==='fw'){
      ctx.beginPath();ctx.arc(0,0,p.r*p.life,0,Math.PI*2);ctx.fillStyle=p.color;ctx.fill();
      ctx.globalAlpha=p.life*.3;ctx.beginPath();ctx.arc(-p.vx*.5,-p.vy*.5,p.r*p.life*.6,0,Math.PI*2);ctx.fill();
    } else if(p.t==='em'){
      ctx.font=p.sz+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.em,0,0);
    } else {
      ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    }
    ctx.restore()}
  raf=P.length>0?requestAnimationFrame(loop):null}
})();
</script>

<!-- ===== DYNAMIC BACKGROUND ANIMATION SYSTEM ===== -->
<script>
(function(){
const bgC=document.getElementById('bg-canvas');
if(!bgC)return;
const bgX=bgC.getContext('2d');
let parts=[],grp=-1,raf=null,active=false;

const FX=[
  // Group 0: Nature ‚Äî floating leaves, butterflies
  {e:['üçÉ','üåø','ü¶ã','üêù','üå∏','‚òòÔ∏è','üåª','üçÄ','üå∫','üêû'],n:22,sp:0.35,t:'float'},
  // Group 1: Ocean ‚Äî rising bubbles, fish
  {e:['ü´ß','üíß','üêü','üê†','üêö','üåä','ü™∏','üê¨','üê°','ü¶à'],n:26,sp:0.5,t:'rise'},
  // Group 2: City/Food ‚Äî twinkling sparkles
  {e:['‚ú®','‚≠ê','üåü','üí´','üéÜ','üéá','üé™','üé†','üé°','üé¢'],n:20,sp:0.25,t:'twinkle'},
  // Group 3: Adventure ‚Äî shooting stars, meteors
  {e:['‚≠ê','üí´','‚òÑÔ∏è','‚ú®','üåü','üî•','üí•','üå†','üèπ','‚öîÔ∏è'],n:14,sp:1.2,t:'shoot'},
  // Group 4: Tech ‚Äî matrix falling code
  {e:['‚ö°','üíé','üîÆ','üí†','ü§ñ','‚öôÔ∏è','üì°','üíæ','üî¨','üíª'],n:32,sp:0.45,t:'fall'},
];

function resize(){
  const p=bgC.parentElement;
  if(p){bgC.width=p.clientWidth;bgC.height=p.clientHeight}
}

function mkP(fx,init){
  const w=bgC.width||innerWidth,h=bgC.height||innerHeight;
  const p={
    x:Math.random()*w,
    y:init?Math.random()*h:(fx.t==='fall'||fx.t==='shoot'?-30:h+30),
    e:fx.e[Math.floor(Math.random()*fx.e.length)],
    sz:10+Math.random()*16,
    sp:fx.sp*(0.4+Math.random()*0.8),
    op:0.12+Math.random()*0.35,
    ph:Math.random()*Math.PI*2,
    dr:(Math.random()-0.5)*0.25,
    rot:0,rs:(Math.random()-0.5)*0.5
  };
  if(fx.t==='shoot'){p.vx=-0.8-Math.random()*1.5;p.vy=0.4+Math.random()*1.2}
  return p;
}

function loop(){
  if(!active){raf=null;return}
  const w=bgC.width,h=bgC.height;
  bgX.clearRect(0,0,w,h);
  const fx=FX[grp];
  if(!fx){raf=requestAnimationFrame(loop);return}

  for(let i=0;i<parts.length;i++){
    const p=parts[i];
    p.ph+=0.015;
    p.rot+=p.rs;

    if(fx.t==='float'){
      p.y-=p.sp;p.x+=Math.sin(p.ph)*0.4+p.dr;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30}
    } else if(fx.t==='rise'){
      p.y-=p.sp;p.x+=Math.sin(p.ph)*0.55;
      p.sz+=Math.sin(p.ph*2)*0.03;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30}
    } else if(fx.t==='twinkle'){
      p.op=0.08+Math.abs(Math.sin(p.ph))*0.45;
      p.sz=10+Math.sin(p.ph*1.3)*5;
      p.y-=p.sp*0.15;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30;p.x=Math.random()*w}
    } else if(fx.t==='shoot'){
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<-50||p.y>h+50){Object.assign(p,mkP(fx,false));p.y=-30;p.x=Math.random()*w}
    } else if(fx.t==='fall'){
      p.y+=p.sp;
      p.op=0.08+Math.abs(Math.sin(p.ph))*0.3;
      if(p.y>h+40){Object.assign(p,mkP(fx,false));p.y=-30;p.x=Math.random()*w}
    }

    bgX.save();
    bgX.globalAlpha=p.op;
    bgX.translate(p.x,p.y);
    bgX.rotate(p.rot*Math.PI/180);
    bgX.font=Math.round(p.sz)+'px serif';
    bgX.textAlign='center';bgX.textBaseline='middle';
    bgX.fillText(p.e,0,0);
    bgX.restore();
  }
  raf=requestAnimationFrame(loop);
}

window.initBg=function(g){
  grp=g;parts=[];active=true;
  resize();
  const fx=FX[g];
  if(fx){for(let i=0;i<fx.n;i++)parts.push(mkP(fx,true))}
  if(!raf)loop();
};

window.stopBg=function(){
  active=false;grp=-1;
  if(bgC.width)bgX.clearRect(0,0,bgC.width,bgC.height);
};

addEventListener('resize',function(){
  resize();
  if(active&&grp>=0){
    const fx=FX[grp];
    if(fx){
      parts=[];
      for(let i=0;i<fx.n;i++)parts.push(mkP(fx,true));
    }
  }
});
})();
</script>

<!-- ===== MAIN GAME ===== -->
<script>
// ===== i18n =====
const LANG=new URLSearchParams(location.search).get('lang')||'ar';
document.documentElement.lang=LANG;document.documentElement.dir=LANG==='ar'?'rtl':'ltr';
const I={
ar:{title:'üß† ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©',sub:'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!',moves:'ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™',pairs:'ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨',time:'ÿßŸÑŸàŸÇÿ™',hint:'ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿ®ÿ∑ÿßŸÇÿ© ŸÑŸÑÿ®ÿØÿ°!',score:'ÿßŸÑŸÜŸÇÿßÿ∑',congrats:'ŸÖÿ®ÿ±ŸàŸÉ!',excellent:'üåü ŸÖŸÖÿ™ÿßÿ≤!',great:'üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™!',good:'üëç ÿ¨ŸäÿØ!',tryMore:'üí™ ÿ≠ÿßŸàŸÑ ÿ£ŸÉÿ´ÿ±!',done:'ÿ£ÿ™ŸÖŸÖÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ!',next:'‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä',share:'üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©',again:'üîÑ ÿ•ÿπÿßÿØÿ©',levels:'üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™',back:'üè† ÿ±ÿ¨Ÿàÿπ',locked:'üîí',
shareText:'ÿ≠ŸÇŸÇÿ™ {score} ŸÜŸÇÿ∑ÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ {level} ŸÖŸÜ ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©! ‚≠ê{stars}',
lvNames:['ŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™','ÿ≥ŸÑÿ© ÿßŸÑŸÅŸàÿßŸÉŸá','ÿπÿßŸÑŸÖ ÿßŸÑÿ®ÿ≠ÿßÿ±','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑÿ≠ÿ¥ÿ±ÿßÿ™','ÿ≥ŸÖÿßÿ° Ÿàÿ∑ŸÇÿ≥','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑŸàÿ±ÿØ','ŸàÿßÿØŸä ÿßŸÑÿÆÿ∂ÿßÿ±','ŸÖÿ∑ÿ®ÿÆ ŸÑÿ∞Ÿäÿ∞','ÿπÿßŸÑŸÖ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™','ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑŸÅÿ∂ÿßÿ°','ŸÖŸÑÿπÿ® ÿßŸÑÿ±Ÿäÿßÿ∂ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ','ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ŸÅÿßÿ±Ÿä','ÿπÿßŸÑŸÖ ÿßŸÑÿ∑ŸäŸàÿ±','Ÿàÿ±ÿ¥ÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™','ÿπÿßŸÑŸÖ ÿßŸÑÿ£ÿ≤Ÿäÿßÿ°','ŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖÿ®ÿßŸÜŸä','ŸäŸàŸÖ ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑÿ™ŸÇŸÜŸäÿ©','üåç ÿ®ÿ∑ŸÑ ÿßŸÑÿπÿßŸÑŸÖ']},
en:{title:'üß† Memory Match',sub:'Choose a level to start!',moves:'Moves',pairs:'Pairs',time:'Time',hint:'Tap any card to start!',score:'Score',congrats:'Congrats!',excellent:'üåü Excellent!',great:'üéâ Great!',good:'üëç Good!',tryMore:'üí™ Try More!',done:'Level complete!',next:'‚û°Ô∏è Next',share:'üì§ Share',again:'üîÑ Replay',levels:'üè† Levels',back:'üè† Back',locked:'üîí',
shareText:'I scored {score} on Level {level} in Memory Match! ‚≠ê{stars}',
lvNames:['Farm Friends','Fruit Basket','Ocean World','Bug Garden','Sky Watch','Flower Garden','Veggie Valley','Yummy Kitchen','On the Move','Space Quest','Sports Arena','Music Studio','Wild Safari','Bird Paradise','Tool Workshop','Fashion Show','City Builder','School Days','Tech World','üåç World Champion']},
pt:{title:'üß† Jogo da Mem√≥ria',sub:'Escolha um n√≠vel!',moves:'Jogadas',pairs:'Pares',time:'Tempo',hint:'Toque para come√ßar!',score:'Pontos',congrats:'Parab√©ns!',excellent:'üåü Excelente!',great:'üéâ Muito Bem!',good:'üëç Bom!',tryMore:'üí™ Tente Mais!',done:'N√≠vel completo!',next:'‚û°Ô∏è Pr√≥ximo',share:'üì§ Compartilhar',again:'üîÑ Repetir',levels:'üè† N√≠veis',back:'üè† Voltar',locked:'üîí',
shareText:'Fiz {score} pontos no N√≠vel {level} do Jogo da Mem√≥ria! ‚≠ê{stars}',
lvNames:['Amigos da Fazenda','Cesta de Frutas','Mundo do Mar','Jardim de Insetos','C√©u e Clima','Jardim de Flores','Vale dos Vegetais','Cozinha Gostosa','Em Movimento','Miss√£o Espacial','Arena Esportiva','Est√∫dio Musical','Safari Selvagem','Para√≠so dos P√°ssaros','Oficina de Ferramentas','Desfile de Moda','Construtor de Cidades','Dia Escolar','Mundo Tech','üåç Campe√£o Mundial']}
};
const t=I[LANG]||I.en;

// ===== 1000+ EDUCATIONAL SYMBOLS =====
const POOL={
farm:['üêÑ','üê∑','üêë','üêê','üê¥','üêî','üêì','ü¶É','üê§','üê£','ü¶Ü','üêï','üêà','üê∞','üêá','üêπ','üê≠','üêø','ü¶î','üê∂','üê±','üêÆ','üêñ','üêó','üêΩ','üêè','üê™','üê´','ü¶ô','üêé','üê•','üïä','üê©','üêæ','ü¶ù','ü¶°','ü¶®','ü¶•','ü¶¶','üêª','üê®','üêº','ü¶ä','üê∫','ü¶´','üêÇ','üêÉ','ü¶Ñ','üêÅ','üêÄ'],
fruit:['üçé','üçè','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçë','üçí','ü•ù','ü••','üçç','ü•≠','üçÖ','ü•ë','ü´ê','ü´í','ü•ï','üçÜ','üå∂','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•ú','üå∞','üçÑ','üç†','ü•¶','ü•ó','ü•£','ü´ô','ü•´','ü•î','ü´ë','üßÜ','ü•ô','ü´ì','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üßà','üçã‚Äçüü©'],
sea:['üêü','üê†','üê°','ü¶à','üê¨','üê≥','üêã','ü¶≠','üêô','ü¶ë','ü¶ê','ü¶Ä','ü¶û','üêö','ü™∏','ü™º','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','ü¶à','üê¨','üêô','ü¶ë','üê†','üêü','üê°','ü¶ê','ü¶Ä','ü¶û','üêö','üê¢','üêä','üêç','üê∏','ü¶é','ü™∏','ü™º','ü¶≠','üêâ','üê≤','ü¶ï','ü¶ñ'],
bug:['ü¶ã','üêõ','üêù','üêû','ü¶ó','üï∑','ü¶Ç','üêú','ü™≤','ü™≥','ü¶ü','ü™∞','üêå','ü™±','üåø','üçÄ','üçÅ','üçÇ','üçÉ','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','ü™¥','üéã','üéç','üçÑ','üåª','üå∏','üåπ','üå∫','üåº','üå∑','üíê','ü™ª','ü™∑','üê¶','üïä','ü¶ã','üêõ','üêù','üêû','ü¶ó','üêú','ü™≤','üêå','ü™±','üï∑'],
weather:['‚òÄÔ∏è','üå§','‚õÖ','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨','üí®','üåä','üåà','üå™','üå´','üíß','üí¶','üå°','üî•','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','üåô','üåõ','üåú','üåö','üåù','üåû','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üåå','üå†'],
flower:['üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥','üéã','üéç','ü™π','ü™∫','üçÑ','üåø','üéÑ','üíÆ','üèµ','üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥'],
veggie:['ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','ü•ô','üå±','ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','üåø','üçÄ','üåæ','üåª','üåº','ü™¥','üßÇ','ü´ô','ü•´','üßà'],
food:['üçï','üçî','üåÆ','üåØ','ü•ö','üç≥','ü•ò','üç≤','üçø','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üç©','üç™','üçØ','ü•ê','ü•ñ','üßá','ü•û','üßà','ü´ï','ü´î','ü•£','ü´ó','üçø','üç±','üßÜ','ü•ô','ü´ì'],
vehicle:['üöó','üöï','üöô','üöå','üöé','üèé','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèç','üõµ','üö≤','üõ¥','üõπ','üõº','üöÅ','üõ∏','üöÄ','üõ©','‚úàÔ∏è','üõ´','üõ¨','üö¢','‚õµ','üõ∂','üö§','üõ•','üõ≥','‚õ¥','üöÇ','üöÉ','üöÑ','üöÖ','üöÜ','üöá','üöà','üöâ','üöä','üöù','üöû','üöã','üö†','üö°','üõ∞','üöè'],
space:['üåç','üåé','üåè','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','üåù','üåû','‚òÄÔ∏è','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','ü™ê','üî≠','üî¨','üß≤','üß™','üß´','üß¨','üí°','üî¶','üïØ','ü™î','üîã','‚ö°','üõ∏','üöÄ','üõ∞','üì°','üåå','üå†','üéÜ','üéá','üí•','üî•','üíß','üåä','üåÄ','üåà'],
sport:['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','üèí','ü•ç','üèè','ü•Ö','‚õ≥','ü™Å','üèπ','üéØ','ü•ä','ü•ã','üéø','‚õ∑','üèÇ','üèãÔ∏è','ü§∏','ü§∫','ü§æ','üèåÔ∏è','üèá','üßò','üßó','ü§ø','üèÑ','üèä','üö£','üéΩ','üèÖ','ü•á','ü•à','ü•â','üèÜ','üéñ','üé™','üé†','üé°','üé¢','üõù','‚õ∫'],
music:['üéµ','üé∂','üéº','üéπ','üé∏','üé∫','üéª','ü•Å','ü™ò','ü™ó','üé∑','üé§','üéß','üìØ','ü™à','üé¨','üé≠','üé®','üñå','üñç','‚úèÔ∏è','üñä','üñã','üìù','üé™','üé†','üé≤','üéØ','üé≥','üé∞','üéÆ','üïπ','üì∫','üìª','üì∏','üé•','üìπ','üìΩ','üéû','üéü','üíø','üìÄ','üíΩ','üì±','üñ•','‚å®Ô∏è','üñ±','üñ®','üì¢','üì£'],
wild:['ü¶Å','üêØ','üêÖ','üêÜ','ü¶í','ü¶ì','üêò','ü¶õ','ü¶è','üêª','ü¶ä','üê∫','ü¶å','ü¶¨','ü¶£','ü¶ß','ü¶ç','üêí','üêµ','üôà','üôâ','üôä','ü¶ò','ü¶•','ü¶®','ü¶°','ü¶ù','ü¶¶','üêª‚Äç‚ùÑÔ∏è','üêº','üê®','üêæ','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','ü¶ã','üêù','üêû','ü¶Ö','ü¶â','üêß','ü¶ú','ü¶ö','ü¶©'],
bird:['ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü¶§','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶§','ü™π','ü™∫','ü•ö','üêæ','üåø','üçÄ','üå≤','üå≥','‚òÅÔ∏è','üå§','‚õÖ','üåà','üåÖ','üèî'],
tool:['üî®','ü™ì','‚õè','üîß','ü™õ','üî©','‚öôÔ∏è','üóú','ü™ö','üìè','üìê','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üîë','üóù','üîí','üîì','ü™§','üß≤','ü™ù','üß∞','ü™ú','ü™£','üßπ','üß∫','üßª','ü™†','üßº','üßΩ','ü™•','ü™í','üîã','üîå','üí°','üî¶','üïØ','ü™î','üßØ','ü™§','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üìé','üñá','üóë'],
fashion:['üëï','üëñ','üß£','üß§','üß•','üß¶','üëó','üëò','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üéí','ü©¥','üëû','üëü','ü•æ','ü•ø','üë†','üë°','ü©∞','üë¢','üëë','üëí','üé©','ü™ñ','‚õëÔ∏è','üíÑ','üíç','üíé','üëì','üï∂','ü•Ω','üìø','üß¢','üëï','üëñ','üß£','üß•','üëó','üëò','üéí','üëü','ü•æ','üë†'],
building:['üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üïå','üïç','‚õ™','üïã','üõï','‚õ©','üèó','üèö','üóº','üóΩ','üóæ','üéë','‚õ≤','‚õ∫','üèõ','üèü','üó∫','üèñ','üèú','üèù','üèû','üèî','‚õ∞','üåã','üåÅ','üåâ','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üóª','üé™','üé°'],
school:['üìö','üìñ','üìù','üìí','üìì','üìî','üìï','üìó','üìò','üìô','üìÑ','üìÉ','üìã','üìé','üìè','üìê','‚úÇÔ∏è','‚úèÔ∏è','üñä','üñã','üñç','üîó','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üóÑ','üóë','üì∞','üóû','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üîñ','üìÆ','üì¨','üì≠','üì™','üì´','‚úâÔ∏è','üì©','üì®','üìß','üíå'],
tech:['üíª','üñ•','üñ®','‚å®Ô∏è','üñ±','üíΩ','üíæ','üíø','üì±','üì≤','üì∑','üì∏','üìπ','üì∫','üìª','üì°','üîå','üîã','üí°','üìü','üì†','üïπ','üéÆ','üéß','üî¨','üî≠','üì°','üõ∞','üíª','üñ•','‚å®Ô∏è','üñ±','üì±','üì≤','üì∑','üìπ','üì∫','üìª','üîå','üîã','üí°','üïπ','üéÆ','üéß','üî¨','üî≠','üõ∞','üì°','‚åö','ü§ñ'],
mix:['üêÑ','üçé','üêü','ü¶ã','‚òÄÔ∏è','üå∏','ü•ï','üçï','üöó','üåç','‚öΩ','üéµ','ü¶Å','ü¶Ö','üî®','üëï','üè†','üìö','üíª','üéâ','üê∑','üçä','üê¨','üêù','üåà','üåπ','üåΩ','üçî','üöå','ü™ê','üèÄ','üé∏','üêØ','ü¶â','üîß','üëó','üè´','üìñ','üì±','üéä','üê¥','üçá','üêô','üêû','‚≠ê','üåª','üçÜ','üç∞','‚úàÔ∏è','üöÄ']
};

// ===== THEMES (base per level) =====
const THEMES=[
  {bg:'linear-gradient(135deg,#86efac,#22c55e)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fca5a5,#ef4444)',cf1:'#dc2626',cf2:'#b91c1c'},
  {bg:'linear-gradient(135deg,#67e8f9,#0891b2)',cf1:'#0891b2',cf2:'#0e7490'},
  {bg:'linear-gradient(135deg,#a3e635,#65a30d)',cf1:'#65a30d',cf2:'#4d7c0f'},
  {bg:'linear-gradient(135deg,#93c5fd,#3b82f6)',cf1:'#3b82f6',cf2:'#2563eb'},
  {bg:'linear-gradient(135deg,#f9a8d4,#ec4899)',cf1:'#ec4899',cf2:'#be185d'},
  {bg:'linear-gradient(135deg,#86efac,#16a34a)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fdba74,#ea580c)',cf1:'#ea580c',cf2:'#c2410c'},
  {bg:'linear-gradient(135deg,#cbd5e1,#475569)',cf1:'#475569',cf2:'#334155'},
  {bg:'linear-gradient(135deg,#c4b5fd,#7c3aed)',cf1:'#7c3aed',cf2:'#6d28d9'},
  {bg:'linear-gradient(135deg,#6ee7b7,#059669)',cf1:'#059669',cf2:'#047857'},
  {bg:'linear-gradient(135deg,#d8b4fe,#9333ea)',cf1:'#9333ea',cf2:'#7e22ce'},
  {bg:'linear-gradient(135deg,#fde68a,#d97706)',cf1:'#d97706',cf2:'#b45309'},
  {bg:'linear-gradient(135deg,#7dd3fc,#0284c7)',cf1:'#0284c7',cf2:'#0369a1'},
  {bg:'linear-gradient(135deg,#fb923c,#c2410c)',cf1:'#c2410c',cf2:'#9a3412'},
  {bg:'linear-gradient(135deg,#f0abfc,#a855f7)',cf1:'#a855f7',cf2:'#9333ea'},
  {bg:'linear-gradient(135deg,#a8a29e,#57534e)',cf1:'#57534e',cf2:'#44403c'},
  {bg:'linear-gradient(135deg,#60a5fa,#2563eb)',cf1:'#2563eb',cf2:'#1d4ed8'},
  {bg:'linear-gradient(135deg,#22d3ee,#0e7490)',cf1:'#0e7490',cf2:'#0891b2'},
  {bg:'linear-gradient(135deg,#fb7185,#be123c)',cf1:'#be123c',cf2:'#9f1239'},
];

// ===== SUB-THEME VARIANTS (per group ‚Äî randomly selected each play) =====
const VARIANTS=[
  // Group 0: Nature greens/springs
  [
    {bg:'linear-gradient(150deg,#bbf7d0,#4ade80)',cf1:'#22c55e',cf2:'#16a34a'},
    {bg:'linear-gradient(120deg,#d9f99d,#84cc16)',cf1:'#65a30d',cf2:'#4d7c0f'},
    {bg:'linear-gradient(160deg,#a7f3d0,#34d399)',cf1:'#059669',cf2:'#047857'},
  ],
  // Group 1: Ocean blues/teals
  [
    {bg:'linear-gradient(150deg,#a5f3fc,#22d3ee)',cf1:'#06b6d4',cf2:'#0891b2'},
    {bg:'linear-gradient(120deg,#bfdbfe,#60a5fa)',cf1:'#2563eb',cf2:'#1d4ed8'},
    {bg:'linear-gradient(160deg,#99f6e4,#14b8a6)',cf1:'#0d9488',cf2:'#0f766e'},
  ],
  // Group 2: City/Food warm
  [
    {bg:'linear-gradient(150deg,#fecaca,#f87171)',cf1:'#ef4444',cf2:'#dc2626'},
    {bg:'linear-gradient(120deg,#fed7aa,#fb923c)',cf1:'#ea580c',cf2:'#c2410c'},
    {bg:'linear-gradient(160deg,#fde68a,#f59e0b)',cf1:'#d97706',cf2:'#b45309'},
  ],
  // Group 3: Adventure golds/coppers
  [
    {bg:'linear-gradient(150deg,#fef08a,#eab308)',cf1:'#ca8a04',cf2:'#a16207'},
    {bg:'linear-gradient(120deg,#fbbf24,#b45309)',cf1:'#92400e',cf2:'#78350f'},
    {bg:'linear-gradient(160deg,#fed7aa,#ea580c)',cf1:'#c2410c',cf2:'#9a3412'},
  ],
  // Group 4: Tech purples/neons
  [
    {bg:'linear-gradient(150deg,#e9d5ff,#a855f7)',cf1:'#9333ea',cf2:'#7e22ce'},
    {bg:'linear-gradient(120deg,#c7d2fe,#818cf8)',cf1:'#6366f1',cf2:'#4f46e5'},
    {bg:'linear-gradient(160deg,#fbcfe8,#ec4899)',cf1:'#db2777',cf2:'#be185d'},
  ],
];

// ===== CARD FRONT ICONS (per group ‚Äî randomly selected each play) =====
const FRONT_ICONS=[
  ['‚ùì','üåø','üçÄ','üå±','üåª','‚òòÔ∏è'],
  ['‚ùì','üåä','üíß','üêö','ü´ß','ü™∏'],
  ['‚ùì','‚ú®','üåü','üî•','‚≠ê','üí´'],
  ['‚ùì','üó∫Ô∏è','‚öîÔ∏è','üèπ','üõ°Ô∏è','üß≠'],
  ['‚ùì','üí†','üîÆ','‚ö°','ü§ñ','üíé'],
];

// ===== LEVEL CONFIG: 20 levels, increasing grid & pairs =====
const LEVELS=[
  {cat:'farm',    gridCols:3,gridRows:2,pairs:3, emoji:'üêÑ'},
  {cat:'fruit',   gridCols:4,gridRows:2,pairs:4, emoji:'üçé'},
  {cat:'sea',     gridCols:4,gridRows:3,pairs:6, emoji:'üê†'},
  {cat:'bug',     gridCols:4,gridRows:3,pairs:6, emoji:'ü¶ã'},
  {cat:'weather', gridCols:4,gridRows:4,pairs:8, emoji:'üå§'},
  {cat:'flower',  gridCols:4,gridRows:4,pairs:8, emoji:'üå∏'},
  {cat:'veggie',  gridCols:4,gridRows:4,pairs:8, emoji:'ü•ï'},
  {cat:'food',    gridCols:5,gridRows:4,pairs:10,emoji:'üçï'},
  {cat:'vehicle', gridCols:5,gridRows:4,pairs:10,emoji:'üöó'},
  {cat:'space',   gridCols:4,gridRows:5,pairs:10,emoji:'üöÄ'},
  {cat:'sport',   gridCols:6,gridRows:4,pairs:12,emoji:'‚öΩ'},
  {cat:'music',   gridCols:6,gridRows:4,pairs:12,emoji:'üéµ'},
  {cat:'wild',    gridCols:5,gridRows:5,pairs:12,emoji:'ü¶Å'},
  {cat:'bird',    gridCols:6,gridRows:5,pairs:15,emoji:'ü¶Ö'},
  {cat:'tool',    gridCols:6,gridRows:5,pairs:15,emoji:'üî®'},
  {cat:'fashion', gridCols:6,gridRows:5,pairs:15,emoji:'üëó'},
  {cat:'building',gridCols:6,gridRows:6,pairs:18,emoji:'üè†'},
  {cat:'school',  gridCols:6,gridRows:6,pairs:18,emoji:'üìö'},
  {cat:'tech',    gridCols:6,gridRows:6,pairs:18,emoji:'üíª'},
  {cat:'mix',     gridCols:6,gridRows:6,pairs:18,emoji:'üåç'},
];

// ===== AUDIO =====
let audioCtx=null;
function ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function tone(f,d,tp,v){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v||.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+(d||.15));o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+(d||.15))}catch(e){}}
function sfxFlip(){tone(523,.06,'sine',.08)}
function sfxMatch(){tone(659,.1,'sine',.12);setTimeout(()=>tone(784,.1,'sine',.12),70);setTimeout(()=>tone(988,.12,'sine',.13),140)}
function sfxNoMatch(){tone(220,.15,'sawtooth',.06)}
function sfxComplete(){[523,659,784,988,1175,1319].forEach((f,i)=>setTimeout(()=>tone(f,.18,'sine',.1),i*80))}
function sfxStar(){[880,1100,1320].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*120))}

// ===== GAME STATE =====
let cards=[],moves=0,matchedPairs=0,totalPairs=8,firstPick=null,secondPick=null,isChecking=false;
let gameStarted=false,startTime=null,timerInterval=null,elapsedSeconds=0;
let currentLevel=-1,currentGridCols=4,currentGridRows=4;
let currentEmoji=[];
let currentFrontIcon='‚ùì';
let currentGroup=0;

let progress=JSON.parse(localStorage.getItem('classify_memory_progress')||'{"unlocked":1,"scores":{},"stars":{}}');
function saveProgress(){localStorage.setItem('classify_memory_progress',JSON.stringify(progress))}

// ===== HELPERS =====
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function fmtTime(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0')}
function pickEmoji(cat,n){const pool=POOL[cat]||POOL.mix;const unique=[...new Set(shuffle(pool))];return unique.slice(0,n)}
function getGroup(idx){return Math.min(4,Math.floor(idx/4))}

function calcScore(moves,pairs,duration){
  const perfect=pairs;
  const extraMoves=Math.max(0,moves-perfect);
  const movePenalty=extraMoves*3;
  const graceSec=pairs*5;
  const extraSec=Math.max(0,duration-graceSec);
  const timePenalty=extraSec*0.3;
  return Math.max(10,Math.min(100,Math.round(100-movePenalty-timePenalty)));
}

// ===== SCREENS =====
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='lvl-screen'){renderLevelSelect();if(window.stopBg)stopBg()}
  if(id==='done-screen'){if(window.stopBg)stopBg()}
}

function renderLevelSelect(){
  const g=document.getElementById('ls-g');g.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cfg=LEVELS[i];
    const grp=getGroup(i);
    const unlocked=i<progress.unlocked;
    const stars=progress.stars[i]||0;
    const isCurr=i===progress.unlocked-1;
    const card=document.createElement('div');
    card.className='lc'+(unlocked?'':' locked')+(isCurr?' current':'');
    card.setAttribute('data-grp',grp);
    if(unlocked){
      card.innerHTML=`<div class="lc-num">${i+1}</div><div class="lc-emoji">${cfg.emoji}</div><div class="lc-name">${t.lvNames[i]}</div><div class="lc-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>`;
      card.onclick=()=>startLevel(i);
    } else {
      card.innerHTML=`<div class="lc-num" style="opacity:.4">${i+1}</div><div class="lc-lock">${t.locked}</div><div class="lc-name" style="opacity:.4">${t.lvNames[i]}</div>`;
    }
    g.appendChild(card);
  }
}

// ===== START LEVEL =====
function startLevel(idx){
  currentLevel=idx;
  const cfg=LEVELS[idx];
  currentGroup=getGroup(idx);
  currentGridCols=cfg.gridCols;currentGridRows=cfg.gridRows;totalPairs=cfg.pairs;
  currentEmoji=pickEmoji(cfg.cat,totalPairs);

  // Pick theme: 50% base, 50% random variant
  const baseTheme=THEMES[idx];
  const groupVariants=VARIANTS[currentGroup];
  const allThemes=[baseTheme,...groupVariants];
  const theme=allThemes[Math.floor(Math.random()*allThemes.length)];

  // Pick random front icon for this group
  const icons=FRONT_ICONS[currentGroup];
  currentFrontIcon=icons[Math.floor(Math.random()*icons.length)];

  // Apply theme
  const gs=document.getElementById('game-screen');
  gs.dataset.group=currentGroup;
  gs.style.background=theme.bg;
  gs.style.setProperty('--cf1',theme.cf1);
  gs.style.setProperty('--cf2',theme.cf2);
  document.getElementById('done-screen').style.background=theme.bg;

  document.getElementById('g-t').textContent=t.lvNames[idx];
  document.getElementById('g-b').textContent=''+(idx+1);

  // Start dynamic background
  if(window.initBg)initBg(currentGroup);

  resetGame();
  showScreen('game-screen');

  // Re-init bg after screen shown (ensures canvas is visible and sized)
  requestAnimationFrame(()=>{if(window.initBg)initBg(currentGroup)});
}

function resetGame(){
  clearInterval(timerInterval);
  cards=createDeck();moves=0;matchedPairs=0;firstPick=null;secondPick=null;isChecking=false;
  gameStarted=false;startTime=null;elapsedSeconds=0;
  document.getElementById('g-mv').textContent='0';
  document.getElementById('g-pr').textContent='0/'+totalPairs;
  document.getElementById('g-tm').textContent='0:00';
  document.getElementById('hint').style.display='';
  renderCards();
}

function createDeck(){
  const chosen=currentEmoji.slice(0,totalPairs);
  const doubled=[...chosen,...chosen];
  return shuffle(doubled).map((s,i)=>({id:i,symbol:s,flipped:false,matched:false}));
}

function renderCards(){
  const g=document.getElementById('grid');
  const wrap=document.querySelector('.grid-wrap');
  const maxW=wrap.clientWidth-8,maxH=wrap.clientHeight-8;
  const gap=Math.max(3,Math.min(6,maxW*.01));
  const sW=(maxW-gap*(currentGridCols-1))/currentGridCols;
  const sH=(maxH-gap*(currentGridRows-1))/currentGridRows;
  const sz=Math.floor(Math.min(sW,sH,80));
  g.style.gridTemplateColumns=`repeat(${currentGridCols},${sz}px)`;
  g.style.gridTemplateRows=`repeat(${currentGridRows},${sz}px)`;
  g.style.gap=gap+'px';
  g.innerHTML='';
  cards.forEach(card=>{
    const btn=document.createElement('button');
    btn.className='card'+(card.flipped?' flipped':'')+(card.matched?' matched flipped':'');
    btn.disabled=card.flipped||card.matched;
    btn.setAttribute('data-id',card.id);
    btn.innerHTML=`<div class="card-inner"><div class="card-front"><span class="icon">${currentFrontIcon}</span></div><div class="card-back"><span class="sym">${card.symbol}</span></div></div>`;
    btn.style.width=sz+'px';btn.style.height=sz+'px';
    btn.addEventListener('click',()=>flipCard(card.id));
    g.appendChild(btn);
  });
}

function flipCard(id){
  if(isChecking)return;
  const card=cards[id];
  if(!card||card.flipped||card.matched)return;
  if(!gameStarted){gameStarted=true;startTime=Date.now();document.getElementById('hint').style.display='none';timerInterval=setInterval(()=>{elapsedSeconds=Math.floor((Date.now()-startTime)/1000);document.getElementById('g-tm').textContent=fmtTime(elapsedSeconds)},1000)}
  card.flipped=true;
  updateCardDOM(id,true,false);
  sfxFlip();
  if(firstPick===null){firstPick=id;return}
  secondPick=id;moves++;
  document.getElementById('g-mv').textContent=moves;
  const first=cards[firstPick],second=cards[secondPick];
  if(first.symbol===second.symbol){
    first.matched=true;second.matched=true;matchedPairs++;
    document.getElementById('g-pr').textContent=matchedPairs+'/'+totalPairs;
    updateCardDOM(first.id,true,true);updateCardDOM(second.id,true,true);
    sfxMatch();
    // Spawn mini particles on match
    spawnMatchParticles(first.id,second.id);
    firstPick=null;secondPick=null;
    if(matchedPairs===totalPairs)setTimeout(()=>endGame(),400);
  } else {
    isChecking=true;sfxNoMatch();
    setTimeout(()=>{first.flipped=false;second.flipped=false;updateCardDOM(first.id,false,false);updateCardDOM(second.id,false,false);firstPick=null;secondPick=null;isChecking=false},800);
  }
}

function spawnMatchParticles(id1,id2){
  try{
    [id1,id2].forEach(id=>{
      const el=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
      if(!el)return;
      const r=el.getBoundingClientRect();
      const cx=r.left+r.width/2,cy=r.top+r.height/2;
      for(let i=0;i<4;i++){
        const p=document.createElement('div');p.className='particle';
        const emojis=['‚≠ê','‚ú®','üåü','üí´','üíé','üéâ'];
        p.textContent=emojis[Math.floor(Math.random()*emojis.length)];
        p.style.left=(cx-10+Math.random()*20)+'px';
        p.style.top=(cy-10+Math.random()*20)+'px';
        p.style.fontSize='18px';
        document.body.appendChild(p);
        setTimeout(()=>p.remove(),1200);
      }
    });
  }catch(e){}
}

function updateCardDOM(id,flipped,matched){
  const btn=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
  if(!btn)return;
  btn.className='card'+(flipped?' flipped':'')+(matched?' matched':'');
  btn.disabled=flipped||matched;
}

function endGame(){
  clearInterval(timerInterval);
  const dur=Math.floor((Date.now()-startTime)/1000);
  const sc=calcScore(moves,totalPairs,dur);
  let stars=0;if(sc>=50)stars=1;if(sc>=75)stars=2;if(sc>=90)stars=3;
  if(currentLevel>=0){
    const prev=progress.stars[currentLevel]||0;if(stars>prev)progress.stars[currentLevel]=stars;
    const prevSc=progress.scores[currentLevel]||0;if(sc>prevSc)progress.scores[currentLevel]=sc;
    if(stars>=1&&currentLevel+1>=progress.unlocked)progress.unlocked=currentLevel+2;
    saveProgress();
  }
  let title,emoji;
  if(stars>=3){title=t.excellent;emoji='üèÜ'}else if(stars>=2){title=t.great;emoji='üéâ'}else if(stars>=1){title=t.good;emoji='üëç'}else{title=t.tryMore;emoji='üí™'}
  document.getElementById('d-e').textContent=emoji;
  document.getElementById('d-t').textContent=title;
  document.getElementById('d-sub').textContent=t.done;
  document.getElementById('d-sc').textContent=sc+'/100';
  document.getElementById('d-mv2').textContent=moves;
  document.getElementById('d-tm').textContent=fmtTime(dur);
  const starsEl=document.getElementById('d-st');starsEl.innerHTML='';
  for(let i=0;i<3;i++){const sp=document.createElement('span');sp.textContent=i<stars?'‚≠ê':'‚òÜ';sp.style.opacity=i<stars?'1':'.3';starsEl.appendChild(sp)}
  document.getElementById('d-nx').style.display=(currentLevel>=0&&currentLevel<LEVELS.length-1)?'':'none';
  sfxComplete();if(stars>0)sfxStar();
  showScreen('done-screen');
  if(window.royalCelebration) window.royalCelebration(stars);
  // Particles
  for(let i=0;i<stars*6;i++){setTimeout(()=>{const p=document.createElement('div');p.className='particle';p.textContent=['‚≠ê','‚ú®','üåü','üéâ','üíé'][Math.floor(Math.random()*5)];p.style.left=(Math.random()*innerWidth)+'px';p.style.top=(innerHeight*.6+Math.random()*80)+'px';p.style.fontSize='22px';document.body.appendChild(p);setTimeout(()=>p.remove(),1200)},i*70)}
  // PostMessage
  try{window.parent.postMessage({type:'GAME_COMPLETE',score:sc,total:100,timeElapsed:dur,moves:moves,level:currentLevel>=0?currentLevel+1:0,stars:stars},'*')}catch(e){}
}

function nextLevel(){if(currentLevel>=0&&currentLevel<LEVELS.length-1)startLevel(currentLevel+1)}
function replayLevel(){if(currentLevel>=0)startLevel(currentLevel)}
function shareResult(){
  const lvl=currentLevel>=0?currentLevel+1:0;const stars=currentLevel>=0?(progress.stars[currentLevel]||0):0;
  const text=t.shareText.replace('{score}',progress.scores[currentLevel]||0).replace('{level}',lvl).replace('{stars}','‚≠ê'.repeat(stars));
  try{if(navigator.share)navigator.share({title:t.title,text:text})}catch(e){}
  try{window.parent.postMessage({type:'SHARE_ACHIEVEMENT',game:'memory',level:lvl,score:progress.scores[currentLevel]||0,stars:stars,text:text},'*')}catch(e){}
  const btn=document.getElementById('d-sh');const o=btn.textContent;btn.textContent='‚úÖ';setTimeout(()=>{btn.textContent=o},2000);
}

// ===== i18n APPLY =====
document.getElementById('ls-t').textContent=t.title;
document.getElementById('ls-s').textContent=t.sub;
document.getElementById('g-mvl').textContent=t.moves;
document.getElementById('g-prl').textContent=t.pairs;
document.getElementById('g-tml').textContent=t.time;
document.getElementById('hint').textContent=t.hint;
document.getElementById('d-scl').textContent=t.score;
document.getElementById('d-mvl2').textContent=t.moves;
document.getElementById('d-tml').textContent=t.time;
document.getElementById('d-nx').textContent=t.next;
document.getElementById('d-sh').textContent=t.share;

// ===== INIT =====
window.addEventListener('resize',()=>{if(document.getElementById('game-screen').classList.contains('active'))renderCards()});
renderLevelSelect();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© - Memory Match</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;z-index:1}
.screen.active{display:flex}

/* === DYNAMIC BACKGROUND CANVAS === */
#bg-canvas{position:absolute;inset:0;pointer-events:none;z-index:0;width:100%;height:100%}
.g-hdr,.grid-wrap,.hint,.g-foot{position:relative;z-index:1}

/* === LEVEL SELECT === */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(6px,1.5vmin,12px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.ls-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.ls-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;flex-shrink:0;font-weight:600}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.lc{position:relative;background:linear-gradient(145deg,rgba(255,255,255,.35),rgba(255,255,255,.15));border:3px solid rgba(255,255,255,.45);border-radius:clamp(14px,3vmin,22px);padding:clamp(8px,2vmin,16px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .25s;backdrop-filter:blur(6px);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08);transform-style:preserve-3d;animation:cardFloat 3s ease-in-out infinite}
.lc:nth-child(even){animation-delay:.5s}.lc:nth-child(3n){animation-delay:1s}.lc:nth-child(4n+1){animation-delay:1.5s}
.lc:hover{transform:translateY(-4px) scale(1.06);background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.25));box-shadow:0 10px 0 rgba(0,0,0,.1),0 16px 32px rgba(0,0,0,.1)}
.lc:active{transform:translateY(3px) scale(.97);box-shadow:0 2px 0 rgba(0,0,0,.15),0 3px 8px rgba(0,0,0,.08)}
.lc.locked{opacity:.5;cursor:not-allowed;animation:none}
.lc.locked:hover{transform:none;background:rgba(255,255,255,.15);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08)}
.lc.current{border-color:#fbbf24;box-shadow:0 6px 0 rgba(251,191,36,.3),0 0 18px rgba(251,191,36,.5)}
.lc-num{font-size:clamp(22px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.lc-emoji{font-size:clamp(32px,7vmin,48px);margin:3px 0;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));animation:emojiWiggle 2.5s ease-in-out infinite}
.lc:nth-child(2n) .lc-emoji{animation-delay:.3s}.lc:nth-child(3n) .lc-emoji{animation-delay:.7s}.lc:nth-child(4n) .lc-emoji{animation-delay:1.1s}.lc.locked .lc-emoji{animation:none}
.lc-name{font-size:clamp(10px,1.8vmin,14px);color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lc-stars{font-size:clamp(14px,2.8vmin,18px);margin-top:3px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(32px,7vmin,46px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}

/* Level card group color hints */
.lc[data-grp="0"]{border-left:3px solid rgba(34,197,94,.6)}
.lc[data-grp="1"]{border-left:3px solid rgba(14,165,233,.6)}
.lc[data-grp="2"]{border-left:3px solid rgba(249,115,22,.6)}
.lc[data-grp="3"]{border-left:3px solid rgba(245,158,11,.6)}
.lc[data-grp="4"]{border-left:3px solid rgba(168,85,247,.6)}

/* === GAME === */
#game-screen{flex-direction:column;align-items:center;padding:clamp(4px,1vmin,10px);gap:clamp(3px,.8vmin,6px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2));transition:background .5s;position:relative}
.g-hdr{width:100%;max-width:540px;display:flex;align-items:center;justify-content:space-between;gap:6px;flex-shrink:0}
.g-title{font-size:clamp(16px,3.2vmin,22px);font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.g-badge{font-size:clamp(12px,2.2vmin,16px);background:rgba(255,255,255,.3);color:#fff;border-radius:20px;padding:3px 10px;font-weight:800}
.g-stats{display:flex;gap:clamp(4px,1vmin,8px);align-items:center}
.g-stat{text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:2px 8px;backdrop-filter:blur(4px)}
.g-sv{font-size:clamp(18px,3.5vmin,24px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.g-sl{font-size:clamp(10px,1.8vmin,12px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.grid-wrap{flex:1;display:flex;align-items:center;justify-content:center;width:100%;min-height:0}
.grid{display:grid;gap:clamp(3px,1vmin,6px);perspective:1000px}

/* === BASE CARD STYLES === */
.card{aspect-ratio:1;border:none;background:transparent;cursor:pointer;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
.card:disabled{cursor:default}
.card-inner{position:relative;width:100%;height:100%;transition:transform .45s ease;transform-style:preserve-3d;border-radius:clamp(8px,2vmin,14px)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:clamp(8px,2vmin,14px);display:flex;align-items:center;justify-content:center}
.card-front{background:linear-gradient(145deg,var(--cf1,#6366f1),var(--cf2,#4f46e5));box-shadow:0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12);border:3px solid rgba(255,255,255,.3);transform-style:preserve-3d}
.card-front .icon{font-size:clamp(1.6rem,5.5vmin,2.6rem);filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));animation:emojiWiggle 3s ease-in-out infinite}
.card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 8px 0 rgba(0,0,0,.18),0 12px 24px rgba(0,0,0,.15);transform:scale(1.06);transition:transform .15s}
.card:not(.flipped):not(.matched):active .card-front{transform:scale(.96);box-shadow:0 2px 0 rgba(0,0,0,.2),0 3px 8px rgba(0,0,0,.1)}
.card-back{background:linear-gradient(145deg,#fff,#f1f5f9);box-shadow:0 5px 0 rgba(99,102,241,.15),0 8px 16px rgba(0,0,0,.08);transform:rotateY(180deg);border:3px solid rgba(99,102,241,.25)}
.card-back .sym{font-size:clamp(2rem,7vmin,3.2rem);filter:drop-shadow(0 1px 3px rgba(0,0,0,.15));animation:emojiBreath 2s ease-in-out infinite}
.card.matched .card-inner{transform:rotateY(180deg)}
.card.matched .card-back{background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-color:rgba(16,185,129,.3);box-shadow:0 0 16px rgba(16,185,129,.25);animation:mpop .4s ease}
@keyframes mpop{0%{transform:rotateY(180deg) scale(1)}50%{transform:rotateY(180deg) scale(1.12)}100%{transform:rotateY(180deg) scale(1)}}

/* ===== GROUP 0: NATURE (Levels 1-4) â€” Soft Rounded, Gentle ===== */
[data-group="0"] .card-inner,
[data-group="0"] .card-front,
[data-group="0"] .card-back{border-radius:clamp(16px,4vmin,24px) !important}
[data-group="0"] .card-inner{transition:transform .5s ease !important}
[data-group="0"] .card.matched .card-back{
  background:linear-gradient(145deg,#dcfce7,#bbf7d0) !important;
  border-color:rgba(34,197,94,.4) !important;
  animation:matchNature 1.5s ease-in-out infinite !important}
@keyframes matchNature{
  0%,100%{box-shadow:0 0 8px rgba(34,197,94,.25),0 4px 0 rgba(16,185,129,.15)}
  50%{box-shadow:0 0 22px rgba(34,197,94,.55),0 0 44px rgba(34,197,94,.15),0 4px 0 rgba(16,185,129,.15)}}

/* ===== GROUP 1: OCEAN (Levels 5-8) â€” Organic Blob, Wavy ===== */
[data-group="1"] .card-inner,
[data-group="1"] .card-front,
[data-group="1"] .card-back{border-radius:30% 70% 60% 40% / 55% 35% 65% 45% !important}
[data-group="1"] .card-inner{transition:transform .55s cubic-bezier(.25,.8,.25,1) !important}
[data-group="1"] .card-front{border:3px solid rgba(14,165,233,.4) !important}
[data-group="1"] .card.matched .card-back{
  background:linear-gradient(145deg,#e0f2fe,#bae6fd) !important;
  border-color:rgba(14,165,233,.4) !important;
  animation:matchOcean 1.3s ease-in-out infinite !important}
@keyframes matchOcean{
  0%,100%{transform:rotateY(180deg) scale(1);box-shadow:0 0 8px rgba(14,165,233,.2),0 4px 0 rgba(14,165,233,.15)}
  50%{transform:rotateY(180deg) scale(1.05);box-shadow:0 0 24px rgba(14,165,233,.5),0 0 48px rgba(14,165,233,.12),0 4px 0 rgba(14,165,233,.15)}}

/* ===== GROUP 2: CITY/FOOD (Levels 9-12) â€” Circle, Bouncy ===== */
[data-group="2"] .card-inner,
[data-group="2"] .card-front,
[data-group="2"] .card-back{border-radius:50% !important}
[data-group="2"] .card-inner{transition:transform .45s cubic-bezier(.34,1.8,.64,1) !important}
[data-group="2"] .card.flipped .card-inner{transform:rotateY(180deg) scale(1.03) !important}
[data-group="2"] .card.matched .card-inner{transform:rotateY(180deg) scale(1) !important}
[data-group="2"] .card.matched .card-back{
  background:linear-gradient(145deg,#fff7ed,#fed7aa) !important;
  animation:matchCity 2.2s linear infinite !important}
@keyframes matchCity{
  0%{border-color:rgba(239,68,68,.5);box-shadow:0 0 12px rgba(239,68,68,.3)}
  25%{border-color:rgba(245,158,11,.5);box-shadow:0 0 12px rgba(245,158,11,.3)}
  50%{border-color:rgba(34,197,94,.5);box-shadow:0 0 12px rgba(34,197,94,.3)}
  75%{border-color:rgba(59,130,246,.5);box-shadow:0 0 12px rgba(59,130,246,.3)}
  100%{border-color:rgba(239,68,68,.5);box-shadow:0 0 12px rgba(239,68,68,.3)}}

/* ===== GROUP 3: ADVENTURE (Levels 13-16) â€” Sharp + Gold Border ===== */
[data-group="3"] .card-inner,
[data-group="3"] .card-front,
[data-group="3"] .card-back{border-radius:clamp(5px,1.2vmin,8px) !important}
[data-group="3"] .card-inner{transition:transform .4s cubic-bezier(.4,0,.2,1) !important}
[data-group="3"] .card.flipped .card-inner{transform:rotateY(180deg) rotateZ(2deg) !important}
[data-group="3"] .card.matched .card-inner{transform:rotateY(180deg) rotateZ(0deg) !important}
[data-group="3"] .card-front{border:3px solid rgba(245,158,11,.5) !important}
[data-group="3"] .card.matched .card-back{
  background:linear-gradient(145deg,#fef9c3,#fde68a) !important;
  border-color:rgba(245,158,11,.5) !important;
  animation:matchAdventure 1.5s ease-in-out infinite !important}
@keyframes matchAdventure{
  0%,100%{box-shadow:0 0 6px rgba(245,158,11,.3)}
  30%{box-shadow:0 0 18px rgba(245,158,11,.6),0 0 36px rgba(245,158,11,.15)}
  60%{box-shadow:0 0 10px rgba(234,88,12,.4)}}

/* ===== GROUP 4: TECH/BOSS (Levels 17-20) â€” Sharp Neon ===== */
[data-group="4"] .card-inner,
[data-group="4"] .card-front,
[data-group="4"] .card-back{border-radius:3px !important}
[data-group="4"] .card-inner{transition:transform .22s cubic-bezier(.7,0,.3,1) !important}
[data-group="4"] .card-front{border:2px solid rgba(168,85,247,.5) !important;box-shadow:0 0 8px rgba(168,85,247,.2),0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12) !important}
[data-group="4"] .card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 0 14px rgba(168,85,247,.4),0 8px 0 rgba(0,0,0,.15),0 12px 24px rgba(0,0,0,.15) !important}
[data-group="4"] .card.matched .card-back{
  background:linear-gradient(145deg,#f3e8ff,#e9d5ff) !important;
  border-color:rgba(168,85,247,.5) !important;
  animation:matchTech 1s ease-in-out infinite !important}
@keyframes matchTech{
  0%,100%{box-shadow:0 0 4px rgba(168,85,247,.4),0 0 8px rgba(168,85,247,.15)}
  50%{box-shadow:0 0 14px rgba(168,85,247,.7),0 0 28px rgba(168,85,247,.25),0 0 56px rgba(168,85,247,.08)}}

/* === MECHANIC OVERLAYS === */
.card .fog-ov{position:absolute;inset:0;background:rgba(180,190,220,.88);border-radius:inherit;display:flex;align-items:center;justify-content:center;z-index:10;font-size:clamp(1.4rem,4.5vmin,2.2rem);cursor:pointer;transition:all .4s;backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.15)}
.card .fog-ov:active{transform:scale(.9)}
.card.decoy-show .card-back .sym{animation:decoyShake .3s ease 2}
@keyframes decoyShake{0%,100%{transform:rotate(0) scale(1)}25%{transform:rotate(-12deg) scale(1.1)}75%{transform:rotate(12deg) scale(1.1)}}
.card.shuffle-anim{animation:shuffleCard .5s cubic-bezier(.34,1.56,.64,1)}
@keyframes shuffleCard{0%{transform:scale(.6) rotate(20deg);opacity:.3}60%{transform:scale(1.08) rotate(-3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}
.mech-info{position:relative;z-index:12;text-align:center;background:rgba(0,0,0,.35);color:#fff;font-size:clamp(11px,2.2vmin,14px);padding:3px 14px;border-radius:16px;font-weight:700;backdrop-filter:blur(4px);flex-shrink:0;max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cd-wrap{position:relative;z-index:12;width:100%;max-width:540px;flex-shrink:0}
.cd-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.cd-bar{width:100%;height:6px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
.cd-fill{height:100%;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);transition:width 1s linear;border-radius:3px}
.cd-txt{font-size:clamp(11px,2vmin,14px);font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.4)}
.cd-txt.urgent{color:#ef4444;animation:urgPulse .5s ease-in-out infinite}
@keyframes urgPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.15)}}
.peek-banner{position:absolute;inset:0;z-index:20;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.35);pointer-events:none;border-radius:8px;opacity:0;transition:opacity .3s}
.peek-banner.show{opacity:1}
.peek-banner span{color:#fff;font-size:clamp(18px,5vmin,28px);font-weight:900;text-shadow:0 2px 8px rgba(0,0,0,.5);animation:peekPulse 1s ease-in-out infinite}
@keyframes peekPulse{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}

/* === DDA SYSTEM === */
.dda-badge{position:relative;z-index:12;display:inline-flex;align-items:center;gap:4px;background:rgba(0,0,0,.25);color:#fff;font-size:clamp(10px,1.8vmin,12px);padding:2px 10px;border-radius:12px;font-weight:700;backdrop-filter:blur(4px);flex-shrink:0;transition:all .5s}
.dda-badge.easy{background:rgba(34,197,94,.35);border:1px solid rgba(34,197,94,.4)}
.dda-badge.normal{background:rgba(59,130,246,.3);border:1px solid rgba(59,130,246,.3)}
.dda-badge.hard{background:rgba(239,68,68,.3);border:1px solid rgba(239,68,68,.3)}
.card.dda-hint .card-front{animation:ddaHintGlow 1.2s ease-in-out 3}
@keyframes ddaHintGlow{0%,100%{box-shadow:0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12)}50%{box-shadow:0 0 16px rgba(251,191,36,.6),0 0 32px rgba(251,191,36,.2),0 5px 0 rgba(0,0,0,.15)}}
.cd-wrap.level-timer{display:block}
.cd-fill.paused{animation:none !important;transition:none !important}

/* === COINS DISPLAY === */
.coins-bar{display:flex;align-items:center;justify-content:center;gap:clamp(8px,2vmin,14px);flex-shrink:0;flex-wrap:wrap}
.coin-display{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(251,191,36,.35),rgba(245,158,11,.25));border:2px solid rgba(251,191,36,.5);border-radius:20px;padding:4px 14px;font-size:clamp(14px,2.8vmin,18px);font-weight:900;color:#fbbf24;text-shadow:0 1px 4px rgba(0,0,0,.3);backdrop-filter:blur(4px)}
.coin-display .coin-icon{font-size:clamp(16px,3vmin,22px);animation:coinSpin 3s linear infinite}
@keyframes coinSpin{0%,80%{transform:rotateY(0)}90%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}
.nav-btn{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.3);border-radius:14px;padding:6px 14px;font-size:clamp(12px,2.2vmin,16px);font-weight:800;color:#fff;cursor:pointer;transition:all .25s;backdrop-filter:blur(4px);text-shadow:0 1px 3px rgba(0,0,0,.2)}
.nav-btn:hover{background:rgba(255,255,255,.35);transform:translateY(-2px) scale(1.05)}
.nav-btn:active{transform:translateY(1px) scale(.96)}
.nav-btn.shop{border-color:rgba(251,191,36,.5);background:linear-gradient(135deg,rgba(251,191,36,.2),rgba(245,158,11,.15))}
.nav-btn.badges{border-color:rgba(168,85,247,.5);background:linear-gradient(135deg,rgba(168,85,247,.2),rgba(139,92,246,.15))}

/* === COIN EARN ANIMATION (done screen) === */
.coin-earned{display:flex;align-items:center;justify-content:center;gap:6px;font-size:clamp(18px,4vmin,26px);font-weight:900;color:#fbbf24;text-shadow:0 2px 8px rgba(0,0,0,.3);animation:coinBounceIn .6s cubic-bezier(.34,1.56,.64,1)}
@keyframes coinBounceIn{0%{opacity:0;transform:scale(0) rotate(-20deg)}60%{transform:scale(1.2) rotate(5deg)}100%{opacity:1;transform:scale(1) rotate(0)}}
.coin-fly{position:fixed;pointer-events:none;z-index:9999;font-size:28px;animation:coinFlyUp 1.2s ease-out forwards}
@keyframes coinFlyUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-120px) scale(.4)}}

/* === SHOP SCREEN === */
#shop-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(8px,2vmin,14px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#fbbf24,#f59e0b))}
.shop-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.shop-coins{font-size:clamp(16px,3vmin,20px);font-weight:800;color:#fef08a;text-shadow:0 1px 4px rgba(0,0,0,.3);flex-shrink:0}
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:clamp(8px,2vmin,12px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.shop-item{position:relative;background:linear-gradient(145deg,rgba(255,255,255,.3),rgba(255,255,255,.12));border:3px solid rgba(255,255,255,.35);border-radius:clamp(14px,3vmin,22px);padding:clamp(10px,2.5vmin,16px);text-align:center;cursor:pointer;transition:all .25s;backdrop-filter:blur(6px)}
.shop-item:hover{transform:translateY(-4px) scale(1.04);background:rgba(255,255,255,.35)}
.shop-item:active{transform:translateY(2px) scale(.97)}
.shop-item.equipped{border-color:#22c55e;box-shadow:0 0 16px rgba(34,197,94,.4)}
.shop-item.owned{border-color:rgba(59,130,246,.5)}
.shop-item.locked{opacity:.7}
.si-preview{width:60px;height:60px;margin:0 auto 6px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 4px 0 rgba(0,0,0,.15),0 6px 12px rgba(0,0,0,.1)}
.si-name{font-size:clamp(13px,2.4vmin,16px);font-weight:800;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.si-price{font-size:clamp(12px,2vmin,14px);font-weight:700;color:#fef08a;margin-top:2px}
.si-btn{margin-top:6px;border:none;border-radius:10px;padding:5px 16px;font-size:clamp(11px,2vmin,14px);font-weight:800;cursor:pointer;transition:all .2s}
.si-btn.buy{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 3px 0 #c2410c}
.si-btn.equip{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 3px 0 #1d4ed8}
.si-btn.equipped{background:rgba(34,197,94,.5);color:#fff;cursor:default}
.si-btn.cant{background:rgba(255,255,255,.15);color:rgba(255,255,255,.5);cursor:not-allowed}
.si-btn:active:not(.cant):not(.equipped){transform:translateY(2px)}

/* === BADGE SCREEN === */
#badge-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(8px,2vmin,14px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#a855f7,#7c3aed))}
.badge-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.badge-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.85);font-weight:600;flex-shrink:0}
.badge-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:clamp(8px,2vmin,12px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.badge-card{background:linear-gradient(145deg,rgba(255,255,255,.25),rgba(255,255,255,.1));border:3px solid rgba(255,255,255,.3);border-radius:clamp(14px,3vmin,22px);padding:clamp(10px,2.5vmin,16px);text-align:center;transition:all .25s;backdrop-filter:blur(6px)}
.badge-card.unlocked{border-color:rgba(251,191,36,.5);box-shadow:0 0 14px rgba(251,191,36,.3);animation:badgeGlow 2.5s ease-in-out infinite}
@keyframes badgeGlow{0%,100%{box-shadow:0 0 8px rgba(251,191,36,.2)}50%{box-shadow:0 0 20px rgba(251,191,36,.5)}}
.badge-card.locked{opacity:.55}
.bc-emoji{font-size:clamp(36px,8vmin,52px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.badge-card.locked .bc-emoji{filter:grayscale(1) drop-shadow(0 2px 6px rgba(0,0,0,.2))}
.bc-name{font-size:clamp(12px,2.2vmin,15px);font-weight:800;color:#fff;margin-top:4px;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.bc-desc{font-size:clamp(10px,1.8vmin,12px);color:rgba(255,255,255,.75);margin-top:2px;font-weight:600}
.bc-date{font-size:clamp(9px,1.5vmin,11px);color:rgba(255,255,255,.5);margin-top:3px}

/* === NEW BADGE POPUP === */
.badge-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:10000;background:linear-gradient(135deg,#1e1b4b,#312e81);border:3px solid #fbbf24;border-radius:24px;padding:24px 32px;text-align:center;animation:badgePopIn .6s cubic-bezier(.34,1.56,.64,1) forwards;box-shadow:0 0 60px rgba(251,191,36,.3),0 20px 40px rgba(0,0,0,.4)}
@keyframes badgePopIn{0%{transform:translate(-50%,-50%) scale(0) rotate(-10deg);opacity:0}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:1}}
.badge-popup .bp-emoji{font-size:60px;animation:emojiWiggle 1.5s ease-in-out infinite}
.badge-popup .bp-title{font-size:20px;font-weight:900;color:#fbbf24;margin-top:8px;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.badge-popup .bp-name{font-size:16px;color:#e9d5ff;margin-top:4px;font-weight:700}
.badge-popup .bp-close{margin-top:12px;border:none;background:rgba(255,255,255,.15);color:#fff;border-radius:10px;padding:6px 24px;font-size:14px;font-weight:700;cursor:pointer}

/* === FOOTER & MISC === */
.g-foot{display:flex;gap:clamp(4px,1vmin,8px);flex-shrink:0;flex-wrap:wrap;justify-content:center}
.f-btn{background:rgba(255,255,255,.25);border:none;border-radius:12px;padding:clamp(7px,1.8vmin,12px) clamp(14px,3.5vmin,24px);font-size:clamp(14px,2.5vmin,18px);font-weight:800;color:#fff;cursor:pointer;transition:all .2s;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.f-btn:hover{background:rgba(255,255,255,.35);transform:scale(1.04)}
.f-btn:active{transform:scale(.95)}
.hint{color:rgba(255,255,255,.9);font-size:clamp(14px,2.5vmin,18px);font-weight:600;flex-shrink:0;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}

/* === COMPLETE === */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vmin,16px);padding:clamp(12px,3vmin,24px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.d-emoji{font-size:clamp(56px,14vmin,84px);animation:bounce 1s ease infinite;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.d-title{font-size:clamp(24px,7vmin,38px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4)}
.d-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;font-weight:600}
.d-stars{display:flex;gap:clamp(5px,1.2vmin,8px);font-size:clamp(36px,9vmin,54px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.d-stats{display:flex;gap:clamp(8px,2vmin,16px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:12px;padding:clamp(6px,1.5vmin,12px) clamp(10px,2.5vmin,18px);backdrop-filter:blur(4px)}
.d-st-e{font-size:clamp(24px,6vmin,36px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.d-st-v{font-size:clamp(20px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.d-st-l{font-size:clamp(10px,1.8vmin,13px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.d-btns{display:flex;gap:clamp(6px,1.5vmin,10px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:14px;padding:clamp(10px,2.5vmin,16px) clamp(24px,6vmin,40px);font-size:clamp(15px,3vmin,20px);font-weight:900;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 18px rgba(249,115,22,.4)}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff;backdrop-filter:blur(4px)}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 18px rgba(37,99,235,.4)}
.particle{position:fixed;pointer-events:none;z-index:999;animation:part 1.1s ease-out forwards}
@keyframes part{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.3)}}
@keyframes cardFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes emojiWiggle{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(-6deg)}50%{transform:scale(1) rotate(0deg)}75%{transform:scale(1.15) rotate(6deg)}}
@keyframes emojiBreath{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

/* ===== ROYAL MATCH 3D VISUAL SYSTEM ===== */
#lvl-screen{background-size:300% 300%;animation:royalBG 15s ease infinite}
#done-screen{background-size:300% 300%;animation:royalBG 15s ease infinite}
@keyframes royalBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.screen.active{animation:screenIn .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes screenIn{0%{opacity:0;transform:scale(.93) translateY(12px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.lc{transform-style:preserve-3d;box-shadow:0 6px 0 rgba(0,0,0,.18),0 10px 0 rgba(0,0,0,.08),0 20px 40px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.4) !important;background:linear-gradient(160deg,rgba(255,255,255,.5) 0%,rgba(255,255,255,.2) 40%,rgba(255,255,255,.05) 100%) !important;border:2px solid rgba(255,255,255,.55) !important;transition:all .35s cubic-bezier(.34,1.56,.64,1) !important}
.lc:hover{transform:translateY(-8px) scale(1.1) rotateX(5deg) !important;box-shadow:0 12px 0 rgba(0,0,0,.12),0 20px 0 rgba(0,0,0,.05),0 32px 60px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.6) !important}
.lc:active{transform:translateY(2px) scale(.96) !important}
.lc.current{animation:currentGlow 2.5s ease-in-out infinite,cardFloat 3s ease-in-out infinite !important;border-color:#fbbf24 !important}
@keyframes currentGlow{0%,100%{box-shadow:0 0 15px rgba(251,191,36,.4),0 6px 0 rgba(0,0,0,.15)}50%{box-shadow:0 0 30px rgba(251,191,36,.7),0 0 60px rgba(251,191,36,.2),0 6px 0 rgba(0,0,0,.12)}}
.card-front{box-shadow:0 6px 0 rgba(0,0,0,.2),0 8px 0 rgba(0,0,0,.1),0 14px 28px rgba(0,0,0,.15),inset 0 2px 0 rgba(255,255,255,.35) !important;background:linear-gradient(165deg,var(--cf1,#6366f1),var(--cf2,#4f46e5),rgba(0,0,0,.15)) !important}
.card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 10px 0 rgba(0,0,0,.15),0 14px 0 rgba(0,0,0,.08),0 20px 36px rgba(0,0,0,.18),inset 0 2px 0 rgba(255,255,255,.4) !important;transform:scale(1.08) !important}
.card:not(.flipped):not(.matched):active .card-front{transform:scale(.94) !important;box-shadow:0 2px 0 rgba(0,0,0,.2),0 3px 6px rgba(0,0,0,.1) !important}
.card-back{box-shadow:0 6px 0 rgba(99,102,241,.2),0 8px 0 rgba(99,102,241,.1),0 14px 24px rgba(0,0,0,.1),inset 0 -2px 0 rgba(0,0,0,.04),inset 0 2px 0 rgba(255,255,255,.6) !important;background:linear-gradient(180deg,#fff,#f5f3ff,#ede9fe) !important}
.g-stat{box-shadow:0 3px 0 rgba(0,0,0,.1),0 4px 8px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .2s}
.f-btn{box-shadow:0 4px 0 rgba(0,0,0,.12),0 6px 10px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .2s cubic-bezier(.34,1.56,.64,1) !important}
.f-btn:hover{transform:translateY(-3px) scale(1.05) !important;box-shadow:0 7px 0 rgba(0,0,0,.1),0 10px 16px rgba(0,0,0,.08) !important}
.f-btn:active{transform:translateY(2px) scale(.96) !important;box-shadow:0 1px 0 rgba(0,0,0,.12) !important}
.d-stars span{display:inline-block;animation:starPop3D .6s cubic-bezier(.34,1.56,.64,1) both}
.d-stars span:nth-child(1){animation-delay:.1s}
.d-stars span:nth-child(2){animation-delay:.3s}
.d-stars span:nth-child(3){animation-delay:.5s}
@keyframes starPop3D{0%{transform:scale(0) rotateY(180deg);opacity:0}60%{transform:scale(1.3) rotateY(45deg);opacity:1}100%{transform:scale(1) rotateY(0deg);opacity:1}}
.d-st{box-shadow:0 4px 0 rgba(0,0,0,.1),0 8px 16px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.2) !important;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.d-st:hover{transform:translateY(-3px) scale(1.05)}
.d-btn.pri{box-shadow:0 6px 0 #c2410c,0 8px 0 #9a3412,0 14px 24px rgba(249,115,22,.3) !important}
.d-btn.pri:hover{transform:translateY(-3px) scale(1.06) !important;box-shadow:0 9px 0 #c2410c,0 12px 0 #9a3412,0 20px 32px rgba(249,115,22,.35) !important}
.d-btn.pri:active{transform:translateY(3px) scale(.96) !important;box-shadow:0 2px 0 #c2410c !important}
.d-btn.shr{box-shadow:0 6px 0 #1d4ed8,0 8px 0 #1e40af,0 14px 24px rgba(37,99,235,.3) !important}
.d-btn.sec{box-shadow:0 4px 0 rgba(0,0,0,.15),0 6px 12px rgba(0,0,0,.08) !important}
.d-emoji{animation:doneBounce3D 1.5s cubic-bezier(.34,1.56,.64,1) infinite !important;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3)) !important}
@keyframes doneBounce3D{0%,100%{transform:translateY(0) scale(1) rotateZ(0)}25%{transform:translateY(-12px) scale(1.05) rotateZ(-3deg)}50%{transform:translateY(-6px) scale(1.02) rotateZ(0)}75%{transform:translateY(-12px) scale(1.05) rotateZ(3deg)}}
.card.flipped .card-inner{transition:transform .5s cubic-bezier(.34,1.56,.64,1) !important}
.grid{filter:drop-shadow(0 4px 16px rgba(0,0,0,.1))}
/* ===== END ROYAL MATCH 3D ===== */
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="lvl-screen" class="screen active">
  <div class="ls-title" id="ls-t">ğŸ§  Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
  <div class="coins-bar">
    <div class="coin-display"><span class="coin-icon">ğŸª™</span> <span id="coin-count">0</span></div>
    <button class="nav-btn shop" onclick="showScreen('shop-screen')">ğŸ›’ <span id="nav-shop-txt">Ø§Ù„Ù…ØªØ¬Ø±</span></button>
    <button class="nav-btn badges" onclick="showScreen('badge-screen')">ğŸ… <span id="nav-badge-txt">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</span></button>
  </div>
  <div class="ls-sub" id="ls-s">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„ØªØ¨Ø¯Ø£!</div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- SHOP -->
<div id="shop-screen" class="screen">
  <div class="shop-title" id="shop-t">ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±</div>
  <div class="shop-coins"><span class="coin-icon">ğŸª™</span> <span id="shop-coins">0</span></div>
  <div class="shop-grid" id="shop-grid"></div>
  <div class="g-foot"><button class="f-btn" onclick="showScreen('lvl-screen')">ğŸ  Ø±Ø¬ÙˆØ¹</button></div>
</div>

<!-- BADGES -->
<div id="badge-screen" class="screen">
  <div class="badge-title" id="badge-t">ğŸ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
  <div class="badge-sub" id="badge-sub">0/10</div>
  <div class="badge-grid" id="badge-grid"></div>
  <div class="g-foot"><button class="f-btn" onclick="showScreen('lvl-screen')">ğŸ  Ø±Ø¬ÙˆØ¹</button></div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <canvas id="bg-canvas"></canvas>
  <div class="g-hdr">
    <div style="display:flex;align-items:center;gap:5px">
      <span class="g-title" id="g-t">Memory</span>
      <span class="g-badge" id="g-b">1</span>
    </div>
    <div class="g-stats">
      <div class="g-stat"><div class="g-sv" id="g-mv">0</div><div class="g-sl" id="g-mvl">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div></div>
      <div class="g-stat"><div class="g-sv" id="g-pr">0/8</div><div class="g-sl" id="g-prl">Ø§Ù„Ø£Ø²ÙˆØ§Ø¬</div></div>
      <div class="g-stat"><div class="g-sv" id="g-tm">0:00</div><div class="g-sl" id="g-tml">Ø§Ù„ÙˆÙ‚Øª</div></div>
    </div>
  </div>
  <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;position:relative;z-index:12"><div class="mech-info" id="mech-info" style="display:none"></div><div class="dda-badge normal" id="dda-badge" style="display:none"></div></div>
  <div class="cd-wrap" id="cd-wrap" style="display:none">
    <div class="cd-hdr"><span class="cd-txt" id="cd-text">â±ï¸ 2:00</span><span class="cd-txt" id="cd-label"></span></div>
    <div class="cd-bar"><div class="cd-fill" id="cd-fill" style="width:100%"></div></div>
  </div>
  <div class="grid-wrap">
    <div class="peek-banner" id="peek-banner"><span id="peek-text">ğŸ‘€</span></div>
    <div class="grid" id="grid"></div>
  </div>
  <p class="hint" id="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡!</p>
  <div class="g-foot">
    <button class="f-btn" onclick="showScreen('lvl-screen')">ğŸ  Ø±Ø¬ÙˆØ¹</button>
  </div>
</div>

<!-- COMPLETE -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">ğŸ‰</div>
  <div class="d-title" id="d-t">Ù…Ø¨Ø±ÙˆÙƒ!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">ğŸ†</div><div class="d-st-v" id="d-sc">0</div><div class="d-st-l" id="d-scl">Ø§Ù„Ù†Ù‚Ø§Ø·</div></div>
    <div class="d-st"><div class="d-st-e">ğŸ¯</div><div class="d-st-v" id="d-mv2">0</div><div class="d-st-l" id="d-mvl2">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div></div>
    <div class="d-st"><div class="d-st-e">â±ï¸</div><div class="d-st-v" id="d-tm">0:00</div><div class="d-st-l" id="d-tml">Ø§Ù„ÙˆÙ‚Øª</div></div>
  </div>
  <div class="coin-earned" id="d-coins" style="display:none"><span class="coin-icon">ğŸª™</span> +<span id="d-coins-val">0</span></div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">â¡ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
    <button class="d-btn sec" onclick="replayLevel()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
    <button class="d-btn sec" onclick="showScreen('lvl-screen')">ğŸ  Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>
  </div>
</div>

<!-- ===== ROYAL MATCH 3D PARTICLE SYSTEM ===== -->
<script>
(function(){
const c=document.createElement('canvas');
c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9999';
document.body.appendChild(c);
const ctx=c.getContext('2d');
let P=[],raf=null;
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener('resize',resize);resize();

window.spawnConfetti=function(x,y,n){
  n=n||40;
  const cols=['#FF6B6B','#4ECDC4','#45B7D1','#FFEAA7','#DDA0DD','#FF69B4','#98D8C8','#F7DC6F','#BB8FCE','#85C1E9','#F8C471','#82E0AA'];
  for(let i=0;i<n;i++){
    P.push({x:x||Math.random()*c.width,y:y||c.height*.3,
      vx:(Math.random()-.5)*14,vy:-Math.random()*16-3,
      w:Math.random()*10+4,h:Math.random()*6+3,
      color:cols[Math.floor(Math.random()*cols.length)],
      rot:Math.random()*360,rs:(Math.random()-.5)*15,
      g:.25+Math.random()*.2,life:1,d:.006+Math.random()*.007})}
  if(!raf)loop()};

window.spawnFirework=function(x,y){
  const cols=['#FFD700','#FF4500','#00FF7F','#1E90FF','#FF69B4','#FFA500','#E74C3C','#2ECC71','#9B59B6','#F39C12'];
  const col=cols[Math.floor(Math.random()*cols.length)];
  for(let i=0;i<50;i++){
    const a=(i/50)*Math.PI*2,sp=2+Math.random()*6;
    P.push({t:'fw',x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      r:1.5+Math.random()*3,color:col,life:1,d:.012+Math.random()*.012,g:.06})}
  if(!raf)loop()};

window.spawn3DStars=function(x,y,n){
  const em=['\u2b50','\ud83c\udf1f','\u2728','\ud83d\udcab','\ud83c\udf86','\ud83d\udc8e','\ud83c\udfc6','\ud83c\udf89','\ud83c\udf8a','\ud83d\udc51'];
  for(let i=0;i<(n||8);i++){
    P.push({t:'em',x:x+(Math.random()-.5)*100,y:y,
      vx:(Math.random()-.5)*6,vy:-Math.random()*10-3,
      em:em[Math.floor(Math.random()*em.length)],
      sz:18+Math.random()*24,life:1,d:.009,g:.12,rot:0,rs:(Math.random()-.5)*10})}
  if(!raf)loop()};

window.royalCelebration=function(stars){
  stars=stars||1;
  for(let w=0;w<Math.min(stars+1,4);w++)
    setTimeout(()=>{
      spawnConfetti(c.width*(.2+Math.random()*.6),c.height*(.2+Math.random()*.2),25+stars*10);
    },w*350);
  for(let f=0;f<Math.min(stars,3);f++)
    setTimeout(()=>{
      spawnFirework(c.width*(.15+Math.random()*.7),c.height*(.1+Math.random()*.25));
    },200+f*600);
  setTimeout(()=>spawn3DStars(c.width/2,c.height*.45,stars*4),100);
};

function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=P.length-1;i>=0;i--){
    const p=P[i];
    p.life-=p.d;
    if(p.life<=0){P.splice(i,1);continue}
    p.vy+=(p.g||.2);p.x+=p.vx;p.y+=p.vy;p.rot=(p.rot||0)+(p.rs||0);
    ctx.save();ctx.globalAlpha=Math.min(1,p.life*1.5);
    ctx.translate(p.x,p.y);ctx.rotate((p.rot||0)*Math.PI/180);
    if(p.t==='fw'){
      ctx.beginPath();ctx.arc(0,0,p.r*p.life,0,Math.PI*2);ctx.fillStyle=p.color;ctx.fill();
      ctx.globalAlpha=p.life*.3;ctx.beginPath();ctx.arc(-p.vx*.5,-p.vy*.5,p.r*p.life*.6,0,Math.PI*2);ctx.fill();
    } else if(p.t==='em'){
      ctx.font=p.sz+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.em,0,0);
    } else {
      ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    }
    ctx.restore()}
  raf=P.length>0?requestAnimationFrame(loop):null}
})();
</script>

<!-- ===== DYNAMIC BACKGROUND ANIMATION SYSTEM ===== -->
<script>
(function(){
const bgC=document.getElementById('bg-canvas');
if(!bgC)return;
const bgX=bgC.getContext('2d');
let parts=[],grp=-1,raf=null,active=false;

const FX=[
  // Group 0: Nature â€” floating leaves, butterflies
  {e:['ğŸƒ','ğŸŒ¿','ğŸ¦‹','ğŸ','ğŸŒ¸','â˜˜ï¸','ğŸŒ»','ğŸ€','ğŸŒº','ğŸ'],n:22,sp:0.35,t:'float'},
  // Group 1: Ocean â€” rising bubbles, fish
  {e:['ğŸ«§','ğŸ’§','ğŸŸ','ğŸ ','ğŸš','ğŸŒŠ','ğŸª¸','ğŸ¬','ğŸ¡','ğŸ¦ˆ'],n:26,sp:0.5,t:'rise'},
  // Group 2: City/Food â€” twinkling sparkles
  {e:['âœ¨','â­','ğŸŒŸ','ğŸ’«','ğŸ†','ğŸ‡','ğŸª','ğŸ ','ğŸ¡','ğŸ¢'],n:20,sp:0.25,t:'twinkle'},
  // Group 3: Adventure â€” shooting stars, meteors
  {e:['â­','ğŸ’«','â˜„ï¸','âœ¨','ğŸŒŸ','ğŸ”¥','ğŸ’¥','ğŸŒ ','ğŸ¹','âš”ï¸'],n:14,sp:1.2,t:'shoot'},
  // Group 4: Tech â€” matrix falling code
  {e:['âš¡','ğŸ’','ğŸ”®','ğŸ’ ','ğŸ¤–','âš™ï¸','ğŸ“¡','ğŸ’¾','ğŸ”¬','ğŸ’»'],n:32,sp:0.45,t:'fall'},
];

function resize(){
  const p=bgC.parentElement;
  if(p){bgC.width=p.clientWidth;bgC.height=p.clientHeight}
}

function mkP(fx,init){
  const w=bgC.width||innerWidth,h=bgC.height||innerHeight;
  const p={
    x:Math.random()*w,
    y:init?Math.random()*h:(fx.t==='fall'||fx.t==='shoot'?-30:h+30),
    e:fx.e[Math.floor(Math.random()*fx.e.length)],
    sz:10+Math.random()*16,
    sp:fx.sp*(0.4+Math.random()*0.8),
    op:0.12+Math.random()*0.35,
    ph:Math.random()*Math.PI*2,
    dr:(Math.random()-0.5)*0.25,
    rot:0,rs:(Math.random()-0.5)*0.5
  };
  if(fx.t==='shoot'){p.vx=-0.8-Math.random()*1.5;p.vy=0.4+Math.random()*1.2}
  return p;
}

function loop(){
  if(!active){raf=null;return}
  const w=bgC.width,h=bgC.height;
  bgX.clearRect(0,0,w,h);
  const fx=FX[grp];
  if(!fx){raf=requestAnimationFrame(loop);return}

  for(let i=0;i<parts.length;i++){
    const p=parts[i];
    p.ph+=0.015;
    p.rot+=p.rs;

    if(fx.t==='float'){
      p.y-=p.sp;p.x+=Math.sin(p.ph)*0.4+p.dr;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30}
    } else if(fx.t==='rise'){
      p.y-=p.sp;p.x+=Math.sin(p.ph)*0.55;
      p.sz+=Math.sin(p.ph*2)*0.03;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30}
    } else if(fx.t==='twinkle'){
      p.op=0.08+Math.abs(Math.sin(p.ph))*0.45;
      p.sz=10+Math.sin(p.ph*1.3)*5;
      p.y-=p.sp*0.15;
      if(p.y<-40){Object.assign(p,mkP(fx,false));p.y=h+30;p.x=Math.random()*w}
    } else if(fx.t==='shoot'){
      p.x+=p.vx;p.y+=p.vy;
      if(p.x<-50||p.y>h+50){Object.assign(p,mkP(fx,false));p.y=-30;p.x=Math.random()*w}
    } else if(fx.t==='fall'){
      p.y+=p.sp;
      p.op=0.08+Math.abs(Math.sin(p.ph))*0.3;
      if(p.y>h+40){Object.assign(p,mkP(fx,false));p.y=-30;p.x=Math.random()*w}
    }

    bgX.save();
    bgX.globalAlpha=p.op;
    bgX.translate(p.x,p.y);
    bgX.rotate(p.rot*Math.PI/180);
    bgX.font=Math.round(p.sz)+'px serif';
    bgX.textAlign='center';bgX.textBaseline='middle';
    bgX.fillText(p.e,0,0);
    bgX.restore();
  }
  raf=requestAnimationFrame(loop);
}

window.initBg=function(g){
  grp=g;parts=[];active=true;
  resize();
  const fx=FX[g];
  if(fx){for(let i=0;i<fx.n;i++)parts.push(mkP(fx,true))}
  if(!raf)loop();
};

window.stopBg=function(){
  active=false;grp=-1;
  if(bgC.width)bgX.clearRect(0,0,bgC.width,bgC.height);
};

addEventListener('resize',function(){
  resize();
  if(active&&grp>=0){
    const fx=FX[grp];
    if(fx){
      parts=[];
      for(let i=0;i<fx.n;i++)parts.push(mkP(fx,true));
    }
  }
});
})();
</script>

<!-- ===== MAIN GAME ===== -->
<script>
// ===== i18n =====
const LANG=new URLSearchParams(location.search).get('lang')||'ar';
document.documentElement.lang=LANG;document.documentElement.dir=LANG==='ar'?'rtl':'ltr';
const I={
ar:{title:'ğŸ§  Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©',sub:'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„ØªØ¨Ø¯Ø£!',moves:'Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª',pairs:'Ø§Ù„Ø£Ø²ÙˆØ§Ø¬',sets:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',time:'Ø§Ù„ÙˆÙ‚Øª',hint:'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡!',score:'Ø§Ù„Ù†Ù‚Ø§Ø·',congrats:'Ù…Ø¨Ø±ÙˆÙƒ!',excellent:'ğŸŒŸ Ù…Ù…ØªØ§Ø²!',great:'ğŸ‰ Ø£Ø­Ø³Ù†Øª!',good:'ğŸ‘ Ø¬ÙŠØ¯!',tryMore:'ğŸ’ª Ø­Ø§ÙˆÙ„ Ø£ÙƒØ«Ø±!',done:'Ø£ØªÙ…Ù…Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰!',next:'â¡ï¸ Ø§Ù„ØªØ§Ù„ÙŠ',share:'ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©',again:'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©',levels:'ğŸ  Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª',back:'ğŸ  Ø±Ø¬ÙˆØ¹',locked:'ğŸ”’',mech:{timed:'â±ï¸ ØªØ°ÙƒÙ‘Ø±!',moving:'ğŸ”€ Ù…ØªØ­Ø±ÙƒØ©!',masked:'ğŸ­ Ù…ÙÙ‚Ù†Ù‘Ø¹Ø©!',fog:'ğŸŒ«ï¸ Ø¶Ø¨Ø§Ø¨!',triple:'ğŸ”± Ø«Ù„Ø§Ø«ÙŠ!',boss:'ğŸ‘‘ Ø§Ù„Ø²Ø¹ÙŠÙ…!'},mechHint:{timed:'ØªØ°ÙƒØ± Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª!',moving:'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªØªØ¨Ø¯Ù„ ÙƒÙ„ Ù£ Ù…Ø­Ø§ÙˆÙ„Ø§Øª!',masked:'Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ®Ø¯Ø¹Ùƒ!',fog:'Ø§Ø¶ØºØ· Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹!',triple:'Ø·Ø§Ø¨Ù‚ Ù£ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø©!',boss:'ÙƒÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª + Ù…Ø¤Ù‚Øª!'},timeUp:'â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!',remember:'ğŸ‘€ ØªØ°ÙƒÙ‘Ø±!',shuffling:'ğŸ”€ ØªØ¨Ø¯ÙŠÙ„...',
shareText:'Ø­Ù‚Ù‚Øª {score} Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {level} Ù…Ù† Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©! â­{stars}',dda:{easy:'ğŸŸ¢ Ø³Ù‡Ù„',normal:'ğŸ”µ Ø¹Ø§Ø¯ÙŠ',hard:'ğŸ”´ ØµØ¹Ø¨'},hintMsg:'ğŸ’¡ ØªÙ„Ù…ÙŠØ­!',
shop:'ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±',badges:'ğŸ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª',coinsEarned:'+{n} Ø¹Ù…Ù„Ø©',buy:'Ø´Ø±Ø§Ø¡',equip:'ØªØ¬Ù‡ÙŠØ²',equipped:'âœ… Ù…Ø¬Ù‡Ø²',cantAfford:'Ù„Ø§ ÙŠÙƒÙÙŠ',owned:'Ù…Ù…Ù„ÙˆÙƒ',newBadge:'ğŸ‰ Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯!',badgeCount:'{n}/{total} Ø¥Ù†Ø¬Ø§Ø²',
badgeNames:['ğŸ£ Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©','â­ Ø¬Ø§Ù…Ø¹ Ø§Ù„Ù†Ø¬ÙˆÙ…','ğŸŒŸ Ø³ÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…','ğŸ† Ø¬ÙˆÙ„Ø© Ù…Ø«Ø§Ù„ÙŠØ©','ğŸŒ¿ Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©','ğŸŒŠ ØºÙˆØ§Øµ Ø§Ù„Ù…Ø­ÙŠØ·','ğŸ™ï¸ Ù…ØªØ¬ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©','âš”ï¸ Ø§Ù„Ù…ØºØ§Ù…Ø±','ğŸ¤– Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„ØªÙ‚Ù†ÙŠØ©','ğŸ‘‘ Ø¨Ø·Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…'],
badgeDescs:['Ø£ÙƒÙ…Ù„ Ø£ÙˆÙ„ Ù…Ø³ØªÙˆÙ‰','Ø§Ø¬Ù…Ø¹ 10 Ù†Ø¬ÙˆÙ…','Ø§Ø¬Ù…Ø¹ 30 Ù†Ø¬Ù…Ø©','Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 3 Ù†Ø¬ÙˆÙ…','Ø£ÙƒÙ…Ù„ Ù…Ø³ØªÙˆÙŠØ§Øª 1-4','Ø£ÙƒÙ…Ù„ Ù…Ø³ØªÙˆÙŠØ§Øª 5-8','Ø£ÙƒÙ…Ù„ Ù…Ø³ØªÙˆÙŠØ§Øª 9-12','Ø£ÙƒÙ…Ù„ Ù…Ø³ØªÙˆÙŠØ§Øª 13-16','Ø£ÙƒÙ…Ù„ Ù…Ø³ØªÙˆÙŠØ§Øª 17-20','Ø£ÙƒÙ…Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª'],
themeNames:['Ø§ÙØªØ±Ø§Ø¶ÙŠ','âœ¨ Ù…Ø¬Ø±Ù‘Ø©','ğŸ¬ Ø­Ù„ÙˆÙ‰','ğŸ’ Ø£Ù„Ù…Ø§Ø³','ğŸ”¥ Ù†Ø§Ø±','ğŸŒˆ Ù‚ÙˆØ³ Ù‚Ø²Ø­'],
lvNames:['Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª','Ø³Ù„Ø© Ø§Ù„ÙÙˆØ§ÙƒÙ‡','Ø¹Ø§Ù„Ù… Ø§Ù„Ø¨Ø­Ø§Ø±','Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø­Ø´Ø±Ø§Øª','Ø³Ù…Ø§Ø¡ ÙˆØ·Ù‚Ø³','Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„ÙˆØ±Ø¯','ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø®Ø¶Ø§Ø±','Ù…Ø·Ø¨Ø® Ù„Ø°ÙŠØ°','Ø¹Ø§Ù„Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª','Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„ÙØ¶Ø§Ø¡','Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©','Ø¹Ø§Ù„Ù… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰','Ø±Ø­Ù„Ø© Ø§Ù„Ø³ÙØ§Ø±ÙŠ','Ø¹Ø§Ù„Ù… Ø§Ù„Ø·ÙŠÙˆØ±','ÙˆØ±Ø´Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª','Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ø²ÙŠØ§Ø¡','Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ','ÙŠÙˆÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©','Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©','ğŸŒ Ø¨Ø·Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…']},
en:{title:'ğŸ§  Memory Match',sub:'Choose a level to start!',moves:'Moves',pairs:'Pairs',sets:'Sets',time:'Time',hint:'Tap any card to start!',score:'Score',congrats:'Congrats!',excellent:'ğŸŒŸ Excellent!',great:'ğŸ‰ Great!',good:'ğŸ‘ Good!',tryMore:'ğŸ’ª Try More!',done:'Level complete!',next:'â¡ï¸ Next',share:'ğŸ“¤ Share',again:'ğŸ”„ Replay',levels:'ğŸ  Levels',back:'ğŸ  Back',locked:'ğŸ”’',mech:{timed:'â±ï¸ Peek!',moving:'ğŸ”€ Moving!',masked:'ğŸ­ Masked!',fog:'ğŸŒ«ï¸ Fog!',triple:'ğŸ”± Triple!',boss:'ğŸ‘‘ Boss!'},mechHint:{timed:'Memorize the cards!',moving:'Cards shuffle every 3 moves!',masked:'Some cards trick you first!',fog:'Tap fog to reveal!',triple:'Match 3 cards!',boss:'All challenges + timer!'},timeUp:'â° Time\'s up!',remember:'ğŸ‘€ Remember!',shuffling:'ğŸ”€ Shuffling...',
shareText:'I scored {score} on Level {level} in Memory Match! â­{stars}',dda:{easy:'ğŸŸ¢ Easy',normal:'ğŸ”µ Normal',hard:'ğŸ”´ Hard'},hintMsg:'ğŸ’¡ Hint!',
shop:'ğŸ›’ Shop',badges:'ğŸ… Badges',coinsEarned:'+{n} coins',buy:'Buy',equip:'Equip',equipped:'âœ… Equipped',cantAfford:'Not enough',owned:'Owned',newBadge:'ğŸ‰ New Badge!',badgeCount:'{n}/{total} badges',
badgeNames:['ğŸ£ First Steps','â­ Star Collector','ğŸŒŸ Star Master','ğŸ† Perfect Round','ğŸŒ¿ Nature Explorer','ğŸŒŠ Ocean Diver','ğŸ™ï¸ City Walker','âš”ï¸ Adventurer','ğŸ¤– Tech Wizard','ğŸ‘‘ World Champion'],
badgeDescs:['Complete first level','Earn 10 stars','Earn 30 stars','Get 3 stars on any level','Complete levels 1-4','Complete levels 5-8','Complete levels 9-12','Complete levels 13-16','Complete levels 17-20','Complete all 20 levels'],
themeNames:['Default','âœ¨ Galaxy','ğŸ¬ Candy','ğŸ’ Diamond','ğŸ”¥ Fire','ğŸŒˆ Rainbow'],
lvNames:['Farm Friends','Fruit Basket','Ocean World','Bug Garden','Sky Watch','Flower Garden','Veggie Valley','Yummy Kitchen','On the Move','Space Quest','Sports Arena','Music Studio','Wild Safari','Bird Paradise','Tool Workshop','Fashion Show','City Builder','School Days','Tech World','ğŸŒ World Champion']},
pt:{title:'ğŸ§  Jogo da MemÃ³ria',sub:'Escolha um nÃ­vel!',moves:'Jogadas',pairs:'Pares',sets:'Conjuntos',time:'Tempo',hint:'Toque para comeÃ§ar!',score:'Pontos',congrats:'ParabÃ©ns!',excellent:'ğŸŒŸ Excelente!',great:'ğŸ‰ Muito Bem!',good:'ğŸ‘ Bom!',tryMore:'ğŸ’ª Tente Mais!',done:'NÃ­vel completo!',next:'â¡ï¸ PrÃ³ximo',share:'ğŸ“¤ Compartilhar',again:'ğŸ”„ Repetir',levels:'ğŸ  NÃ­veis',back:'ğŸ  Voltar',locked:'ğŸ”’',mech:{timed:'â±ï¸ Memorize!',moving:'ğŸ”€ Mover!',masked:'ğŸ­ Mascarado!',fog:'ğŸŒ«ï¸ NÃ©voa!',triple:'ğŸ”± Triplo!',boss:'ğŸ‘‘ Chefe!'},mechHint:{timed:'Memorize as cartas!',moving:'Cartas mudam a cada 3!',masked:'Algumas enganam primeiro!',fog:'Toque a nÃ©voa primeiro!',triple:'Combine 3 cartas!',boss:'Todos desafios + tempo!'},timeUp:'â° Tempo esgotado!',remember:'ğŸ‘€ Lembre-se!',shuffling:'ğŸ”€ Movendo...',
shareText:'Fiz {score} pontos no NÃ­vel {level} do Jogo da MemÃ³ria! â­{stars}',dda:{easy:'ğŸŸ¢ FÃ¡cil',normal:'ğŸ”µ Normal',hard:'ğŸ”´ DifÃ­cil'},hintMsg:'ğŸ’¡ Dica!',
shop:'ğŸ›’ Loja',badges:'ğŸ… Conquistas',coinsEarned:'+{n} moedas',buy:'Comprar',equip:'Equipar',equipped:'âœ… Equipado',cantAfford:'Sem moedas',owned:'Comprado',newBadge:'ğŸ‰ Nova Conquista!',badgeCount:'{n}/{total} conquistas',
badgeNames:['ğŸ£ Primeiros Passos','â­ Coletor de Estrelas','ğŸŒŸ Mestre Estelar','ğŸ† Rodada Perfeita','ğŸŒ¿ Explorador Natural','ğŸŒŠ Mergulhador','ğŸ™ï¸ Caminhante Urbano','âš”ï¸ Aventureiro','ğŸ¤– GÃªnio Tech','ğŸ‘‘ CampeÃ£o Mundial'],
badgeDescs:['Complete o primeiro nÃ­vel','Ganhe 10 estrelas','Ganhe 30 estrelas','3 estrelas em um nÃ­vel','Complete nÃ­veis 1-4','Complete nÃ­veis 5-8','Complete nÃ­veis 9-12','Complete nÃ­veis 13-16','Complete nÃ­veis 17-20','Complete todos 20 nÃ­veis'],
themeNames:['PadrÃ£o','âœ¨ GalÃ¡xia','ğŸ¬ Doce','ğŸ’ Diamante','ğŸ”¥ Fogo','ğŸŒˆ Arco-Ã­ris'],
lvNames:['Amigos da Fazenda','Cesta de Frutas','Mundo do Mar','Jardim de Insetos','CÃ©u e Clima','Jardim de Flores','Vale dos Vegetais','Cozinha Gostosa','Em Movimento','MissÃ£o Espacial','Arena Esportiva','EstÃºdio Musical','Safari Selvagem','ParaÃ­so dos PÃ¡ssaros','Oficina de Ferramentas','Desfile de Moda','Construtor de Cidades','Dia Escolar','Mundo Tech','ğŸŒ CampeÃ£o Mundial']}
};
const t=I[LANG]||I.en;

// ===== 1000+ EDUCATIONAL SYMBOLS =====
const POOL={
farm:['ğŸ„','ğŸ·','ğŸ‘','ğŸ','ğŸ´','ğŸ”','ğŸ“','ğŸ¦ƒ','ğŸ¤','ğŸ£','ğŸ¦†','ğŸ•','ğŸˆ','ğŸ°','ğŸ‡','ğŸ¹','ğŸ­','ğŸ¿','ğŸ¦”','ğŸ¶','ğŸ±','ğŸ®','ğŸ–','ğŸ—','ğŸ½','ğŸ','ğŸª','ğŸ«','ğŸ¦™','ğŸ','ğŸ¥','ğŸ•Š','ğŸ©','ğŸ¾','ğŸ¦','ğŸ¦¡','ğŸ¦¨','ğŸ¦¥','ğŸ¦¦','ğŸ»','ğŸ¨','ğŸ¼','ğŸ¦Š','ğŸº','ğŸ¦«','ğŸ‚','ğŸƒ','ğŸ¦„','ğŸ','ğŸ€'],
fruit:['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ‘','ğŸ’','ğŸ¥','ğŸ¥¥','ğŸ','ğŸ¥­','ğŸ…','ğŸ¥‘','ğŸ«','ğŸ«’','ğŸ¥•','ğŸ†','ğŸŒ¶','ğŸŒ½','ğŸ¥’','ğŸ¥¬','ğŸ§…','ğŸ§„','ğŸ¥œ','ğŸŒ°','ğŸ„','ğŸ ','ğŸ¥¦','ğŸ¥—','ğŸ¥£','ğŸ«™','ğŸ¥«','ğŸ¥”','ğŸ«‘','ğŸ§†','ğŸ¥™','ğŸ«“','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ§ˆ','ğŸ‹â€ğŸŸ©'],
sea:['ğŸŸ','ğŸ ','ğŸ¡','ğŸ¦ˆ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦­','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦€','ğŸ¦','ğŸš','ğŸª¸','ğŸª¼','ğŸŠ','ğŸ¢','ğŸ','ğŸ¦','ğŸ¸','ğŸ²','ğŸ‰','ğŸ¦•','ğŸ¦–','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸ¬','ğŸ™','ğŸ¦‘','ğŸ ','ğŸŸ','ğŸ¡','ğŸ¦','ğŸ¦€','ğŸ¦','ğŸš','ğŸ¢','ğŸŠ','ğŸ','ğŸ¸','ğŸ¦','ğŸª¸','ğŸª¼','ğŸ¦­','ğŸ‰','ğŸ²','ğŸ¦•','ğŸ¦–'],
bug:['ğŸ¦‹','ğŸ›','ğŸ','ğŸ','ğŸ¦—','ğŸ•·','ğŸ¦‚','ğŸœ','ğŸª²','ğŸª³','ğŸ¦Ÿ','ğŸª°','ğŸŒ','ğŸª±','ğŸŒ¿','ğŸ€','ğŸ','ğŸ‚','ğŸƒ','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸŒ¾','ğŸª´','ğŸ‹','ğŸ','ğŸ„','ğŸŒ»','ğŸŒ¸','ğŸŒ¹','ğŸŒº','ğŸŒ¼','ğŸŒ·','ğŸ’','ğŸª»','ğŸª·','ğŸ¦','ğŸ•Š','ğŸ¦‹','ğŸ›','ğŸ','ğŸ','ğŸ¦—','ğŸœ','ğŸª²','ğŸŒ','ğŸª±','ğŸ•·'],
weather:['â˜€ï¸','ğŸŒ¤','â›…','ğŸŒ¥','â˜ï¸','ğŸŒ¦','ğŸŒ§','â›ˆ','ğŸŒ©','ğŸŒ¨','â„ï¸','â˜ƒï¸','â›„','ğŸŒ¬','ğŸ’¨','ğŸŒŠ','ğŸŒˆ','ğŸŒª','ğŸŒ«','ğŸ’§','ğŸ’¦','ğŸŒ¡','ğŸ”¥','â­','ğŸŒŸ','ğŸ’«','âœ¨','â˜„ï¸','ğŸŒ™','ğŸŒ›','ğŸŒœ','ğŸŒš','ğŸŒ','ğŸŒ','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ…','ğŸŒ„','ğŸŒ‡','ğŸŒ†','ğŸ™','ğŸŒƒ','ğŸŒŒ','ğŸŒ '],
flower:['ğŸŒ¸','ğŸŒ¹','ğŸŒº','ğŸŒ»','ğŸŒ¼','ğŸŒ·','ğŸ’','ğŸª»','ğŸª·','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸŒ¾','ğŸ€','â˜˜ï¸','ğŸ','ğŸ‚','ğŸƒ','ğŸª´','ğŸ‹','ğŸ','ğŸª¹','ğŸªº','ğŸ„','ğŸŒ¿','ğŸ„','ğŸ’®','ğŸµ','ğŸŒ¸','ğŸŒ¹','ğŸŒº','ğŸŒ»','ğŸŒ¼','ğŸŒ·','ğŸ’','ğŸª»','ğŸª·','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸ€','â˜˜ï¸','ğŸ','ğŸ‚','ğŸƒ','ğŸª´'],
veggie:['ğŸ¥•','ğŸ¥¦','ğŸŒ½','ğŸ¥’','ğŸ¥¬','ğŸ§…','ğŸ§„','ğŸ¥”','ğŸ†','ğŸŒ¶','ğŸ«‘','ğŸ¥œ','ğŸŒ°','ğŸ„','ğŸ ','ğŸ«˜','ğŸ«›','ğŸ¥—','ğŸ§†','ğŸ¥™','ğŸŒ±','ğŸ¥•','ğŸ¥¦','ğŸŒ½','ğŸ¥’','ğŸ¥¬','ğŸ§…','ğŸ§„','ğŸ¥”','ğŸ†','ğŸŒ¶','ğŸ«‘','ğŸ¥œ','ğŸŒ°','ğŸ„','ğŸ ','ğŸ«˜','ğŸ«›','ğŸ¥—','ğŸ§†','ğŸŒ¿','ğŸ€','ğŸŒ¾','ğŸŒ»','ğŸŒ¼','ğŸª´','ğŸ§‚','ğŸ«™','ğŸ¥«','ğŸ§ˆ'],
food:['ğŸ•','ğŸ”','ğŸŒ®','ğŸŒ¯','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ¿','ğŸ±','ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ©','ğŸª','ğŸ¯','ğŸ¥','ğŸ¥–','ğŸ§‡','ğŸ¥','ğŸ§ˆ','ğŸ«•','ğŸ«”','ğŸ¥£','ğŸ«—','ğŸ¿','ğŸ±','ğŸ§†','ğŸ¥™','ğŸ«“'],
vehicle:['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸ','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ','ğŸ›µ','ğŸš²','ğŸ›´','ğŸ›¹','ğŸ›¼','ğŸš','ğŸ›¸','ğŸš€','ğŸ›©','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸš¢','â›µ','ğŸ›¶','ğŸš¤','ğŸ›¥','ğŸ›³','â›´','ğŸš‚','ğŸšƒ','ğŸš„','ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸš ','ğŸš¡','ğŸ›°','ğŸš'],
space:['ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ™','ğŸŒš','ğŸŒ›','ğŸŒœ','ğŸŒ','ğŸŒ','â˜€ï¸','â­','ğŸŒŸ','ğŸ’«','âœ¨','â˜„ï¸','ğŸª','ğŸ”­','ğŸ”¬','ğŸ§²','ğŸ§ª','ğŸ§«','ğŸ§¬','ğŸ’¡','ğŸ”¦','ğŸ•¯','ğŸª”','ğŸ”‹','âš¡','ğŸ›¸','ğŸš€','ğŸ›°','ğŸ“¡','ğŸŒŒ','ğŸŒ ','ğŸ†','ğŸ‡','ğŸ’¥','ğŸ”¥','ğŸ’§','ğŸŒŠ','ğŸŒ€','ğŸŒˆ'],
sport:['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸ“','ğŸ¸','ğŸ’','ğŸ¥','ğŸ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ¯','ğŸ¥Š','ğŸ¥‹','ğŸ¿','â›·','ğŸ‚','ğŸ‹ï¸','ğŸ¤¸','ğŸ¤º','ğŸ¤¾','ğŸŒï¸','ğŸ‡','ğŸ§˜','ğŸ§—','ğŸ¤¿','ğŸ„','ğŸŠ','ğŸš£','ğŸ½','ğŸ…','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ†','ğŸ–','ğŸª','ğŸ ','ğŸ¡','ğŸ¢','ğŸ›','â›º'],
music:['ğŸµ','ğŸ¶','ğŸ¼','ğŸ¹','ğŸ¸','ğŸº','ğŸ»','ğŸ¥','ğŸª˜','ğŸª—','ğŸ·','ğŸ¤','ğŸ§','ğŸ“¯','ğŸªˆ','ğŸ¬','ğŸ­','ğŸ¨','ğŸ–Œ','ğŸ–','âœï¸','ğŸ–Š','ğŸ–‹','ğŸ“','ğŸª','ğŸ ','ğŸ²','ğŸ¯','ğŸ³','ğŸ°','ğŸ®','ğŸ•¹','ğŸ“º','ğŸ“»','ğŸ“¸','ğŸ¥','ğŸ“¹','ğŸ“½','ğŸ','ğŸŸ','ğŸ’¿','ğŸ“€','ğŸ’½','ğŸ“±','ğŸ–¥','âŒ¨ï¸','ğŸ–±','ğŸ–¨','ğŸ“¢','ğŸ“£'],
wild:['ğŸ¦','ğŸ¯','ğŸ…','ğŸ†','ğŸ¦’','ğŸ¦“','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸ»','ğŸ¦Š','ğŸº','ğŸ¦Œ','ğŸ¦¬','ğŸ¦£','ğŸ¦§','ğŸ¦','ğŸ’','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ¦˜','ğŸ¦¥','ğŸ¦¨','ğŸ¦¡','ğŸ¦','ğŸ¦¦','ğŸ»â€â„ï¸','ğŸ¼','ğŸ¨','ğŸ¾','ğŸŠ','ğŸ¢','ğŸ','ğŸ¦','ğŸ¸','ğŸ²','ğŸ‰','ğŸ¦•','ğŸ¦–','ğŸ¦‹','ğŸ','ğŸ','ğŸ¦…','ğŸ¦‰','ğŸ§','ğŸ¦œ','ğŸ¦š','ğŸ¦©'],
bird:['ğŸ¦…','ğŸ¦†','ğŸ¦‰','ğŸ¦œ','ğŸ§','ğŸ¦š','ğŸ¦¢','ğŸ¦©','ğŸ¦¤','ğŸª¶','ğŸ¦','ğŸ•Š','ğŸ¦ƒ','ğŸ”','ğŸ“','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦…','ğŸ¦†','ğŸ¦‰','ğŸ¦œ','ğŸ§','ğŸ¦š','ğŸ¦¢','ğŸ¦©','ğŸª¶','ğŸ¦','ğŸ•Š','ğŸ¦ƒ','ğŸ”','ğŸ“','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦¤','ğŸª¹','ğŸªº','ğŸ¥š','ğŸ¾','ğŸŒ¿','ğŸ€','ğŸŒ²','ğŸŒ³','â˜ï¸','ğŸŒ¤','â›…','ğŸŒˆ','ğŸŒ…','ğŸ”'],
tool:['ğŸ”¨','ğŸª“','â›','ğŸ”§','ğŸª›','ğŸ”©','âš™ï¸','ğŸ—œ','ğŸªš','ğŸ“','ğŸ“','âœ‚ï¸','ğŸ–Š','ğŸ–‹','âœ’ï¸','ğŸ”‘','ğŸ—','ğŸ”’','ğŸ”“','ğŸª¤','ğŸ§²','ğŸª','ğŸ§°','ğŸªœ','ğŸª£','ğŸ§¹','ğŸ§º','ğŸ§»','ğŸª ','ğŸ§¼','ğŸ§½','ğŸª¥','ğŸª’','ğŸ”‹','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯','ğŸª”','ğŸ§¯','ğŸª¤','ğŸ“Œ','ğŸ“','ğŸ—‚','ğŸ“','ğŸ“‚','ğŸ—ƒ','ğŸ“','ğŸ–‡','ğŸ—‘'],
fashion:['ğŸ‘•','ğŸ‘–','ğŸ§£','ğŸ§¤','ğŸ§¥','ğŸ§¦','ğŸ‘—','ğŸ‘˜','ğŸ¥»','ğŸ©±','ğŸ©²','ğŸ©³','ğŸ‘™','ğŸ‘š','ğŸ‘›','ğŸ‘œ','ğŸ‘','ğŸ’','ğŸ©´','ğŸ‘','ğŸ‘Ÿ','ğŸ¥¾','ğŸ¥¿','ğŸ‘ ','ğŸ‘¡','ğŸ©°','ğŸ‘¢','ğŸ‘‘','ğŸ‘’','ğŸ©','ğŸª–','â›‘ï¸','ğŸ’„','ğŸ’','ğŸ’','ğŸ‘“','ğŸ•¶','ğŸ¥½','ğŸ“¿','ğŸ§¢','ğŸ‘•','ğŸ‘–','ğŸ§£','ğŸ§¥','ğŸ‘—','ğŸ‘˜','ğŸ’','ğŸ‘Ÿ','ğŸ¥¾','ğŸ‘ '],
building:['ğŸ ','ğŸ¡','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸ©','ğŸª','ğŸ«','ğŸ¬','ğŸ­','ğŸ¯','ğŸ°','ğŸ•Œ','ğŸ•','â›ª','ğŸ•‹','ğŸ›•','â›©','ğŸ—','ğŸš','ğŸ—¼','ğŸ—½','ğŸ—¾','ğŸ‘','â›²','â›º','ğŸ›','ğŸŸ','ğŸ—º','ğŸ–','ğŸœ','ğŸ','ğŸ','ğŸ”','â›°','ğŸŒ‹','ğŸŒ','ğŸŒ‰','ğŸŒ…','ğŸŒ„','ğŸŒ‡','ğŸŒ†','ğŸ™','ğŸŒƒ','ğŸ—»','ğŸª','ğŸ¡'],
school:['ğŸ“š','ğŸ“–','ğŸ“','ğŸ“’','ğŸ““','ğŸ“”','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“„','ğŸ“ƒ','ğŸ“‹','ğŸ“','ğŸ“','ğŸ“','âœ‚ï¸','âœï¸','ğŸ–Š','ğŸ–‹','ğŸ–','ğŸ”—','ğŸ“Œ','ğŸ“','ğŸ—‚','ğŸ“','ğŸ“‚','ğŸ—ƒ','ğŸ—„','ğŸ—‘','ğŸ“°','ğŸ—','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ—’','ğŸ—“','ğŸ“†','ğŸ“…','ğŸ”–','ğŸ“®','ğŸ“¬','ğŸ“­','ğŸ“ª','ğŸ“«','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ'],
tech:['ğŸ’»','ğŸ–¥','ğŸ–¨','âŒ¨ï¸','ğŸ–±','ğŸ’½','ğŸ’¾','ğŸ’¿','ğŸ“±','ğŸ“²','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ“º','ğŸ“»','ğŸ“¡','ğŸ”Œ','ğŸ”‹','ğŸ’¡','ğŸ“Ÿ','ğŸ“ ','ğŸ•¹','ğŸ®','ğŸ§','ğŸ”¬','ğŸ”­','ğŸ“¡','ğŸ›°','ğŸ’»','ğŸ–¥','âŒ¨ï¸','ğŸ–±','ğŸ“±','ğŸ“²','ğŸ“·','ğŸ“¹','ğŸ“º','ğŸ“»','ğŸ”Œ','ğŸ”‹','ğŸ’¡','ğŸ•¹','ğŸ®','ğŸ§','ğŸ”¬','ğŸ”­','ğŸ›°','ğŸ“¡','âŒš','ğŸ¤–'],
mix:['ğŸ„','ğŸ','ğŸŸ','ğŸ¦‹','â˜€ï¸','ğŸŒ¸','ğŸ¥•','ğŸ•','ğŸš—','ğŸŒ','âš½','ğŸµ','ğŸ¦','ğŸ¦…','ğŸ”¨','ğŸ‘•','ğŸ ','ğŸ“š','ğŸ’»','ğŸ‰','ğŸ·','ğŸŠ','ğŸ¬','ğŸ','ğŸŒˆ','ğŸŒ¹','ğŸŒ½','ğŸ”','ğŸšŒ','ğŸª','ğŸ€','ğŸ¸','ğŸ¯','ğŸ¦‰','ğŸ”§','ğŸ‘—','ğŸ«','ğŸ“–','ğŸ“±','ğŸŠ','ğŸ´','ğŸ‡','ğŸ™','ğŸ','â­','ğŸŒ»','ğŸ†','ğŸ°','âœˆï¸','ğŸš€']
};

// ===== THEMES (base per level) =====
const THEMES=[
  {bg:'linear-gradient(135deg,#86efac,#22c55e)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fca5a5,#ef4444)',cf1:'#dc2626',cf2:'#b91c1c'},
  {bg:'linear-gradient(135deg,#67e8f9,#0891b2)',cf1:'#0891b2',cf2:'#0e7490'},
  {bg:'linear-gradient(135deg,#a3e635,#65a30d)',cf1:'#65a30d',cf2:'#4d7c0f'},
  {bg:'linear-gradient(135deg,#93c5fd,#3b82f6)',cf1:'#3b82f6',cf2:'#2563eb'},
  {bg:'linear-gradient(135deg,#f9a8d4,#ec4899)',cf1:'#ec4899',cf2:'#be185d'},
  {bg:'linear-gradient(135deg,#86efac,#16a34a)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fdba74,#ea580c)',cf1:'#ea580c',cf2:'#c2410c'},
  {bg:'linear-gradient(135deg,#cbd5e1,#475569)',cf1:'#475569',cf2:'#334155'},
  {bg:'linear-gradient(135deg,#c4b5fd,#7c3aed)',cf1:'#7c3aed',cf2:'#6d28d9'},
  {bg:'linear-gradient(135deg,#6ee7b7,#059669)',cf1:'#059669',cf2:'#047857'},
  {bg:'linear-gradient(135deg,#d8b4fe,#9333ea)',cf1:'#9333ea',cf2:'#7e22ce'},
  {bg:'linear-gradient(135deg,#fde68a,#d97706)',cf1:'#d97706',cf2:'#b45309'},
  {bg:'linear-gradient(135deg,#7dd3fc,#0284c7)',cf1:'#0284c7',cf2:'#0369a1'},
  {bg:'linear-gradient(135deg,#fb923c,#c2410c)',cf1:'#c2410c',cf2:'#9a3412'},
  {bg:'linear-gradient(135deg,#f0abfc,#a855f7)',cf1:'#a855f7',cf2:'#9333ea'},
  {bg:'linear-gradient(135deg,#a8a29e,#57534e)',cf1:'#57534e',cf2:'#44403c'},
  {bg:'linear-gradient(135deg,#60a5fa,#2563eb)',cf1:'#2563eb',cf2:'#1d4ed8'},
  {bg:'linear-gradient(135deg,#22d3ee,#0e7490)',cf1:'#0e7490',cf2:'#0891b2'},
  {bg:'linear-gradient(135deg,#fb7185,#be123c)',cf1:'#be123c',cf2:'#9f1239'},
];

// ===== SUB-THEME VARIANTS (per group â€” randomly selected each play) =====
const VARIANTS=[
  // Group 0: Nature greens/springs
  [
    {bg:'linear-gradient(150deg,#bbf7d0,#4ade80)',cf1:'#22c55e',cf2:'#16a34a'},
    {bg:'linear-gradient(120deg,#d9f99d,#84cc16)',cf1:'#65a30d',cf2:'#4d7c0f'},
    {bg:'linear-gradient(160deg,#a7f3d0,#34d399)',cf1:'#059669',cf2:'#047857'},
  ],
  // Group 1: Ocean blues/teals
  [
    {bg:'linear-gradient(150deg,#a5f3fc,#22d3ee)',cf1:'#06b6d4',cf2:'#0891b2'},
    {bg:'linear-gradient(120deg,#bfdbfe,#60a5fa)',cf1:'#2563eb',cf2:'#1d4ed8'},
    {bg:'linear-gradient(160deg,#99f6e4,#14b8a6)',cf1:'#0d9488',cf2:'#0f766e'},
  ],
  // Group 2: City/Food warm
  [
    {bg:'linear-gradient(150deg,#fecaca,#f87171)',cf1:'#ef4444',cf2:'#dc2626'},
    {bg:'linear-gradient(120deg,#fed7aa,#fb923c)',cf1:'#ea580c',cf2:'#c2410c'},
    {bg:'linear-gradient(160deg,#fde68a,#f59e0b)',cf1:'#d97706',cf2:'#b45309'},
  ],
  // Group 3: Adventure golds/coppers
  [
    {bg:'linear-gradient(150deg,#fef08a,#eab308)',cf1:'#ca8a04',cf2:'#a16207'},
    {bg:'linear-gradient(120deg,#fbbf24,#b45309)',cf1:'#92400e',cf2:'#78350f'},
    {bg:'linear-gradient(160deg,#fed7aa,#ea580c)',cf1:'#c2410c',cf2:'#9a3412'},
  ],
  // Group 4: Tech purples/neons
  [
    {bg:'linear-gradient(150deg,#e9d5ff,#a855f7)',cf1:'#9333ea',cf2:'#7e22ce'},
    {bg:'linear-gradient(120deg,#c7d2fe,#818cf8)',cf1:'#6366f1',cf2:'#4f46e5'},
    {bg:'linear-gradient(160deg,#fbcfe8,#ec4899)',cf1:'#db2777',cf2:'#be185d'},
  ],
];

// ===== CARD FRONT ICONS (per group â€” randomly selected each play) =====
const FRONT_ICONS=[
  ['â“','ğŸŒ¿','ğŸ€','ğŸŒ±','ğŸŒ»','â˜˜ï¸'],
  ['â“','ğŸŒŠ','ğŸ’§','ğŸš','ğŸ«§','ğŸª¸'],
  ['â“','âœ¨','ğŸŒŸ','ğŸ”¥','â­','ğŸ’«'],
  ['â“','ğŸ—ºï¸','âš”ï¸','ğŸ¹','ğŸ›¡ï¸','ğŸ§­'],
  ['â“','ğŸ’ ','ğŸ”®','âš¡','ğŸ¤–','ğŸ’'],
];

// ===== LEVEL CONFIG: 20 levels, increasing grid & pairs =====
const LEVELS=[
  {cat:'farm',    gridCols:3,gridRows:2,pairs:3, emoji:'ğŸ„',mechanic:'classic'},
  {cat:'fruit',   gridCols:4,gridRows:2,pairs:4, emoji:'ğŸ',mechanic:'classic'},
  {cat:'sea',     gridCols:4,gridRows:3,pairs:6, emoji:'ğŸ ',mechanic:'classic'},
  {cat:'bug',     gridCols:4,gridRows:3,pairs:6, emoji:'ğŸ¦‹',mechanic:'classic'},
  {cat:'weather', gridCols:4,gridRows:4,pairs:8, emoji:'ğŸŒ¤',mechanic:'classic'},
  {cat:'flower',  gridCols:4,gridRows:4,pairs:8, emoji:'ğŸŒ¸',mechanic:'timed'},
  {cat:'veggie',  gridCols:4,gridRows:4,pairs:8, emoji:'ğŸ¥•',mechanic:'timed'},
  {cat:'food',    gridCols:5,gridRows:4,pairs:10,emoji:'ğŸ•',mechanic:'timed'},
  {cat:'vehicle', gridCols:5,gridRows:4,pairs:10,emoji:'ğŸš—',mechanic:'moving'},
  {cat:'space',   gridCols:4,gridRows:5,pairs:10,emoji:'ğŸš€',mechanic:'moving'},
  {cat:'sport',   gridCols:6,gridRows:4,pairs:12,emoji:'âš½',mechanic:'moving'},
  {cat:'music',   gridCols:6,gridRows:4,pairs:12,emoji:'ğŸµ',mechanic:'masked'},
  {cat:'wild',    gridCols:5,gridRows:5,pairs:12,emoji:'ğŸ¦',mechanic:'masked'},
  {cat:'bird',    gridCols:6,gridRows:5,pairs:15,emoji:'ğŸ¦…',mechanic:'masked'},
  {cat:'tool',    gridCols:6,gridRows:5,pairs:15,emoji:'ğŸ”¨',mechanic:'fog'},
  {cat:'fashion', gridCols:6,gridRows:5,pairs:15,emoji:'ğŸ‘—',mechanic:'fog'},
  {cat:'building',gridCols:6,gridRows:6,pairs:18,emoji:'ğŸ ',mechanic:'fog'},
  {cat:'school',  gridCols:6,gridRows:6,pairs:12,emoji:'ğŸ“š',mechanic:'triple'},
  {cat:'tech',    gridCols:6,gridRows:6,pairs:12,emoji:'ğŸ’»',mechanic:'triple'},
  {cat:'mix',     gridCols:6,gridRows:6,pairs:18,emoji:'ğŸŒ',mechanic:'boss'},
];

// ===== AUDIO =====
let audioCtx=null;
function ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function tone(f,d,tp,v){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v||.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+(d||.15));o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+(d||.15))}catch(e){}}
function sfxFlip(){tone(523,.06,'sine',.08)}
function sfxMatch(){tone(659,.1,'sine',.12);setTimeout(()=>tone(784,.1,'sine',.12),70);setTimeout(()=>tone(988,.12,'sine',.13),140)}
function sfxNoMatch(){tone(220,.15,'sawtooth',.06)}
function sfxComplete(){[523,659,784,988,1175,1319].forEach((f,i)=>setTimeout(()=>tone(f,.18,'sine',.1),i*80))}
function sfxStar(){[880,1100,1320].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*120))}

// ===== GAME STATE =====
let cards=[],moves=0,matchedPairs=0,totalPairs=8,isChecking=false;
let gameStarted=false,startTime=null,timerInterval=null,elapsedSeconds=0;
let currentLevel=-1,currentGridCols=4,currentGridRows=4;
let currentEmoji=[];
let currentFrontIcon='â“';
let currentGroup=0;

// ===== MECHANIC STATE =====
let mechanic='classic';
let matchCount=2;
let picks=[];
let fogSet=new Set();
let maskedMap={};
let peekInProgress=false;
let movesSinceShuffle=0;
let bossCountdownSec=0;
let bossTimerId=null;

// ===== DDA (Dynamic Difficulty Adjustment) STATE =====
let dda={skill:50,streak:0,failStreak:0,lastMoveTime:0,hintTimer:null,diff:'normal'};
let levelTimerSec=0;
let levelTimerMax=0;
let levelTimerId=null;

// Load persistent DDA profile
let ddaProfile=JSON.parse(localStorage.getItem('classify_memory_dda')||'{"skill":50,"gamesPlayed":0,"totalStars":0,"avgMoveRatio":1.0}');
function saveDDA(){localStorage.setItem('classify_memory_dda',JSON.stringify(ddaProfile))}

let progress=JSON.parse(localStorage.getItem('classify_memory_progress')||'{"unlocked":1,"scores":{},"stars":{}}');
function saveProgress(){localStorage.setItem('classify_memory_progress',JSON.stringify(progress))}

// ===== WALLET (Coins) =====
let wallet=JSON.parse(localStorage.getItem('classify_memory_wallet')||'{"coins":0,"owned":["default"],"equipped":"default","totalEarned":0}');
function saveWallet(){localStorage.setItem('classify_memory_wallet',JSON.stringify(wallet))}

// ===== SHOP THEMES =====
const SHOP_ITEMS=[
  {id:'default',icon:'â“',price:0,cf1:'#6366f1',cf2:'#4f46e5',frontIcon:'â“'},
  {id:'galaxy',icon:'âœ¨',price:100,cf1:'#312e81',cf2:'#1e1b4b',frontIcon:'âœ¨'},
  {id:'candy',icon:'ğŸ¬',price:150,cf1:'#ec4899',cf2:'#be185d',frontIcon:'ğŸ¬'},
  {id:'diamond',icon:'ğŸ’',price:200,cf1:'#0ea5e9',cf2:'#0369a1',frontIcon:'ğŸ’'},
  {id:'fire',icon:'ğŸ”¥',price:250,cf1:'#ef4444',cf2:'#b91c1c',frontIcon:'ğŸ”¥'},
  {id:'rainbow',icon:'ğŸŒˆ',price:300,cf1:'#a855f7',cf2:'#6d28d9',frontIcon:'ğŸŒˆ'},
];

// ===== BADGES =====
let badgeData=JSON.parse(localStorage.getItem('classify_memory_badges')||'{"unlocked":[],"dates":{}}');
function saveBadges(){localStorage.setItem('classify_memory_badges',JSON.stringify(badgeData))}

const BADGE_DEFS=[
  {id:'first',emoji:'ğŸ£',check:()=>Object.keys(progress.stars).length>=1},
  {id:'stars10',emoji:'â­',check:()=>totalStarsEarned()>=10},
  {id:'stars30',emoji:'ğŸŒŸ',check:()=>totalStarsEarned()>=30},
  {id:'perfect',emoji:'ğŸ†',check:()=>Object.values(progress.stars).some(s=>s>=3)},
  {id:'nature',emoji:'ğŸŒ¿',check:()=>[0,1,2,3].every(i=>progress.stars[i]>=1)},
  {id:'ocean',emoji:'ğŸŒŠ',check:()=>[4,5,6,7].every(i=>progress.stars[i]>=1)},
  {id:'city',emoji:'ğŸ™ï¸',check:()=>[8,9,10,11].every(i=>progress.stars[i]>=1)},
  {id:'adventure',emoji:'âš”ï¸',check:()=>[12,13,14,15].every(i=>progress.stars[i]>=1)},
  {id:'tech',emoji:'ğŸ¤–',check:()=>[16,17,18,19].every(i=>progress.stars[i]>=1)},
  {id:'champion',emoji:'ğŸ‘‘',check:()=>progress.unlocked>20},
];
function totalStarsEarned(){return Object.values(progress.stars).reduce((s,v)=>s+(v||0),0)}

function sfxCoin(){tone(1047,.06,'sine',.08);setTimeout(()=>tone(1319,.08,'sine',.1),60)}
function sfxBadge(){[880,1047,1319,1568].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.12),i*100))}

// ===== RENDER SHOP =====
function renderShop(){
  const grid=document.getElementById('shop-grid');
  if(!grid)return;
  grid.innerHTML='';
  document.getElementById('shop-coins').textContent=wallet.coins;
  const names=t.themeNames||[];
  SHOP_ITEMS.forEach((item,i)=>{
    const isOwned=wallet.owned.includes(item.id);
    const isEquipped=wallet.equipped===item.id;
    const canBuy=wallet.coins>=item.price;
    const card=document.createElement('div');
    card.className='shop-item'+(isEquipped?' equipped':isOwned?' owned':canBuy?'':' locked');
    const preview=document.createElement('div');
    preview.className='si-preview';
    preview.style.background=`linear-gradient(145deg,${item.cf1},${item.cf2})`;
    preview.textContent=item.frontIcon;
    card.appendChild(preview);
    const name=document.createElement('div');name.className='si-name';name.textContent=names[i]||item.id;card.appendChild(name);
    if(!isOwned){
      const price=document.createElement('div');price.className='si-price';price.textContent='ğŸª™ '+item.price;card.appendChild(price);
    }
    const btn=document.createElement('button');btn.className='si-btn';
    if(isEquipped){btn.className+=' equipped';btn.textContent=t.equipped||'âœ… Equipped';btn.disabled=true}
    else if(isOwned){btn.className+=' equip';btn.textContent=t.equip||'Equip';btn.onclick=()=>{wallet.equipped=item.id;saveWallet();renderShop()}}
    else if(canBuy){btn.className+=' buy';btn.textContent=(t.buy||'Buy')+' ğŸª™'+item.price;btn.onclick=()=>{buyItem(item)}}
    else{btn.className+=' cant';btn.textContent=t.cantAfford||'Not enough';btn.disabled=true}
    card.appendChild(btn);
    grid.appendChild(card);
  });
}

function buyItem(item){
  if(wallet.coins<item.price)return;
  wallet.coins-=item.price;
  wallet.owned.push(item.id);
  wallet.equipped=item.id;
  saveWallet();
  sfxCoin();
  renderShop();
  updateCoinDisplays();
}

// ===== RENDER BADGES =====
function renderBadges(){
  const grid=document.getElementById('badge-grid');
  if(!grid)return;
  grid.innerHTML='';
  const unlockedCount=badgeData.unlocked.length;
  document.getElementById('badge-sub').textContent=(t.badgeCount||'{n}/{total}').replace('{n}',unlockedCount).replace('{total}',BADGE_DEFS.length);
  const names=t.badgeNames||[];
  const descs=t.badgeDescs||[];
  BADGE_DEFS.forEach((b,i)=>{
    const isUnlocked=badgeData.unlocked.includes(b.id);
    const card=document.createElement('div');
    card.className='badge-card'+(isUnlocked?' unlocked':' locked');
    card.innerHTML=`<div class="bc-emoji">${b.emoji}</div><div class="bc-name">${names[i]||b.id}</div><div class="bc-desc">${descs[i]||''}</div>${isUnlocked&&badgeData.dates[b.id]?'<div class="bc-date">'+badgeData.dates[b.id]+'</div>':''}`;
    grid.appendChild(card);
  });
}

// ===== CHECK BADGES =====
function checkBadges(){
  const newBadges=[];
  BADGE_DEFS.forEach(b=>{
    if(!badgeData.unlocked.includes(b.id)&&b.check()){
      badgeData.unlocked.push(b.id);
      badgeData.dates[b.id]=new Date().toLocaleDateString();
      newBadges.push(b);
    }
  });
  if(newBadges.length>0){
    saveBadges();
    showBadgePopup(newBadges[0]);
  }
}

function showBadgePopup(badge){
  const idx=BADGE_DEFS.indexOf(badge);
  const name=(t.badgeNames||[])[idx]||badge.id;
  const popup=document.createElement('div');popup.className='badge-popup';
  popup.innerHTML=`<div class="bp-emoji">${badge.emoji}</div><div class="bp-title">${t.newBadge||'ğŸ‰ New Badge!'}</div><div class="bp-name">${name}</div><button class="bp-close" onclick="this.parentElement.remove()">OK</button>`;
  document.body.appendChild(popup);
  sfxBadge();
  if(window.spawnConfetti)spawnConfetti(innerWidth/2,innerHeight*.3,30);
  setTimeout(()=>{if(popup.parentElement)popup.remove()},5000);
}

// ===== EARN COINS =====
function earnCoins(stars,isFirstTime){
  if(stars<=0)return 0;
  const base=stars===3?50:stars===2?25:10;
  const bonus=isFirstTime?20:0;
  const mechBonus=mechanic==='boss'?15:mechanic==='classic'?0:5;
  const total=base+bonus+mechBonus;
  wallet.coins+=total;
  wallet.totalEarned+=total;
  saveWallet();
  return total;
}

function spawnCoinFly(n){
  const count=Math.min(n>30?8:n>15?5:3,8);
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='coin-fly';el.textContent='ğŸª™';
      el.style.left=(innerWidth*.3+Math.random()*innerWidth*.4)+'px';
      el.style.top=(innerHeight*.45+Math.random()*40)+'px';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),1300);
    },i*120);
  }
}

function updateCoinDisplays(){
  const el=document.getElementById('coin-count');if(el)el.textContent=wallet.coins;
  const el2=document.getElementById('shop-coins');if(el2)el2.textContent=wallet.coins;
}

// ===== HELPERS =====
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function fmtTime(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0')}
function pickEmoji(cat,n){const pool=POOL[cat]||POOL.mix;const unique=[...new Set(shuffle(pool))];return unique.slice(0,n)}
function getGroup(idx){return Math.min(4,Math.floor(idx/4))}

function calcScore(moves,pairs,duration,matched){
  matched=matched||pairs;
  const ratio=matched/pairs;
  const perfect=matched;
  const extraMoves=Math.max(0,moves-perfect);
  const movePenalty=extraMoves*3;
  const graceSec=pairs*5;
  const extraSec=Math.max(0,duration-graceSec);
  const timePenalty=extraSec*0.3;
  const mechBonus=mechanic==='classic'?0:mechanic==='boss'?10:5;
  return Math.max(0,Math.min(100,Math.round((100-movePenalty-timePenalty)*ratio+mechBonus)));
}

// ===== SCREENS =====
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='lvl-screen'){renderLevelSelect();updateCoinDisplays();if(window.stopBg)stopBg();ddaClearHintTimer();stopLevelTimer()}
  if(id==='done-screen'){if(window.stopBg)stopBg()}
  if(id==='shop-screen'){renderShop()}
  if(id==='badge-screen'){renderBadges()}
}

function renderLevelSelect(){
  const g=document.getElementById('ls-g');g.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cfg=LEVELS[i];
    const grp=getGroup(i);
    const unlocked=i<progress.unlocked;
    const stars=progress.stars[i]||0;
    const isCurr=i===progress.unlocked-1;
    const card=document.createElement('div');
    card.className='lc'+(unlocked?'':' locked')+(isCurr?' current':'');
    card.setAttribute('data-grp',grp);
    if(unlocked){
      card.innerHTML=`<div class="lc-num">${i+1}</div><div class="lc-emoji">${cfg.emoji}</div><div class="lc-name">${t.lvNames[i]}</div><div class="lc-stars">${stars>=1?'â­':'â˜†'}${stars>=2?'â­':'â˜†'}${stars>=3?'â­':'â˜†'}</div>`;
      card.onclick=()=>startLevel(i);
    } else {
      card.innerHTML=`<div class="lc-num" style="opacity:.4">${i+1}</div><div class="lc-lock">${t.locked}</div><div class="lc-name" style="opacity:.4">${t.lvNames[i]}</div>`;
    }
    g.appendChild(card);
  }
}

// ===== START LEVEL =====
function startLevel(idx){
  currentLevel=idx;
  const cfg=LEVELS[idx];
  currentGroup=getGroup(idx);
  currentGridCols=cfg.gridCols;currentGridRows=cfg.gridRows;totalPairs=cfg.pairs;
  currentEmoji=pickEmoji(cfg.cat,totalPairs);

  // Pick theme: 50% base, 50% random variant
  const baseTheme=THEMES[idx];
  const groupVariants=VARIANTS[currentGroup];
  const allThemes=[baseTheme,...groupVariants];
  const theme=allThemes[Math.floor(Math.random()*allThemes.length)];

  // Pick random front icon for this group (or use shop theme)
  const equipped=SHOP_ITEMS.find(si=>si.id===wallet.equipped);
  if(equipped&&equipped.id!=='default'){
    currentFrontIcon=equipped.frontIcon;
  } else {
    const icons=FRONT_ICONS[currentGroup];
    currentFrontIcon=icons[Math.floor(Math.random()*icons.length)];
  }

  // Apply theme
  const gs=document.getElementById('game-screen');
  gs.dataset.group=currentGroup;
  gs.style.background=theme.bg;
  // Apply shop theme card colors if non-default equipped
  if(equipped&&equipped.id!=='default'){
    gs.style.setProperty('--cf1',equipped.cf1);
    gs.style.setProperty('--cf2',equipped.cf2);
  } else {
    gs.style.setProperty('--cf1',theme.cf1);
    gs.style.setProperty('--cf2',theme.cf2);
  }
  document.getElementById('done-screen').style.background=theme.bg;

  document.getElementById('g-t').textContent=t.lvNames[idx];
  document.getElementById('g-b').textContent=''+(idx+1);

  // Start dynamic background
  if(window.initBg)initBg(currentGroup);

  resetGame();
  showScreen('game-screen');

  // Render cards AFTER screen visible â€” poll until grid-wrap has real dimensions
  function tryRender(attempt){
    const wrap=document.querySelector('.grid-wrap');
    const w=wrap?wrap.clientWidth:0, h=wrap?wrap.clientHeight:0;
    if(w>30&&h>30){
      renderCards();
      if(window.initBg)initBg(currentGroup);
    } else if(attempt<20){
      setTimeout(()=>tryRender(attempt+1),50);
    }
  }
  setTimeout(()=>tryRender(0),30);

  // Timed mechanic: peek all cards briefly
  if(mechanic==='timed'){
    setTimeout(()=>doTimedPeek(),400);
  }
}

function resetGame(){
  clearInterval(timerInterval);
  if(bossTimerId){clearInterval(bossTimerId);bossTimerId=null}
  stopLevelTimer();
  picks=[];isChecking=false;
  gameStarted=false;startTime=null;elapsedSeconds=0;
  peekInProgress=false;movesSinceShuffle=0;
  fogSet=new Set();maskedMap={};
  bossCountdownSec=0;levelTimerSec=0;levelTimerMax=0;

  // Setup mechanic from current level
  const cfg=LEVELS[currentLevel];
  mechanic=cfg?cfg.mechanic||'classic':'classic';
  matchCount=(mechanic==='triple')?3:2;

  // Compute level timer
  levelTimerMax=computeLevelTimer(currentLevel,cfg?cfg.pairs:8,mechanic);

  // Init DDA
  ddaInit();

  cards=createDeck();moves=0;matchedPairs=0;
  document.getElementById('g-mv').textContent='0';
  document.getElementById('g-pr').textContent='0/'+totalPairs;
  document.getElementById('g-prl').textContent=(matchCount===3&&t.sets)?t.sets:t.pairs;
  document.getElementById('g-tm').textContent='0:00';
  document.getElementById('hint').style.display='';

  // Hide mechanic UI
  const mechInfo=document.getElementById('mech-info');
  const cdWrap=document.getElementById('cd-wrap');
  const peekBanner=document.getElementById('peek-banner');
  if(mechInfo)mechInfo.style.display='none';
  if(cdWrap)cdWrap.style.display='none';
  if(peekBanner)peekBanner.classList.remove('show');

  // Setup mechanic-specific state
  setupMechanic();
  // NOTE: renderCards() is called after showScreen() in startLevel()
}

function createDeck(){
  const chosen=currentEmoji.slice(0,totalPairs);
  let deck=[];
  if(matchCount===3){
    chosen.forEach(s=>{deck.push(s,s,s)});
  } else {
    deck=[...chosen,...chosen];
  }
  return shuffle(deck).map((s,i)=>({id:i,symbol:s,flipped:false,matched:false,unmasked:false}));
}

function renderCards(){
  const g=document.getElementById('grid');
  const wrap=document.querySelector('.grid-wrap');
  const maxW=Math.max(wrap.clientWidth-8,60),maxH=Math.max(wrap.clientHeight-8,60);
  const gap=Math.max(3,Math.min(6,maxW*.01));
  const sW=(maxW-gap*(currentGridCols-1))/currentGridCols;
  const sH=(maxH-gap*(currentGridRows-1))/currentGridRows;
  const maxSz=Math.min(Math.max(80,Math.min(maxW,maxH)*.22),160);
  const sz=Math.max(40,Math.floor(Math.min(sW,sH,maxSz)));
  g.style.gridTemplateColumns=`repeat(${currentGridCols},${sz}px)`;
  g.style.gridTemplateRows=`repeat(${currentGridRows},${sz}px)`;
  g.style.gap=gap+'px';
  g.innerHTML='';
  cards.forEach(card=>{
    const btn=document.createElement('button');
    btn.className='card'+(card.flipped?' flipped':'')+(card.matched?' matched flipped':'');
    btn.disabled=card.flipped||card.matched;
    btn.setAttribute('data-id',card.id);
    btn.innerHTML=`<div class="card-inner"><div class="card-front"><span class="icon">${currentFrontIcon}</span></div><div class="card-back"><span class="sym">${card.symbol}</span></div></div>`;
    // Fog overlay
    if((mechanic==='fog'||mechanic==='boss')&&fogSet.has(card.id)&&!card.matched&&!card.flipped){
      const fog=document.createElement('div');
      fog.className='fog-ov';fog.textContent='ğŸŒ«ï¸';
      fog.addEventListener('click',function(e){e.stopPropagation();clearFog(card.id)});
      btn.querySelector('.card-inner').appendChild(fog);
    }
    btn.style.width=sz+'px';btn.style.height=sz+'px';
    btn.addEventListener('click',()=>flipCard(card.id));
    g.appendChild(btn);
  });
}

function flipCard(id){
  if(isChecking||peekInProgress)return;
  const card=cards[id];
  if(!card||card.flipped||card.matched)return;

  // Fog: can't flip fogged cards (must tap fog first)
  if(fogSet.has(id))return;

  // Start timer on first real flip
  if(!gameStarted){
    gameStarted=true;startTime=Date.now();
    document.getElementById('hint').style.display='none';
    timerInterval=setInterval(()=>{elapsedSeconds=Math.floor((Date.now()-startTime)/1000);document.getElementById('g-tm').textContent=fmtTime(elapsedSeconds)},1000);
    // Boss countdown
    if(mechanic==='boss'&&bossCountdownSec>0)startBossCountdown();
    // Level timer (non-classic, non-boss)
    if(levelTimerMax>0)startLevelTimer();
  }

  // Masked: first flip shows decoy, then auto-hides
  if(mechanic==='masked'&&maskedMap[id]!==undefined&&!card.unmasked){
    card.flipped=true;card.unmasked=true;
    const btn=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
    if(btn){
      btn.classList.add('flipped','decoy-show');
      const sym=btn.querySelector('.sym');
      if(sym)sym.textContent=maskedMap[id];
    }
    sfxFlip();
    isChecking=true;
    setTimeout(()=>{
      card.flipped=false;
      const btn2=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
      if(btn2){
        btn2.classList.remove('flipped','decoy-show');
        btn2.disabled=false;
        const sym2=btn2.querySelector('.sym');
        if(sym2)sym2.textContent=card.symbol;
      }
      delete maskedMap[id];
      isChecking=false;
    },900);
    return;
  }

  card.flipped=true;
  updateCardDOM(id,true,false);
  sfxFlip();
  picks.push(id);

  if(picks.length<matchCount)return;

  // All picks made â€” check match
  moves++;movesSinceShuffle++;
  document.getElementById('g-mv').textContent=moves;
  const allMatch=picks.every(pid=>cards[pid].symbol===cards[picks[0]].symbol);

  if(allMatch){
    picks.forEach(pid=>{cards[pid].matched=true;updateCardDOM(pid,true,true)});
    matchedPairs++;
    document.getElementById('g-pr').textContent=matchedPairs+'/'+totalPairs;
    sfxMatch();
    spawnMatchParticles(picks[0],picks[picks.length-1]);
    ddaOnMatch();
    picks=[];
    if(matchedPairs===totalPairs)setTimeout(()=>endGame(),400);
  } else {
    isChecking=true;sfxNoMatch();
    ddaOnMismatch();
    setTimeout(()=>{
      picks.forEach(pid=>{cards[pid].flipped=false;updateCardDOM(pid,false,false)});
      picks=[];isChecking=false;
    },800);
  }

  // Moving / Boss: shuffle based on DDA-adjusted interval
  const shuffleInterval=dda.diff==='easy'?4:dda.diff==='hard'?2:3;
  if((mechanic==='moving'||mechanic==='boss')&&movesSinceShuffle>=shuffleInterval&&matchedPairs<totalPairs){
    movesSinceShuffle=0;
    setTimeout(()=>shufflePositions(),allMatch?600:1000);
  }
}

function spawnMatchParticles(id1,id2){
  try{
    [id1,id2].forEach(id=>{
      const el=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
      if(!el)return;
      const r=el.getBoundingClientRect();
      const cx=r.left+r.width/2,cy=r.top+r.height/2;
      for(let i=0;i<4;i++){
        const p=document.createElement('div');p.className='particle';
        const emojis=['â­','âœ¨','ğŸŒŸ','ğŸ’«','ğŸ’','ğŸ‰'];
        p.textContent=emojis[Math.floor(Math.random()*emojis.length)];
        p.style.left=(cx-10+Math.random()*20)+'px';
        p.style.top=(cy-10+Math.random()*20)+'px';
        p.style.fontSize='18px';
        document.body.appendChild(p);
        setTimeout(()=>p.remove(),1200);
      }
    });
  }catch(e){}
}

// ===== MECHANIC SETUP =====
function setupMechanic(){
  const infoEl=document.getElementById('mech-info');
  const cdWrap=document.getElementById('cd-wrap');

  // Show countdown bar for any level with a timer
  if(levelTimerMax>0){
    cdWrap.style.display='';
    levelTimerSec=levelTimerMax;
    updateCountdownDisplay();
  }

  if(mechanic==='classic'){return}

  // Show mechanic name + hint
  if(t.mech&&t.mech[mechanic]){
    const hint=t.mechHint?t.mechHint[mechanic]:'';
    infoEl.textContent=t.mech[mechanic]+(hint?' â€” '+hint:'');
    infoEl.style.display='';
  }

  // DDA-adjusted fog percentage
  const fogPct=dda.diff==='easy'?0.3:dda.diff==='hard'?0.5:0.4;
  const maskPct=dda.diff==='easy'?0.25:dda.diff==='hard'?0.45:0.35;

  // Fog: mark cards
  if(mechanic==='fog'){
    const nFog=Math.floor(cards.length*fogPct);
    const idxs=shuffle(cards.map(c=>c.id)).slice(0,nFog);
    idxs.forEach(i=>fogSet.add(i));
  }

  // Masked: assign decoys
  if(mechanic==='masked'){
    const nMask=Math.floor(cards.length*maskPct);
    const idxs=shuffle(cards.map(c=>c.id)).slice(0,nMask);
    idxs.forEach(i=>{
      let decoy;
      do{decoy=currentEmoji[Math.floor(Math.random()*currentEmoji.length)]}while(decoy===cards[i].symbol);
      maskedMap[i]=decoy;
    });
  }

  // Boss: fog + countdown
  if(mechanic==='boss'){
    const bossFogPct=dda.diff==='easy'?0.2:dda.diff==='hard'?0.35:0.25;
    const nFog=Math.floor(cards.length*bossFogPct);
    const idxs=shuffle(cards.map(c=>c.id)).slice(0,nFog);
    idxs.forEach(i=>fogSet.add(i));
    // DDA-adjusted boss timer
    bossCountdownSec=dda.diff==='easy'?150:dda.diff==='hard'?100:120;
    cdWrap.style.display='';
    updateCountdownDisplay();
  }
}

// ===== CLEAR FOG =====
function clearFog(id){
  fogSet.delete(id);
  const btn=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
  if(btn){
    const fog=btn.querySelector('.fog-ov');
    if(fog){fog.style.opacity='0';fog.style.transform='scale(.5)';setTimeout(()=>fog.remove(),400)}
  }
  sfxFlip();
}

// ===== TIMED PEEK =====
function doTimedPeek(){
  peekInProgress=true;
  const grid=document.getElementById('grid');
  const btns=grid.querySelectorAll('.card');
  btns.forEach(b=>b.classList.add('flipped'));
  const banner=document.getElementById('peek-banner');
  const peekText=document.getElementById('peek-text');
  if(peekText)peekText.textContent=t.remember||'ğŸ‘€ Remember!';
  if(banner)banner.classList.add('show');
  // DDA: easy gets longer peek, hard gets shorter
  const peekMs=dda.diff==='easy'?3500:dda.diff==='hard'?1800:2500;
  setTimeout(()=>{
    btns.forEach(b=>{
      if(!b.classList.contains('matched')){
        b.classList.remove('flipped');
        b.disabled=false;
      }
    });
    if(banner)banner.classList.remove('show');
    peekInProgress=false;
  },peekMs);
}

// ===== SHUFFLE POSITIONS =====
function shufflePositions(){
  if(matchedPairs>=totalPairs)return;
  const unmatched=cards.filter(c=>!c.matched);
  if(unmatched.length<4)return;

  // Unflip any picked cards first
  picks.forEach(pid=>{cards[pid].flipped=false});
  picks=[];isChecking=false;

  // Shuffle symbols among unmatched cards
  const syms=unmatched.map(c=>({symbol:c.symbol,unmasked:c.unmasked}));
  const shuffled=shuffle(syms);
  unmatched.forEach((c,i)=>{
    c.symbol=shuffled[i].symbol;
    c.flipped=false;
    c.unmasked=shuffled[i].unmasked;
  });

  // Re-render and animate
  renderCards();
  setTimeout(()=>{
    const grid=document.getElementById('grid');
    grid.querySelectorAll('.card:not(.matched)').forEach(b=>b.classList.add('shuffle-anim'));
    setTimeout(()=>grid.querySelectorAll('.shuffle-anim').forEach(b=>b.classList.remove('shuffle-anim')),600);
  },50);
}

// ===== BOSS COUNTDOWN =====
function startBossCountdown(){
  updateCountdownDisplay();
  bossTimerId=setInterval(()=>{
    bossCountdownSec--;
    updateCountdownDisplay();
    if(bossCountdownSec<=0){
      clearInterval(bossTimerId);bossTimerId=null;
      endGame();
    }
  },1000);
}

function updateCountdownDisplay(){
  const fill=document.getElementById('cd-fill');
  const text=document.getElementById('cd-text');
  if(!fill||!text)return;
  const max=mechanic==='boss'?120:levelTimerMax;
  const sec=mechanic==='boss'?bossCountdownSec:levelTimerSec;
  const pct=max>0?Math.max(0,(sec/max)*100):100;
  fill.style.width=pct+'%';
  text.textContent='â±ï¸ '+fmtTime(sec);
  text.className='cd-txt'+(sec<=Math.min(20,max*0.15)?' urgent':'');
}

// ===== DDA ENGINE =====
function computeLevelTimer(lvl,pairs,mech){
  // Base: pairs Ã— 8s for classic, less for harder mechanics
  const mechMult={classic:0,timed:8,moving:7,masked:7.5,fog:7,triple:9,boss:0};
  const mult=mechMult[mech]||8;
  if(mech==='classic')return 0; // no timer for classic
  if(mech==='boss')return 0; // boss uses its own countdown

  let base=pairs*mult;
  // DDA adjustment: struggling players get +25% time, skilled get -15%
  if(ddaProfile.skill<35) base*=1.25;
  else if(ddaProfile.skill>70) base*=0.85;
  return Math.round(base);
}

function ddaInit(){
  dda={skill:ddaProfile.skill,streak:0,failStreak:0,lastMoveTime:Date.now(),hintTimer:null,diff:'normal'};
  ddaUpdateBadge();
}

function ddaUpdateBadge(){
  const badge=document.getElementById('dda-badge');
  if(!badge)return;
  if(mechanic==='classic'&&currentLevel<3){badge.style.display='none';return}
  badge.style.display='';
  let diff,cls;
  if(dda.skill<35){diff=t.dda?t.dda.easy:'ğŸŸ¢ Easy';cls='easy'}
  else if(dda.skill>70){diff=t.dda?t.dda.hard:'ğŸ”´ Hard';cls='hard'}
  else{diff=t.dda?t.dda.normal:'ğŸ”µ Normal';cls='normal'}
  badge.textContent=diff;
  badge.className='dda-badge '+cls;
  dda.diff=cls;
}

function ddaOnMatch(){
  dda.streak++;dda.failStreak=0;
  dda.skill=Math.min(100,dda.skill+2);
  ddaClearHintTimer();
  ddaUpdateBadge();
}

function ddaOnMismatch(){
  dda.failStreak++;dda.streak=0;
  dda.skill=Math.max(0,dda.skill-1.5);
  ddaUpdateBadge();
  // If 3+ consecutive fails, start hint timer
  if(dda.failStreak>=3) ddaStartHintTimer();
}

function ddaStartHintTimer(){
  ddaClearHintTimer();
  // After a pause, glow-hint one of the correct cards
  const delay=dda.diff==='easy'?4000:dda.diff==='hard'?8000:6000;
  dda.hintTimer=setTimeout(()=>{
    if(matchedPairs>=totalPairs||!gameStarted)return;
    ddaShowHint();
  },delay);
}

function ddaClearHintTimer(){
  if(dda.hintTimer){clearTimeout(dda.hintTimer);dda.hintTimer=null}
}

function ddaShowHint(){
  // Find an unmatched pair and glow one of its cards
  const unmatched=cards.filter(c=>!c.matched&&!c.flipped);
  if(unmatched.length<2)return;
  // Find a symbol that appears at least twice in unmatched
  const symCount={};
  unmatched.forEach(c=>{symCount[c.symbol]=(symCount[c.symbol]||0)+1});
  const hintSym=Object.keys(symCount).find(s=>symCount[s]>=2);
  if(!hintSym)return;
  const hintCards=unmatched.filter(c=>c.symbol===hintSym);
  const hintCard=hintCards[0];
  const btn=document.getElementById('grid').querySelector(`[data-id="${hintCard.id}"]`);
  if(btn){
    btn.classList.add('dda-hint');
    setTimeout(()=>btn.classList.remove('dda-hint'),3600);
  }
  dda.failStreak=0; // reset after giving hint
}

function ddaEndLevel(score,stars){
  // Update persistent profile
  ddaProfile.gamesPlayed++;
  ddaProfile.totalStars+=stars;
  // Weighted skill update: 70% current + 30% from this game's performance
  const perfScore=Math.min(100,score+(stars*5));
  ddaProfile.skill=Math.round(ddaProfile.skill*0.7+perfScore*0.3);
  ddaProfile.avgMoveRatio=ddaProfile.gamesPlayed>1?
    ddaProfile.avgMoveRatio*0.8+(moves/(totalPairs||1))*0.2:
    moves/(totalPairs||1);
  saveDDA();
  ddaClearHintTimer();
}

// ===== LEVEL TIMER (non-classic, non-boss) =====
function startLevelTimer(){
  if(levelTimerMax<=0)return;
  levelTimerSec=levelTimerMax;
  const cdWrap=document.getElementById('cd-wrap');
  if(cdWrap)cdWrap.style.display='';
  updateCountdownDisplay();
  levelTimerId=setInterval(()=>{
    levelTimerSec--;
    updateCountdownDisplay();
    if(levelTimerSec<=0){
      clearInterval(levelTimerId);levelTimerId=null;
      endGame();
    }
  },1000);
}

function stopLevelTimer(){
  if(levelTimerId){clearInterval(levelTimerId);levelTimerId=null}
}

function updateCardDOM(id,flipped,matched){
  const btn=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
  if(!btn)return;
  btn.className='card'+(flipped?' flipped':'')+(matched?' matched':'');
  btn.disabled=flipped||matched;
}

function endGame(){
  clearInterval(timerInterval);
  if(bossTimerId){clearInterval(bossTimerId);bossTimerId=null}
  stopLevelTimer();
  ddaClearHintTimer();
  peekInProgress=false;
  const dur=Math.floor((Date.now()-startTime)/1000);
  const isPartial=matchedPairs<totalPairs;
  const sc=calcScore(moves,totalPairs,dur,matchedPairs);
  let stars=0;if(sc>=50)stars=1;if(sc>=75)stars=2;if(sc>=90)stars=3;
  if(isPartial){stars=0}

  // DDA: update persistent profile
  ddaEndLevel(sc,stars);

  if(currentLevel>=0){
    const prev=progress.stars[currentLevel]||0;
    const isFirstTime=prev===0&&stars>=1;
    if(stars>prev)progress.stars[currentLevel]=stars;
    const prevSc=progress.scores[currentLevel]||0;if(sc>prevSc)progress.scores[currentLevel]=sc;
    if(stars>=1&&currentLevel+1>=progress.unlocked)progress.unlocked=currentLevel+2;
    saveProgress();

    // Earn coins
    const coinsGained=earnCoins(stars,isFirstTime);
    const dCoins=document.getElementById('d-coins');
    const dCoinsVal=document.getElementById('d-coins-val');
    if(coinsGained>0&&dCoins&&dCoinsVal){
      dCoinsVal.textContent=coinsGained;
      dCoins.style.display='';
      sfxCoin();
      setTimeout(()=>spawnCoinFly(coinsGained),300);
    } else if(dCoins){dCoins.style.display='none'}

    // Check badges
    setTimeout(()=>checkBadges(),1200);
  }
  let title,emoji;
  if(isPartial){title=t.timeUp||'â° Time\'s up!';emoji='â°'}
  else if(stars>=3){title=t.excellent;emoji='ğŸ†'}else if(stars>=2){title=t.great;emoji='ğŸ‰'}else if(stars>=1){title=t.good;emoji='ğŸ‘'}else{title=t.tryMore;emoji='ğŸ’ª'}
  document.getElementById('d-e').textContent=emoji;
  document.getElementById('d-t').textContent=title;
  document.getElementById('d-sub').textContent=isPartial?(matchedPairs+'/'+totalPairs):t.done;
  document.getElementById('d-sc').textContent=sc+'/100';
  document.getElementById('d-mv2').textContent=moves;
  document.getElementById('d-tm').textContent=fmtTime(dur);
  const starsEl=document.getElementById('d-st');starsEl.innerHTML='';
  for(let i=0;i<3;i++){const sp=document.createElement('span');sp.textContent=i<stars?'â­':'â˜†';sp.style.opacity=i<stars?'1':'.3';starsEl.appendChild(sp)}
  document.getElementById('d-nx').style.display=(currentLevel>=0&&currentLevel<LEVELS.length-1&&!isPartial)?'':'none';
  sfxComplete();if(stars>0)sfxStar();
  showScreen('done-screen');
  if(window.royalCelebration&&!isPartial) window.royalCelebration(stars);
  // Particles
  if(!isPartial){for(let i=0;i<stars*6;i++){setTimeout(()=>{const p=document.createElement('div');p.className='particle';p.textContent=['â­','âœ¨','ğŸŒŸ','ğŸ‰','ğŸ’'][Math.floor(Math.random()*5)];p.style.left=(Math.random()*innerWidth)+'px';p.style.top=(innerHeight*.6+Math.random()*80)+'px';p.style.fontSize='22px';document.body.appendChild(p);setTimeout(()=>p.remove(),1200)},i*70)}}
  // PostMessage
  try{window.parent.postMessage({type:'GAME_COMPLETE',score:sc,total:100,timeElapsed:dur,moves:moves,level:currentLevel>=0?currentLevel+1:0,stars:stars},'*')}catch(e){}
}

function nextLevel(){if(currentLevel>=0&&currentLevel<LEVELS.length-1)startLevel(currentLevel+1)}
function replayLevel(){if(currentLevel>=0)startLevel(currentLevel)}
function shareResult(){
  const lvl=currentLevel>=0?currentLevel+1:0;const stars=currentLevel>=0?(progress.stars[currentLevel]||0):0;
  const text=t.shareText.replace('{score}',progress.scores[currentLevel]||0).replace('{level}',lvl).replace('{stars}','â­'.repeat(stars));
  try{if(navigator.share)navigator.share({title:t.title,text:text})}catch(e){}
  try{window.parent.postMessage({type:'SHARE_ACHIEVEMENT',game:'memory',level:lvl,score:progress.scores[currentLevel]||0,stars:stars,text:text},'*')}catch(e){}
  const btn=document.getElementById('d-sh');const o=btn.textContent;btn.textContent='âœ…';setTimeout(()=>{btn.textContent=o},2000);
}

// ===== i18n APPLY =====
document.getElementById('ls-t').textContent=t.title;
document.getElementById('ls-s').textContent=t.sub;
document.getElementById('g-mvl').textContent=t.moves;
document.getElementById('g-prl').textContent=t.pairs;
document.getElementById('g-tml').textContent=t.time;
document.getElementById('hint').textContent=t.hint;
document.getElementById('d-scl').textContent=t.score;
document.getElementById('d-mvl2').textContent=t.moves;
document.getElementById('d-tml').textContent=t.time;
document.getElementById('d-nx').textContent=t.next;
document.getElementById('d-sh').textContent=t.share;
// Phase D i18n
if(t.shop)document.getElementById('nav-shop-txt').textContent=t.shop.replace(/ğŸ›’\s*/,'');
if(t.badges)document.getElementById('nav-badge-txt').textContent=t.badges.replace(/ğŸ…\s*/,'');
if(t.shop)document.getElementById('shop-t').textContent=t.shop;
if(t.badges)document.getElementById('badge-t').textContent=t.badges;

// ===== INIT =====
window.addEventListener('resize',()=>{if(document.getElementById('game-screen').classList.contains('active'))renderCards()});
updateCoinDisplays();
renderLevelSelect();
</script>
</body>
</html>

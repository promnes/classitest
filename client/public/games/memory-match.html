<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© - Memory Match</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0}
.screen.active{display:flex}

/* === LEVEL SELECT === */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(6px,1.5vmin,12px);overflow-y:auto;background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.ls-title{font-size:clamp(26px,7vmin,40px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.ls-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;flex-shrink:0;font-weight:600}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.lc{position:relative;background:linear-gradient(145deg,rgba(255,255,255,.35),rgba(255,255,255,.15));border:3px solid rgba(255,255,255,.45);border-radius:clamp(14px,3vmin,22px);padding:clamp(8px,2vmin,16px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .25s;backdrop-filter:blur(6px);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08);transform-style:preserve-3d;animation:cardFloat 3s ease-in-out infinite}
.lc:nth-child(even){animation-delay:.5s}.lc:nth-child(3n){animation-delay:1s}.lc:nth-child(4n+1){animation-delay:1.5s}
.lc:hover{transform:translateY(-4px) scale(1.06);background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.25));box-shadow:0 10px 0 rgba(0,0,0,.1),0 16px 32px rgba(0,0,0,.1)}
.lc:active{transform:translateY(3px) scale(.97);box-shadow:0 2px 0 rgba(0,0,0,.15),0 3px 8px rgba(0,0,0,.08)}
.lc.locked{opacity:.5;cursor:not-allowed;animation:none}
.lc.locked:hover{transform:none;background:rgba(255,255,255,.15);box-shadow:0 6px 0 rgba(0,0,0,.12),0 10px 24px rgba(0,0,0,.08)}
.lc.current{border-color:#fbbf24;box-shadow:0 6px 0 rgba(251,191,36,.3),0 0 18px rgba(251,191,36,.5)}
.lc-num{font-size:clamp(22px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.lc-emoji{font-size:clamp(32px,7vmin,48px);margin:3px 0;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));animation:emojiWiggle 2.5s ease-in-out infinite}
.lc:nth-child(2n) .lc-emoji{animation-delay:.3s}.lc:nth-child(3n) .lc-emoji{animation-delay:.7s}.lc:nth-child(4n) .lc-emoji{animation-delay:1.1s}.lc.locked .lc-emoji{animation:none}
.lc-name{font-size:clamp(10px,1.8vmin,14px);color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lc-stars{font-size:clamp(14px,2.8vmin,18px);margin-top:3px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(32px,7vmin,46px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}

/* === GAME === */
#game-screen{flex-direction:column;align-items:center;padding:clamp(4px,1vmin,10px);gap:clamp(3px,.8vmin,6px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2));transition:background .5s}
.g-hdr{width:100%;max-width:540px;display:flex;align-items:center;justify-content:space-between;gap:6px;flex-shrink:0}
.g-title{font-size:clamp(16px,3.2vmin,22px);font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.g-badge{font-size:clamp(12px,2.2vmin,16px);background:rgba(255,255,255,.3);color:#fff;border-radius:20px;padding:3px 10px;font-weight:800}
.g-stats{display:flex;gap:clamp(4px,1vmin,8px);align-items:center}
.g-stat{text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:2px 8px;backdrop-filter:blur(4px)}
.g-sv{font-size:clamp(18px,3.5vmin,24px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.g-sl{font-size:clamp(10px,1.8vmin,12px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.grid-wrap{flex:1;display:flex;align-items:center;justify-content:center;width:100%;min-height:0}
.grid{display:grid;gap:clamp(3px,1vmin,6px);perspective:1000px}
.card{aspect-ratio:1;border:none;background:transparent;cursor:pointer;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
.card:disabled{cursor:default}
.card-inner{position:relative;width:100%;height:100%;transition:transform .45s ease;transform-style:preserve-3d;border-radius:clamp(8px,2vmin,14px)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:clamp(8px,2vmin,14px);display:flex;align-items:center;justify-content:center}
.card-front{background:linear-gradient(145deg,var(--cf1,#6366f1),var(--cf2,#4f46e5));box-shadow:0 5px 0 rgba(0,0,0,.2),0 8px 16px rgba(0,0,0,.12);border:3px solid rgba(255,255,255,.3);transform-style:preserve-3d}
.card-front .icon{font-size:clamp(1.6rem,5.5vmin,2.6rem);filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));animation:emojiWiggle 3s ease-in-out infinite}
.card:not(.flipped):not(.matched):hover .card-front{box-shadow:0 8px 0 rgba(0,0,0,.18),0 12px 24px rgba(0,0,0,.15);transform:scale(1.06);transition:transform .15s}
.card:not(.flipped):not(.matched):active .card-front{transform:scale(.96);box-shadow:0 2px 0 rgba(0,0,0,.2),0 3px 8px rgba(0,0,0,.1)}
.card-back{background:linear-gradient(145deg,#fff,#f1f5f9);box-shadow:0 5px 0 rgba(99,102,241,.15),0 8px 16px rgba(0,0,0,.08);transform:rotateY(180deg);border:3px solid rgba(99,102,241,.25)}
.card-back .sym{font-size:clamp(2rem,7vmin,3.2rem);filter:drop-shadow(0 1px 3px rgba(0,0,0,.15));animation:emojiBreath 2s ease-in-out infinite}
.card.matched .card-inner{transform:rotateY(180deg)}
.card.matched .card-back{background:linear-gradient(145deg,#d1fae5,#a7f3d0);border-color:rgba(16,185,129,.3);box-shadow:0 0 16px rgba(16,185,129,.25);animation:mpop .4s ease}
@keyframes mpop{0%{transform:rotateY(180deg) scale(1)}50%{transform:rotateY(180deg) scale(1.12)}100%{transform:rotateY(180deg) scale(1)}}
.g-foot{display:flex;gap:clamp(4px,1vmin,8px);flex-shrink:0;flex-wrap:wrap;justify-content:center}
.f-btn{background:rgba(255,255,255,.25);border:none;border-radius:12px;padding:clamp(7px,1.8vmin,12px) clamp(14px,3.5vmin,24px);font-size:clamp(14px,2.5vmin,18px);font-weight:800;color:#fff;cursor:pointer;transition:all .2s;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.f-btn:hover{background:rgba(255,255,255,.35);transform:scale(1.04)}
.f-btn:active{transform:scale(.95)}
.hint{color:rgba(255,255,255,.9);font-size:clamp(14px,2.5vmin,18px);font-weight:600;flex-shrink:0;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}

/* === COMPLETE === */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vmin,16px);padding:clamp(12px,3vmin,24px);background:var(--bg,linear-gradient(135deg,#667eea,#764ba2))}
.d-emoji{font-size:clamp(56px,14vmin,84px);animation:bounce 1s ease infinite;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.d-title{font-size:clamp(24px,7vmin,38px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4)}
.d-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);text-align:center;font-weight:600}
.d-stars{display:flex;gap:clamp(5px,1.2vmin,8px);font-size:clamp(36px,9vmin,54px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.d-stats{display:flex;gap:clamp(8px,2vmin,16px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:12px;padding:clamp(6px,1.5vmin,12px) clamp(10px,2.5vmin,18px);backdrop-filter:blur(4px)}
.d-st-e{font-size:clamp(24px,6vmin,36px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.d-st-v{font-size:clamp(20px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.d-st-l{font-size:clamp(10px,1.8vmin,13px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.d-btns{display:flex;gap:clamp(6px,1.5vmin,10px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:14px;padding:clamp(10px,2.5vmin,16px) clamp(24px,6vmin,40px);font-size:clamp(15px,3vmin,20px);font-weight:900;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 18px rgba(249,115,22,.4)}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff;backdrop-filter:blur(4px)}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 18px rgba(37,99,235,.4)}
.particle{position:fixed;pointer-events:none;z-index:999;animation:part 1.1s ease-out forwards}
@keyframes part{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.3)}}
@keyframes cardFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes emojiWiggle{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(-6deg)}50%{transform:scale(1) rotate(0deg)}75%{transform:scale(1.15) rotate(6deg)}}
@keyframes emojiBreath{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="lvl-screen" class="screen active">
  <div class="ls-title" id="ls-t">üß† ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©</div>
  <div class="ls-sub" id="ls-s">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!</div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="g-hdr">
    <div style="display:flex;align-items:center;gap:5px">
      <span class="g-title" id="g-t">Memory</span>
      <span class="g-badge" id="g-b">1</span>
    </div>
    <div class="g-stats">
      <div class="g-stat"><div class="g-sv" id="g-mv">0</div><div class="g-sl" id="g-mvl">ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™</div></div>
      <div class="g-stat"><div class="g-sv" id="g-pr">0/8</div><div class="g-sl" id="g-prl">ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨</div></div>
      <div class="g-stat"><div class="g-sv" id="g-tm">0:00</div><div class="g-sl" id="g-tml">ÿßŸÑŸàŸÇÿ™</div></div>
    </div>
  </div>
  <div class="grid-wrap"><div class="grid" id="grid"></div></div>
  <p class="hint" id="hint">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿ®ÿ∑ÿßŸÇÿ© ŸÑŸÑÿ®ÿØÿ°!</p>
  <div class="g-foot">
    <button class="f-btn" onclick="showScreen('lvl-screen')">üè† ÿ±ÿ¨Ÿàÿπ</button>
  </div>
</div>

<!-- COMPLETE -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">üéâ</div>
  <div class="d-title" id="d-t">ŸÖÿ®ÿ±ŸàŸÉ!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">üèÜ</div><div class="d-st-v" id="d-sc">0</div><div class="d-st-l" id="d-scl">ÿßŸÑŸÜŸÇÿßÿ∑</div></div>
    <div class="d-st"><div class="d-st-e">üéØ</div><div class="d-st-v" id="d-mv2">0</div><div class="d-st-l" id="d-mvl2">ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™</div></div>
    <div class="d-st"><div class="d-st-e">‚è±Ô∏è</div><div class="d-st-v" id="d-tm">0:00</div><div class="d-st-l" id="d-tml">ÿßŸÑŸàŸÇÿ™</div></div>
  </div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="d-btn sec" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="d-btn sec" onclick="showScreen('lvl-screen')">üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™</button>
  </div>
</div>

<script>
// ===== i18n =====
const LANG=new URLSearchParams(location.search).get('lang')||'ar';
document.documentElement.lang=LANG;document.documentElement.dir=LANG==='ar'?'rtl':'ltr';
const I={
ar:{title:'üß† ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©',sub:'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!',moves:'ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™',pairs:'ÿßŸÑÿ£ÿ≤Ÿàÿßÿ¨',time:'ÿßŸÑŸàŸÇÿ™',hint:'ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿ®ÿ∑ÿßŸÇÿ© ŸÑŸÑÿ®ÿØÿ°!',score:'ÿßŸÑŸÜŸÇÿßÿ∑',congrats:'ŸÖÿ®ÿ±ŸàŸÉ!',excellent:'üåü ŸÖŸÖÿ™ÿßÿ≤!',great:'üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™!',good:'üëç ÿ¨ŸäÿØ!',tryMore:'üí™ ÿ≠ÿßŸàŸÑ ÿ£ŸÉÿ´ÿ±!',done:'ÿ£ÿ™ŸÖŸÖÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ!',next:'‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä',share:'üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©',again:'üîÑ ÿ•ÿπÿßÿØÿ©',levels:'üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™',back:'üè† ÿ±ÿ¨Ÿàÿπ',locked:'üîí',
shareText:'ÿ≠ŸÇŸÇÿ™ {score} ŸÜŸÇÿ∑ÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ {level} ŸÖŸÜ ŸÑÿπÿ®ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©! ‚≠ê{stars}',
lvNames:['ŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™','ÿ≥ŸÑÿ© ÿßŸÑŸÅŸàÿßŸÉŸá','ÿπÿßŸÑŸÖ ÿßŸÑÿ®ÿ≠ÿßÿ±','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑÿ≠ÿ¥ÿ±ÿßÿ™','ÿ≥ŸÖÿßÿ° Ÿàÿ∑ŸÇÿ≥','ÿ≠ÿØŸäŸÇÿ© ÿßŸÑŸàÿ±ÿØ','ŸàÿßÿØŸä ÿßŸÑÿÆÿ∂ÿßÿ±','ŸÖÿ∑ÿ®ÿÆ ŸÑÿ∞Ÿäÿ∞','ÿπÿßŸÑŸÖ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™','ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑŸÅÿ∂ÿßÿ°','ŸÖŸÑÿπÿ® ÿßŸÑÿ±Ÿäÿßÿ∂ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ','ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ŸÅÿßÿ±Ÿä','ÿπÿßŸÑŸÖ ÿßŸÑÿ∑ŸäŸàÿ±','Ÿàÿ±ÿ¥ÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™','ÿπÿßŸÑŸÖ ÿßŸÑÿ£ÿ≤Ÿäÿßÿ°','ŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖÿ®ÿßŸÜŸä','ŸäŸàŸÖ ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©','ÿπÿßŸÑŸÖ ÿßŸÑÿ™ŸÇŸÜŸäÿ©','üåç ÿ®ÿ∑ŸÑ ÿßŸÑÿπÿßŸÑŸÖ']},
en:{title:'üß† Memory Match',sub:'Choose a level to start!',moves:'Moves',pairs:'Pairs',time:'Time',hint:'Tap any card to start!',score:'Score',congrats:'Congrats!',excellent:'üåü Excellent!',great:'üéâ Great!',good:'üëç Good!',tryMore:'üí™ Try More!',done:'Level complete!',next:'‚û°Ô∏è Next',share:'üì§ Share',again:'üîÑ Replay',levels:'üè† Levels',back:'üè† Back',locked:'üîí',
shareText:'I scored {score} on Level {level} in Memory Match! ‚≠ê{stars}',
lvNames:['Farm Friends','Fruit Basket','Ocean World','Bug Garden','Sky Watch','Flower Garden','Veggie Valley','Yummy Kitchen','On the Move','Space Quest','Sports Arena','Music Studio','Wild Safari','Bird Paradise','Tool Workshop','Fashion Show','City Builder','School Days','Tech World','üåç World Champion']},
pt:{title:'üß† Jogo da Mem√≥ria',sub:'Escolha um n√≠vel!',moves:'Jogadas',pairs:'Pares',time:'Tempo',hint:'Toque para come√ßar!',score:'Pontos',congrats:'Parab√©ns!',excellent:'üåü Excelente!',great:'üéâ Muito Bem!',good:'üëç Bom!',tryMore:'üí™ Tente Mais!',done:'N√≠vel completo!',next:'‚û°Ô∏è Pr√≥ximo',share:'üì§ Compartilhar',again:'üîÑ Repetir',levels:'üè† N√≠veis',back:'üè† Voltar',locked:'üîí',
shareText:'Fiz {score} pontos no N√≠vel {level} do Jogo da Mem√≥ria! ‚≠ê{stars}',
lvNames:['Amigos da Fazenda','Cesta de Frutas','Mundo do Mar','Jardim de Insetos','C√©u e Clima','Jardim de Flores','Vale dos Vegetais','Cozinha Gostosa','Em Movimento','Miss√£o Espacial','Arena Esportiva','Est√∫dio Musical','Safari Selvagem','Para√≠so dos P√°ssaros','Oficina de Ferramentas','Desfile de Moda','Construtor de Cidades','Dia Escolar','Mundo Tech','üåç Campe√£o Mundial']}
};
const t=I[LANG]||I.en;

// ===== 1000+ EDUCATIONAL SYMBOLS =====
const POOL={
farm:['üêÑ','üê∑','üêë','üêê','üê¥','üêî','üêì','ü¶É','üê§','üê£','ü¶Ü','üêï','üêà','üê∞','üêá','üêπ','üê≠','üêø','ü¶î','üê∂','üê±','üêÆ','üêñ','üêó','üêΩ','üêè','üê™','üê´','ü¶ô','üêé','üê•','üïä','üê©','üêæ','ü¶ù','ü¶°','ü¶®','ü¶•','ü¶¶','üêª','üê®','üêº','ü¶ä','üê∫','ü¶´','üêÇ','üêÉ','ü¶Ñ','üêÅ','üêÄ'],
fruit:['üçé','üçè','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçë','üçí','ü•ù','ü••','üçç','ü•≠','üçÖ','ü•ë','ü´ê','ü´í','ü•ï','üçÜ','üå∂','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•ú','üå∞','üçÑ','üç†','ü•¶','ü•ó','ü•£','ü´ô','ü•´','ü•î','ü´ë','üßÜ','ü•ô','ü´ì','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üßà','üçã‚Äçüü©'],
sea:['üêü','üê†','üê°','ü¶à','üê¨','üê≥','üêã','ü¶≠','üêô','ü¶ë','ü¶ê','ü¶Ä','ü¶û','üêö','ü™∏','ü™º','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','ü¶à','üê¨','üêô','ü¶ë','üê†','üêü','üê°','ü¶ê','ü¶Ä','ü¶û','üêö','üê¢','üêä','üêç','üê∏','ü¶é','ü™∏','ü™º','ü¶≠','üêâ','üê≤','ü¶ï','ü¶ñ'],
bug:['ü¶ã','üêõ','üêù','üêû','ü¶ó','üï∑','ü¶Ç','üêú','ü™≤','ü™≥','ü¶ü','ü™∞','üêå','ü™±','üåø','üçÄ','üçÅ','üçÇ','üçÉ','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','ü™¥','üéã','üéç','üçÑ','üåª','üå∏','üåπ','üå∫','üåº','üå∑','üíê','ü™ª','ü™∑','üê¶','üïä','ü¶ã','üêõ','üêù','üêû','ü¶ó','üêú','ü™≤','üêå','ü™±','üï∑'],
weather:['‚òÄÔ∏è','üå§','‚õÖ','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨','üí®','üåä','üåà','üå™','üå´','üíß','üí¶','üå°','üî•','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','üåô','üåõ','üåú','üåö','üåù','üåû','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üåå','üå†'],
flower:['üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥','üéã','üéç','ü™π','ü™∫','üçÑ','üåø','üéÑ','üíÆ','üèµ','üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥'],
veggie:['ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','ü•ô','üå±','ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','üåø','üçÄ','üåæ','üåª','üåº','ü™¥','üßÇ','ü´ô','ü•´','üßà'],
food:['üçï','üçî','üåÆ','üåØ','ü•ö','üç≥','ü•ò','üç≤','üçø','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üç©','üç™','üçØ','ü•ê','ü•ñ','üßá','ü•û','üßà','ü´ï','ü´î','ü•£','ü´ó','üçø','üç±','üßÜ','ü•ô','ü´ì'],
vehicle:['üöó','üöï','üöô','üöå','üöé','üèé','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèç','üõµ','üö≤','üõ¥','üõπ','üõº','üöÅ','üõ∏','üöÄ','üõ©','‚úàÔ∏è','üõ´','üõ¨','üö¢','‚õµ','üõ∂','üö§','üõ•','üõ≥','‚õ¥','üöÇ','üöÉ','üöÑ','üöÖ','üöÜ','üöá','üöà','üöâ','üöä','üöù','üöû','üöã','üö†','üö°','üõ∞','üöè'],
space:['üåç','üåé','üåè','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','üåù','üåû','‚òÄÔ∏è','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','ü™ê','üî≠','üî¨','üß≤','üß™','üß´','üß¨','üí°','üî¶','üïØ','ü™î','üîã','‚ö°','üõ∏','üöÄ','üõ∞','üì°','üåå','üå†','üéÜ','üéá','üí•','üî•','üíß','üåä','üåÄ','üåà'],
sport:['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','üèí','ü•ç','üèè','ü•Ö','‚õ≥','ü™Å','üèπ','üéØ','ü•ä','ü•ã','üéø','‚õ∑','üèÇ','üèãÔ∏è','ü§∏','ü§∫','ü§æ','üèåÔ∏è','üèá','üßò','üßó','ü§ø','üèÑ','üèä','üö£','üéΩ','üèÖ','ü•á','ü•à','ü•â','üèÜ','üéñ','üé™','üé†','üé°','üé¢','üõù','‚õ∫'],
music:['üéµ','üé∂','üéº','üéπ','üé∏','üé∫','üéª','ü•Å','ü™ò','ü™ó','üé∑','üé§','üéß','üìØ','ü™à','üé¨','üé≠','üé®','üñå','üñç','‚úèÔ∏è','üñä','üñã','üìù','üé™','üé†','üé≤','üéØ','üé≥','üé∞','üéÆ','üïπ','üì∫','üìª','üì∏','üé•','üìπ','üìΩ','üéû','üéü','üíø','üìÄ','üíΩ','üì±','üñ•','‚å®Ô∏è','üñ±','üñ®','üì¢','üì£'],
wild:['ü¶Å','üêØ','üêÖ','üêÜ','ü¶í','ü¶ì','üêò','ü¶õ','ü¶è','üêª','ü¶ä','üê∫','ü¶å','ü¶¨','ü¶£','ü¶ß','ü¶ç','üêí','üêµ','üôà','üôâ','üôä','ü¶ò','ü¶•','ü¶®','ü¶°','ü¶ù','ü¶¶','üêª‚Äç‚ùÑÔ∏è','üêº','üê®','üêæ','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','ü¶ã','üêù','üêû','ü¶Ö','ü¶â','üêß','ü¶ú','ü¶ö','ü¶©'],
bird:['ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü¶§','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶§','ü™π','ü™∫','ü•ö','üêæ','üåø','üçÄ','üå≤','üå≥','‚òÅÔ∏è','üå§','‚õÖ','üåà','üåÖ','üèî'],
tool:['üî®','ü™ì','‚õè','üîß','ü™õ','üî©','‚öôÔ∏è','üóú','ü™ö','üìè','üìê','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üîë','üóù','üîí','üîì','ü™§','üß≤','ü™ù','üß∞','ü™ú','ü™£','üßπ','üß∫','üßª','ü™†','üßº','üßΩ','ü™•','ü™í','üîã','üîå','üí°','üî¶','üïØ','ü™î','üßØ','ü™§','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üìé','üñá','üóë'],
fashion:['üëï','üëñ','üß£','üß§','üß•','üß¶','üëó','üëò','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üéí','ü©¥','üëû','üëü','ü•æ','ü•ø','üë†','üë°','ü©∞','üë¢','üëë','üëí','üé©','ü™ñ','‚õëÔ∏è','üíÑ','üíç','üíé','üëì','üï∂','ü•Ω','üìø','üß¢','üëï','üëñ','üß£','üß•','üëó','üëò','üéí','üëü','ü•æ','üë†'],
building:['üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üïå','üïç','‚õ™','üïã','üõï','‚õ©','üèó','üèö','üóº','üóΩ','üóæ','üéë','‚õ≤','‚õ∫','üèõ','üèü','üó∫','üèñ','üèú','üèù','üèû','üèî','‚õ∞','üåã','üåÅ','üåâ','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üóª','üé™','üé°'],
school:['üìö','üìñ','üìù','üìí','üìì','üìî','üìï','üìó','üìò','üìô','üìÑ','üìÉ','üìã','üìé','üìè','üìê','‚úÇÔ∏è','‚úèÔ∏è','üñä','üñã','üñç','üîó','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üóÑ','üóë','üì∞','üóû','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üîñ','üìÆ','üì¨','üì≠','üì™','üì´','‚úâÔ∏è','üì©','üì®','üìß','üíå'],
tech:['üíª','üñ•','üñ®','‚å®Ô∏è','üñ±','üíΩ','üíæ','üíø','üì±','üì≤','üì∑','üì∏','üìπ','üì∫','üìª','üì°','üîå','üîã','üí°','üìü','üì†','üïπ','üéÆ','üéß','üî¨','üî≠','üì°','üõ∞','üíª','üñ•','‚å®Ô∏è','üñ±','üì±','üì≤','üì∑','üìπ','üì∫','üìª','üîå','üîã','üí°','üïπ','üéÆ','üéß','üî¨','üî≠','üõ∞','üì°','‚åö','ü§ñ'],
mix:['üêÑ','üçé','üêü','ü¶ã','‚òÄÔ∏è','üå∏','ü•ï','üçï','üöó','üåç','‚öΩ','üéµ','ü¶Å','ü¶Ö','üî®','üëï','üè†','üìö','üíª','üéâ','üê∑','üçä','üê¨','üêù','üåà','üåπ','üåΩ','üçî','üöå','ü™ê','üèÄ','üé∏','üêØ','ü¶â','üîß','üëó','üè´','üìñ','üì±','üéä','üê¥','üçá','üêô','üêû','‚≠ê','üåª','üçÜ','üç∞','‚úàÔ∏è','üöÄ']
};

// ===== THEMES =====
const THEMES=[
  {bg:'linear-gradient(135deg,#86efac,#22c55e)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fca5a5,#ef4444)',cf1:'#dc2626',cf2:'#b91c1c'},
  {bg:'linear-gradient(135deg,#67e8f9,#0891b2)',cf1:'#0891b2',cf2:'#0e7490'},
  {bg:'linear-gradient(135deg,#a3e635,#65a30d)',cf1:'#65a30d',cf2:'#4d7c0f'},
  {bg:'linear-gradient(135deg,#93c5fd,#3b82f6)',cf1:'#3b82f6',cf2:'#2563eb'},
  {bg:'linear-gradient(135deg,#f9a8d4,#ec4899)',cf1:'#ec4899',cf2:'#be185d'},
  {bg:'linear-gradient(135deg,#86efac,#16a34a)',cf1:'#16a34a',cf2:'#15803d'},
  {bg:'linear-gradient(135deg,#fdba74,#ea580c)',cf1:'#ea580c',cf2:'#c2410c'},
  {bg:'linear-gradient(135deg,#cbd5e1,#475569)',cf1:'#475569',cf2:'#334155'},
  {bg:'linear-gradient(135deg,#c4b5fd,#7c3aed)',cf1:'#7c3aed',cf2:'#6d28d9'},
  {bg:'linear-gradient(135deg,#6ee7b7,#059669)',cf1:'#059669',cf2:'#047857'},
  {bg:'linear-gradient(135deg,#d8b4fe,#9333ea)',cf1:'#9333ea',cf2:'#7e22ce'},
  {bg:'linear-gradient(135deg,#fde68a,#d97706)',cf1:'#d97706',cf2:'#b45309'},
  {bg:'linear-gradient(135deg,#7dd3fc,#0284c7)',cf1:'#0284c7',cf2:'#0369a1'},
  {bg:'linear-gradient(135deg,#fb923c,#c2410c)',cf1:'#c2410c',cf2:'#9a3412'},
  {bg:'linear-gradient(135deg,#f0abfc,#a855f7)',cf1:'#a855f7',cf2:'#9333ea'},
  {bg:'linear-gradient(135deg,#a8a29e,#57534e)',cf1:'#57534e',cf2:'#44403c'},
  {bg:'linear-gradient(135deg,#60a5fa,#2563eb)',cf1:'#2563eb',cf2:'#1d4ed8'},
  {bg:'linear-gradient(135deg,#22d3ee,#0e7490)',cf1:'#0e7490',cf2:'#0891b2'},
  {bg:'linear-gradient(135deg,#fb7185,#be123c)',cf1:'#be123c',cf2:'#9f1239'},
];

// ===== LEVEL CONFIG: 20 levels, increasing grid & pairs =====
const LEVELS=[
  {cat:'farm',    gridCols:3,gridRows:2,pairs:3, emoji:'üêÑ'},
  {cat:'fruit',   gridCols:4,gridRows:2,pairs:4, emoji:'üçé'},
  {cat:'sea',     gridCols:4,gridRows:3,pairs:6, emoji:'üê†'},
  {cat:'bug',     gridCols:4,gridRows:3,pairs:6, emoji:'ü¶ã'},
  {cat:'weather', gridCols:4,gridRows:4,pairs:8, emoji:'üå§'},
  {cat:'flower',  gridCols:4,gridRows:4,pairs:8, emoji:'üå∏'},
  {cat:'veggie',  gridCols:4,gridRows:4,pairs:8, emoji:'ü•ï'},
  {cat:'food',    gridCols:5,gridRows:4,pairs:10,emoji:'üçï'},
  {cat:'vehicle', gridCols:5,gridRows:4,pairs:10,emoji:'üöó'},
  {cat:'space',   gridCols:4,gridRows:5,pairs:10,emoji:'üöÄ'},
  {cat:'sport',   gridCols:6,gridRows:4,pairs:12,emoji:'‚öΩ'},
  {cat:'music',   gridCols:6,gridRows:4,pairs:12,emoji:'üéµ'},
  {cat:'wild',    gridCols:5,gridRows:5,pairs:12,emoji:'ü¶Å'},
  {cat:'bird',    gridCols:6,gridRows:5,pairs:15,emoji:'ü¶Ö'},
  {cat:'tool',    gridCols:6,gridRows:5,pairs:15,emoji:'üî®'},
  {cat:'fashion', gridCols:6,gridRows:5,pairs:15,emoji:'üëó'},
  {cat:'building',gridCols:6,gridRows:6,pairs:18,emoji:'üè†'},
  {cat:'school',  gridCols:6,gridRows:6,pairs:18,emoji:'üìö'},
  {cat:'tech',    gridCols:6,gridRows:6,pairs:18,emoji:'üíª'},
  {cat:'mix',     gridCols:6,gridRows:6,pairs:18,emoji:'üåç'},
];

// ===== AUDIO =====
let audioCtx=null;
function ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function tone(f,d,tp,v){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v||.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+(d||.15));o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+(d||.15))}catch(e){}}
function sfxFlip(){tone(523,.06,'sine',.08)}
function sfxMatch(){tone(659,.1,'sine',.12);setTimeout(()=>tone(784,.1,'sine',.12),70);setTimeout(()=>tone(988,.12,'sine',.13),140)}
function sfxNoMatch(){tone(220,.15,'sawtooth',.06)}
function sfxComplete(){[523,659,784,988,1175,1319].forEach((f,i)=>setTimeout(()=>tone(f,.18,'sine',.1),i*80))}
function sfxStar(){[880,1100,1320].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*120))}

// ===== GAME STATE =====
let cards=[],moves=0,matchedPairs=0,totalPairs=8,firstPick=null,secondPick=null,isChecking=false;
let gameStarted=false,startTime=null,timerInterval=null,elapsedSeconds=0;
let currentLevel=-1,currentGridCols=4,currentGridRows=4;
let currentEmoji=[];

let progress=JSON.parse(localStorage.getItem('classify_memory_progress')||'{"unlocked":1,"scores":{},"stars":{}}');
function saveProgress(){localStorage.setItem('classify_memory_progress',JSON.stringify(progress))}

// ===== HELPERS =====
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function fmtTime(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0')}
function pickEmoji(cat,n){const pool=POOL[cat]||POOL.mix;const unique=[...new Set(shuffle(pool))];return unique.slice(0,n)}

function calcScore(moves,pairs,duration){
  const perfect=pairs;
  const extraMoves=Math.max(0,moves-perfect);
  const movePenalty=extraMoves*3;
  const graceSec=pairs*5;
  const extraSec=Math.max(0,duration-graceSec);
  const timePenalty=extraSec*0.3;
  return Math.max(10,Math.min(100,Math.round(100-movePenalty-timePenalty)));
}

// ===== SCREENS =====
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='lvl-screen')renderLevelSelect();
}

function renderLevelSelect(){
  const g=document.getElementById('ls-g');g.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cfg=LEVELS[i];
    const unlocked=i<progress.unlocked;
    const stars=progress.stars[i]||0;
    const isCurr=i===progress.unlocked-1;
    const card=document.createElement('div');
    card.className='lc'+(unlocked?'':' locked')+(isCurr?' current':'');
    if(unlocked){
      card.innerHTML=`<div class="lc-num">${i+1}</div><div class="lc-emoji">${cfg.emoji}</div><div class="lc-name">${t.lvNames[i]}</div><div class="lc-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>`;
      card.onclick=()=>startLevel(i);
    } else {
      card.innerHTML=`<div class="lc-num" style="opacity:.4">${i+1}</div><div class="lc-lock">${t.locked}</div><div class="lc-name" style="opacity:.4">${t.lvNames[i]}</div>`;
    }
    g.appendChild(card);
  }
}

// ===== START LEVEL =====
function startLevel(idx){
  currentLevel=idx;
  const cfg=LEVELS[idx];
  currentGridCols=cfg.gridCols;currentGridRows=cfg.gridRows;totalPairs=cfg.pairs;
  currentEmoji=pickEmoji(cfg.cat,totalPairs);
  const theme=THEMES[idx];
  document.getElementById('game-screen').style.background=theme.bg;
  document.getElementById('game-screen').style.setProperty('--cf1',theme.cf1);
  document.getElementById('game-screen').style.setProperty('--cf2',theme.cf2);
  document.getElementById('done-screen').style.background=theme.bg;
  document.getElementById('g-t').textContent=t.lvNames[idx];
  document.getElementById('g-b').textContent=''+(idx+1);
  resetGame();
  showScreen('game-screen');
}

function resetGame(){
  clearInterval(timerInterval);
  cards=createDeck();moves=0;matchedPairs=0;firstPick=null;secondPick=null;isChecking=false;
  gameStarted=false;startTime=null;elapsedSeconds=0;
  document.getElementById('g-mv').textContent='0';
  document.getElementById('g-pr').textContent='0/'+totalPairs;
  document.getElementById('g-tm').textContent='0:00';
  document.getElementById('hint').style.display='';
  renderCards();
}

function createDeck(){
  const chosen=currentEmoji.slice(0,totalPairs);
  const doubled=[...chosen,...chosen];
  return shuffle(doubled).map((s,i)=>({id:i,symbol:s,flipped:false,matched:false}));
}

function renderCards(){
  const g=document.getElementById('grid');
  const wrap=document.querySelector('.grid-wrap');
  const maxW=wrap.clientWidth-8,maxH=wrap.clientHeight-8;
  const gap=Math.max(3,Math.min(6,maxW*.01));
  const sW=(maxW-gap*(currentGridCols-1))/currentGridCols;
  const sH=(maxH-gap*(currentGridRows-1))/currentGridRows;
  const sz=Math.floor(Math.min(sW,sH,80));
  g.style.gridTemplateColumns=`repeat(${currentGridCols},${sz}px)`;
  g.style.gridTemplateRows=`repeat(${currentGridRows},${sz}px)`;
  g.style.gap=gap+'px';
  g.innerHTML='';
  cards.forEach(card=>{
    const btn=document.createElement('button');
    btn.className='card'+(card.flipped?' flipped':'')+(card.matched?' matched flipped':'');
    btn.disabled=card.flipped||card.matched;
    btn.setAttribute('data-id',card.id);
    btn.innerHTML=`<div class="card-inner"><div class="card-front"><span class="icon">‚ùì</span></div><div class="card-back"><span class="sym">${card.symbol}</span></div></div>`;
    btn.style.width=sz+'px';btn.style.height=sz+'px';
    btn.addEventListener('click',()=>flipCard(card.id));
    g.appendChild(btn);
  });
}

function flipCard(id){
  if(isChecking)return;
  const card=cards[id];
  if(!card||card.flipped||card.matched)return;
  if(!gameStarted){gameStarted=true;startTime=Date.now();document.getElementById('hint').style.display='none';timerInterval=setInterval(()=>{elapsedSeconds=Math.floor((Date.now()-startTime)/1000);document.getElementById('g-tm').textContent=fmtTime(elapsedSeconds)},1000)}
  card.flipped=true;
  updateCardDOM(id,true,false);
  sfxFlip();
  if(firstPick===null){firstPick=id;return}
  secondPick=id;moves++;
  document.getElementById('g-mv').textContent=moves;
  const first=cards[firstPick],second=cards[secondPick];
  if(first.symbol===second.symbol){
    first.matched=true;second.matched=true;matchedPairs++;
    document.getElementById('g-pr').textContent=matchedPairs+'/'+totalPairs;
    updateCardDOM(first.id,true,true);updateCardDOM(second.id,true,true);
    sfxMatch();
    firstPick=null;secondPick=null;
    if(matchedPairs===totalPairs)setTimeout(()=>endGame(),400);
  } else {
    isChecking=true;sfxNoMatch();
    setTimeout(()=>{first.flipped=false;second.flipped=false;updateCardDOM(first.id,false,false);updateCardDOM(second.id,false,false);firstPick=null;secondPick=null;isChecking=false},800);
  }
}

function updateCardDOM(id,flipped,matched){
  const btn=document.getElementById('grid').querySelector(`[data-id="${id}"]`);
  if(!btn)return;
  btn.className='card'+(flipped?' flipped':'')+(matched?' matched':'');
  btn.disabled=flipped||matched;
}

function endGame(){
  clearInterval(timerInterval);
  const dur=Math.floor((Date.now()-startTime)/1000);
  const sc=calcScore(moves,totalPairs,dur);
  let stars=0;if(sc>=50)stars=1;if(sc>=75)stars=2;if(sc>=90)stars=3;
  if(currentLevel>=0){
    const prev=progress.stars[currentLevel]||0;if(stars>prev)progress.stars[currentLevel]=stars;
    const prevSc=progress.scores[currentLevel]||0;if(sc>prevSc)progress.scores[currentLevel]=sc;
    if(stars>=1&&currentLevel+1>=progress.unlocked)progress.unlocked=currentLevel+2;
    saveProgress();
  }
  let title,emoji;
  if(stars>=3){title=t.excellent;emoji='üèÜ'}else if(stars>=2){title=t.great;emoji='üéâ'}else if(stars>=1){title=t.good;emoji='üëç'}else{title=t.tryMore;emoji='üí™'}
  document.getElementById('d-e').textContent=emoji;
  document.getElementById('d-t').textContent=title;
  document.getElementById('d-sub').textContent=t.done;
  document.getElementById('d-sc').textContent=sc+'/100';
  document.getElementById('d-mv2').textContent=moves;
  document.getElementById('d-tm').textContent=fmtTime(dur);
  const starsEl=document.getElementById('d-st');starsEl.innerHTML='';
  for(let i=0;i<3;i++){const sp=document.createElement('span');sp.textContent=i<stars?'‚≠ê':'‚òÜ';sp.style.opacity=i<stars?'1':'.3';starsEl.appendChild(sp)}
  document.getElementById('d-nx').style.display=(currentLevel>=0&&currentLevel<LEVELS.length-1)?'':'none';
  sfxComplete();if(stars>0)sfxStar();
  showScreen('done-screen');
  // Particles
  for(let i=0;i<stars*6;i++){setTimeout(()=>{const p=document.createElement('div');p.className='particle';p.textContent=['‚≠ê','‚ú®','üåü','üéâ','üíé'][Math.floor(Math.random()*5)];p.style.left=(Math.random()*innerWidth)+'px';p.style.top=(innerHeight*.6+Math.random()*80)+'px';p.style.fontSize='22px';document.body.appendChild(p);setTimeout(()=>p.remove(),1200)},i*70)}
  // PostMessage
  try{window.parent.postMessage({type:'GAME_COMPLETE',score:sc,total:100,timeElapsed:dur,moves:moves,level:currentLevel>=0?currentLevel+1:0,stars:stars},'*')}catch(e){}
}

function nextLevel(){if(currentLevel>=0&&currentLevel<LEVELS.length-1)startLevel(currentLevel+1)}
function replayLevel(){if(currentLevel>=0)startLevel(currentLevel)}
function shareResult(){
  const lvl=currentLevel>=0?currentLevel+1:0;const stars=currentLevel>=0?(progress.stars[currentLevel]||0):0;
  const text=t.shareText.replace('{score}',progress.scores[currentLevel]||0).replace('{level}',lvl).replace('{stars}','‚≠ê'.repeat(stars));
  try{if(navigator.share)navigator.share({title:t.title,text:text})}catch(e){}
  try{window.parent.postMessage({type:'SHARE_ACHIEVEMENT',game:'memory',level:lvl,score:progress.scores[currentLevel]||0,stars:stars,text:text},'*')}catch(e){}
  const btn=document.getElementById('d-sh');const o=btn.textContent;btn.textContent='‚úÖ';setTimeout(()=>{btn.textContent=o},2000);
}

// ===== i18n APPLY =====
document.getElementById('ls-t').textContent=t.title;
document.getElementById('ls-s').textContent=t.sub;
document.getElementById('g-mvl').textContent=t.moves;
document.getElementById('g-prl').textContent=t.pairs;
document.getElementById('g-tml').textContent=t.time;
document.getElementById('hint').textContent=t.hint;
document.getElementById('d-scl').textContent=t.score;
document.getElementById('d-mvl2').textContent=t.moves;
document.getElementById('d-tml').textContent=t.time;
document.getElementById('d-nx').textContent=t.next;
document.getElementById('d-sh').textContent=t.share;

// ===== INIT =====
window.addEventListener('resize',()=>{if(document.getElementById('game-screen').classList.contains('active'))renderCards()});
renderLevelSelect();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ - Emoji Kingdom</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0}
.screen.active{display:flex}

/* ===== WORLD SELECT ===== */
#world-screen{flex-direction:column;align-items:center;padding:clamp(6px,1.5vmin,12px);gap:clamp(4px,1vmin,8px);overflow-y:auto;background:linear-gradient(135deg,#8b5cf6,#6366f1,#a855f7,#7c3aed);background-size:300% 300%;animation:royalBG 15s ease infinite}
.top-bar{display:flex;width:100%;max-width:500px;justify-content:space-between;align-items:center;flex-shrink:0;gap:6px;flex-wrap:wrap}
.tb-item{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.2);border-radius:12px;padding:6px 14px;font-size:clamp(14px,2.8vmin,18px);color:#fff;font-weight:800;backdrop-filter:blur(4px);text-shadow:0 1px 4px rgba(0,0,0,.3);box-shadow:0 3px 0 rgba(0,0,0,.12),0 4px 8px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2);transition:all .2s}
.tb-item:hover{transform:translateY(-2px) scale(1.04)}
.mute-btn{cursor:pointer;font-size:clamp(18px,3.5vmin,24px);padding:6px 10px !important}
.xp-bar-wrap{width:100%;max-width:500px;flex-shrink:0}
.xp-bar{height:10px;background:rgba(255,255,255,.25);border-radius:99px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.2),0 1px 0 rgba(255,255,255,.15)}
.xp-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px;transition:width .5s;box-shadow:0 1px 6px rgba(251,191,36,.5),inset 0 -1px 0 rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.4)}
.xp-label{font-size:clamp(11px,2vmin,14px);color:rgba(255,255,255,.85);text-align:center;margin-top:3px;font-weight:600}
.ls-title{font-size:clamp(24px,6vmin,36px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4);text-align:center;flex-shrink:0}
.ls-sub{font-size:clamp(13px,2.5vmin,16px);color:rgba(255,255,255,.8);font-weight:600;text-align:center;flex-shrink:0}
.ls-btns{display:flex;gap:8px;flex-shrink:0}
.ls-btn{border:none;background:rgba(255,255,255,.25);color:#fff;font-weight:800;font-size:clamp(14px,2.8vmin,18px);padding:10px 20px;border-radius:12px;cursor:pointer;backdrop-filter:blur(4px);text-shadow:0 1px 4px rgba(0,0,0,.3);box-shadow:0 4px 0 rgba(0,0,0,.12),0 6px 12px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.3);transition:all .2s cubic-bezier(.34,1.56,.64,1)}
.ls-btn:hover{background:rgba(255,255,255,.35);transform:translateY(-3px) scale(1.05)}
.ls-btn:active{transform:translateY(2px) scale(.96)}
.ls-btn.daily{background:linear-gradient(135deg,#f59e0b,#f97316);box-shadow:0 4px 0 #c2410c,0 6px 12px rgba(249,115,22,.4)}

/* WORLD CARDS GRID */
.world-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(8px,2vmin,12px);width:100%;max-width:540px;padding:4px 0}
.wc{position:relative;border-radius:clamp(16px,3.5vmin,24px);padding:clamp(12px,2.5vmin,18px) clamp(8px,1.5vmin,12px);text-align:center;cursor:pointer;transition:all .35s cubic-bezier(.34,1.56,.64,1);box-shadow:0 6px 0 rgba(0,0,0,.18),0 10px 0 rgba(0,0,0,.08),0 20px 40px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.4);border:2px solid rgba(255,255,255,.4);overflow:hidden;animation:cardFloat 3s ease-in-out infinite;transform-style:preserve-3d}
.wc:nth-child(even){animation-delay:.5s}.wc:nth-child(3n){animation-delay:1s}.wc:nth-child(4n+1){animation-delay:1.5s}
.wc:hover{transform:translateY(-8px) scale(1.06) rotateX(3deg);box-shadow:0 12px 0 rgba(0,0,0,.12),0 20px 0 rgba(0,0,0,.05),0 32px 60px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.6)}
.wc:active{transform:translateY(2px) scale(.96)}
.wc.locked{opacity:.55;cursor:not-allowed;animation:none;filter:grayscale(.4)}
.wc.locked:hover{transform:none;box-shadow:0 6px 0 rgba(0,0,0,.18),0 10px 0 rgba(0,0,0,.08)}
.wc-icon{font-size:clamp(36px,8vmin,52px);margin-bottom:4px;filter:drop-shadow(0 3px 6px rgba(0,0,0,.25));animation:emojiWiggle 2.5s ease-in-out infinite}
.wc:nth-child(2n) .wc-icon{animation-delay:.3s}.wc:nth-child(3n) .wc-icon{animation-delay:.7s}
.wc.locked .wc-icon{animation:none}
.wc-name{font-size:clamp(13px,2.5vmin,17px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.4);margin-bottom:2px}
.wc-desc{font-size:clamp(10px,1.6vmin,12px);color:rgba(255,255,255,.85);font-weight:600;margin-bottom:4px}
.wc-progress{font-size:clamp(12px,2vmin,15px);color:#fbbf24;font-weight:800;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.wc-mastery{font-size:clamp(11px,1.8vmin,14px);color:rgba(255,255,255,.9);font-weight:700;margin-top:2px}
.wc-lock{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:clamp(36px,8vmin,50px);background:rgba(0,0,0,.25);border-radius:inherit;backdrop-filter:blur(2px)}
.wc-lock-text{position:absolute;bottom:clamp(6px,1.5vmin,10px);left:0;right:0;font-size:clamp(9px,1.5vmin,11px);color:rgba(255,255,255,.9);font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,.5)}

/* ===== LEVEL SELECT (within world) ===== */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(6px,1.5vmin,12px);gap:clamp(4px,1vmin,8px);overflow-y:auto;background:linear-gradient(135deg,#8b5cf6,#6366f1);transition:background .5s}
.lvl-header{display:flex;width:100%;max-width:500px;align-items:center;gap:8px;flex-shrink:0}
.lvl-back{border:none;background:rgba(255,255,255,.2);color:#fff;font-weight:800;font-size:clamp(14px,2.8vmin,18px);padding:8px 16px;border-radius:12px;cursor:pointer;backdrop-filter:blur(4px);box-shadow:0 3px 0 rgba(0,0,0,.12);transition:all .2s}
.lvl-back:hover{background:rgba(255,255,255,.3);transform:translateY(-2px)}
.lvl-world-title{flex:1;font-size:clamp(18px,4.5vmin,26px);font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.4);text-align:center}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:540px;padding:4px 0}
.lc{position:relative;background:linear-gradient(160deg,rgba(255,255,255,.5) 0%,rgba(255,255,255,.2) 40%,rgba(255,255,255,.05) 100%);border:2px solid rgba(255,255,255,.55);border-radius:clamp(14px,3vmin,22px);padding:clamp(8px,2vmin,16px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .35s cubic-bezier(.34,1.56,.64,1);backdrop-filter:blur(6px);box-shadow:0 6px 0 rgba(0,0,0,.18),0 10px 0 rgba(0,0,0,.08),0 20px 40px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.4);transform-style:preserve-3d;animation:cardFloat 3s ease-in-out infinite}
.lc:nth-child(even){animation-delay:.5s}.lc:nth-child(3n){animation-delay:1s}.lc:nth-child(4n+1){animation-delay:1.5s}
.lc:hover{transform:translateY(-8px) scale(1.1) rotateX(5deg);box-shadow:0 12px 0 rgba(0,0,0,.12),0 20px 0 rgba(0,0,0,.05),0 32px 60px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.6)}
.lc:active{transform:translateY(2px) scale(.96)}
.lc.locked{opacity:.5;cursor:not-allowed;animation:none}.lc.locked:hover{transform:none}
.lc.current{animation:currentGlow 2.5s ease-in-out infinite,cardFloat 3s ease-in-out infinite;border-color:#fbbf24}
@keyframes currentGlow{0%,100%{box-shadow:0 0 15px rgba(251,191,36,.4),0 6px 0 rgba(0,0,0,.15)}50%{box-shadow:0 0 30px rgba(251,191,36,.7),0 0 60px rgba(251,191,36,.2),0 6px 0 rgba(0,0,0,.12)}}
.lc.boss-card{border-color:#ef4444;box-shadow:0 6px 0 rgba(239,68,68,.3),0 0 14px rgba(239,68,68,.3),0 20px 40px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.4)}
.lc-num{font-size:clamp(22px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.lc-emoji{font-size:clamp(32px,7vmin,48px);margin:3px 0;filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));animation:emojiWiggle 2.5s ease-in-out infinite}
.lc:nth-child(2n) .lc-emoji{animation-delay:.3s}.lc:nth-child(3n) .lc-emoji{animation-delay:.7s}.lc:nth-child(4n) .lc-emoji{animation-delay:1.1s}.lc.locked .lc-emoji{animation:none}
.lc-name{font-size:clamp(10px,1.8vmin,13px);color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lc-stars{font-size:clamp(14px,2.8vmin,18px);margin-top:2px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(32px,7vmin,46px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}

/* ===== GAME SCREEN ===== */
#game-screen{flex-direction:column;align-items:center;justify-content:flex-start;padding:clamp(6px,1.5vmin,12px);gap:clamp(3px,0.8vmin,6px);background:var(--bg,linear-gradient(135deg,#8b5cf6,#6366f1));transition:background .5s}
.g-top{display:flex;width:100%;max-width:480px;justify-content:space-between;align-items:center;gap:6px;flex-shrink:0}
.g-lives{display:flex;gap:2px;font-size:clamp(22px,5vmin,32px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.g-combo{font-size:clamp(18px,3.5vmin,24px);font-weight:900;color:#fbbf24;min-width:70px;text-align:center;opacity:0;transition:opacity .3s;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.g-combo.show{opacity:1;text-shadow:0 0 10px rgba(251,191,36,.6),0 0 20px rgba(251,191,36,.3),0 2px 8px rgba(0,0,0,.3);animation:combo3DPulse .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes combo3DPulse{0%{transform:scale(1)}50%{transform:scale(1.35) rotateZ(-5deg)}100%{transform:scale(1)}}
.g-mute{background:none;border:none;color:rgba(255,255,255,.85);font-size:clamp(20px,4vmin,28px);cursor:pointer;padding:4px 8px;border-radius:8px}
.g-mute:hover{color:#fff;background:rgba(255,255,255,.15)}
.gc{background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(255,255,255,.92));border:2px solid rgba(255,255,255,.2);border-radius:24px;padding:clamp(10px,2.5vmin,20px);max-width:min(480px,95vw);width:100%;text-align:center;box-shadow:0 16px 0 rgba(0,0,0,.04),0 24px 64px rgba(0,0,0,.2),inset 0 2px 0 rgba(255,255,255,.8);flex-shrink:1;overflow-y:auto;max-height:75vh}
.g-hdr h1{font-size:clamp(17px,3.2vmin,22px);color:var(--accent,#4c1d95);margin-bottom:6px;font-weight:800}
.g-stats{display:flex;justify-content:center;gap:clamp(10px,2.5vmin,20px);margin-bottom:clamp(6px,1.5vmin,10px)}
.g-stat{display:flex;flex-direction:column;align-items:center}
.g-sv{font-size:clamp(22px,5vmin,30px);font-weight:900;color:var(--accent,#7c3aed)}
.g-sl{font-size:clamp(10px,1.8vmin,13px);color:#4b5563;text-transform:uppercase;letter-spacing:.04em;font-weight:700}
.pbar{width:100%;height:clamp(8px,1.5vmin,10px);background:#e5e7eb;border-radius:99px;margin-bottom:clamp(6px,1.5vmin,10px);overflow:hidden;box-shadow:inset 0 3px 6px rgba(0,0,0,.15),0 2px 0 rgba(255,255,255,.2);border:1px solid rgba(0,0,0,.06)}
.pfill{height:100%;background:linear-gradient(90deg,var(--accent,#8b5cf6),#ec4899);border-radius:99px;transition:width .4s;box-shadow:0 2px 8px rgba(236,72,153,.4),inset 0 -2px 0 rgba(0,0,0,.1),inset 0 2px 0 rgba(255,255,255,.3)}
.timer{font-size:clamp(15px,2.5vmin,18px);color:#4b5563;margin-bottom:4px;font-weight:700}
.timer.urgent{color:#ef4444;font-weight:700;animation:pulse .5s ease infinite;text-shadow:0 0 10px rgba(239,68,68,.5),0 0 20px rgba(239,68,68,.2)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.q-area{margin-bottom:clamp(6px,1.5vmin,12px)}
.q-visual{font-size:clamp(28px,6vmin,40px);margin-bottom:6px;line-height:1.4;min-height:clamp(30px,6.5vmin,44px);transition:opacity .3s;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15))}
.q-text{font-size:clamp(32px,8vmin,52px);font-weight:900;color:#111827;direction:ltr;margin-bottom:4px;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.q-feedback{font-size:clamp(16px,3vmin,22px);color:#d97706;font-weight:800;min-height:clamp(20px,3.5vmin,26px);transition:all .3s}
.ans-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(8px,1.8vmin,12px);margin-bottom:clamp(6px,1.5vmin,10px)}
.ans-btn{padding:clamp(12px,2.8vmin,20px);font-size:clamp(24px,5.5vmin,36px);font-weight:900;border:none;border-radius:clamp(16px,3vmin,24px);background:linear-gradient(180deg,#fff 0%,#faf5ff 50%,#f3e8ff 100%);cursor:pointer;transition:all .15s cubic-bezier(.34,1.56,.64,1);color:#111827;text-shadow:0 1px 2px rgba(0,0,0,.08);box-shadow:0 6px 0 #c4b5fd,0 8px 0 #a78bfa,0 14px 28px rgba(0,0,0,.12),inset 0 -3px 0 rgba(0,0,0,.06),inset 0 2px 0 rgba(255,255,255,.8);position:relative;overflow:hidden}
.ans-btn::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);transition:left .5s}
.ans-btn:hover::after{left:100%}
.ans-btn:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 10px 0 #c4b5fd,0 12px 0 #a78bfa,0 22px 40px rgba(0,0,0,.15),inset 0 -3px 0 rgba(0,0,0,.04),inset 0 2px 0 rgba(255,255,255,.9)}
.ans-btn:active{transform:translateY(4px) scale(.97);box-shadow:0 2px 0 #c4b5fd,0 3px 0 #a78bfa,0 4px 8px rgba(0,0,0,.08)}
.ans-btn.correct{box-shadow:0 6px 0 #059669,0 8px 0 #047857,0 0 20px rgba(16,185,129,.4),inset 0 2px 0 rgba(255,255,255,.6);background:linear-gradient(180deg,#ecfdf5,#d1fae5,#a7f3d0);color:#064e3b;animation:correct3D .5s cubic-bezier(.34,1.56,.64,1)}
.ans-btn.wrong{box-shadow:0 6px 0 #dc2626,0 8px 0 #b91c1c,0 0 20px rgba(239,68,68,.3),inset 0 2px 0 rgba(255,255,255,.4);background:linear-gradient(180deg,#fff1f2,#fee2e2,#fecaca);color:#7f1d1d}
.ans-btn:disabled{cursor:default;opacity:.7}
@keyframes correct3D{0%{transform:scale(1)}40%{transform:scale(1.12) rotateZ(-3deg)}70%{transform:scale(.95) rotateZ(2deg)}100%{transform:scale(1) rotateZ(0)}}

/* BOOSTERS */
.boosters{display:flex;justify-content:center;gap:clamp(8px,2vmin,14px);margin-top:6px}
.bst-btn{border:none;background:rgba(255,255,255,.15);border-radius:14px;padding:6px 14px;font-size:clamp(18px,3.5vmin,26px);cursor:pointer;transition:all .2s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:4px;box-shadow:0 4px 0 rgba(0,0,0,.12),0 6px 12px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.3)}
.bst-btn:hover{transform:translateY(-3px) scale(1.08);box-shadow:0 7px 0 rgba(0,0,0,.1),0 12px 20px rgba(0,0,0,.1)}
.bst-btn:disabled{opacity:.3;cursor:not-allowed}
.bst-cnt{font-size:clamp(12px,2.2vmin,16px);color:#374151;font-weight:800}

/* BOSS */
.boss-bar{width:100%;max-width:480px;flex-shrink:0}
.boss-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.boss-emoji{font-size:clamp(36px,8vmin,52px);animation:bossFloat 2s ease infinite;filter:drop-shadow(0 4px 12px rgba(0,0,0,.4)) drop-shadow(0 0 20px rgba(239,68,68,.3))}
@keyframes bossFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-label{font-size:clamp(16px,3vmin,20px);color:#fff;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.boss-hp{display:flex;height:clamp(14px,3vmin,20px);border-radius:99px;overflow:hidden;gap:3px;background:rgba(0,0,0,.25);padding:3px;box-shadow:inset 0 2px 4px rgba(0,0,0,.3),0 2px 0 rgba(255,255,255,.1)}
.boss-seg{flex:1;border-radius:99px;transition:all .4s cubic-bezier(.34,1.56,.64,1)}
.boss-seg.empty{opacity:.2}

/* ===== DONE SCREEN ===== */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(6px,1.5vmin,12px);padding:clamp(10px,2.5vmin,20px);overflow-y:auto;background-size:300% 300%;animation:royalBG 15s ease infinite}
.d-emoji{font-size:clamp(56px,14vmin,84px);animation:doneBounce3D 1.5s cubic-bezier(.34,1.56,.64,1) infinite;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3))}
@keyframes doneBounce3D{0%,100%{transform:translateY(0) scale(1) rotateZ(0)}25%{transform:translateY(-12px) scale(1.05) rotateZ(-3deg)}50%{transform:translateY(-6px) scale(1.02) rotateZ(0)}75%{transform:translateY(-12px) scale(1.05) rotateZ(3deg)}}
.d-title{font-size:clamp(24px,7vmin,36px);font-weight:900;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.4)}
.d-stars{display:flex;gap:clamp(5px,1.2vmin,8px);font-size:clamp(32px,8vmin,50px);filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.d-stars span{display:inline-block;animation:starPop3D .6s cubic-bezier(.34,1.56,.64,1) both}
.d-stars span:nth-child(1){animation-delay:.1s}.d-stars span:nth-child(2){animation-delay:.3s}.d-stars span:nth-child(3){animation-delay:.5s}
@keyframes starPop3D{0%{transform:scale(0) rotateY(180deg);opacity:0}60%{transform:scale(1.3) rotateY(45deg);opacity:1}100%{transform:scale(1) rotateY(0deg);opacity:1}}
.d-sub{font-size:clamp(14px,2.8vmin,18px);color:rgba(255,255,255,.9);font-weight:600}
.d-near{font-size:clamp(16px,3vmin,20px);color:#fbbf24;font-weight:800;animation:pulse .8s ease infinite;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.d-stats{display:flex;gap:clamp(6px,1.5vmin,12px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:10px;padding:clamp(5px,1.2vmin,10px) clamp(8px,2vmin,16px);backdrop-filter:blur(4px);box-shadow:0 4px 0 rgba(0,0,0,.1),0 8px 16px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.2);transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.d-st:hover{transform:translateY(-3px) scale(1.05)}
.d-st-e{font-size:clamp(24px,6vmin,36px);filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.d-st-v{font-size:clamp(20px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.d-st-l{font-size:clamp(10px,1.8vmin,12px);color:rgba(255,255,255,.8);text-transform:uppercase;font-weight:600}
.d-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.d-badge{background:rgba(255,255,255,.3);border-radius:10px;padding:5px 14px;font-size:clamp(14px,2.5vmin,18px);color:#fff;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.3);box-shadow:0 3px 0 rgba(0,0,0,.1),0 4px 8px rgba(0,0,0,.06),inset 0 1px 0 rgba(255,255,255,.2);transition:all .2s}
.d-badge:hover{transform:translateY(-2px) scale(1.05)}
.d-btns{display:flex;gap:clamp(5px,1.2vmin,8px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:14px;padding:clamp(10px,2.2vmin,16px) clamp(22px,5vmin,38px);font-size:clamp(15px,3vmin,20px);font-weight:900;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 6px 0 #c2410c,0 8px 0 #9a3412,0 14px 24px rgba(249,115,22,.3)}
.d-btn.pri:hover{transform:translateY(-3px) scale(1.06);box-shadow:0 9px 0 #c2410c,0 12px 0 #9a3412,0 20px 32px rgba(249,115,22,.35)}
.d-btn.pri:active{transform:translateY(3px) scale(.96);box-shadow:0 2px 0 #c2410c,0 3px 0 #9a3412}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff;box-shadow:0 4px 0 rgba(0,0,0,.15),0 6px 12px rgba(0,0,0,.08)}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 6px 0 #1d4ed8,0 8px 0 #1e40af,0 14px 24px rgba(37,99,235,.3)}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:20px;padding:clamp(16px,4vmin,32px);text-align:center;max-width:320px;width:90%;box-shadow:0 8px 0 rgba(0,0,0,.1),0 24px 60px rgba(0,0,0,.4),inset 0 2px 0 rgba(255,255,255,.3);animation:modalIn .4s ease}
@keyframes modalIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.modal h2{font-size:clamp(24px,6vmin,34px);font-weight:900;color:#fff;margin-bottom:10px;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.modal p{font-size:clamp(15px,3vmin,20px);color:rgba(255,255,255,.95);margin-bottom:14px;font-weight:600}
.modal button{border:none;background:#fff;color:#b45309;font-weight:900;font-size:clamp(16px,3.2vmin,20px);padding:10px 32px;border-radius:14px;cursor:pointer}
.shop-modal{background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:20px;padding:clamp(12px,3vmin,24px);text-align:center;max-width:360px;width:90%;box-shadow:0 8px 0 rgba(0,0,0,.12),0 24px 60px rgba(0,0,0,.4),inset 0 2px 0 rgba(255,255,255,.2);animation:modalIn .4s ease}
.shop-modal h2{color:#fff;font-size:clamp(20px,5vmin,28px);margin-bottom:12px;text-shadow:0 2px 6px rgba(0,0,0,.3)}
.shop-coins{color:#fbbf24;font-weight:900;font-size:clamp(18px,4vmin,24px);margin-bottom:12px;text-shadow:0 1px 4px rgba(0,0,0,.3)}
.shop-items{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.shop-item{background:rgba(255,255,255,.15);border-radius:12px;padding:10px;backdrop-filter:blur(4px)}
.shop-item-icon{font-size:40px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.shop-item-name{color:#fff;font-size:15px;font-weight:700;margin:6px 0}
.shop-item-price{color:#fbbf24;font-weight:800;font-size:16px;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.shop-item-owned{color:rgba(255,255,255,.75);font-size:13px;font-weight:600}
.shop-buy{border:none;background:#fbbf24;color:#1f2937;font-weight:800;font-size:14px;padding:6px 16px;border-radius:10px;cursor:pointer;margin-top:6px}
.shop-buy:disabled{opacity:.4;cursor:not-allowed}
.shop-close{border:none;background:rgba(255,255,255,.3);color:#fff;font-weight:800;padding:8px 24px;border-radius:12px;cursor:pointer;margin-top:12px;font-size:16px}

/* BACK */
.g-back{background:none;border:none;color:rgba(255,255,255,.85);font-size:clamp(16px,3vmin,20px);font-weight:800;cursor:pointer;padding:6px 12px;border-radius:10px;flex-shrink:0}
.g-back:hover{color:#fff;background:rgba(255,255,255,.15)}

/* TOOLTIP */
.tooltip-popup{position:fixed;z-index:200;background:#1f2937;color:#fff;font-size:16px;font-weight:700;padding:10px 20px;border-radius:12px;transform:translateX(-50%) translateY(-100%);pointer-events:none;box-shadow:0 6px 20px rgba(0,0,0,.3);transition:opacity .3s;opacity:1}

/* PARTICLES + ANIMATIONS */
.particle{position:fixed;pointer-events:none;z-index:999;animation:floatup 1.2s ease-out forwards}
@keyframes floatup{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-90px) scale(.3)}}
@keyframes emojiBounce{0%{transform:scale(1)}30%{transform:scale(1.2)}60%{transform:scale(0.95)}100%{transform:scale(1)}}
@keyframes screenShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-3px)}80%{transform:translateX(2px)}}
@keyframes cardFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes emojiWiggle{0%,100%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.15) rotate(-6deg)}50%{transform:scale(1) rotate(0deg)}75%{transform:scale(1.15) rotate(6deg)}}
@keyframes royalBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.screen.active{animation:screenIn .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes screenIn{0%{opacity:0;transform:scale(.93) translateY(12px)}100%{opacity:1;transform:scale(1) translateY(0)}}
</style>
</head>
<body>

<!-- ===== WORLD SELECT ===== -->
<div id="world-screen" class="screen active">
  <div class="top-bar">
    <div class="tb-item" id="tb-level">‚≠ê Lv.1</div>
    <div class="tb-item" id="tb-coins">ü™ô 0</div>
    <div class="tb-item" id="tb-lives">‚ù§Ô∏è 5</div>
    <div class="tb-item mute-btn" id="tb-mute" onclick="toggleMuteBtn()">üîä</div>
    <div class="tb-item" id="tb-perf" style="cursor:pointer" onclick="togglePerf()">‚ö°</div>
  </div>
  <div class="xp-bar-wrap">
    <div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
    <div class="xp-label" id="xp-label">0 / 1000 XP</div>
  </div>
  <div class="ls-title" id="ws-t">üßÆ ŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ</div>
  <div class="ls-sub" id="ws-sub">ÿßÿÆÿ™ÿ± ÿπÿßŸÑŸÖŸÉ ŸÑÿ™ÿ®ÿØÿ£ ÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ©!</div>
  <div class="ls-btns">
    <button class="ls-btn daily" id="daily-btn" onclick="startDaily()">üéØ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä</button>
    <button class="ls-btn" onclick="openShop()">üõí ÿßŸÑŸÖÿ™ÿ¨ÿ±</button>
  </div>
  <div class="world-grid" id="world-grid"></div>
</div>

<!-- ===== LEVEL SELECT (within world) ===== -->
<div id="lvl-screen" class="screen">
  <div class="lvl-header">
    <button class="lvl-back" id="lvl-back" onclick="backToWorlds()">‚Üê ÿßŸÑÿπŸàÿßŸÑŸÖ</button>
    <div class="lvl-world-title" id="lvl-world-title"></div>
    <div class="tb-item mute-btn" onclick="toggleMuteBtn()" id="lvl-mute">üîä</div>
  </div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- ===== GAME SCREEN ===== -->
<div id="game-screen" class="screen">
  <div class="g-top">
    <div class="g-lives" id="g-lives"></div>
    <div class="g-combo" id="g-combo">üî• x1</div>
    <button class="g-mute" id="g-mute" onclick="toggleMuteBtn()">üîä</button>
    <button class="g-back" onclick="exitGame()">‚úï</button>
  </div>
  <div class="boss-bar" id="boss-bar" style="display:none">
    <div class="boss-hdr">
      <span class="boss-emoji" id="boss-emoji">üê≤</span>
      <span class="boss-label" id="boss-label">Boss</span>
      <span class="boss-emoji" id="boss-p-emoji">üõ°Ô∏è</span>
    </div>
    <div class="boss-hp" id="boss-hp"></div>
  </div>
  <div class="gc" id="gc">
    <div class="g-hdr"><h1 id="g-t">üßÆ</h1></div>
    <div class="g-stats">
      <div class="g-stat"><span class="g-sv" id="g-sc">0</span><span class="g-sl" id="g-scl">ÿßŸÑŸÜŸÇÿßÿ∑</span></div>
      <div class="g-stat"><span class="g-sv" id="g-qn">1/10</span><span class="g-sl" id="g-qnl">ÿßŸÑÿ≥ÿ§ÿßŸÑ</span></div>
    </div>
    <div class="pbar"><div class="pfill" id="pfill" style="width:10%"></div></div>
    <div class="timer" id="timer"></div>
    <div class="q-area">
      <div class="q-visual" id="q-visual"></div>
      <div class="q-text" id="q-text">5 + 3 = ?</div>
      <div class="q-feedback" id="q-feedback"></div>
    </div>
    <div class="ans-grid" id="answers"></div>
    <div class="boosters" id="boosters"></div>
  </div>
</div>

<!-- ===== DONE SCREEN ===== -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">üèÜ</div>
  <div class="d-title" id="d-t">ÿ£ÿ≠ÿ≥ŸÜÿ™!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-near" id="d-near" style="display:none"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">‚úÖ</div><div class="d-st-v" id="d-cr">0</div><div class="d-st-l" id="d-crl">ÿµÿ≠Ÿäÿ≠</div></div>
    <div class="d-st"><div class="d-st-e">‚ùå</div><div class="d-st-v" id="d-wr">0</div><div class="d-st-l" id="d-wrl">ÿÆÿ∑ÿ£</div></div>
    <div class="d-st"><div class="d-st-e">‚è±Ô∏è</div><div class="d-st-v" id="d-tm">0s</div><div class="d-st-l" id="d-tml">ÿßŸÑŸàŸÇÿ™</div></div>
    <div class="d-st"><div class="d-st-e">‚≠ê</div><div class="d-st-v" id="d-xp">+0</div><div class="d-st-l">XP</div></div>
    <div class="d-st"><div class="d-st-e">ü™ô</div><div class="d-st-v" id="d-cn">+0</div><div class="d-st-l" id="d-cnl">ÿπŸÖŸÑÿßÿ™</div></div>
  </div>
  <div class="d-badges" id="d-badges"></div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="d-btn sec" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="d-btn sec" onclick="showScreen('world-screen')">üè†</button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="lvlup-modal">
  <div class="modal">
    <h2 id="lvlup-title">‚¨ÜÔ∏è Level Up!</h2>
    <p id="lvlup-msg">Earned: +1 üî® +1 üí° +1 ‚ù§Ô∏è</p>
    <button onclick="closeLvlUp()">üëç</button>
  </div>
</div>
<div class="modal-overlay" id="shop-modal">
  <div class="shop-modal">
    <h2>üõí ÿßŸÑŸÖÿ™ÿ¨ÿ±</h2>
    <div class="shop-coins" id="shop-coins">ü™ô 0</div>
    <div class="shop-items" id="shop-items"></div>
    <button class="shop-close" onclick="closeShop()">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
  </div>
</div>
<div class="modal-overlay" id="nolives-modal">
  <div class="modal" style="background:linear-gradient(135deg,#ef4444,#b91c1c)">
    <h2>‚ù§Ô∏è ŸÑÿß ÿ£ÿ±Ÿàÿßÿ≠!</h2>
    <p id="nolives-msg">ÿßŸÑŸÇŸÑÿ® ÿßŸÑÿ™ÿßŸÑŸä ÿÆŸÑÿßŸÑ 10 ÿØŸÇÿßÿ¶ŸÇ</p>
    <button onclick="closeNoLives()">ÿ≠ÿ≥ŸÜÿßŸã</button>
  </div>
</div>

<!-- ===== PARTICLE SYSTEM ===== -->
<script>
(function(){
const c=document.createElement('canvas');
c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9999';
document.body.appendChild(c);
const ctx=c.getContext('2d');
let P=[],raf=null;
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener('resize',resize);resize();

window.spawnConfetti=function(x,y,n){
  n=n||40;
  const cols=['#FF6B6B','#4ECDC4','#45B7D1','#FFEAA7','#DDA0DD','#FF69B4','#98D8C8','#F7DC6F','#BB8FCE','#85C1E9','#F8C471','#82E0AA'];
  for(let i=0;i<n;i++){
    P.push({x:x||Math.random()*c.width,y:y||c.height*.3,
      vx:(Math.random()-.5)*14,vy:-Math.random()*16-3,
      w:Math.random()*10+4,h:Math.random()*6+3,
      color:cols[Math.floor(Math.random()*cols.length)],
      rot:Math.random()*360,rs:(Math.random()-.5)*15,
      g:.25+Math.random()*.2,life:1,d:.006+Math.random()*.007})}
  if(!raf)loop()};

window.spawnFirework=function(x,y){
  const cols=['#FFD700','#FF4500','#00FF7F','#1E90FF','#FF69B4','#FFA500','#E74C3C','#2ECC71','#9B59B6','#F39C12'];
  const col=cols[Math.floor(Math.random()*cols.length)];
  for(let i=0;i<50;i++){
    const a=(i/50)*Math.PI*2,sp=2+Math.random()*6;
    P.push({t:'fw',x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
      r:1.5+Math.random()*3,color:col,life:1,d:.012+Math.random()*.012,g:.06})}
  if(!raf)loop()};

window.spawn3DStars=function(x,y,n){
  const em=['‚≠ê','üåü','‚ú®','üí´','üéÜ','üíé','üèÜ','üéâ','üéä','üëë'];
  for(let i=0;i<(n||8);i++){
    P.push({t:'em',x:x+(Math.random()-.5)*100,y:y,
      vx:(Math.random()-.5)*6,vy:-Math.random()*10-3,
      em:em[Math.floor(Math.random()*em.length)],
      sz:18+Math.random()*24,life:1,d:.009,g:.12,rot:0,rs:(Math.random()-.5)*10})}
  if(!raf)loop()};

window.royalCelebration=function(stars){
  stars=stars||1;
  for(let w=0;w<Math.min(stars+1,4);w++)
    setTimeout(()=>{
      spawnConfetti(c.width*(.2+Math.random()*.6),c.height*(.2+Math.random()*.2),25+stars*10);
    },w*350);
  for(let f=0;f<Math.min(stars,3);f++)
    setTimeout(()=>{
      spawnFirework(c.width*(.15+Math.random()*.7),c.height*(.1+Math.random()*.25));
    },200+f*600);
  setTimeout(()=>spawn3DStars(c.width/2,c.height*.45,stars*4),100);
};

function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=P.length-1;i>=0;i--){
    const p=P[i];
    p.life-=p.d;
    if(p.life<=0){P.splice(i,1);continue}
    p.vy+=(p.g||.2);p.x+=p.vx;p.y+=p.vy;p.rot=(p.rot||0)+(p.rs||0);
    ctx.save();ctx.globalAlpha=Math.min(1,p.life*1.5);
    ctx.translate(p.x,p.y);ctx.rotate((p.rot||0)*Math.PI/180);
    if(p.t==='fw'){
      ctx.beginPath();ctx.arc(0,0,p.r*p.life,0,Math.PI*2);ctx.fillStyle=p.color;ctx.fill();
      ctx.globalAlpha=p.life*.3;ctx.beginPath();ctx.arc(-p.vx*.5,-p.vy*.5,p.r*p.life*.6,0,Math.PI*2);ctx.fill();
    } else if(p.t==='em'){
      ctx.font=p.sz+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.em,0,0);
    } else {
      ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    }
    ctx.restore()}
  raf=P.length>0?requestAnimationFrame(loop):null}
})();
</script>

<!-- ===== GAME MODULE ===== -->
<script type="module">
import { POOL, CATEGORIES, LANG, t, I18N } from './math-modules/config.js';
import { WORLDS, WORLD_MAP, generateLevelConfig, isWorldUnlocked, getTotalStars, getWorldCompletion, getMasteryIcon, getLevelName, generateDailyChallenge } from './math-modules/worlds.js';
import * as Core from './math-modules/core.js';
import * as Intel from './math-modules/intelligence.js';
import * as Engage from './math-modules/engagement.js';
import * as UI from './math-modules/ui.js';
import * as Econ from './math-modules/economy.js';
import * as Boss from './math-modules/boss.js';

// Apply lang
document.documentElement.lang = LANG;
document.documentElement.dir = LANG === 'ar' ? 'rtl' : 'ltr';
const T = (I18N[LANG] || I18N.en);

// ===== GAME STATE =====
let progress;
let currentWorld = null;       // world ID
let currentLevelIndex = -1;    // level index within world
let levelConfig = null;        // generated level config
let currentQ = 0, totalScore = 0, streak = 0, highStreak = 0;
let questions = [], timerInterval = null, timeLeft = 0, answering = false, startTime = 0;
let usedHintThisLevel = false, bossState = null, dailyMode = false, questionStartTime = 0;
let totalCorrect = 0, totalQ = 10, currentTimerMax = 0;
let challengeTracker;

function el(id) { return document.getElementById(id); }

// ===== INIT =====
function init() {
  progress = Core.loadProgress();
  if (!progress.skillData) progress.skillData = { avgResponseTime: 8, accuracyRate: 0.5, highestStreak: 0, totalGamesPlayed: 0, smoothedSkill: 50 };
  if (!progress.boosters) progress.boosters = { hammer: 1, shuffle: 1, extraTime: 1, hint: 3 };
  if (!progress.tutorialShown) progress.tutorialShown = {};
  if (!progress.purchaseCounts) progress.purchaseCounts = { hammer: 0, shuffle: 0, extraTime: 0, hint: 0 };

  // Init mute state  
  UI.initMuteState(progress.soundMuted);
  updateMuteButtons();

  // i18n
  el('ws-t').textContent = T.title;
  el('ws-sub').textContent = T.sub;
  el('g-scl').textContent = T.score;
  el('g-qnl').textContent = T.question;
  el('d-crl').textContent = T.correct;
  el('d-wrl').textContent = T.wrong;
  el('d-tml').textContent = T.time;
  el('d-cnl').textContent = T.coins;
  el('d-sh').textContent = T.share;
  el('daily-btn').textContent = T.daily;
  el('lvl-back').textContent = T.backToWorlds;

  updateDailyBtn();
  renderWorldSelect();
}

// ===== MUTE =====
function toggleMuteBtn() {
  const muted = UI.toggleMute();
  progress.soundMuted = muted;
  Core.saveProgress(progress);
  updateMuteButtons();
}
window.toggleMuteBtn = toggleMuteBtn;

function updateMuteButtons() {
  const icon = UI.isMuted() ? T.soundOff : T.soundOn;
  ['tb-mute', 'lvl-mute', 'g-mute'].forEach(id => {
    const e = el(id);
    if (e) e.textContent = icon;
  });
}

// ===== SCREENS =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  el(id).classList.add('active');
  if (id === 'world-screen') { renderWorldSelect(); UI.stopMusic(); }
  if (id === 'lvl-screen') { renderLevelSelect(); }
}
window.showScreen = showScreen;

// ===== TOP BAR =====
function updateTopBar() {
  const lvl = Core.getPlayerLevel(progress);
  const xpCur = Core.getLevelXPProgress(progress);
  const xpMax = Core.getXPToNextLevel();
  el('tb-level').textContent = '‚≠ê Lv.' + lvl;
  el('tb-coins').textContent = 'ü™ô ' + Econ.getCoins(progress);
  el('tb-lives').textContent = '‚ù§Ô∏è ' + Core.getLives(progress);
  el('xp-fill').style.width = (xpCur / xpMax * 100) + '%';
  el('xp-label').textContent = xpCur + ' / ' + xpMax + ' XP';
  el('tb-perf').textContent = UI.isLowPerf() ? 'üê¢' : '‚ö°';
}

function updateDailyBtn() {
  const today = new Date().toDateString();
  if (progress.dailyChallengeDate === today && progress.dailyChallengeCompleted) {
    el('daily-btn').textContent = T.dailyDone;
    el('daily-btn').disabled = true;
    el('daily-btn').style.opacity = '.5';
  }
}

// ===== WORLD SELECT =====
function renderWorldSelect() {
  updateTopBar();
  const g = el('world-grid');
  g.innerHTML = '';

  for (const w of WORLDS) {
    const unlocked = isWorldUnlocked(w.id, progress.worlds);
    const wp = progress.worlds[w.id] || {};
    const completion = getWorldCompletion(wp);
    const masteryIcon = getMasteryIcon(completion.mastery);
    const worldName = T.worldNames[w.id] || w.id;
    const worldDesc = T.worldDescs[w.id] || '';

    const card = document.createElement('div');
    card.className = 'wc' + (unlocked ? '' : ' locked');
    card.style.background = unlocked ? w.gradient : 'rgba(100,100,140,.35)';

    if (unlocked) {
      card.innerHTML = `
        <div class="wc-icon">${w.icon}</div>
        <div class="wc-name">${worldName}</div>
        <div class="wc-desc">${worldDesc}</div>
        <div class="wc-progress">${completion.stars} ‚≠ê ¬∑ ${T.level} ${completion.levels}</div>
        ${masteryIcon ? `<div class="wc-mastery">${masteryIcon} ${T.mastery[completion.mastery] || ''}</div>` : ''}
      `;
      card.onclick = () => enterWorld(w.id);
    } else {
      const reqWorld = w.unlockReq ? w.unlockReq.world : '';
      const reqStars = w.unlockReq ? w.unlockReq.starsNeeded : 0;
      const reqName = T.worldNames[reqWorld] || reqWorld;
      card.innerHTML = `
        <div class="wc-icon" style="opacity:.5">${w.icon}</div>
        <div class="wc-name">${worldName}</div>
        <div class="wc-desc">${worldDesc}</div>
        <div class="wc-lock">üîí</div>
        <div class="wc-lock-text">${T.starsNeeded.replace('{n}', reqStars).replace('{world}', reqName)}</div>
      `;
    }
    g.appendChild(card);
  }
}

// ===== ENTER WORLD =====
function enterWorld(worldId) {
  currentWorld = worldId;
  const w = WORLD_MAP[worldId];
  // Apply world theme to level screen
  el('lvl-screen').style.background = w.gradient;
  el('lvl-world-title').textContent = T.worldNames[worldId] || worldId;
  showScreen('lvl-screen');
}
window.enterWorld = enterWorld;

function backToWorlds() {
  currentWorld = null;
  showScreen('world-screen');
}
window.backToWorlds = backToWorlds;

// ===== LEVEL SELECT (within world) =====
function renderLevelSelect() {
  if (!currentWorld) return;
  const w = WORLD_MAP[currentWorld];
  const wp = progress.worlds[currentWorld] || { levelReached: 0, scores: {}, stars: {} };
  const levelsToShow = Math.max(20, (wp.levelReached || 0) + 4);

  const g = el('ls-g');
  g.innerHTML = '';

  for (let i = 0; i < levelsToShow; i++) {
    const unlocked = i < Math.max(1, wp.levelReached || 1);
    const stars = wp.stars[i] || 0;
    const isCurr = i === Math.max(0, (wp.levelReached || 1) - 1);
    const isBoss = (i + 1) % w.bossEvery === 0;
    const levelName = getLevelName(currentWorld, i, LANG);

    const card = document.createElement('div');
    card.className = 'lc' + (unlocked ? '' : ' locked') + (isCurr ? ' current' : '') + (isBoss && unlocked ? ' boss-card' : '');

    if (unlocked) {
      card.innerHTML = `
        <div class="lc-num">${isBoss ? 'üëë' : (i + 1)}</div>
        <div class="lc-emoji">${isBoss ? '‚öîÔ∏è' : w.emoji}</div>
        <div class="lc-name">${isBoss ? T.bossBattle : levelName}</div>
        <div class="lc-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>
      `;
      card.onclick = () => startLevel(currentWorld, i);
    } else {
      card.innerHTML = `
        <div class="lc-num" style="opacity:.4">${i + 1}</div>
        <div class="lc-lock">üîí</div>
      `;
    }
    g.appendChild(card);
  }
}

// ===== LIVES CHECK =====
function checkLives() {
  const lives = Core.getLives(progress);
  if (lives <= 0) {
    const ms = Core.getTimeToNextLife(progress);
    const mins = Math.ceil(ms / 60000);
    el('nolives-msg').textContent = T.livesRegen.replace('{m}', mins);
    el('nolives-modal').classList.add('show');
    return false;
  }
  return true;
}
window.closeNoLives = () => el('nolives-modal').classList.remove('show');

// ===== QUESTION GENERATION =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

function pickMultiCatEmoji(cats) {
  let pool = [];
  for (const c of cats) pool = pool.concat(POOL[c] || []);
  return shuffle([...new Set(pool)]);
}

function genQuestion(ops, range, emojiPool, difficulty, isBoss) {
  const effRange = Intel.getDifficultyRange(range, difficulty);
  let op = ops[Math.floor(Math.random() * ops.length)];
  // Handle special ops as add/sub fallback
  if (['count','fraction','decimal','pattern','geometry','algebra'].includes(op)) {
    if (op === 'count') op = 'add';
    else if (op === 'fraction') op = 'add';
    else if (op === 'decimal') op = 'add';
    else if (op === 'pattern') op = 'add';
    else if (op === 'geometry') op = 'mul';
    else if (op === 'algebra') op = 'add';
  }
  let a, b, answer, text, visual = '';
  const em = emojiPool[Math.floor(Math.random() * emojiPool.length)];
  switch(op) {
    case 'add':
      a = Math.floor(Math.random() * effRange) + 1;
      b = Math.floor(Math.random() * effRange) + 1;
      answer = a + b; text = `${a} + ${b} = ?`;
      if (a <= 6 && b <= 6) visual = em.repeat(a) + ' + ' + em.repeat(b);
      break;
    case 'sub':
      a = Math.floor(Math.random() * effRange) + 2;
      b = Math.floor(Math.random() * a) + 1;
      answer = a - b; text = `${a} - ${b} = ?`;
      if (a <= 8) visual = em.repeat(a) + ' - ' + em.repeat(b);
      break;
    case 'mul':
      a = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      b = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      answer = a * b; text = `${a} √ó ${b} = ?`;
      if (a <= 4 && b <= 4) { const rows = []; for (let r = 0; r < a; r++) rows.push(em.repeat(b)); visual = rows.join(' '); }
      break;
    case 'div':
      b = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      const q = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      a = b * q; answer = q; text = `${a} √∑ ${b} = ?`;
      if (a <= 12) visual = em.repeat(a) + ' √∑ ' + b;
      break;
    default:
      a = Math.floor(Math.random() * effRange) + 1;
      b = Math.floor(Math.random() * effRange) + 1;
      answer = a + b; text = `${a} + ${b} = ?`;
  }
  const wrongs = new Set();
  while (wrongs.size < 3) {
    const off = Math.floor(Math.random() * 10) + 1;
    const w = Math.random() < .5 ? answer + off : answer - off;
    if (w !== answer && w >= 0 && !wrongs.has(w)) wrongs.add(w);
  }
  return { text, answer, options: shuffle([answer, ...wrongs]), visual };
}

function genAllQuestions(cfg, isBoss) {
  const skill = Intel.getSmoothedSkill(progress.skillData || {});
  const adjustedRange = Intel.adjustRange(cfg.range, skill);
  currentTimerMax = cfg.timer;
  const pool = pickMultiCatEmoji(cfg.cats);
  const qs = [];
  for (let i = 0; i < cfg.questions; i++) {
    const diff = Intel.getQuestionDifficulty(i, cfg.questions, isBoss);
    let ops = cfg.ops;
    if (isBoss && bossState) ops = Boss.getCurrentPhaseOps(bossState);
    qs.push(genQuestion(ops, adjustedRange, pool, diff, isBoss));
  }
  return qs;
}

// ===== START LEVEL =====
function startLevel(worldId, levelIdx) {
  if (!checkLives()) return;
  dailyMode = false;
  currentWorld = worldId;
  currentLevelIndex = levelIdx;

  const w = WORLD_MAP[worldId];
  levelConfig = generateLevelConfig(worldId, levelIdx, progress.skillData);
  if (!levelConfig) return;

  totalQ = levelConfig.questions;
  const isBoss = levelConfig.boss;

  // Theme
  UI.applyWorldTheme(levelConfig.gradient, levelConfig.accent, el('game-screen'), el('done-screen'));

  // Boss init
  if (isBoss) {
    const bossOps = levelConfig.ops.length > 0 ? levelConfig.ops : ['add'];
    bossState = Boss.createBossState(levelConfig.bossType, bossOps);
    totalQ = bossState.totalHP;
    el('boss-bar').style.display = '';
    renderBossHP();
    el('boss-emoji').textContent = Boss.getBossEmoji(bossState);
    el('boss-label').textContent = Boss.getBossPhaseLabel(bossState);
  } else {
    bossState = null;
    el('boss-bar').style.display = 'none';
  }

  const levelName = getLevelName(worldId, levelIdx, LANG);
  el('g-t').textContent = (isBoss ? 'üëë ' + T.bossBattle : levelName + ' üßÆ');

  // Reset state
  currentQ = 0; totalScore = 0; streak = 0; highStreak = 0;
  totalCorrect = 0; usedHintThisLevel = false; answering = false;
  startTime = Date.now();
  challengeTracker = Engage.createChallengeTracker();
  currentTimerMax = levelConfig.timer;

  // Generate questions
  if (isBoss) {
    questions = genBossQuestions(levelConfig);
  } else {
    questions = genAllQuestions(levelConfig, false);
  }

  el('g-sc').textContent = '0';
  renderLives();
  updateCombo();
  showScreen('game-screen');
  if (!UI.isMuted()) UI.startMusic();
  renderBoosters();
  showQuestion();
}
window.startLevel = startLevel;

function genBossQuestions(cfg) {
  if (!bossState) return genAllQuestions(cfg, true);
  const phases = Boss.getPhases(bossState);
  const skill = Intel.getSmoothedSkill(progress.skillData || {});
  const pool = pickMultiCatEmoji(cfg.cats);
  const qs = [];
  for (const phase of phases) {
    for (let i = 0; i < phase.questions; i++) {
      const diff = Intel.getQuestionDifficulty(i, phase.questions, true);
      qs.push(genQuestion(phase.ops, Intel.adjustRange(cfg.range, skill), pool, diff, true));
    }
  }
  return qs;
}

// ===== DAILY CHALLENGE =====
function startDaily() {
  const today = new Date().toDateString();
  if (progress.dailyChallengeDate === today && progress.dailyChallengeCompleted) return;
  if (!checkLives()) return;
  dailyMode = true;
  currentWorld = null;
  currentLevelIndex = -1;

  const dailyCfg = generateDailyChallenge(today, progress.skillData);
  levelConfig = dailyCfg;
  totalQ = dailyCfg.questions;
  currentTimerMax = dailyCfg.timer;

  UI.applyWorldTheme(dailyCfg.gradient, dailyCfg.accent, el('game-screen'), el('done-screen'));
  el('boss-bar').style.display = 'none';
  bossState = null;
  el('g-t').textContent = T.daily + ' üéØ';

  currentQ = 0; totalScore = 0; streak = 0; highStreak = 0;
  totalCorrect = 0; usedHintThisLevel = false; answering = false;
  startTime = Date.now();
  challengeTracker = Engage.createChallengeTracker();

  const pool = pickMultiCatEmoji(dailyCfg.cats);
  questions = [];
  for (let i = 0; i < totalQ; i++) {
    const diff = Intel.getQuestionDifficulty(i, totalQ, false);
    questions.push(genQuestion(dailyCfg.ops, dailyCfg.range, pool, diff, false));
  }

  el('g-sc').textContent = '0';
  renderLives();
  updateCombo();
  showScreen('game-screen');
  if (!UI.isMuted()) UI.startMusic();
  renderBoosters();
  showQuestion();
}
window.startDaily = startDaily;

// ===== SHOW QUESTION =====
function showQuestion() {
  if (currentQ >= totalQ) { endGame(); return; }
  answering = false;
  questionStartTime = Date.now();
  const q = questions[currentQ];

  if (bossState) {
    el('boss-emoji').textContent = Boss.getBossEmoji(bossState);
    el('boss-label').textContent = Boss.getBossPhaseLabel(bossState);
    renderBossHP();
  }

  el('q-text').textContent = q.text;
  const vizEl = el('q-visual');
  vizEl.textContent = q.visual || '';
  UI.bounceElement(vizEl);

  el('q-feedback').textContent = '';
  el('g-qn').textContent = (currentQ + 1) + '/' + totalQ;
  el('g-sc').textContent = totalScore;
  el('pfill').style.width = ((currentQ + 1) / totalQ * 100) + '%';

  const ans = el('answers'); ans.innerHTML = '';
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn';
    btn.textContent = opt;
    btn.onclick = () => selectAnswer(opt, btn);
    ans.appendChild(btn);
  });

  clearInterval(timerInterval);
  if (currentTimerMax > 0) {
    timeLeft = currentTimerMax;
    updateTimerUI();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerUI();
      if (timeLeft <= 5) UI.sfxTick();
      if (timeLeft <= 0) { clearInterval(timerInterval); timeUp(); }
    }, 1000);
  } else {
    el('timer').textContent = '';
  }

  renderBoosters();
}

function updateTimerUI() {
  const tEl = el('timer');
  tEl.textContent = T.timerTxt(timeLeft);
  tEl.className = timeLeft <= 5 ? 'timer urgent' : 'timer';
}

// ===== SELECT ANSWER =====
function selectAnswer(selected, btn) {
  if (answering) return;
  answering = true;
  clearInterval(timerInterval);

  const q = questions[currentQ];
  const responseTime = (Date.now() - questionStartTime) / 1000;
  const correct = selected === q.answer;

  document.querySelectorAll('.ans-btn').forEach(b => b.disabled = true);

  if (correct) {
    btn.classList.add('correct');
    totalCorrect++;
    streak++;
    if (streak > highStreak) highStreak = streak;

    const comboMult = Core.getComboMultiplier(streak);
    const qScore = Core.calculateScore(true, timeLeft, currentTimerMax || 15, comboMult, usedHintThisLevel);
    totalScore += qScore;

    const streakMsg = Engage.getStreakMessage(streak);
    if (streakMsg) el('q-feedback').textContent = streakMsg;

    UI.sfxCorrect();
    if (streak > 1) UI.sfxComboUp(streak);
    const rect = btn.getBoundingClientRect();
    const pStyle = levelConfig ? levelConfig.particleStyle : '‚≠ê';
    UI.spawnParticles(rect.left + rect.width / 2, rect.top, 4, pStyle);

    if (bossState) {
      Boss.hitBoss(bossState);
      UI.sfxBossHit();
      renderBossHP();
    }

    Intel.updateSkillData(progress.skillData, true, responseTime);

  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.ans-btn').forEach(b => {
      if (+b.textContent === q.answer) b.classList.add('correct');
    });

    if (streak >= 3) {
      el('q-feedback').textContent = Engage.getWrongAfterStreakMessage(streak);
    }
    streak = 0;

    Core.loseLife(progress);
    renderLives();
    UI.sfxWrong();
    UI.vibrate(100);
    UI.shakeElement(el('gc'));

    if (bossState) {
      const atk = Boss.bossAttack(bossState);
      UI.sfxBossAttack();
      if (atk.gameOver) { setTimeout(() => endGame(), 800); return; }
    }

    if (Core.getLives(progress) <= 0 && !bossState) {
      setTimeout(() => endGame(), 800);
      return;
    }

    Intel.updateSkillData(progress.skillData, false, responseTime);
  }

  Engage.trackAnswer(challengeTracker, correct, responseTime, false);
  updateCombo();
  UI.updateMusicLayers(streak, !!bossState);

  currentQ++;
  const delay = Intel.getTransitionDelay(responseTime);
  setTimeout(showQuestion, delay);
}

function timeUp() {
  if (answering) return;
  answering = true;
  const q = questions[currentQ];
  document.querySelectorAll('.ans-btn').forEach(b => {
    b.disabled = true;
    if (+b.textContent === q.answer) b.classList.add('correct');
  });
  el('q-feedback').textContent = T.timeUp;

  if (streak >= 3) el('q-feedback').textContent = T.timeUp + ' ' + Engage.getWrongAfterStreakMessage(streak);
  streak = 0;
  Core.loseLife(progress);
  renderLives();
  UI.vibrate(100);

  if (bossState) Boss.bossAttack(bossState);
  Engage.trackAnswer(challengeTracker, false, currentTimerMax, false);
  updateCombo();

  currentQ++;
  if (Core.getLives(progress) <= 0 && !bossState) {
    setTimeout(() => endGame(), 800);
  } else {
    setTimeout(showQuestion, 1400);
  }
}

// ===== UI HELPERS =====
function renderLives() {
  const lives = Core.getLives(progress);
  const max = Core.getMaxLives();
  let html = '';
  for (let i = 0; i < max; i++) html += i < lives ? '‚ù§Ô∏è' : 'üñ§';
  el('g-lives').innerHTML = html;
}

function updateCombo() {
  const comboEl = el('g-combo');
  if (streak >= 2) {
    comboEl.textContent = 'üî• x' + Core.getComboMultiplier(streak).toFixed(1);
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

function renderBossHP() {
  if (!bossState) return;
  const segments = Boss.getBossPhaseSegments(bossState);
  const hpEl = el('boss-hp');
  hpEl.innerHTML = '';
  for (const seg of segments) {
    for (let i = 0; i < seg.total; i++) {
      const div = document.createElement('div');
      div.className = 'boss-seg' + (i >= seg.remaining ? ' empty' : '');
      div.style.background = i < seg.remaining ? seg.color : 'rgba(255,255,255,.1)';
      div.style.flex = '1';
      hpEl.appendChild(div);
    }
  }
}

// ===== BOOSTERS =====
function renderBoosters() {
  const bEl = el('boosters');
  bEl.innerHTML = '';
  const types = [
    { key: 'hint', icon: 'üí°', action: useHint },
    { key: 'hammer', icon: 'üî®', action: useHammer },
    { key: 'shuffle', icon: 'üîÑ', action: useShuffle },
    { key: 'extraTime', icon: '‚è±Ô∏è', action: useExtraTime },
  ];
  for (const bt of types) {
    const count = Econ.getBoosterCount(progress, bt.key);
    const btn = document.createElement('button');
    btn.className = 'bst-btn';
    btn.disabled = count <= 0 || answering;
    btn.innerHTML = `${bt.icon}<span class="bst-cnt">${count}</span>`;
    btn.onclick = bt.action;
    bEl.appendChild(btn);
  }
}

function useHint() {
  if (answering) return;
  if (!Econ.useBooster(progress, 'hint')) return;
  usedHintThisLevel = true;
  Core.saveProgress(progress);
  const q = questions[currentQ];
  const btns = [...document.querySelectorAll('.ans-btn')];
  const wrongBtns = btns.filter(b => +b.textContent !== q.answer);
  shuffle(wrongBtns).slice(0, 2).forEach(b => { b.disabled = true; b.style.opacity = '.2'; });
  renderBoosters();
}

function useHammer() {
  if (answering) return;
  if (!Econ.useBooster(progress, 'hammer')) return;
  Core.saveProgress(progress);
  const q = questions[currentQ];
  const btns = [...document.querySelectorAll('.ans-btn')];
  const wrongBtns = btns.filter(b => +b.textContent !== q.answer && !b.disabled);
  if (wrongBtns.length > 0) { wrongBtns[0].disabled = true; wrongBtns[0].style.opacity = '.2'; }
  renderBoosters();
}

function useShuffle() {
  if (answering) return;  
  if (!Econ.useBooster(progress, 'shuffle')) return;
  Core.saveProgress(progress);
  if (!levelConfig) return;
  const pool = pickMultiCatEmoji(levelConfig.cats);
  const diff = Intel.getQuestionDifficulty(currentQ, totalQ, !!bossState);
  questions[currentQ] = genQuestion(levelConfig.ops, levelConfig.range, pool, diff, !!bossState);
  showQuestion();
}

function useExtraTime() {
  if (answering || currentTimerMax <= 0) return;
  if (!Econ.useBooster(progress, 'extraTime')) return;
  Core.saveProgress(progress);
  timeLeft += 5;
  updateTimerUI();
  renderBoosters();
}

// ===== END GAME =====
function endGame() {
  clearInterval(timerInterval);
  UI.stopMusic();
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  const stars = Core.getStarsForScore(totalCorrect, totalQ);
  const isPerfect = totalCorrect === totalQ;
  const noHints = !usedHintThisLevel;

  const xpGained = Core.calculateXP(totalScore, totalQ, isPerfect, noHints, dailyMode);
  const coinsGained = Core.calculateCoins(stars, isPerfect, dailyMode);
  const xpResult = Core.addXP(progress, xpGained);
  Econ.addCoins(progress, coinsGained);

  // Update world progress
  if (currentWorld && currentLevelIndex >= 0 && !dailyMode) {
    Core.updateLevelProgress(progress, currentWorld, currentLevelIndex, totalScore, stars);
  }

  // Daily  
  if (dailyMode) {
    progress.dailyChallengeDate = new Date().toDateString();
    progress.dailyChallengeCompleted = true;
    if (stars === 0) progress.boosters.hint = (progress.boosters.hint || 0) + 1;
  }

  // Skill
  const avgRT = Engage.getAvgResponseTime(challengeTracker);
  Intel.updateSkillAfterLevel(progress.skillData, totalCorrect / totalQ, avgRT, highStreak, totalQ);

  // Badges
  const badges = Engage.evaluateBadges(challengeTracker);
  Engage.saveBadges(progress, badges);
  Core.saveProgress(progress);

  // ===== RENDER DONE =====
  let title, emoji;
  if (isPerfect) { title = T.excellent; emoji = 'üèÜ'; }
  else if (stars >= 2) { title = T.great; emoji = 'üéâ'; }
  else if (stars >= 1) { title = T.good; emoji = 'üëç'; }
  else { title = T.tryMore; emoji = 'üí™'; }

  if (bossState && Boss.isBossDefeated(bossState)) {
    title = 'üëë ' + T.boss + ' - ' + T.excellent;
    emoji = 'üëë';
  }

  el('d-e').textContent = emoji;
  el('d-t').textContent = title;
  el('d-sub').textContent = T.done + (dailyMode ? ' ' + T.dailyReward : '');
  el('d-cr').textContent = totalCorrect;
  el('d-wr').textContent = totalQ - totalCorrect;
  el('d-tm').textContent = elapsed + 's';
  el('d-xp').textContent = '+' + xpResult.xpGained;
  el('d-cn').textContent = '+' + coinsGained;

  // Stars
  const starsEl = el('d-st'); starsEl.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const sp = document.createElement('span');
    sp.textContent = i < stars ? '‚≠ê' : '‚òÜ';
    sp.style.opacity = i < stars ? '1' : '.3';
    starsEl.appendChild(sp);
  }

  // Near miss
  const nearMiss = Engage.checkNearMiss(totalCorrect, Math.ceil(totalQ * 0.6), totalQ, timeLeft, currentQ >= totalQ);
  el('d-near').style.display = nearMiss.isNearMiss ? '' : 'none';
  el('d-near').textContent = nearMiss.isNearMiss ? Engage.getNearMissMessage() : '';

  // Badges
  const badgesEl = el('d-badges'); badgesEl.innerHTML = '';
  for (const b of badges) {
    const span = document.createElement('span');
    span.className = 'd-badge';
    span.textContent = b.icon + ' ' + b.label;
    badgesEl.appendChild(span);
  }
  if (isPerfect) {
    const sp = document.createElement('span');
    sp.className = 'd-badge';
    sp.textContent = 'üèÜ ' + T.perfect;
    badgesEl.appendChild(sp);
  }
  if (noHints && totalQ >= 5) {
    const sp = document.createElement('span');
    sp.className = 'd-badge';
    sp.textContent = 'üß† ' + T.nohint;
    badgesEl.appendChild(sp);
  }

  // Next button: show if playing a world level and got at least 1 star
  el('d-nx').style.display = (currentWorld && currentLevelIndex >= 0 && !dailyMode && stars >= 1) ? '' : 'none';
  el('d-nx').textContent = T.next;

  UI.sfxComplete();
  if (stars > 0) UI.sfxStar();

  // Apply world theme to done screen
  if (levelConfig) {
    el('done-screen').style.background = levelConfig.gradient;
  }
  showScreen('done-screen');
  UI.spawnCelebration(stars * 5 + (isPerfect ? 10 : 0));
  if (window.royalCelebration) window.royalCelebration(stars);

  // Level up   
  if (xpResult.leveledUp) {
    setTimeout(() => {
      el('lvlup-title').textContent = T.lvlUp;
      el('lvlup-msg').textContent = T.newLevel.replace('{n}', xpResult.newLevel) + ' üéÅ +1üî® +1üí° +1‚ù§Ô∏è';
      el('lvlup-modal').classList.add('show');
      UI.sfxLevelUp();
    }, 1500);
  }

  // PostMessage
  const scaledScore = Math.round(totalCorrect / totalQ * 100);
  try {
    window.parent.postMessage({
      type: 'GAME_COMPLETE', score: scaledScore, total: 100,
      timeElapsed: elapsed, level: currentLevelIndex >= 0 ? currentLevelIndex + 1 : 0,
      world: currentWorld, stars
    }, '*');
  } catch(e) {}
}

function closeLvlUp() { el('lvlup-modal').classList.remove('show'); }
window.closeLvlUp = closeLvlUp;

function nextLevel() {
  if (currentWorld && currentLevelIndex >= 0) {
    startLevel(currentWorld, currentLevelIndex + 1);
  }
}
window.nextLevel = nextLevel;

function replayLevel() {
  if (dailyMode) startDaily();
  else if (currentWorld && currentLevelIndex >= 0) startLevel(currentWorld, currentLevelIndex);
}
window.replayLevel = replayLevel;

function exitGame() {
  clearInterval(timerInterval);
  UI.stopMusic();
  if (currentWorld) {
    showScreen('lvl-screen');
  } else {
    showScreen('world-screen');
  }
}
window.exitGame = exitGame;

// ===== SHARE =====
function shareResult() {
  const worldName = currentWorld ? (T.worldNames[currentWorld] || currentWorld) : T.daily;
  const starsCount = currentWorld && currentLevelIndex >= 0 ? (Core.getWorldProgress(progress, currentWorld).stars[currentLevelIndex] || 0) : 0;
  const text = T.shareText.replace('{score}', totalScore).replace('{world}', worldName).replace('{stars}', '‚≠ê'.repeat(starsCount));
  try { if (navigator.share) navigator.share({ title: T.title, text }); } catch(e) {}
  try {
    window.parent.postMessage({
      type: 'SHARE_ACHIEVEMENT', game: 'math', world: currentWorld,
      level: currentLevelIndex, score: totalScore, stars: starsCount, text
    }, '*');
  } catch(e) {}
  el('d-sh').textContent = '‚úÖ';
  setTimeout(() => el('d-sh').textContent = T.share, 2000);
}
window.shareResult = shareResult;

// ===== SHOP =====
function openShop() {
  el('shop-coins').textContent = 'ü™ô ' + Econ.getCoins(progress);
  const items = Econ.getShopItems(progress);
  const grid = el('shop-items'); grid.innerHTML = '';
  const names = { hammer: T.hammer, shuffle: T.shuffle, extraTime: T.extraTime, hint: T.hint };
  for (const item of items) {
    const div = document.createElement('div');
    div.className = 'shop-item';
    div.innerHTML = `
      <div class="shop-item-icon">${item.icon}</div>
      <div class="shop-item-name">${names[item.type] || item.type}</div>
      <div class="shop-item-price">ü™ô ${item.price}</div>
      <div class="shop-item-owned">x${item.owned}</div>
    `;
    const btn = document.createElement('button');
    btn.className = 'shop-buy';
    btn.textContent = T.buy;
    btn.disabled = !item.canAfford;
    btn.onclick = () => {
      const result = Econ.buyBooster(progress, item.type);
      if (result.success) {
        Core.saveProgress(progress);
        openShop();
        updateTopBar();
      }
    };
    div.appendChild(btn);
    grid.appendChild(div);
  }
  el('shop-modal').classList.add('show');
}
window.openShop = openShop;

function closeShop() { el('shop-modal').classList.remove('show'); }
window.closeShop = closeShop;

// ===== PERF TOGGLE =====
function togglePerf() {
  UI.setLowPerf(!UI.isLowPerf());
  updateTopBar();
}
window.togglePerf = togglePerf;

// ===== BOOT =====
init();
</script>
</body>
</html>

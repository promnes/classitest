<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ - Math Challenge</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0}
.screen.active{display:flex}

/* === LEVEL SELECT === */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(8px,2vmin,16px);gap:clamp(6px,1.5vmin,12px);overflow-y:auto;background:linear-gradient(135deg,#8b5cf6,#6366f1)}
.ls-title{font-size:clamp(20px,5vmin,32px);font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3);text-align:center;flex-shrink:0}
.ls-sub{font-size:clamp(11px,2vmin,14px);color:rgba(255,255,255,.8);text-align:center;flex-shrink:0}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(6px,1.5vmin,10px);width:100%;max-width:480px;padding:clamp(4px,1vmin,8px) 0}
.lc{position:relative;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:clamp(10px,2vmin,16px);padding:clamp(8px,2vmin,14px) clamp(4px,1vmin,8px);text-align:center;cursor:pointer;transition:all .2s;backdrop-filter:blur(4px)}
.lc:hover{transform:scale(1.04);background:rgba(255,255,255,.25)}
.lc:active{transform:scale(.96)}
.lc.locked{opacity:.5;cursor:not-allowed}
.lc.locked:hover{transform:none;background:rgba(255,255,255,.15)}
.lc.current{border-color:#fbbf24;box-shadow:0 0 16px rgba(251,191,36,.5)}
.lc-num{font-size:clamp(18px,4vmin,28px);font-weight:900;color:#fff}
.lc-emoji{font-size:clamp(22px,5vmin,34px);margin:2px 0}
.lc-name{font-size:clamp(8px,1.5vmin,11px);color:rgba(255,255,255,.85);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lc-stars{font-size:clamp(10px,2vmin,14px);margin-top:2px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(24px,6vmin,36px)}

/* === GAME === */
#game-screen{flex-direction:column;align-items:center;justify-content:center;padding:clamp(8px,2vmin,16px);gap:clamp(4px,1vmin,10px);background:var(--bg,linear-gradient(135deg,#8b5cf6,#6366f1));transition:background .5s}
.gc{background:rgba(255,255,255,.95);border-radius:clamp(12px,3vmin,24px);padding:clamp(12px,3vmin,24px);max-width:min(480px,95vw);width:100%;max-height:92vh;overflow-y:auto;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.g-hdr{margin-bottom:clamp(8px,2vmin,16px)}
.g-hdr h1{font-size:clamp(14px,3vmin,20px);color:var(--accent,#4c1d95);margin-bottom:6px}
.g-stats{display:flex;justify-content:center;gap:clamp(12px,3vmin,24px);margin-bottom:clamp(8px,2vmin,14px)}
.g-stat{display:flex;flex-direction:column;align-items:center}
.g-sv{font-size:clamp(20px,4.5vmin,28px);font-weight:800;color:var(--accent,#7c3aed)}
.g-sl{font-size:clamp(9px,1.4vmin,11px);color:#6b7280;text-transform:uppercase;letter-spacing:.04em}
.pbar{width:100%;height:clamp(5px,1vmin,8px);background:#e5e7eb;border-radius:999px;margin-bottom:clamp(10px,2.5vmin,18px);overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,var(--accent,#8b5cf6),#ec4899);border-radius:999px;transition:width .4s}
.timer{font-size:clamp(12px,1.8vmin,14px);color:#6b7280;margin-bottom:6px}
.timer.urgent{color:#ef4444;font-weight:700}
.q-area{margin-bottom:clamp(10px,2.5vmin,20px)}
.q-visual{font-size:clamp(18px,4vmin,28px);margin-bottom:6px;line-height:1.4;min-height:clamp(24px,5vmin,36px)}
.q-text{font-size:clamp(28px,7vmin,44px);font-weight:800;color:#1f2937;direction:ltr;margin-bottom:4px}
.q-hint{font-size:clamp(11px,1.6vmin,13px);color:#9ca3af}
.ans-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(6px,1.2vmin,10px);margin-bottom:clamp(8px,2vmin,14px)}
.ans-btn{padding:clamp(10px,2vmin,16px);font-size:clamp(18px,4vmin,24px);font-weight:700;border:3px solid #e5e7eb;border-radius:clamp(10px,2vmin,16px);background:#fff;cursor:pointer;transition:all .2s;color:#374151;position:relative;overflow:hidden}
.ans-btn:hover{border-color:var(--accent,#8b5cf6);background:#f5f3ff;transform:scale(1.03)}
.ans-btn:active{transform:scale(.97)}
.ans-btn.correct{border-color:#10b981;background:#d1fae5;color:#065f46;animation:apulse .4s ease}
.ans-btn.wrong{border-color:#ef4444;background:#fee2e2;color:#991b1b;animation:ashake .4s ease}
.ans-btn:disabled{cursor:default;opacity:.7}
@keyframes apulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes ashake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.g-back{background:none;border:none;color:rgba(255,255,255,.7);font-size:clamp(11px,1.8vmin,13px);font-weight:600;cursor:pointer;padding:6px 12px;border-radius:8px}
.g-back:hover{color:#fff;background:rgba(255,255,255,.15)}

/* === DONE === */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(8px,2vmin,16px);padding:clamp(12px,3vmin,24px);background:var(--bg,linear-gradient(135deg,#8b5cf6,#6366f1))}
.d-emoji{font-size:clamp(44px,12vmin,72px);animation:bounce 1s ease infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.d-title{font-size:clamp(20px,5.5vmin,32px);font-weight:900;color:#fff;text-shadow:0 3px 10px rgba(0,0,0,.3)}
.d-stars{display:flex;gap:clamp(4px,1vmin,8px);font-size:clamp(28px,7vmin,44px)}
.d-sub{font-size:clamp(11px,2.2vmin,14px);color:rgba(255,255,255,.85)}
.d-stats{display:flex;gap:clamp(8px,2vmin,16px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:12px;padding:clamp(6px,1.5vmin,12px) clamp(10px,2.5vmin,18px);backdrop-filter:blur(4px)}
.d-st-e{font-size:clamp(18px,4.5vmin,28px)}
.d-st-v{font-size:clamp(16px,3.5vmin,22px);font-weight:800;color:#fff}
.d-st-l{font-size:clamp(8px,1.3vmin,10px);color:rgba(255,255,255,.7);text-transform:uppercase}
.d-btns{display:flex;gap:clamp(6px,1.5vmin,10px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:14px;padding:clamp(8px,2vmin,14px) clamp(20px,5vmin,36px);font-size:clamp(12px,2.5vmin,16px);font-weight:800;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 18px rgba(249,115,22,.4)}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 18px rgba(37,99,235,.4)}
.particle{position:fixed;pointer-events:none;z-index:999;animation:floatup 1.2s ease-out forwards}
@keyframes floatup{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-90px) scale(.3)}}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="lvl-screen" class="screen active">
  <div class="ls-title" id="ls-t">üßÆ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™</div>
  <div class="ls-sub" id="ls-s">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!</div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="gc">
    <div class="g-hdr"><h1 id="g-t">ÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ üßÆ</h1></div>
    <div class="g-stats">
      <div class="g-stat"><span class="g-sv" id="g-sc">0</span><span class="g-sl" id="g-scl">ÿßŸÑŸÜŸÇÿßÿ∑</span></div>
      <div class="g-stat"><span class="g-sv" id="g-qn">1/10</span><span class="g-sl" id="g-qnl">ÿßŸÑÿ≥ÿ§ÿßŸÑ</span></div>
    </div>
    <div class="pbar"><div class="pfill" id="pfill" style="width:10%"></div></div>
    <div class="timer" id="timer">‚è±Ô∏è 15</div>
    <div class="q-area">
      <div class="q-visual" id="q-visual"></div>
      <div class="q-text" id="q-text">5 + 3 = ?</div>
      <div class="q-hint" id="q-hint"></div>
    </div>
    <div class="ans-grid" id="answers"></div>
  </div>
  <button class="g-back" onclick="showScreen('lvl-screen')">üè† ÿ±ÿ¨Ÿàÿπ</button>
</div>

<!-- DONE -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">üèÜ</div>
  <div class="d-title" id="d-t">ÿ£ÿ≠ÿ≥ŸÜÿ™!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">‚úÖ</div><div class="d-st-v" id="d-cr">0</div><div class="d-st-l" id="d-crl">ÿµÿ≠Ÿäÿ≠</div></div>
    <div class="d-st"><div class="d-st-e">‚ùå</div><div class="d-st-v" id="d-wr">0</div><div class="d-st-l" id="d-wrl">ÿÆÿ∑ÿ£</div></div>
    <div class="d-st"><div class="d-st-e">‚è±Ô∏è</div><div class="d-st-v" id="d-tm">0s</div><div class="d-st-l" id="d-tml">ÿßŸÑŸàŸÇÿ™</div></div>
  </div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="d-btn sec" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="d-btn sec" onclick="showScreen('lvl-screen')">üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™</button>
  </div>
</div>

<script>
// ===== i18n =====
const LANG=new URLSearchParams(location.search).get('lang')||'ar';
document.documentElement.lang=LANG;document.documentElement.dir=LANG==='ar'?'rtl':'ltr';
const I={
ar:{title:'üßÆ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™',sub:'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑÿ™ÿ®ÿØÿ£!',score:'ÿßŸÑŸÜŸÇÿßÿ∑',question:'ÿßŸÑÿ≥ÿ§ÿßŸÑ',time:'ÿßŸÑŸàŸÇÿ™',correct:'ÿµÿ≠Ÿäÿ≠',wrong:'ÿÆÿ∑ÿ£',
excellent:'üåü ŸÖŸÖÿ™ÿßÿ≤!',great:'üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™!',good:'üëç ÿ¨ŸäÿØ!',tryMore:'üí™ ÿ≠ÿßŸàŸÑ ÿ£ŸÉÿ´ÿ±!',done:'ÿ£ÿ™ŸÖŸÖÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ!',
next:'‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä',share:'üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©',again:'üîÑ ÿ•ÿπÿßÿØÿ©',levels:'üè† ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™',back:'üè† ÿ±ÿ¨Ÿàÿπ',locked:'üîí',
timerTxt:(s)=>'‚è±Ô∏è '+s+' ÿ´ÿßŸÜŸäÿ©',timeUp:'‚è∞ ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!',
shareText:'ÿ≠ŸÇŸÇÿ™ {score}/10 ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ {level} ŸÖŸÜ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™! ‚≠ê{stars}',
lvNames:['ÿπÿØ ÿßŸÑŸÖÿ≤ÿ±ÿπÿ©','ÿπÿØ ÿßŸÑŸÅŸàÿßŸÉŸá','ÿπÿØ ÿßŸÑÿ®ÿ≠ÿ±','ÿπÿØ ÿßŸÑÿ≠ÿ¥ÿ±ÿßÿ™','ÿ¨ŸÖÿπ ÿßŸÑÿ∑ŸÇÿ≥','ÿ¨ŸÖÿπ ÿßŸÑÿ≤ŸáŸàÿ±','ÿ¨ŸÖÿπ Ÿà ÿ∑ÿ±ÿ≠ ÿßŸÑÿÆÿ∂ÿßÿ±','ÿ¨ŸÖÿπ Ÿà ÿ∑ÿ±ÿ≠ ÿßŸÑÿ∑ÿπÿßŸÖ','ÿ∂ÿ±ÿ® ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™','ÿ∂ÿ±ÿ® ÿßŸÑŸÅÿ∂ÿßÿ°','ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂ÿ©','ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ','ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≥ŸÅÿßÿ±Ÿä','ÿ™ÿ≠ÿØŸä ÿßŸÑÿ∑ŸäŸàÿ±','ÿ∂ÿ±ÿ® ŸàŸÇÿ≥ŸÖÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™','ÿ∂ÿ±ÿ® ŸàŸÇÿ≥ŸÖÿ© ÿßŸÑÿ£ÿ≤Ÿäÿßÿ°','ŸÉŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ - ŸÖÿ®ÿßŸÜŸä','ŸÉŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ - ŸÖÿØÿ±ÿ≥ÿ©','ÿ™ÿ≠ÿØŸä ÿßŸÑÿ™ŸÇŸÜŸäÿ©','üåç ÿ®ÿ∑ŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™'],
ops:{add:'ÿ¨ŸÖÿπ',sub:'ÿ∑ÿ±ÿ≠',mul:'ÿ∂ÿ±ÿ®',div:'ŸÇÿ≥ŸÖÿ©',mix:'ŸÖÿÆÿ™ŸÑÿ∑'}},
en:{title:'üßÆ Math Challenge',sub:'Choose a level to start!',score:'Score',question:'Question',time:'Time',correct:'Correct',wrong:'Wrong',
excellent:'üåü Excellent!',great:'üéâ Great!',good:'üëç Good!',tryMore:'üí™ Try More!',done:'Level complete!',
next:'‚û°Ô∏è Next',share:'üì§ Share',again:'üîÑ Replay',levels:'üè† Levels',back:'üè† Back',locked:'üîí',
timerTxt:(s)=>'‚è±Ô∏è '+s+'s',timeUp:'‚è∞ Time up!',
shareText:'I scored {score}/10 on Level {level} in Math Challenge! ‚≠ê{stars}',
lvNames:['Farm Counting','Fruit Counting','Sea Counting','Bug Counting','Weather Addition','Flower Addition','Veggie Add & Sub','Food Add & Sub','Vehicle Multiply','Space Multiply','Sports Mixed','Music Mixed','Safari Challenge','Bird Challenge','Tools Mul & Div','Fashion Mul & Div','Building All Ops','School All Ops','Tech Challenge','üåç Math Champion'],
ops:{add:'Addition',sub:'Subtraction',mul:'Multiplication',div:'Division',mix:'Mixed'}},
pt:{title:'üßÆ Desafio Matem√°tico',sub:'Escolha um n√≠vel!',score:'Pontos',question:'Quest√£o',time:'Tempo',correct:'Correto',wrong:'Errado',
excellent:'üåü Excelente!',great:'üéâ Muito Bem!',good:'üëç Bom!',tryMore:'üí™ Tente Mais!',done:'N√≠vel completo!',
next:'‚û°Ô∏è Pr√≥ximo',share:'üì§ Compartilhar',again:'üîÑ Repetir',levels:'üè† N√≠veis',back:'üè† Voltar',locked:'üîí',
timerTxt:(s)=>'‚è±Ô∏è '+s+'s',timeUp:'‚è∞ Acabou!',
shareText:'Acertei {score}/10 no N√≠vel {level} do Desafio Matem√°tico! ‚≠ê{stars}',
lvNames:['Contando Fazenda','Contando Frutas','Contando Mar','Contando Insetos','Adi√ß√£o Clima','Adi√ß√£o Flores','Vegetal Soma & Sub','Comida Soma & Sub','Multiplicar Ve√≠culos','Multiplicar Espa√ßo','Esportes Misto','M√∫sica Misto','Safari Desafio','P√°ssaros Desafio','Ferramentas Mul & Div','Moda Mul & Div','Edif√≠cios Todas Ops','Escola Todas Ops','Tech Desafio','üåç Campe√£o da Matem√°tica'],
ops:{add:'Adi√ß√£o',sub:'Subtra√ß√£o',mul:'Multiplica√ß√£o',div:'Divis√£o',mix:'Misto'}}
};
const t=I[LANG]||I.en;

// ===== 1000+ EDUCATIONAL SYMBOLS =====
const POOL={
farm:['üêÑ','üê∑','üêë','üêê','üê¥','üêî','üêì','ü¶É','üê§','üê£','ü¶Ü','üêï','üêà','üê∞','üêá','üêπ','üê≠','üêø','ü¶î','üê∂','üê±','üêÆ','üêñ','üêó','üêΩ','üêè','üê™','üê´','ü¶ô','üêé','üê•','üïä','üê©','üêæ','ü¶ù','ü¶°','ü¶®','ü¶•','ü¶¶','üêª','üê®','üêº','ü¶ä','üê∫','ü¶´','üêÇ','üêÉ','ü¶Ñ','üêÅ','üêÄ'],
fruit:['üçé','üçè','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçë','üçí','ü•ù','ü••','üçç','ü•≠','üçÖ','ü•ë','ü´ê','ü´í','ü•ï','üçÜ','üå∂','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•ú','üå∞','üçÑ','üç†','ü•¶','ü•ó','ü•£','ü´ô','ü•´','ü•î','ü´ë','üßÜ','ü•ô','ü´ì','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üßà','üçã‚Äçüü©'],
sea:['üêü','üê†','üê°','ü¶à','üê¨','üê≥','üêã','ü¶≠','üêô','ü¶ë','ü¶ê','ü¶Ä','ü¶û','üêö','ü™∏','ü™º','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','ü¶à','üê¨','üêô','ü¶ë','üê†','üêü','üê°','ü¶ê','ü¶Ä','ü¶û','üêö','üê¢','üêä','üêç','üê∏','ü¶é','ü™∏','ü™º','ü¶≠','üêâ','üê≤','ü¶ï','ü¶ñ'],
bug:['ü¶ã','üêõ','üêù','üêû','ü¶ó','üï∑','ü¶Ç','üêú','ü™≤','ü™≥','ü¶ü','ü™∞','üêå','ü™±','üåø','üçÄ','üçÅ','üçÇ','üçÉ','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','ü™¥','üéã','üéç','üçÑ','üåª','üå∏','üåπ','üå∫','üåº','üå∑','üíê','ü™ª','ü™∑','üê¶','üïä','ü¶ã','üêõ','üêù','üêû','ü¶ó','üêú','ü™≤','üêå','ü™±','üï∑'],
weather:['‚òÄÔ∏è','üå§','‚õÖ','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨','üí®','üåä','üåà','üå™','üå´','üíß','üí¶','üå°','üî•','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','üåô','üåõ','üåú','üåö','üåù','üåû','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üåå','üå†'],
flower:['üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥','üéã','üéç','ü™π','ü™∫','üçÑ','üåø','üéÑ','üíÆ','üèµ','üå∏','üåπ','üå∫','üåª','üåº','üå∑','üíê','ü™ª','ü™∑','üå±','üå≤','üå≥','üå¥','üåµ','üçÄ','‚òòÔ∏è','üçÅ','üçÇ','üçÉ','ü™¥'],
veggie:['ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','ü•ô','üå±','ü•ï','ü•¶','üåΩ','ü•í','ü•¨','üßÖ','üßÑ','ü•î','üçÜ','üå∂','ü´ë','ü•ú','üå∞','üçÑ','üç†','ü´ò','ü´õ','ü•ó','üßÜ','üåø','üçÄ','üåæ','üåª','üåº','ü™¥','üßÇ','ü´ô','ü•´','üßà'],
food:['üçï','üçî','üåÆ','üåØ','ü•ö','üç≥','ü•ò','üç≤','üçø','üç±','üçò','üçô','üçö','üçõ','üçú','üçù','üç†','üç¢','üç£','üç§','üç•','ü•Æ','üç°','ü•ü','ü•†','ü•°','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üç©','üç™','üçØ','ü•ê','ü•ñ','üßá','ü•û','üßà','ü´ï','ü´î','ü•£','ü´ó','üçø','üç±','üßÜ','ü•ô','ü´ì'],
vehicle:['üöó','üöï','üöô','üöå','üöé','üèé','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèç','üõµ','üö≤','üõ¥','üõπ','üõº','üöÅ','üõ∏','üöÄ','üõ©','‚úàÔ∏è','üõ´','üõ¨','üö¢','‚õµ','üõ∂','üö§','üõ•','üõ≥','‚õ¥','üöÇ','üöÉ','üöÑ','üöÖ','üöÜ','üöá','üöà','üöâ','üöä','üöù','üöû','üöã','üö†','üö°','üõ∞','üöè'],
space:['üåç','üåé','üåè','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','üåù','üåû','‚òÄÔ∏è','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','ü™ê','üî≠','üî¨','üß≤','üß™','üß´','üß¨','üí°','üî¶','üïØ','ü™î','üîã','‚ö°','üõ∏','üöÄ','üõ∞','üì°','üåå','üå†','üéÜ','üéá','üí•','üî•','üíß','üåä','üåÄ','üåà'],
sport:['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','üèí','ü•ç','üèè','ü•Ö','‚õ≥','ü™Å','üèπ','üéØ','ü•ä','ü•ã','üéø','‚õ∑','üèÇ','üèãÔ∏è','ü§∏','ü§∫','ü§æ','üèåÔ∏è','üèá','üßò','üßó','ü§ø','üèÑ','üèä','üö£','üéΩ','üèÖ','ü•á','ü•à','ü•â','üèÜ','üéñ','üé™','üé†','üé°','üé¢','üõù','‚õ∫'],
music:['üéµ','üé∂','üéº','üéπ','üé∏','üé∫','üéª','ü•Å','ü™ò','ü™ó','üé∑','üé§','üéß','üìØ','ü™à','üé¨','üé≠','üé®','üñå','üñç','‚úèÔ∏è','üñä','üñã','üìù','üé™','üé†','üé≤','üéØ','üé≥','üé∞','üéÆ','üïπ','üì∫','üìª','üì∏','üé•','üìπ','üìΩ','üéû','üéü','üíø','üìÄ','üíΩ','üì±','üñ•','‚å®Ô∏è','üñ±','üñ®','üì¢','üì£'],
wild:['ü¶Å','üêØ','üêÖ','üêÜ','ü¶í','ü¶ì','üêò','ü¶õ','ü¶è','üêª','ü¶ä','üê∫','ü¶å','ü¶¨','ü¶£','ü¶ß','ü¶ç','üêí','üêµ','üôà','üôâ','üôä','ü¶ò','ü¶•','ü¶®','ü¶°','ü¶ù','ü¶¶','üêª‚Äç‚ùÑÔ∏è','üêº','üê®','üêæ','üêä','üê¢','üêç','ü¶é','üê∏','üê≤','üêâ','ü¶ï','ü¶ñ','ü¶ã','üêù','üêû','ü¶Ö','ü¶â','üêß','ü¶ú','ü¶ö','ü¶©'],
bird:['ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü¶§','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶Ö','ü¶Ü','ü¶â','ü¶ú','üêß','ü¶ö','ü¶¢','ü¶©','ü™∂','üê¶','üïä','ü¶É','üêî','üêì','üê§','üê£','üê•','ü¶§','ü™π','ü™∫','ü•ö','üêæ','üåø','üçÄ','üå≤','üå≥','‚òÅÔ∏è','üå§','‚õÖ','üåà','üåÖ','üèî'],
tool:['üî®','ü™ì','‚õè','üîß','ü™õ','üî©','‚öôÔ∏è','üóú','ü™ö','üìè','üìê','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üîë','üóù','üîí','üîì','ü™§','üß≤','ü™ù','üß∞','ü™ú','ü™£','üßπ','üß∫','üßª','ü™†','üßº','üßΩ','ü™•','ü™í','üîã','üîå','üí°','üî¶','üïØ','ü™î','üßØ','ü™§','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üìé','üñá','üóë'],
fashion:['üëï','üëñ','üß£','üß§','üß•','üß¶','üëó','üëò','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üéí','ü©¥','üëû','üëü','ü•æ','ü•ø','üë†','üë°','ü©∞','üë¢','üëë','üëí','üé©','ü™ñ','‚õëÔ∏è','üíÑ','üíç','üíé','üëì','üï∂','ü•Ω','üìø','üß¢','üëï','üëñ','üß£','üß•','üëó','üëò','üéí','üëü','ü•æ','üë†'],
building:['üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üïå','üïç','‚õ™','üïã','üõï','‚õ©','üèó','üèö','üóº','üóΩ','üóæ','üéë','‚õ≤','‚õ∫','üèõ','üèü','üó∫','üèñ','üèú','üèù','üèû','üèî','‚õ∞','üåã','üåÅ','üåâ','üåÖ','üåÑ','üåá','üåÜ','üèô','üåÉ','üóª','üé™','üé°'],
school:['üìö','üìñ','üìù','üìí','üìì','üìî','üìï','üìó','üìò','üìô','üìÑ','üìÉ','üìã','üìé','üìè','üìê','‚úÇÔ∏è','‚úèÔ∏è','üñä','üñã','üñç','üîó','üìå','üìç','üóÇ','üìÅ','üìÇ','üóÉ','üóÑ','üóë','üì∞','üóû','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üîñ','üìÆ','üì¨','üì≠','üì™','üì´','‚úâÔ∏è','üì©','üì®','üìß','üíå'],
tech:['üíª','üñ•','üñ®','‚å®Ô∏è','üñ±','üíΩ','üíæ','üíø','üì±','üì≤','üì∑','üì∏','üìπ','üì∫','üìª','üì°','üîå','üîã','üí°','üìü','üì†','üïπ','üéÆ','üéß','üî¨','üî≠','üì°','üõ∞','üíª','üñ•','‚å®Ô∏è','üñ±','üì±','üì≤','üì∑','üìπ','üì∫','üìª','üîå','üîã','üí°','üïπ','üéÆ','üéß','üî¨','üî≠','üõ∞','üì°','‚åö','ü§ñ'],
mix:['üêÑ','üçé','üêü','ü¶ã','‚òÄÔ∏è','üå∏','ü•ï','üçï','üöó','üåç','‚öΩ','üéµ','ü¶Å','ü¶Ö','üî®','üëï','üè†','üìö','üíª','üéâ','üê∑','üçä','üê¨','üêù','üåà','üåπ','üåΩ','üçî','üöå','ü™ê','üèÄ','üé∏','üêØ','ü¶â','üîß','üëó','üè´','üìñ','üì±','üéä','üê¥','üçá','üêô','üêû','‚≠ê','üåª','üçÜ','üç∞','‚úàÔ∏è','üöÄ']
};

// ===== THEMES =====
const THEMES=[
  {bg:'linear-gradient(135deg,#86efac,#22c55e)',accent:'#16a34a'},
  {bg:'linear-gradient(135deg,#fca5a5,#ef4444)',accent:'#b91c1c'},
  {bg:'linear-gradient(135deg,#67e8f9,#0891b2)',accent:'#0e7490'},
  {bg:'linear-gradient(135deg,#a3e635,#65a30d)',accent:'#4d7c0f'},
  {bg:'linear-gradient(135deg,#93c5fd,#3b82f6)',accent:'#1d4ed8'},
  {bg:'linear-gradient(135deg,#f9a8d4,#ec4899)',accent:'#be185d'},
  {bg:'linear-gradient(135deg,#86efac,#16a34a)',accent:'#15803d'},
  {bg:'linear-gradient(135deg,#fdba74,#ea580c)',accent:'#c2410c'},
  {bg:'linear-gradient(135deg,#cbd5e1,#475569)',accent:'#334155'},
  {bg:'linear-gradient(135deg,#c4b5fd,#7c3aed)',accent:'#6d28d9'},
  {bg:'linear-gradient(135deg,#6ee7b7,#059669)',accent:'#047857'},
  {bg:'linear-gradient(135deg,#d8b4fe,#9333ea)',accent:'#7e22ce'},
  {bg:'linear-gradient(135deg,#fde68a,#d97706)',accent:'#b45309'},
  {bg:'linear-gradient(135deg,#7dd3fc,#0284c7)',accent:'#0369a1'},
  {bg:'linear-gradient(135deg,#fb923c,#c2410c)',accent:'#9a3412'},
  {bg:'linear-gradient(135deg,#f0abfc,#a855f7)',accent:'#9333ea'},
  {bg:'linear-gradient(135deg,#a8a29e,#57534e)',accent:'#44403c'},
  {bg:'linear-gradient(135deg,#60a5fa,#2563eb)',accent:'#1d4ed8'},
  {bg:'linear-gradient(135deg,#22d3ee,#0e7490)',accent:'#0891b2'},
  {bg:'linear-gradient(135deg,#fb7185,#be123c)',accent:'#9f1239'},
];

// ===== 20 LEVEL CONFIG =====
// ops: add, sub, mul, div; range: max number; timer: seconds per question; questions: number
const LEVELS=[
  {cat:'farm',   ops:['add'],         range:5,  timer:20,questions:10,emoji:'üêÑ'},
  {cat:'fruit',  ops:['add'],         range:8,  timer:18,questions:10,emoji:'üçé'},
  {cat:'sea',    ops:['add'],         range:10, timer:18,questions:10,emoji:'üê†'},
  {cat:'bug',    ops:['add'],         range:12, timer:16,questions:10,emoji:'ü¶ã'},
  {cat:'weather',ops:['add','sub'],   range:10, timer:18,questions:10,emoji:'üå§'},
  {cat:'flower', ops:['add','sub'],   range:15, timer:16,questions:10,emoji:'üå∏'},
  {cat:'veggie', ops:['add','sub'],   range:20, timer:16,questions:10,emoji:'ü•ï'},
  {cat:'food',   ops:['add','sub'],   range:25, timer:15,questions:10,emoji:'üçï'},
  {cat:'vehicle',ops:['mul'],         range:5,  timer:18,questions:10,emoji:'üöó'},
  {cat:'space',  ops:['mul'],         range:8,  timer:16,questions:10,emoji:'üöÄ'},
  {cat:'sport',  ops:['add','sub','mul'],range:12,timer:15,questions:10,emoji:'‚öΩ'},
  {cat:'music',  ops:['add','sub','mul'],range:15,timer:14,questions:10,emoji:'üéµ'},
  {cat:'wild',   ops:['add','sub','mul'],range:20,timer:14,questions:10,emoji:'ü¶Å'},
  {cat:'bird',   ops:['add','sub','mul'],range:25,timer:13,questions:10,emoji:'ü¶Ö'},
  {cat:'tool',   ops:['mul','div'],   range:10, timer:16,questions:10,emoji:'üî®'},
  {cat:'fashion',ops:['mul','div'],   range:12, timer:15,questions:10,emoji:'üëó'},
  {cat:'building',ops:['add','sub','mul','div'],range:20,timer:14,questions:10,emoji:'üè†'},
  {cat:'school', ops:['add','sub','mul','div'],range:30,timer:13,questions:10,emoji:'üìö'},
  {cat:'tech',   ops:['add','sub','mul','div'],range:50,timer:12,questions:10,emoji:'üíª'},
  {cat:'mix',    ops:['add','sub','mul','div'],range:100,timer:10,questions:10,emoji:'üåç'},
];

// ===== AUDIO =====
let audioCtx=null;
function ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function tone(f,d,tp,v){try{const c=ctx(),o=c.createOscillator(),g=c.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v||.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+(d||.15));o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+(d||.15))}catch(e){}}
function sfxCorrect(){tone(659,.1,'sine',.1);setTimeout(()=>tone(988,.12,'sine',.1),80)}
function sfxWrong(){tone(220,.15,'sawtooth',.06)}
function sfxComplete(){[523,659,784,988,1175,1319].forEach((f,i)=>setTimeout(()=>tone(f,.18,'sine',.1),i*80))}
function sfxStar(){[880,1100,1320].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*120))}
function sfxTick(){tone(440,.03,'sine',.04)}

// ===== GAME STATE =====
let currentLevel=-1,currentQ=0,score=0,questions=[],timer=null,timeLeft=15;
let answering=false,startTime=0,levelEmoji=[],totalQ=10,currentTimerMax=15;

let progress=JSON.parse(localStorage.getItem('classify_math_progress')||'{"unlocked":1,"scores":{},"stars":{}}');
function saveProgress(){localStorage.setItem('classify_math_progress',JSON.stringify(progress))}

// ===== HELPERS =====
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function pickEmoji(cat){const pool=POOL[cat]||POOL.mix;return shuffle([...new Set(pool)])}

// ===== QUESTION GENERATION =====
function genQuestion(ops,range,emojiPool){
  const op=ops[Math.floor(Math.random()*ops.length)];
  let a,b,answer,text,visual='';
  const em=emojiPool[Math.floor(Math.random()*emojiPool.length)];
  switch(op){
    case 'add':
      a=Math.floor(Math.random()*range)+1;
      b=Math.floor(Math.random()*range)+1;
      answer=a+b;text=`${a} + ${b} = ?`;
      if(a<=6&&b<=6){visual=em.repeat(a)+' + '+em.repeat(b)}
      break;
    case 'sub':
      a=Math.floor(Math.random()*range)+1;
      b=Math.floor(Math.random()*a)+1;
      answer=a-b;text=`${a} - ${b} = ?`;
      if(a<=8){visual=em.repeat(a)+' - '+em.repeat(b)}
      break;
    case 'mul':
      a=Math.floor(Math.random()*Math.min(range,12))+1;
      b=Math.floor(Math.random()*Math.min(range,12))+1;
      answer=a*b;text=`${a} √ó ${b} = ?`;
      if(a<=4&&b<=4){const rows=[];for(let i=0;i<a;i++)rows.push(em.repeat(b));visual=rows.join(' ')}
      break;
    case 'div':
      b=Math.floor(Math.random()*Math.min(range,12))+1;
      const q=Math.floor(Math.random()*Math.min(range,12))+1;
      a=b*q;
      answer=q;text=`${a} √∑ ${b} = ?`;
      if(a<=12){visual=em.repeat(a)+' √∑ '+b}
      break;
  }
  // Generate wrong answers
  const wrongs=new Set();
  while(wrongs.size<3){
    const off=Math.floor(Math.random()*10)+1;
    const w=Math.random()<.5?answer+off:answer-off;
    if(w!==answer&&w>=0&&!wrongs.has(w))wrongs.add(w);
  }
  const options=shuffle([answer,...wrongs]);
  return{text,answer,options,visual};
}

function genAllQuestions(){
  const cfg=LEVELS[currentLevel];
  const pool=pickEmoji(cfg.cat);
  questions=[];
  for(let i=0;i<cfg.questions;i++)questions.push(genQuestion(cfg.ops,cfg.range,pool));
}

// ===== SCREENS =====
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='lvl-screen')renderLevelSelect();
}

function renderLevelSelect(){
  const g=document.getElementById('ls-g');g.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cfg=LEVELS[i];
    const unlocked=i<progress.unlocked;
    const stars=progress.stars[i]||0;
    const isCurr=i===progress.unlocked-1;
    const card=document.createElement('div');
    card.className='lc'+(unlocked?'':' locked')+(isCurr?' current':'');
    if(unlocked){
      card.innerHTML=`<div class="lc-num">${i+1}</div><div class="lc-emoji">${cfg.emoji}</div><div class="lc-name">${t.lvNames[i]}</div><div class="lc-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>`;
      card.onclick=()=>startLevel(i);
    } else {
      card.innerHTML=`<div class="lc-num" style="opacity:.4">${i+1}</div><div class="lc-lock">${t.locked}</div><div class="lc-name" style="opacity:.4">${t.lvNames[i]}</div>`;
    }
    g.appendChild(card);
  }
}

// ===== START LEVEL =====
function startLevel(idx){
  currentLevel=idx;
  const cfg=LEVELS[idx];
  totalQ=cfg.questions;currentTimerMax=cfg.timer;
  const theme=THEMES[idx];
  document.getElementById('game-screen').style.background=theme.bg;
  document.getElementById('game-screen').style.setProperty('--accent',theme.accent);
  document.getElementById('done-screen').style.background=theme.bg;
  document.getElementById('g-t').textContent=t.lvNames[idx]+' üßÆ';
  currentQ=0;score=0;answering=false;
  startTime=Date.now();
  genAllQuestions();
  document.getElementById('g-sc').textContent='0';
  showScreen('game-screen');
  showQuestion();
}

function showQuestion(){
  if(currentQ>=totalQ){endGame();return}
  answering=false;
  const q=questions[currentQ];
  document.getElementById('q-text').textContent=q.text;
  document.getElementById('q-visual').textContent=q.visual||'';
  document.getElementById('q-hint').textContent='';
  document.getElementById('g-qn').textContent=(currentQ+1)+'/'+totalQ;
  document.getElementById('g-sc').textContent=score;
  document.getElementById('pfill').style.width=((currentQ+1)/totalQ*100)+'%';
  const ans=document.getElementById('answers');ans.innerHTML='';
  q.options.forEach(opt=>{
    const btn=document.createElement('button');btn.className='ans-btn';btn.textContent=opt;
    btn.onclick=()=>selectAns(opt,btn);ans.appendChild(btn);
  });
  timeLeft=currentTimerMax;updateTimerUI();
  clearInterval(timer);
  timer=setInterval(()=>{timeLeft--;updateTimerUI();sfxTick();if(timeLeft<=0){clearInterval(timer);timeUp()}},1000);
}

function updateTimerUI(){
  const el=document.getElementById('timer');
  el.textContent=t.timerTxt(timeLeft);
  el.className=timeLeft<=5?'timer urgent':'timer';
}

function selectAns(sel,btn){
  if(answering)return;answering=true;clearInterval(timer);
  const q=questions[currentQ];
  document.querySelectorAll('.ans-btn').forEach(b=>b.disabled=true);
  if(sel===q.answer){btn.classList.add('correct');score++;sfxCorrect();spawnStars(btn)}
  else{btn.classList.add('wrong');sfxWrong();document.querySelectorAll('.ans-btn').forEach(b=>{if(+b.textContent===q.answer)b.classList.add('correct')})}
  currentQ++;setTimeout(showQuestion,1100);
}

function timeUp(){
  answering=true;const q=questions[currentQ];
  document.querySelectorAll('.ans-btn').forEach(b=>{b.disabled=true;if(+b.textContent===q.answer)b.classList.add('correct')});
  document.getElementById('q-hint').textContent=t.timeUp;
  currentQ++;setTimeout(()=>{document.getElementById('q-hint').textContent='';showQuestion()},1300);
}

function spawnStars(btn){
  const rect=btn.getBoundingClientRect();
  for(let i=0;i<4;i++){const p=document.createElement('div');p.className='particle';p.textContent=['‚≠ê','‚ú®','üåü'][Math.floor(Math.random()*3)];p.style.left=(rect.left+Math.random()*rect.width)+'px';p.style.top=rect.top+'px';p.style.fontSize='22px';document.body.appendChild(p);setTimeout(()=>p.remove(),1300)}
}

function endGame(){
  clearInterval(timer);
  const elapsed=Math.round((Date.now()-startTime)/1000);
  let stars=0;
  if(score>=6)stars=1;if(score>=8)stars=2;if(score>=10)stars=3;
  if(currentLevel>=0){
    const prev=progress.stars[currentLevel]||0;if(stars>prev)progress.stars[currentLevel]=stars;
    const prevSc=progress.scores[currentLevel]||0;if(score>prevSc)progress.scores[currentLevel]=score;
    if(stars>=1&&currentLevel+1>=progress.unlocked)progress.unlocked=currentLevel+2;
    saveProgress();
  }
  let title,emoji;
  if(stars>=3){title=t.excellent;emoji='üèÜ'}else if(stars>=2){title=t.great;emoji='üéâ'}else if(stars>=1){title=t.good;emoji='üëç'}else{title=t.tryMore;emoji='üí™'}
  document.getElementById('d-e').textContent=emoji;
  document.getElementById('d-t').textContent=title;
  document.getElementById('d-sub').textContent=t.done;
  document.getElementById('d-cr').textContent=score;
  document.getElementById('d-wr').textContent=totalQ-score;
  document.getElementById('d-tm').textContent=elapsed+'s';
  const starsEl=document.getElementById('d-st');starsEl.innerHTML='';
  for(let i=0;i<3;i++){const sp=document.createElement('span');sp.textContent=i<stars?'‚≠ê':'‚òÜ';sp.style.opacity=i<stars?'1':'.3';starsEl.appendChild(sp)}
  document.getElementById('d-nx').style.display=(currentLevel>=0&&currentLevel<LEVELS.length-1)?'':'none';
  sfxComplete();if(stars>0)sfxStar();
  showScreen('done-screen');
  // Particles
  for(let i=0;i<stars*5;i++){setTimeout(()=>{const p=document.createElement('div');p.className='particle';p.textContent=['‚≠ê','‚ú®','üèÜ','üéâ','üíé'][Math.floor(Math.random()*5)];p.style.left=(Math.random()*innerWidth)+'px';p.style.top=(innerHeight*.6+Math.random()*80)+'px';p.style.fontSize='22px';document.body.appendChild(p);setTimeout(()=>p.remove(),1300)},i*70)}
  // PostMessage ‚Äî score is out of 100 scale
  const scaledScore=Math.round(score/totalQ*100);
  try{window.parent.postMessage({type:'GAME_COMPLETE',score:scaledScore,total:100,timeElapsed:elapsed,level:currentLevel>=0?currentLevel+1:0,stars:stars},'*')}catch(e){}
}

function nextLevel(){if(currentLevel>=0&&currentLevel<LEVELS.length-1)startLevel(currentLevel+1)}
function replayLevel(){if(currentLevel>=0)startLevel(currentLevel)}
function shareResult(){
  const lvl=currentLevel>=0?currentLevel+1:0;const stars=currentLevel>=0?(progress.stars[currentLevel]||0):0;
  const text=t.shareText.replace('{score}',score).replace('{level}',lvl).replace('{stars}','‚≠ê'.repeat(stars));
  try{if(navigator.share)navigator.share({title:t.title,text:text})}catch(e){}
  try{window.parent.postMessage({type:'SHARE_ACHIEVEMENT',game:'math',level:lvl,score:score,stars:stars,text:text},'*')}catch(e){}
  const btn=document.getElementById('d-sh');const o=btn.textContent;btn.textContent='‚úÖ';setTimeout(()=>{btn.textContent=o},2000);
}

// ===== i18n APPLY =====
document.getElementById('ls-t').textContent=t.title;
document.getElementById('ls-s').textContent=t.sub;
document.getElementById('g-scl').textContent=t.score;
document.getElementById('g-qnl').textContent=t.question;
document.getElementById('d-crl').textContent=t.correct;
document.getElementById('d-wrl').textContent=t.wrong;
document.getElementById('d-tml').textContent=t.time;
document.getElementById('d-nx').textContent=t.next;
document.getElementById('d-sh').textContent=t.share;

// ===== INIT =====
renderLevelSelect();
</script>
</body>
</html>

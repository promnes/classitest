<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ - Emoji Kingdom</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,sans-serif;user-select:none;-webkit-tap-highlight-color:transparent}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0}
.screen.active{display:flex}

/* LEVEL SELECT */
#lvl-screen{flex-direction:column;align-items:center;padding:clamp(6px,1.5vmin,12px);gap:clamp(4px,1vmin,8px);overflow-y:auto;background:linear-gradient(135deg,#8b5cf6,#6366f1)}
.top-bar{display:flex;width:100%;max-width:500px;justify-content:space-between;align-items:center;flex-shrink:0;gap:6px;flex-wrap:wrap}
.tb-item{display:flex;align-items:center;gap:3px;background:rgba(255,255,255,.15);border-radius:10px;padding:4px 10px;font-size:clamp(10px,1.8vmin,13px);color:#fff;font-weight:700;backdrop-filter:blur(4px)}
.xp-bar-wrap{width:100%;max-width:500px;flex-shrink:0}
.xp-bar{height:6px;background:rgba(255,255,255,.2);border-radius:99px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px;transition:width .5s}
.xp-label{font-size:clamp(8px,1.3vmin,10px);color:rgba(255,255,255,.7);text-align:center;margin-top:2px}
.ls-title{font-size:clamp(18px,4.5vmin,28px);font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3);text-align:center;flex-shrink:0}
.ls-btns{display:flex;gap:8px;flex-shrink:0}
.ls-btn{border:none;background:rgba(255,255,255,.2);color:#fff;font-weight:700;font-size:clamp(10px,1.8vmin,13px);padding:6px 14px;border-radius:10px;cursor:pointer;backdrop-filter:blur(4px)}
.ls-btn:hover{background:rgba(255,255,255,.35)}
.ls-btn:active{transform:scale(.95)}
.ls-btn.daily{background:linear-gradient(135deg,#f59e0b,#f97316);box-shadow:0 2px 10px rgba(249,115,22,.4)}
.ls-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:clamp(5px,1.2vmin,8px);width:100%;max-width:500px;padding:2px 0}
.lc{position:relative;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);border-radius:clamp(8px,1.8vmin,14px);padding:clamp(6px,1.5vmin,12px) clamp(3px,0.8vmin,6px);text-align:center;cursor:pointer;transition:all .2s;backdrop-filter:blur(4px)}
.lc:hover{transform:scale(1.04);background:rgba(255,255,255,.25)}
.lc:active{transform:scale(.96)}
.lc.locked{opacity:.5;cursor:not-allowed}.lc.locked:hover{transform:none;background:rgba(255,255,255,.15)}
.lc.current{border-color:#fbbf24;box-shadow:0 0 14px rgba(251,191,36,.5)}
.lc-num{font-size:clamp(16px,3.5vmin,24px);font-weight:900;color:#fff}
.lc-emoji{font-size:clamp(20px,4.5vmin,30px);margin:1px 0}
.lc-name{font-size:clamp(7px,1.2vmin,10px);color:rgba(255,255,255,.85);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lc-stars{font-size:clamp(9px,1.6vmin,12px);margin-top:1px}
.lc-lock{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(22px,5vmin,32px)}

/* GAME SCREEN */
#game-screen{flex-direction:column;align-items:center;justify-content:flex-start;padding:clamp(6px,1.5vmin,12px);gap:clamp(3px,0.8vmin,6px);background:var(--bg,linear-gradient(135deg,#8b5cf6,#6366f1));transition:background .5s}
.g-top{display:flex;width:100%;max-width:480px;justify-content:space-between;align-items:center;gap:6px;flex-shrink:0}
.g-lives{display:flex;gap:1px;font-size:clamp(14px,3vmin,20px)}
.g-combo{font-size:clamp(12px,2.5vmin,16px);font-weight:800;color:#fbbf24;min-width:60px;text-align:center;opacity:0;transition:opacity .3s}
.g-combo.show{opacity:1}
.gc{background:rgba(255,255,255,.95);border-radius:clamp(10px,2.5vmin,20px);padding:clamp(10px,2.5vmin,20px);max-width:min(480px,95vw);width:100%;text-align:center;box-shadow:0 16px 50px rgba(0,0,0,.3);flex-shrink:1;overflow-y:auto;max-height:75vh}
.g-hdr h1{font-size:clamp(13px,2.5vmin,18px);color:var(--accent,#4c1d95);margin-bottom:4px}
.g-stats{display:flex;justify-content:center;gap:clamp(10px,2.5vmin,20px);margin-bottom:clamp(6px,1.5vmin,10px)}
.g-stat{display:flex;flex-direction:column;align-items:center}
.g-sv{font-size:clamp(18px,4vmin,24px);font-weight:800;color:var(--accent,#7c3aed)}
.g-sl{font-size:clamp(8px,1.2vmin,10px);color:#6b7280;text-transform:uppercase;letter-spacing:.04em}
.pbar{width:100%;height:clamp(4px,0.8vmin,6px);background:#e5e7eb;border-radius:99px;margin-bottom:clamp(6px,1.5vmin,10px);overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,var(--accent,#8b5cf6),#ec4899);border-radius:99px;transition:width .4s}
.timer{font-size:clamp(11px,1.6vmin,13px);color:#6b7280;margin-bottom:4px}
.timer.urgent{color:#ef4444;font-weight:700;animation:pulse .5s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.q-area{margin-bottom:clamp(6px,1.5vmin,12px)}
.q-visual{font-size:clamp(16px,3.5vmin,24px);margin-bottom:4px;line-height:1.4;min-height:clamp(20px,4vmin,30px);transition:opacity .3s}
.q-text{font-size:clamp(24px,6vmin,38px);font-weight:800;color:#1f2937;direction:ltr;margin-bottom:2px}
.q-feedback{font-size:clamp(12px,2.2vmin,16px);color:#f59e0b;font-weight:700;min-height:clamp(16px,2.5vmin,20px);transition:all .3s}
.ans-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(5px,1vmin,8px);margin-bottom:clamp(6px,1.5vmin,10px)}
.ans-btn{padding:clamp(8px,1.8vmin,14px);font-size:clamp(16px,3.5vmin,22px);font-weight:700;border:3px solid #e5e7eb;border-radius:clamp(8px,1.8vmin,14px);background:#fff;cursor:pointer;transition:all .15s;color:#374151}
.ans-btn:hover{border-color:var(--accent,#8b5cf6);background:#f5f3ff;transform:scale(1.03)}
.ans-btn:active{transform:scale(.97)}
.ans-btn.correct{border-color:#10b981;background:#d1fae5;color:#065f46;animation:apulse .4s ease}
.ans-btn.wrong{border-color:#ef4444;background:#fee2e2;color:#991b1b;animation:ashake .4s ease}
.ans-btn:disabled{cursor:default;opacity:.7}
@keyframes apulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes ashake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

/* BOOSTERS */
.boosters{display:flex;justify-content:center;gap:clamp(6px,1.5vmin,10px);margin-top:4px}
.bst-btn{border:none;background:rgba(0,0,0,.06);border-radius:10px;padding:4px 10px;font-size:clamp(10px,1.8vmin,14px);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:3px}
.bst-btn:hover{background:rgba(0,0,0,.12);transform:scale(1.05)}
.bst-btn:disabled{opacity:.3;cursor:not-allowed}
.bst-cnt{font-size:clamp(8px,1.3vmin,11px);color:#6b7280;font-weight:600}

/* BOSS */
.boss-bar{width:100%;max-width:480px;flex-shrink:0}
.boss-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.boss-emoji{font-size:clamp(24px,5vmin,36px);animation:bossFloat 2s ease infinite}
@keyframes bossFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-label{font-size:clamp(11px,1.8vmin,14px);color:#fff;font-weight:700}
.boss-hp{display:flex;height:clamp(10px,2vmin,14px);border-radius:99px;overflow:hidden;gap:2px;background:rgba(0,0,0,.2);padding:2px}
.boss-seg{flex:1;border-radius:99px;transition:all .3s}
.boss-seg.empty{opacity:.2}

/* DONE */
#done-screen{flex-direction:column;align-items:center;justify-content:center;gap:clamp(6px,1.5vmin,12px);padding:clamp(10px,2.5vmin,20px);background:var(--bg,linear-gradient(135deg,#8b5cf6,#6366f1));overflow-y:auto}
.d-emoji{font-size:clamp(40px,10vmin,64px);animation:bounce 1s ease infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.d-title{font-size:clamp(18px,5vmin,28px);font-weight:900;color:#fff;text-shadow:0 3px 10px rgba(0,0,0,.3)}
.d-stars{display:flex;gap:clamp(3px,0.8vmin,6px);font-size:clamp(24px,6vmin,38px)}
.d-sub{font-size:clamp(10px,2vmin,13px);color:rgba(255,255,255,.85)}
.d-near{font-size:clamp(12px,2.2vmin,15px);color:#fbbf24;font-weight:700;animation:pulse .8s ease infinite}
.d-stats{display:flex;gap:clamp(6px,1.5vmin,12px);flex-wrap:wrap;justify-content:center}
.d-st{text-align:center;background:rgba(255,255,255,.2);border-radius:10px;padding:clamp(5px,1.2vmin,10px) clamp(8px,2vmin,16px);backdrop-filter:blur(4px)}
.d-st-e{font-size:clamp(16px,4vmin,24px)}
.d-st-v{font-size:clamp(14px,3vmin,20px);font-weight:800;color:#fff}
.d-st-l{font-size:clamp(7px,1.2vmin,9px);color:rgba(255,255,255,.7);text-transform:uppercase}
.d-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
.d-badge{background:rgba(255,255,255,.25);border-radius:8px;padding:3px 10px;font-size:clamp(10px,1.8vmin,13px);color:#fff;font-weight:600}
.d-btns{display:flex;gap:clamp(5px,1.2vmin,8px);flex-wrap:wrap;justify-content:center}
.d-btn{border:none;border-radius:12px;padding:clamp(7px,1.5vmin,12px) clamp(16px,4vmin,30px);font-size:clamp(11px,2.2vmin,15px);font-weight:800;cursor:pointer;transition:all .2s}
.d-btn:hover{transform:scale(1.04)}.d-btn:active{transform:scale(.95)}
.d-btn.pri{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 14px rgba(249,115,22,.4)}
.d-btn.sec{background:rgba(255,255,255,.25);color:#fff}
.d-btn.shr{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;box-shadow:0 4px 14px rgba(37,99,235,.4)}

/* LEVEL UP MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:20px;padding:clamp(16px,4vmin,32px);text-align:center;max-width:320px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:modalIn .4s ease}
@keyframes modalIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.modal h2{font-size:clamp(20px,5vmin,28px);font-weight:900;color:#fff;margin-bottom:8px}
.modal p{font-size:clamp(12px,2.2vmin,15px);color:rgba(255,255,255,.9);margin-bottom:12px}
.modal button{border:none;background:#fff;color:#b45309;font-weight:800;font-size:clamp(13px,2.5vmin,16px);padding:8px 28px;border-radius:12px;cursor:pointer}

/* SHOP MODAL */
.shop-modal{background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:20px;padding:clamp(12px,3vmin,24px);text-align:center;max-width:360px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:modalIn .4s ease}
.shop-modal h2{color:#fff;font-size:clamp(16px,4vmin,24px);margin-bottom:10px}
.shop-coins{color:#fbbf24;font-weight:800;font-size:clamp(14px,3vmin,18px);margin-bottom:10px}
.shop-items{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.shop-item{background:rgba(255,255,255,.15);border-radius:12px;padding:10px;backdrop-filter:blur(4px)}
.shop-item-icon{font-size:28px}
.shop-item-name{color:#fff;font-size:12px;font-weight:600;margin:4px 0}
.shop-item-price{color:#fbbf24;font-weight:700;font-size:13px}
.shop-item-owned{color:rgba(255,255,255,.6);font-size:10px}
.shop-buy{border:none;background:#fbbf24;color:#1f2937;font-weight:700;font-size:11px;padding:4px 12px;border-radius:8px;cursor:pointer;margin-top:4px}
.shop-buy:disabled{opacity:.4;cursor:not-allowed}
.shop-close{border:none;background:rgba(255,255,255,.25);color:#fff;font-weight:700;padding:6px 20px;border-radius:10px;cursor:pointer;margin-top:10px;font-size:13px}

/* BACK BUTTON */
.g-back{background:none;border:none;color:rgba(255,255,255,.7);font-size:clamp(10px,1.6vmin,12px);font-weight:600;cursor:pointer;padding:4px 10px;border-radius:8px;flex-shrink:0}
.g-back:hover{color:#fff;background:rgba(255,255,255,.15)}

/* TOOLTIP */
.tooltip-popup{position:fixed;z-index:200;background:#1f2937;color:#fff;font-size:13px;font-weight:600;padding:8px 16px;border-radius:10px;transform:translateX(-50%) translateY(-100%);pointer-events:none;box-shadow:0 6px 20px rgba(0,0,0,.3);transition:opacity .3s;opacity:1}

/* PARTICLES */
.particle{position:fixed;pointer-events:none;z-index:999;animation:floatup 1.2s ease-out forwards}
@keyframes floatup{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-90px) scale(.3)}}
@keyframes emojiBounce{0%{transform:scale(1)}30%{transform:scale(1.2)}60%{transform:scale(0.95)}100%{transform:scale(1)}}
@keyframes screenShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-3px)}80%{transform:translateX(2px)}}
</style>
</head>
<body>

<!-- LEVEL SELECT -->
<div id="lvl-screen" class="screen active">
  <div class="top-bar">
    <div class="tb-item" id="tb-level">‚≠ê Lv.1</div>
    <div class="tb-item" id="tb-coins">ü™ô 0</div>
    <div class="tb-item" id="tb-lives">‚ù§Ô∏è 5</div>
    <div class="tb-item" id="tb-perf" style="cursor:pointer" onclick="togglePerf()">‚ö°</div>
  </div>
  <div class="xp-bar-wrap">
    <div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
    <div class="xp-label" id="xp-label">0 / 1000 XP</div>
  </div>
  <div class="ls-title" id="ls-t">üßÆ ŸÖŸÖŸÑŸÉÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ</div>
  <div class="ls-btns">
    <button class="ls-btn daily" id="daily-btn" onclick="startDaily()">üéØ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä</button>
    <button class="ls-btn" onclick="openShop()">üõí ÿßŸÑŸÖÿ™ÿ¨ÿ±</button>
  </div>
  <div class="ls-grid" id="ls-g"></div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
  <div class="g-top">
    <div class="g-lives" id="g-lives"></div>
    <div class="g-combo" id="g-combo">üî• x1</div>
    <button class="g-back" onclick="exitGame()">‚úï</button>
  </div>
  <div class="boss-bar" id="boss-bar" style="display:none">
    <div class="boss-hdr">
      <span class="boss-emoji" id="boss-emoji">üê≤</span>
      <span class="boss-label" id="boss-label">Boss</span>
      <span class="boss-emoji" id="boss-p-emoji">üõ°Ô∏è</span>
    </div>
    <div class="boss-hp" id="boss-hp"></div>
  </div>
  <div class="gc" id="gc">
    <div class="g-hdr"><h1 id="g-t">üßÆ</h1></div>
    <div class="g-stats">
      <div class="g-stat"><span class="g-sv" id="g-sc">0</span><span class="g-sl" id="g-scl">ÿßŸÑŸÜŸÇÿßÿ∑</span></div>
      <div class="g-stat"><span class="g-sv" id="g-qn">1/10</span><span class="g-sl" id="g-qnl">ÿßŸÑÿ≥ÿ§ÿßŸÑ</span></div>
    </div>
    <div class="pbar"><div class="pfill" id="pfill" style="width:10%"></div></div>
    <div class="timer" id="timer"></div>
    <div class="q-area">
      <div class="q-visual" id="q-visual"></div>
      <div class="q-text" id="q-text">5 + 3 = ?</div>
      <div class="q-feedback" id="q-feedback"></div>
    </div>
    <div class="ans-grid" id="answers"></div>
    <div class="boosters" id="boosters"></div>
  </div>
</div>

<!-- DONE SCREEN -->
<div id="done-screen" class="screen">
  <div class="d-emoji" id="d-e">üèÜ</div>
  <div class="d-title" id="d-t">ÿ£ÿ≠ÿ≥ŸÜÿ™!</div>
  <div class="d-stars" id="d-st"></div>
  <div class="d-sub" id="d-sub"></div>
  <div class="d-near" id="d-near" style="display:none"></div>
  <div class="d-stats">
    <div class="d-st"><div class="d-st-e">‚úÖ</div><div class="d-st-v" id="d-cr">0</div><div class="d-st-l" id="d-crl">ÿµÿ≠Ÿäÿ≠</div></div>
    <div class="d-st"><div class="d-st-e">‚ùå</div><div class="d-st-v" id="d-wr">0</div><div class="d-st-l" id="d-wrl">ÿÆÿ∑ÿ£</div></div>
    <div class="d-st"><div class="d-st-e">‚è±Ô∏è</div><div class="d-st-v" id="d-tm">0s</div><div class="d-st-l" id="d-tml">ÿßŸÑŸàŸÇÿ™</div></div>
    <div class="d-st"><div class="d-st-e">‚≠ê</div><div class="d-st-v" id="d-xp">+0</div><div class="d-st-l">XP</div></div>
    <div class="d-st"><div class="d-st-e">ü™ô</div><div class="d-st-v" id="d-cn">+0</div><div class="d-st-l" id="d-cnl">ÿπŸÖŸÑÿßÿ™</div></div>
  </div>
  <div class="d-badges" id="d-badges"></div>
  <div class="d-btns">
    <button class="d-btn pri" id="d-nx" onclick="nextLevel()">‚û°Ô∏è ÿßŸÑÿ™ÿßŸÑŸä</button>
    <button class="d-btn shr" id="d-sh" onclick="shareResult()">üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©</button>
    <button class="d-btn sec" onclick="replayLevel()">üîÑ ÿ•ÿπÿßÿØÿ©</button>
    <button class="d-btn sec" onclick="showScreen('lvl-screen')">üè†</button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="lvlup-modal">
  <div class="modal">
    <h2 id="lvlup-title">‚¨ÜÔ∏è Level Up!</h2>
    <p id="lvlup-msg">Earned: +1 üî® +1 üí° +1 ‚ù§Ô∏è</p>
    <button onclick="closeLvlUp()">üëç</button>
  </div>
</div>
<div class="modal-overlay" id="shop-modal">
  <div class="shop-modal">
    <h2>üõí ÿßŸÑŸÖÿ™ÿ¨ÿ±</h2>
    <div class="shop-coins" id="shop-coins">ü™ô 0</div>
    <div class="shop-items" id="shop-items"></div>
    <button class="shop-close" onclick="closeShop()">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
  </div>
</div>
<div class="modal-overlay" id="nolives-modal">
  <div class="modal" style="background:linear-gradient(135deg,#ef4444,#b91c1c)">
    <h2>‚ù§Ô∏è ŸÑÿß ÿ£ÿ±Ÿàÿßÿ≠!</h2>
    <p id="nolives-msg">ÿßŸÑŸÇŸÑÿ® ÿßŸÑÿ™ÿßŸÑŸä ÿÆŸÑÿßŸÑ 10 ÿØŸÇÿßÿ¶ŸÇ</p>
    <button onclick="closeNoLives()">ÿ≠ÿ≥ŸÜÿßŸã</button>
  </div>
</div>

<script type="module">
import { POOL, LEVELS, THEMES, THEME_GROUPS, LANG, t, I18N } from './math-modules/config.js';
import * as Core from './math-modules/core.js';
import * as Intel from './math-modules/intelligence.js';
import * as Engage from './math-modules/engagement.js';
import * as UI from './math-modules/ui.js';
import * as Econ from './math-modules/economy.js';
import * as Boss from './math-modules/boss.js';

// Apply lang
document.documentElement.lang = LANG;
document.documentElement.dir = LANG === 'ar' ? 'rtl' : 'ltr';
const T = (I18N[LANG] || I18N.en);

// ===== GAME STATE =====
let progress, currentLevel = -1, currentQ = 0, totalScore = 0, streak = 0, highStreak = 0;
let questions = [], timerInterval = null, timeLeft = 0, answering = false, startTime = 0;
let usedHintThisLevel = false, bossState = null, dailyMode = false, questionStartTime = 0;
let totalCorrect = 0, totalQ = 10, currentTimerMax = 0;
let challengeTracker;

// ===== INIT =====
function init() {
  progress = Core.loadProgress();
  // Defensive: ensure skillData exists (legacy migration)
  if (!progress.skillData) progress.skillData = { avgResponseTime: 8, accuracyRate: 0.5, highestStreak: 0, totalGamesPlayed: 0, smoothedSkill: 50 };
  if (!progress.boosters) progress.boosters = { hammer: 1, shuffle: 1, extraTime: 1, hint: 3 };
  if (!progress.tutorialShown) progress.tutorialShown = {};
  if (!progress.purchaseCounts) progress.purchaseCounts = { hammer: 0, shuffle: 0, extraTime: 0, hint: 0 };
  // Apply i18n
  el('ls-t').textContent = T.title;
  el('g-scl').textContent = T.score;
  el('g-qnl').textContent = T.question;
  el('d-crl').textContent = T.correct;
  el('d-wrl').textContent = T.wrong;
  el('d-tml').textContent = T.time;
  el('d-cnl').textContent = T.coins;
  el('d-sh').textContent = T.share;
  el('daily-btn').textContent = T.daily;
  // Check daily
  updateDailyBtn();
  renderLevelSelect();
}

function el(id) { return document.getElementById(id); }

// ===== SCREENS =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  el(id).classList.add('active');
  if (id === 'lvl-screen') { renderLevelSelect(); UI.stopMusic(); }
}
window.showScreen = showScreen;

// ===== TOP BAR =====
function updateTopBar() {
  const lvl = Core.getPlayerLevel(progress);
  const xpCur = Core.getLevelXPProgress(progress);
  const xpMax = Core.getXPToNextLevel();
  el('tb-level').textContent = '‚≠ê Lv.' + lvl;
  el('tb-coins').textContent = 'ü™ô ' + Econ.getCoins(progress);
  el('tb-lives').textContent = '‚ù§Ô∏è ' + Core.getLives(progress);
  el('xp-fill').style.width = (xpCur / xpMax * 100) + '%';
  el('xp-label').textContent = xpCur + ' / ' + xpMax + ' XP';
  el('tb-perf').textContent = UI.isLowPerf() ? 'üê¢' : '‚ö°';
}

function updateDailyBtn() {
  const today = new Date().toDateString();
  if (progress.dailyChallengeDate === today && progress.dailyChallengeCompleted) {
    el('daily-btn').textContent = T.dailyDone;
    el('daily-btn').disabled = true;
    el('daily-btn').style.opacity = '.5';
  }
}

// ===== LEVEL SELECT =====
function renderLevelSelect() {
  updateTopBar();
  const g = el('ls-g'); g.innerHTML = '';
  for (let i = 0; i < LEVELS.length; i++) {
    const cfg = LEVELS[i];
    const unlocked = i < (progress.unlocked || 1);
    const stars = progress.stars[i] || 0;
    const isCurr = i === (progress.unlocked || 1) - 1;
    const card = document.createElement('div');
    card.className = 'lc' + (unlocked ? '' : ' locked') + (isCurr ? ' current' : '');
    if (unlocked) {
      card.innerHTML = `<div class="lc-num">${i+1}</div><div class="lc-emoji">${cfg.emoji}</div><div class="lc-name">${T.lvNames[i]}</div><div class="lc-stars">${stars>=1?'‚≠ê':'‚òÜ'}${stars>=2?'‚≠ê':'‚òÜ'}${stars>=3?'‚≠ê':'‚òÜ'}</div>`;
      card.onclick = () => startLevel(i);
    } else {
      card.innerHTML = `<div class="lc-num" style="opacity:.4">${i+1}</div><div class="lc-lock">${T.locked}</div><div class="lc-name" style="opacity:.4">${T.lvNames[i]}</div>`;
    }
    g.appendChild(card);
  }
  // Tutorial: first visit
  if (UI.shouldShowTooltip(progress, 'levelSelect')) {
    UI.markTooltipShown(progress, 'levelSelect');
    Core.saveProgress(progress);
  }
}

// ===== LIVES CHECK =====
function checkLives() {
  const lives = Core.getLives(progress);
  if (lives <= 0) {
    const ms = Core.getTimeToNextLife(progress);
    const mins = Math.ceil(ms / 60000);
    el('nolives-msg').textContent = T.livesRegen.replace('{m}', mins);
    el('nolives-modal').classList.add('show');
    return false;
  }
  return true;
}
window.closeNoLives = () => el('nolives-modal').classList.remove('show');

// ===== QUESTION GENERATION =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
  return a;
}

function pickMultiCatEmoji(cats) {
  let pool = [];
  for (const c of cats) pool = pool.concat(POOL[c] || []);
  return shuffle([...new Set(pool)]);
}

function genQuestion(ops, range, emojiPool, difficulty, isBoss) {
  const effRange = Intel.getDifficultyRange(range, difficulty);
  const op = ops[Math.floor(Math.random() * ops.length)];
  let a, b, answer, text, visual = '';
  const em = emojiPool[Math.floor(Math.random() * emojiPool.length)];
  switch(op) {
    case 'add':
      a = Math.floor(Math.random() * effRange) + 1;
      b = Math.floor(Math.random() * effRange) + 1;
      answer = a + b; text = `${a} + ${b} = ?`;
      if (a <= 6 && b <= 6) visual = em.repeat(a) + ' + ' + em.repeat(b);
      break;
    case 'sub':
      a = Math.floor(Math.random() * effRange) + 2;
      b = Math.floor(Math.random() * a) + 1;
      answer = a - b; text = `${a} - ${b} = ?`;
      if (a <= 8) visual = em.repeat(a) + ' - ' + em.repeat(b);
      break;
    case 'mul':
      a = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      b = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      answer = a * b; text = `${a} √ó ${b} = ?`;
      if (a <= 4 && b <= 4) { const rows = []; for (let r = 0; r < a; r++) rows.push(em.repeat(b)); visual = rows.join(' '); }
      break;
    case 'div':
      b = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      const q = Math.floor(Math.random() * Math.min(effRange, 12)) + 1;
      a = b * q; answer = q; text = `${a} √∑ ${b} = ?`;
      if (a <= 12) visual = em.repeat(a) + ' √∑ ' + b;
      break;
  }
  const wrongs = new Set();
  while (wrongs.size < 3) {
    const off = Math.floor(Math.random() * 10) + 1;
    const w = Math.random() < .5 ? answer + off : answer - off;
    if (w !== answer && w >= 0 && !wrongs.has(w)) wrongs.add(w);
  }
  return { text, answer, options: shuffle([answer, ...wrongs]), visual };
}

function genAllQuestions(cfg, isBoss) {
  const skill = Intel.getSmoothedSkill(progress.skillData || {});
  const adjustedRange = Intel.adjustRange(cfg.range, skill);
  const adjustedTimer = Intel.adjustTimer(cfg.timer, skill);
  currentTimerMax = adjustedTimer;
  const pool = pickMultiCatEmoji(cfg.cats);
  const qs = [];
  const bossOps = isBoss ? null : null; // for boss, phase ops come from boss module
  for (let i = 0; i < cfg.questions; i++) {
    const diff = Intel.getQuestionDifficulty(i, cfg.questions, isBoss);
    let ops = cfg.ops;
    if (isBoss && bossState) ops = Boss.getCurrentPhaseOps(bossState);
    qs.push(genQuestion(ops, adjustedRange, pool, diff, isBoss));
  }
  return qs;
}

// ===== START LEVEL =====
function startLevel(idx) {
  if (!checkLives()) return;
  dailyMode = false;
  currentLevel = idx;
  const cfg = LEVELS[idx];
  totalQ = cfg.questions;
  const isBoss = cfg.boss;

  // Theme
  UI.applyTheme(idx, el('game-screen'), el('done-screen'));

  // Boss init
  if (isBoss) {
    bossState = Boss.createBossState();
    el('boss-bar').style.display = '';
    renderBossHP();
    el('boss-emoji').textContent = Boss.getBossEmoji(bossState);
    el('boss-label').textContent = Boss.getBossPhaseLabel(bossState);
  } else {
    bossState = null;
    el('boss-bar').style.display = 'none';
  }

  el('g-t').textContent = T.lvNames[idx] + (isBoss ? ' üëë' : ' üßÆ');

  // Reset state
  currentQ = 0; totalScore = 0; streak = 0; highStreak = 0;
  totalCorrect = 0; usedHintThisLevel = false; answering = false;
  startTime = Date.now();
  challengeTracker = Engage.createChallengeTracker();

  // Generate questions (for boss, generate per-phase later)
  if (isBoss) {
    questions = genBossQuestions(cfg);
  } else {
    questions = genAllQuestions(cfg, false);
  }

  el('g-sc').textContent = '0';
  renderLives();
  updateCombo();
  showScreen('game-screen');
  UI.startMusic();
  renderBoosters();

  // Tutorial
  if (currentTimerMax > 0 && UI.shouldShowTooltip(progress, 'timer')) {
    UI.markTooltipShown(progress, 'timer');
    Core.saveProgress(progress);
  }

  showQuestion();
}
window.startLevel = startLevel;

function genBossQuestions(cfg) {
  const phases = Boss.getPhases();
  const skill = Intel.getSmoothedSkill(progress.skillData || {});
  const pool = pickMultiCatEmoji(cfg.cats);
  const qs = [];
  for (const phase of phases) {
    for (let i = 0; i < phase.questions; i++) {
      const diff = Intel.getQuestionDifficulty(i, phase.questions, true);
      qs.push(genQuestion(phase.ops, Intel.adjustRange(cfg.range, skill), pool, diff, true));
    }
  }
  return qs;
}

// ===== DAILY CHALLENGE =====
function startDaily() {
  const today = new Date().toDateString();
  if (progress.dailyChallengeDate === today && progress.dailyChallengeCompleted) return;
  if (!checkLives()) return;
  dailyMode = true;
  currentLevel = -1;
  totalQ = 10;
  currentTimerMax = 14;

  UI.applyTheme(Math.floor(Math.random() * 20), el('game-screen'), el('done-screen'));
  el('boss-bar').style.display = 'none';
  bossState = null;
  el('g-t').textContent = T.daily + ' üéØ';

  currentQ = 0; totalScore = 0; streak = 0; highStreak = 0;
  totalCorrect = 0; usedHintThisLevel = false; answering = false;
  startTime = Date.now();
  challengeTracker = Engage.createChallengeTracker();

  // Mix questions from random levels
  const pool = pickMultiCatEmoji(['mix', 'farm', 'fruit', 'sport', 'space']);
  questions = [];
  const ops = ['add', 'sub', 'mul', 'div'];
  for (let i = 0; i < totalQ; i++) {
    const diff = Intel.getQuestionDifficulty(i, totalQ, false);
    questions.push(genQuestion(ops, 30, pool, diff, false));
  }

  el('g-sc').textContent = '0';
  renderLives();
  updateCombo();
  showScreen('game-screen');
  UI.startMusic();
  renderBoosters();
  showQuestion();
}
window.startDaily = startDaily;

// ===== SHOW QUESTION =====
function showQuestion() {
  if (currentQ >= totalQ) { endGame(); return; }
  answering = false;
  questionStartTime = Date.now();
  const q = questions[currentQ];

  // Boss: update phase ops
  if (bossState) {
    el('boss-emoji').textContent = Boss.getBossEmoji(bossState);
    el('boss-label').textContent = Boss.getBossPhaseLabel(bossState);
    renderBossHP();
  }

  el('q-text').textContent = q.text;
  const vizEl = el('q-visual');
  vizEl.textContent = q.visual || '';
  UI.bounceElement(vizEl);

  el('q-feedback').textContent = '';
  el('g-qn').textContent = (currentQ + 1) + '/' + totalQ;
  el('g-sc').textContent = totalScore;
  el('pfill').style.width = ((currentQ + 1) / totalQ * 100) + '%';

  const ans = el('answers'); ans.innerHTML = '';
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn';
    btn.textContent = opt;
    btn.onclick = () => selectAnswer(opt, btn);
    ans.appendChild(btn);
  });

  // Timer
  clearInterval(timerInterval);
  if (currentTimerMax > 0) {
    timeLeft = currentTimerMax;
    updateTimerUI();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerUI();
      if (timeLeft <= 5) UI.sfxTick();
      if (timeLeft <= 0) { clearInterval(timerInterval); timeUp(); }
    }, 1000);
  } else {
    el('timer').textContent = '';
  }

  renderBoosters();
}

function updateTimerUI() {
  const tEl = el('timer');
  tEl.textContent = T.timerTxt(timeLeft);
  tEl.className = timeLeft <= 5 ? 'timer urgent' : 'timer';
}

// ===== SELECT ANSWER =====
function selectAnswer(selected, btn) {
  if (answering) return;
  answering = true;
  clearInterval(timerInterval);

  const q = questions[currentQ];
  const responseTime = (Date.now() - questionStartTime) / 1000;
  const correct = selected === q.answer;

  document.querySelectorAll('.ans-btn').forEach(b => b.disabled = true);

  if (correct) {
    btn.classList.add('correct');
    totalCorrect++;
    streak++;
    if (streak > highStreak) highStreak = streak;

    // Scoring
    const comboMult = Core.getComboMultiplier(streak);
    const qScore = Core.calculateScore(true, timeLeft, currentTimerMax || 15, comboMult, usedHintThisLevel);
    totalScore += qScore;

    // Engagement
    const streakMsg = Engage.getStreakMessage(streak);
    if (streakMsg) el('q-feedback').textContent = streakMsg;

    // Audio + visual
    UI.sfxCorrect();
    if (streak > 1) UI.sfxComboUp(streak);
    const rect = btn.getBoundingClientRect();
    const thGroup = currentLevel >= 0 ? UI.getThemeGroup(currentLevel) : THEME_GROUPS.nature;
    UI.spawnParticles(rect.left + rect.width / 2, rect.top, 4, thGroup.particleStyle);

    // Boss hit
    if (bossState) {
      const result = Boss.hitBoss(bossState);
      UI.sfxBossHit();
      renderBossHP();
    }

    // Skill tracking
    Intel.updateSkillData(progress.skillData, true, responseTime);

  } else {
    btn.classList.add('wrong');
    // Show correct
    document.querySelectorAll('.ans-btn').forEach(b => {
      if (+b.textContent === q.answer) b.classList.add('correct');
    });

    // Engagement feedback
    if (streak >= 3) {
      el('q-feedback').textContent = Engage.getWrongAfterStreakMessage(streak);
    }
    streak = 0;

    // Lose life
    Core.loseLife(progress);
    renderLives();
    UI.sfxWrong();
    UI.vibrate(100);
    UI.shakeElement(el('gc'));

    // Boss attack
    if (bossState) {
      const atk = Boss.bossAttack(bossState);
      UI.sfxBossAttack();
      if (atk.gameOver) {
        // Boss killed player
        setTimeout(() => endGame(), 800);
        return;
      }
    }

    // Check lives
    if (Core.getLives(progress) <= 0 && !bossState) {
      setTimeout(() => endGame(), 800);
      return;
    }

    Intel.updateSkillData(progress.skillData, false, responseTime);
  }

  // Track challenge
  Engage.trackAnswer(challengeTracker, correct, responseTime, false);

  updateCombo();
  UI.updateMusicLayers(streak, !!bossState);

  currentQ++;

  // Flow controller transition
  const delay = Intel.getTransitionDelay(responseTime);
  setTimeout(showQuestion, delay);
}

function timeUp() {
  if (answering) return;
  answering = true;
  const q = questions[currentQ];
  document.querySelectorAll('.ans-btn').forEach(b => {
    b.disabled = true;
    if (+b.textContent === q.answer) b.classList.add('correct');
  });
  el('q-feedback').textContent = T.timeUp;

  // Lose life + streak reset
  if (streak >= 3) el('q-feedback').textContent = T.timeUp + ' ' + Engage.getWrongAfterStreakMessage(streak);
  streak = 0;
  Core.loseLife(progress);
  renderLives();
  UI.vibrate(100);

  if (bossState) Boss.bossAttack(bossState);

  Engage.trackAnswer(challengeTracker, false, currentTimerMax, false);
  updateCombo();

  currentQ++;
  if (Core.getLives(progress) <= 0 && !bossState) {
    setTimeout(() => endGame(), 800);
  } else {
    setTimeout(showQuestion, 1400);
  }
}

// ===== UI HELPERS =====
function renderLives() {
  const lives = Core.getLives(progress);
  const maxLives = Core.getMaxLives();
  let html = '';
  for (let i = 0; i < maxLives; i++) html += i < lives ? '‚ù§Ô∏è' : 'üñ§';
  el('g-lives').innerHTML = html;
}

function updateCombo() {
  const comboEl = el('g-combo');
  if (streak >= 2) {
    comboEl.textContent = 'üî• x' + Core.getComboMultiplier(streak).toFixed(1);
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

function renderBossHP() {
  if (!bossState) return;
  const segments = Boss.getBossPhaseSegments(bossState);
  const hpEl = el('boss-hp');
  hpEl.innerHTML = '';
  for (const seg of segments) {
    for (let i = 0; i < seg.total; i++) {
      const div = document.createElement('div');
      div.className = 'boss-seg' + (i >= seg.remaining ? ' empty' : '');
      div.style.background = i < seg.remaining ? seg.color : 'rgba(255,255,255,.1)';
      div.style.flex = '1';
      hpEl.appendChild(div);
    }
  }
}

// ===== BOOSTERS =====
function renderBoosters() {
  const bEl = el('boosters');
  bEl.innerHTML = '';
  const types = [
    { key: 'hint', icon: 'üí°', action: useHint },
    { key: 'hammer', icon: 'üî®', action: useHammer },
    { key: 'shuffle', icon: 'üîÑ', action: useShuffle },
    { key: 'extraTime', icon: '‚è±Ô∏è', action: useExtraTime },
  ];
  for (const bt of types) {
    const count = Econ.getBoosterCount(progress, bt.key);
    const btn = document.createElement('button');
    btn.className = 'bst-btn';
    btn.disabled = count <= 0 || answering;
    btn.innerHTML = `${bt.icon}<span class="bst-cnt">${count}</span>`;
    btn.onclick = bt.action;
    bEl.appendChild(btn);
  }

  // Tooltip for boosters on first sight
  if (UI.shouldShowTooltip(progress, 'boosters') && Econ.getBoosterCount(progress, 'hint') > 0) {
    setTimeout(() => {
      UI.showTooltip('üí° ' + T.hint, bEl.firstChild, 2500);
      UI.markTooltipShown(progress, 'boosters');
      Core.saveProgress(progress);
    }, 1000);
  }
}

function useHint() {
  if (answering) return;
  if (!Econ.useBooster(progress, 'hint')) return;
  usedHintThisLevel = true;
  Core.saveProgress(progress);
  // Remove 2 wrong answers
  const q = questions[currentQ];
  const btns = [...document.querySelectorAll('.ans-btn')];
  const wrongBtns = btns.filter(b => +b.textContent !== q.answer);
  shuffle(wrongBtns).slice(0, 2).forEach(b => { b.disabled = true; b.style.opacity = '.2'; });
  renderBoosters();
}

function useHammer() {
  if (answering) return;
  if (!Econ.useBooster(progress, 'hammer')) return;
  Core.saveProgress(progress);
  // Remove 1 wrong answer
  const q = questions[currentQ];
  const btns = [...document.querySelectorAll('.ans-btn')];
  const wrongBtns = btns.filter(b => +b.textContent !== q.answer && !b.disabled);
  if (wrongBtns.length > 0) { wrongBtns[0].disabled = true; wrongBtns[0].style.opacity = '.2'; }
  renderBoosters();
}

function useShuffle() {
  if (answering) return;
  if (!Econ.useBooster(progress, 'shuffle')) return;
  Core.saveProgress(progress);
  // Regenerate current question
  const cfg = currentLevel >= 0 ? LEVELS[currentLevel] : { ops: ['add','sub','mul','div'], range: 30, cats: ['mix'] };
  const pool = pickMultiCatEmoji(cfg.cats);
  const diff = Intel.getQuestionDifficulty(currentQ, totalQ, !!(bossState));
  questions[currentQ] = genQuestion(cfg.ops, cfg.range, pool, diff, !!(bossState));
  showQuestion();
}

function useExtraTime() {
  if (answering || currentTimerMax <= 0) return;
  if (!Econ.useBooster(progress, 'extraTime')) return;
  Core.saveProgress(progress);
  timeLeft += 5;
  updateTimerUI();
  renderBoosters();
}

// ===== END GAME =====
function endGame() {
  clearInterval(timerInterval);
  UI.stopMusic();
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  const stars = Core.getStarsForScore(totalCorrect, totalQ);
  const isPerfect = totalCorrect === totalQ;
  const noHints = !usedHintThisLevel;

  // XP & Coins
  const xpGained = Core.calculateXP(totalScore, totalQ, isPerfect, noHints, dailyMode);
  const coinsGained = Core.calculateCoins(stars, isPerfect, dailyMode);
  const xpResult = Core.addXP(progress, xpGained);
  Econ.addCoins(progress, coinsGained);

  // Update level progress
  if (currentLevel >= 0 && !dailyMode) {
    Core.updateLevelProgress(progress, currentLevel, totalScore, stars);
  }

  // Daily challenge
  if (dailyMode) {
    progress.dailyChallengeDate = new Date().toDateString();
    progress.dailyChallengeCompleted = true;
    // Daily hint reward on failure (consolation prize)
    if (stars === 0) {
      progress.boosters.hint = (progress.boosters.hint || 0) + 1;
    }
  }

  // Skill update
  const avgRT = Engage.getAvgResponseTime(challengeTracker);
  Intel.updateSkillAfterLevel(progress.skillData, totalCorrect / totalQ, avgRT, highStreak, totalQ);

  // Badges
  const badges = Engage.evaluateBadges(challengeTracker);
  Engage.saveBadges(progress, badges);

  Core.saveProgress(progress);

  // ===== RENDER DONE SCREEN =====
  let title, emoji;
  if (isPerfect) { title = T.excellent; emoji = 'üèÜ'; }
  else if (stars >= 2) { title = T.great; emoji = 'üéâ'; }
  else if (stars >= 1) { title = T.good; emoji = 'üëç'; }
  else { title = T.tryMore; emoji = 'üí™'; }

  if (bossState && Boss.isBossDefeated(bossState)) {
    title = 'üëë ' + T.boss + ' - ' + T.excellent;
    emoji = 'üëë';
  }

  el('d-e').textContent = emoji;
  el('d-t').textContent = title;
  el('d-sub').textContent = T.done + (dailyMode ? ' ' + T.dailyReward : '');
  el('d-cr').textContent = totalCorrect;
  el('d-wr').textContent = totalQ - totalCorrect;
  el('d-tm').textContent = elapsed + 's';
  el('d-xp').textContent = '+' + xpResult.xpGained;
  el('d-cn').textContent = '+' + coinsGained;

  // Stars
  const starsEl = el('d-st'); starsEl.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const sp = document.createElement('span');
    sp.textContent = i < stars ? '‚≠ê' : '‚òÜ';
    sp.style.opacity = i < stars ? '1' : '.3';
    starsEl.appendChild(sp);
  }

  // Near miss
  const nearMiss = Engage.checkNearMiss(totalCorrect, Math.ceil(totalQ * 0.6), totalQ, timeLeft, currentQ >= totalQ);
  el('d-near').style.display = nearMiss.isNearMiss ? '' : 'none';
  el('d-near').textContent = nearMiss.isNearMiss ? Engage.getNearMissMessage() : '';

  // Badges
  const badgesEl = el('d-badges'); badgesEl.innerHTML = '';
  for (const b of badges) {
    const span = document.createElement('span');
    span.className = 'd-badge';
    span.textContent = b.icon + ' ' + b.label;
    badgesEl.appendChild(span);
  }
  if (isPerfect) {
    const sp = document.createElement('span');
    sp.className = 'd-badge';
    sp.textContent = 'üèÜ ' + T.perfect;
    badgesEl.appendChild(sp);
  }
  if (noHints && totalQ >= 5) {
    const sp = document.createElement('span');
    sp.className = 'd-badge';
    sp.textContent = 'üß† ' + T.nohint;
    badgesEl.appendChild(sp);
  }

  // Next button
  el('d-nx').style.display = (currentLevel >= 0 && currentLevel < LEVELS.length - 1 && !dailyMode && stars >= 1) ? '' : 'none';
  el('d-nx').textContent = T.next;

  UI.sfxComplete();
  if (stars > 0) UI.sfxStar();
  showScreen('done-screen');
  UI.spawnCelebration(stars * 5 + (isPerfect ? 10 : 0));

  // Level up modal
  if (xpResult.leveledUp) {
    setTimeout(() => {
      el('lvlup-title').textContent = T.lvlUp;
      el('lvlup-msg').textContent = T.newLevel.replace('{n}', xpResult.newLevel) + ' üéÅ +1üî® +1üí° +1‚ù§Ô∏è';
      el('lvlup-modal').classList.add('show');
      UI.sfxLevelUp();
    }, 1500);
  }

  // PostMessage to parent
  const scaledScore = Math.round(totalCorrect / totalQ * 100);
  try {
    window.parent.postMessage({
      type: 'GAME_COMPLETE', score: scaledScore, total: 100,
      timeElapsed: elapsed, level: currentLevel >= 0 ? currentLevel + 1 : 0, stars
    }, '*');
  } catch(e) {}
}

function closeLvlUp() { el('lvlup-modal').classList.remove('show'); }
window.closeLvlUp = closeLvlUp;

function nextLevel() {
  if (currentLevel >= 0 && currentLevel < LEVELS.length - 1) startLevel(currentLevel + 1);
}
window.nextLevel = nextLevel;

function replayLevel() {
  if (dailyMode) startDaily();
  else if (currentLevel >= 0) startLevel(currentLevel);
}
window.replayLevel = replayLevel;

function exitGame() {
  clearInterval(timerInterval);
  UI.stopMusic();
  showScreen('lvl-screen');
}
window.exitGame = exitGame;

// ===== SHARE =====
function shareResult() {
  const lvl = currentLevel >= 0 ? currentLevel + 1 : 0;
  const stars = currentLevel >= 0 ? (progress.stars[currentLevel] || 0) : 0;
  const text = T.shareText.replace('{score}', totalScore).replace('{level}', lvl).replace('{stars}', '‚≠ê'.repeat(stars));
  try { if (navigator.share) navigator.share({ title: T.title, text }); } catch(e) {}
  try {
    window.parent.postMessage({
      type: 'SHARE_ACHIEVEMENT', game: 'math', level: lvl,
      score: totalScore, stars, text
    }, '*');
  } catch(e) {}
  el('d-sh').textContent = '‚úÖ';
  setTimeout(() => el('d-sh').textContent = T.share, 2000);
}
window.shareResult = shareResult;

// ===== SHOP =====
function openShop() {
  el('shop-coins').textContent = 'ü™ô ' + Econ.getCoins(progress);
  const items = Econ.getShopItems(progress);
  const grid = el('shop-items'); grid.innerHTML = '';
  const names = { hammer: T.hammer, shuffle: T.shuffle, extraTime: T.extraTime, hint: T.hint };
  for (const item of items) {
    const div = document.createElement('div');
    div.className = 'shop-item';
    div.innerHTML = `
      <div class="shop-item-icon">${item.icon}</div>
      <div class="shop-item-name">${names[item.type] || item.type}</div>
      <div class="shop-item-price">ü™ô ${item.price}</div>
      <div class="shop-item-owned">x${item.owned}</div>
    `;
    const btn = document.createElement('button');
    btn.className = 'shop-buy';
    btn.textContent = T.buy;
    btn.disabled = !item.canAfford;
    btn.onclick = () => {
      const result = Econ.buyBooster(progress, item.type);
      if (result.success) {
        Core.saveProgress(progress);
        openShop(); // refresh
        updateTopBar();
      }
    };
    div.appendChild(btn);
    grid.appendChild(div);
  }
  el('shop-modal').classList.add('show');
}
window.openShop = openShop;

function closeShop() { el('shop-modal').classList.remove('show'); }
window.closeShop = closeShop;

// ===== PERF TOGGLE =====
function togglePerf() {
  UI.setLowPerf(!UI.isLowPerf());
  updateTopBar();
}
window.togglePerf = togglePerf;

// ===== BOOT =====
init();
</script>
</body>
</html>
